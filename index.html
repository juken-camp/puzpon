<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no, maximum-scale=1.0, minimum-scale=1.0">
    <title>ğŸ± NEKOPON Quiz ğŸ±</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="problems.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=M+PLUS+Rounded+1c:wght@400;700&display=swap');

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            -webkit-user-select: none;
            -moz-user-select: none;
            -ms-user-select: none;
            user-select: none;
            -webkit-touch-callout: none;
            -webkit-tap-highlight-color: transparent;
        }

        :root {
            --primary-brown: #8b4513;
            --light-brown: #d2691e;
            --cream: #faf8f5;
            --white: #ffffff;
            --soft-orange: #ff7f50;
            --gold: #ffd700;
            --pink: #ffb6c1;
            --shadow: rgba(139,69,19,0.25);
            --neon-pink: #ff1493;
            --neon-blue: #00bfff;
            --neon-green: #00ff00;
        }

        body {
            font-family: 'M PLUS Rounded 1c', sans-serif;
            background: var(--cream);
            color: var(--primary-brown);
            font-weight: 700;
            min-height: 100vh;
            touch-action: manipulation;
            overflow-x: hidden;
            -webkit-text-size-adjust: none;
            -moz-text-size-adjust: none;
            -ms-text-size-adjust: none;
            text-size-adjust: none;
            cursor: pointer;
            position: relative;
        }

        .container-spacing {
            margin: 0 auto;
            max-width: 95%;
            width: 100%;
        }

        @media (min-width: 640px) {
            .container-spacing {
                max-width: 500px;
            }
        }

        @media (min-width: 768px) {
            .container-spacing {
                max-width: 600px;
            }
        }

        @media (min-width: 1024px) {
            .container-spacing {
                max-width: 700px;
            }
        }

        /* æ¨ªä¸¦ã³ã‚¹ã‚³ã‚¢è¡¨ç¤ºï¼ˆNEKOPONé¢¨ï¼‰ */
        .horizontal-points-display {
            position: fixed !important;
            bottom: 20px !important;
            left: 50% !important;
            transform: translateX(-50%) !important;
            z-index: 9999 !important;
            display: flex !important;
            gap: 12px !important;
            pointer-events: none;
            background: rgba(255,255,255,0.35);
            padding: 8px 24px;
            border-radius: 25px;
            backdrop-filter: blur(15px);
            box-shadow: 
                0 8px 32px rgba(139,69,19,0.15),
                inset 0 1px 0 rgba(255,255,255,0.3);
            animation: header-enter 1.2s ease-out 0.8s forwards;
            opacity: 0;
        }

        @keyframes header-enter {
            0% { 
                opacity: 0; 
                transform: translateX(-50%) translateY(20px) scale(0.9); 
            }
            100% { 
                opacity: 1; 
                transform: translateX(-50%) translateY(0) scale(1); 
            }
        }

        .point-bubble {
            background: transparent;
            border: none;
            border-radius: 15px;
            padding: 5px 8px;
            display: flex;
            align-items: center;
            gap: 6px;
            font-size: 16px;
            font-weight: 700;
            color: var(--primary-brown);
            cursor: pointer;
            pointer-events: auto;
            transition: all 0.3s ease;
            position: relative;
        }

        .point-bubble:hover {
            background: rgba(255,255,255,0.2);
            transform: scale(1.05);
        }

        /* ã‚¢ã‚¤ã‚³ãƒ³ã®ã¿ã®å›è»¢ç”¨ã‚¯ãƒ©ã‚¹ - æ‹¡å¼µç‰ˆ */
        .rotating-icon, .auto-rotating-emoji {
            display: inline-block;
            transition: transform 0.1s ease-out;
            --rotation: 0deg;
        }

        .rotating-icon:not(.animating):not(.bounce), 
        .auto-rotating-emoji:not(.animating):not(.bounce) {
            transform: rotate(var(--rotation)) !important;
        }

        .point-bubble:nth-child(1):not(.tap-sparkle) .rotating-icon,
        .point-bubble:nth-child(1):not(.tap-sparkle) .auto-rotating-emoji {
            animation: gentle-sparkle 4s ease-in-out 3s infinite;
        }

        .point-bubble:nth-child(2):not(.tap-fire) .rotating-icon,
        .point-bubble:nth-child(2):not(.tap-fire) .auto-rotating-emoji {
            animation: gentle-fire 3.5s ease-in-out 3.5s infinite;
        }

        .point-bubble:nth-child(3):not(.tap-trophy) .rotating-icon,
        .point-bubble:nth-child(3):not(.tap-trophy) .auto-rotating-emoji {
            animation: gentle-trophy 5s ease-in-out 4s infinite;
        }

        .point-bubble.tap-sparkle .rotating-icon,
        .point-bubble.tap-sparkle .auto-rotating-emoji {
            animation: tap-sparkle 0.8s ease-out !important;
        }

        .point-bubble.tap-fire .rotating-icon,
        .point-bubble.tap-fire .auto-rotating-emoji {
            animation: tap-fire 0.8s ease-out !important;
        }

        .point-bubble.tap-trophy .rotating-icon,
        .point-bubble.tap-trophy .auto-rotating-emoji {
            animation: tap-trophy 0.8s ease-out !important;
        }

        @keyframes gentle-sparkle {
            0%, 100% { filter: brightness(1); transform: scale(1) rotate(var(--rotation)); }
            50% { filter: brightness(1.2) drop-shadow(0 0 5px gold); transform: scale(1.02) rotate(calc(var(--rotation) + 5deg)); }
        }

        @keyframes gentle-fire {
            0%, 100% { filter: brightness(1); transform: scale(1) rotate(var(--rotation)); }
            33% { filter: brightness(1.3) hue-rotate(15deg); transform: scale(1.03) rotate(calc(var(--rotation) + 3deg)); }
            66% { filter: brightness(1.1) hue-rotate(-10deg); transform: scale(1.01) rotate(calc(var(--rotation) - 3deg)); }
        }

        @keyframes gentle-trophy {
            0%, 100% { filter: brightness(1); transform: scale(1) rotate(var(--rotation)); }
            50% { filter: brightness(1.4) drop-shadow(0 0 8px orange); transform: scale(1.04) rotate(calc(var(--rotation) + 4deg)); }
        }

        @keyframes tap-sparkle {
            0% { transform: scale(1) rotate(var(--rotation)); filter: brightness(1); }
            30% { transform: scale(1.4) rotate(calc(var(--rotation) + 15deg)); filter: brightness(2) drop-shadow(0 0 20px gold) saturate(2); }
            60% { transform: scale(1.2) rotate(calc(var(--rotation) + 5deg)); filter: brightness(1.8) drop-shadow(0 0 15px gold); }
            100% { transform: scale(1) rotate(var(--rotation)); filter: brightness(1); }
        }

        @keyframes tap-fire {
            0% { transform: scale(1) rotate(var(--rotation)); filter: brightness(1); }
            25% { transform: scale(1.5) rotate(calc(var(--rotation) + 20deg)); filter: brightness(3) hue-rotate(90deg) saturate(3); }
            50% { transform: scale(1.3) rotate(calc(var(--rotation) - 10deg)); filter: brightness(2.5) hue-rotate(45deg) saturate(2); }
            75% { transform: scale(1.1) rotate(calc(var(--rotation) + 8deg)); filter: brightness(1.8) hue-rotate(20deg); }
            100% { transform: scale(1) rotate(var(--rotation)); filter: brightness(1); }
        }

        @keyframes tap-trophy {
            0% { transform: scale(1) rotate(var(--rotation)); filter: brightness(1); }
            20% { transform: scale(1.6) translateY(-5px) rotate(calc(var(--rotation) + 25deg)); filter: brightness(4) drop-shadow(0 0 25px orange) saturate(3); }
            40% { transform: scale(1.4) translateY(-2px) rotate(calc(var(--rotation) - 15deg)); filter: brightness(3) drop-shadow(0 0 20px gold); }
            60% { transform: scale(1.2) translateY(0px) rotate(calc(var(--rotation) + 10deg)); filter: brightness(2) drop-shadow(0 0 15px orange); }
            80% { transform: scale(1.05) translateY(0px) rotate(calc(var(--rotation) - 3deg)); filter: brightness(1.5); }
            100% { transform: scale(1) translateY(0px) rotate(var(--rotation)); filter: brightness(1); }
        }

        /* ã‚¯ãƒªãƒƒã‚«ãƒ–ãƒ«ãªè¦ç´ ã®åŸºæœ¬ã‚¹ã‚¿ã‚¤ãƒ«ï¼ˆå›è»¢ãªã—ï¼‰ */
        .clickable-element {
            cursor: pointer !important;
            transition: all 0.2s cubic-bezier(0.25, 0.46, 0.45, 0.94) !important;
            position: relative;
            overflow: visible;
        }

        .clickable-element:hover {
            transform: scale(1.05) !important;
            filter: brightness(1.2) !important;
        }

        .clickable-element:active {
            transform: scale(0.95) !important;
        }

        /* å¯æ„›ã„éœ‡ãˆã‚¨ãƒ•ã‚§ã‚¯ãƒˆï¼ˆå›è»¢ãªã—ï¼‰ */
        .cute-shake-effect {
            animation: cute-shake 0.6s ease-in-out !important;
        }

        @keyframes cute-shake {
            0%, 100% { 
                transform: scale(1); 
            }
            10% { 
                transform: scale(1.1); 
            }
            20% { 
                transform: scale(0.95); 
            }
            30% { 
                transform: scale(1.08); 
            }
            40% { 
                transform: scale(0.98); 
            }
            50% { 
                transform: scale(1.05); 
            }
            60% { 
                transform: scale(0.99); 
            }
            70% { 
                transform: scale(1.02); 
            }
            80% { 
                transform: scale(0.995); 
            }
            90% { 
                transform: scale(1.01); 
            }
        }

        /* ã‚²ãƒ¼ãƒ ã‚¿ã‚¤ãƒˆãƒ« */
        .game-title {
            font-family: 'M PLUS Rounded 1c', sans-serif;
            font-weight: 700;
            font-size: clamp(1.4rem, 4vw, 2rem);
            text-align: center;
            letter-spacing: 1px;
            margin-bottom: 1rem;
            cursor: pointer;
            transition: all 0.3s cubic-bezier(0.25, 0.46, 0.45, 0.94);
            user-select: none;
            opacity: 0;
            animation: title-enter 1.5s ease-out 0.2s forwards;
            white-space: normal;
            overflow: visible;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .game-title-text {
            background: linear-gradient(45deg, var(--light-brown), var(--soft-orange), var(--gold));
            background-size: 200% 200%;
            -webkit-background-clip: text;
            background-clip: text;
            -webkit-text-fill-color: transparent;
        }

        @keyframes title-enter {
            0% { 
                opacity: 0; 
                transform: translateY(-30px) scale(0.8); 
            }
            60% { 
                opacity: 1; 
                transform: translateY(5px) scale(1.1); 
            }
            80% { 
                transform: translateY(-2px) scale(1.05); 
            }
            100% { 
                opacity: 1; 
                transform: translateY(0) scale(1); 
            }
        }

        .game-title.title-bounce {
            animation: title-mega-bounce 0.8s cubic-bezier(0.25, 0.46, 0.45, 0.94) !important;
        }

        @keyframes title-mega-bounce {
            0% { transform: scale(1); }
            20% { transform: scale(1.15); }
            40% { transform: scale(0.95); }
            60% { transform: scale(1.1); }
            80% { transform: scale(0.98); }
            100% { transform: scale(1); }
        }

        /* çŒ«ã‚¢ã‚¤ã‚³ãƒ³ */
        .cat-icon {
            color: #8b4513;
            display: inline-block;
            cursor: pointer;
            font-size: clamp(28px, 4vw, 40px);
            margin: 0 8px;
            transition: all 0.1s ease-out;
            --rotation: 0deg;
        }

        .cat-icon:hover {
            transform: scale(1.4) rotate(calc(var(--rotation) + 15deg)) !important;
            filter: drop-shadow(0 0 15px var(--neon-pink)) brightness(1.5) !important;
        }

        .cat-icon.bounce {
            animation: cat-mega-bounce 0.8s ease-in-out !important;
        }

        .cat-icon:not(.bounce) {
            transform: rotate(var(--rotation));
        }

        @keyframes cat-mega-bounce {
            0%, 100% { 
                transform: scale(1) rotate(var(--rotation)); 
            }
            25% { 
                transform: scale(1.6) rotate(calc(var(--rotation) + 20deg)); 
            }
            50% { 
                transform: scale(1.8) rotate(calc(var(--rotation) - 15deg)); 
            }
            75% { 
                transform: scale(1.4) rotate(calc(var(--rotation) + 10deg)); 
            }
        }

        /* å°ã•ãªãƒ•ãƒ­ãƒ¼ãƒ†ã‚£ãƒ³ã‚°ãƒã‚¤ãƒ³ãƒˆè¡¨ç¤º */
        .floating-points {
            position: absolute;
            font-family: 'M PLUS Rounded 1c', sans-serif;
            font-size: 16px;
            font-weight: 700;
            pointer-events: none;
            z-index: 8000;
            text-shadow: 1px 1px 4px rgba(0,0,0,0.3);
            animation: float-points 2s ease-out forwards;
            white-space: nowrap;
        }

        .floating-points.normal {
            color: var(--soft-orange);
        }

        .floating-points.bonus {
            font-size: 18px;
            color: var(--neon-pink);
        }

        .floating-points.mega {
            font-size: 20px;
            color: var(--neon-blue);
        }

        .floating-points.ultra {
            font-size: 22px;
            background: linear-gradient(45deg, var(--neon-pink), var(--neon-blue), var(--neon-green), var(--gold));
            background-size: 200% 200%;
            -webkit-background-clip: text;
            background-clip: text;
            -webkit-text-fill-color: transparent;
        }

        @keyframes float-points {
            0% { opacity: 1; transform: translateY(0) scale(1); }
            100% { opacity: 0; transform: translateY(-60px) scale(1.2); }
        }

        /* å°ã•ãªãƒ‘ãƒ¼ãƒ†ã‚£ã‚¯ãƒ« */
        .cute-particle {
            position: absolute;
            font-size: 14px;
            pointer-events: none;
            z-index: 7000;
            animation: cute-particle-burst 1.5s ease-out forwards;
        }

        @keyframes cute-particle-burst {
            0% { 
                opacity: 1; 
                transform: scale(0) rotate(0deg); 
            }
            20% { 
                opacity: 1; 
                transform: scale(1.2) rotate(180deg); 
            }
            100% { 
                opacity: 0; 
                transform: scale(0.5) rotate(360deg) translateY(-80px); 
            }
        }

        .clean-card {
            background: var(--white);
            border: 2px solid var(--light-brown);
            border-radius: 20px;
            box-shadow: 0 8px 24px var(--shadow);
            position: relative;
            overflow: hidden;
            backdrop-filter: blur(10px);
        }

        .clean-button {
            background: var(--light-brown);
            border: none;
            color: white;
            font-weight: 700;
            border-radius: 25px;
            transition: all 0.3s cubic-bezier(0.25, 0.46, 0.45, 0.94);
            box-shadow: 0 4px 12px var(--shadow);
            font-family: 'M PLUS Rounded 1c', sans-serif;
            cursor: pointer;
            position: relative;
            overflow: hidden;
        }

        .clean-button:hover {
            transform: translateY(-3px);
            box-shadow: 0 8px 20px var(--shadow);
            background: var(--soft-orange);
        }

        .clean-button:active {
            transform: translateY(0);
            box-shadow: 0 4px 12px var(--shadow);
        }

        .clean-button:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none;
        }

        .subject-btn, .category-btn {
            background: var(--white);
            border: 3px solid var(--light-brown);
            border-radius: 15px;
            color: var(--primary-brown);
            transition: all 0.3s cubic-bezier(0.25, 0.46, 0.45, 0.94);
            position: relative;
            overflow: hidden;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            box-shadow: 0 4px 12px var(--shadow);
            font-family: 'M PLUS Rounded 1c', sans-serif;
            font-weight: 700;
            cursor: pointer;
            text-align: center;
        }

        .subject-btn:hover, .category-btn:hover {
            border-color: var(--soft-orange);
            transform: translateY(-4px) scale(1.02);
            box-shadow: 0 12px 28px var(--shadow);
            background: #fff8f0;
        }

        .subject-btn.active, .category-btn.active {
            background: #ffe4cc;
            border-color: var(--soft-orange);
            color: var(--soft-orange);
            transform: translateY(-4px) scale(1.02);
            box-shadow: 0 12px 28px var(--shadow);
        }

        .category-btn {
            padding: 0.5rem 0.75rem !important;
            min-height: 50px !important;
            font-size: 0.85rem !important;
            line-height: 1.2 !important;
        }

        .category-btn:hover {
            transform: translateY(-2px) scale(1.01) !important;
        }

        .category-btn.active {
            transform: translateY(-2px) scale(1.01) !important;
        }

        /* ã‚¢ã‚¤ã‚³ãƒ³éƒ¨åˆ†ã ã‘å›è»¢ã•ã›ã‚‹ */
        .subject-icon, .category-icon {
            display: inline-block;
            transition: transform 0.1s ease-out;
            --rotation: 0deg;
        }

        .subject-icon:not(.animating):not(.bounce), 
        .category-icon:not(.animating):not(.bounce) {
            transform: rotate(var(--rotation)) !important;
        }

        .modal {
            display: none;
            position: fixed;
            inset: 0;
            background: rgba(139,69,19,0.4);
            backdrop-filter: blur(8px);
            align-items: center;
            justify-content: center;
            z-index: 5000;
            padding: 1rem;
        }

        .modal.show {
            display: flex;
            animation: modalFadeIn 0.5s ease-out;
        }

        .modal.unit-modal {
            align-items: flex-start;
            padding: 0.5rem;
            overflow-y: auto;
        }

        @keyframes modalFadeIn {
            from {
                opacity: 0;
                transform: scale(0.9);
            }
            to {
                opacity: 1;
                transform: scale(1);
            }
        }

        .floating-msg {
            position: absolute;
            font-family: 'M PLUS Rounded 1c', sans-serif;
            font-size: 16px;
            font-weight: 700;
            color: var(--primary-brown);
            pointer-events: none;
            z-index: 7500;
            animation: float-up 2s ease-out forwards;
            text-shadow: 1px 1px 4px rgba(255,255,255,0.8);
            white-space: nowrap;
        }

        @keyframes float-up {
            0% { opacity: 1; transform: translateY(0) scale(1); }
            100% { opacity: 0; transform: translateY(-60px) scale(1.2); }
        }

        .quiz-option {
            background: var(--white);
            border: 3px solid var(--light-brown);
            color: var(--primary-brown);
            border-radius: 15px;
            padding: 0.75rem 1rem;
            transition: all 0.3s cubic-bezier(0.25, 0.46, 0.45, 0.94);
            font-weight: 700;
            font-size: 0.9rem;
            position: relative;
            box-shadow: 0 4px 12px var(--shadow);
            font-family: 'M PLUS Rounded 1c', sans-serif;
            cursor: pointer;
        }

        .quiz-option:hover {
            border-color: var(--soft-orange);
            transform: translateY(-2px);
            box-shadow: 0 8px 20px var(--shadow);
            background: #fff8f0;
        }

        .quiz-explanation {
            height: 150px;
            background: #fff8f0;
            border-radius: 15px;
            padding: 0.75rem;
            margin-top: 1rem;
            border: 3px solid var(--light-brown);
            display: flex;
            align-items: flex-start;
            justify-content: center;
            text-align: center;
            overflow-y: auto;
            box-sizing: border-box;
            font-size: 1rem;
            line-height: 1.4;
            font-family: 'M PLUS Rounded 1c', sans-serif;
            font-weight: 700;
        }

        .quiz-explanation p {
            margin: 0;
            padding: 0;
            word-wrap: break-word;
            max-height: 100%;
            overflow: hidden;
            font-size: 1rem;
        }

        .quiz-explanation.has-content {
            border-color: var(--soft-orange);
            background: #ffe4cc;
        }

        .back-button {
            background: #f8f4f0;
            border: 2px solid var(--light-brown);
            color: var(--primary-brown);
            border-radius: 15px;
            padding: 0.5rem 1rem;
            font-weight: 700;
            transition: all 0.3s cubic-bezier(0.25, 0.46, 0.45, 0.94);
            font-size: 0.9rem;
            font-family: 'M PLUS Rounded 1c', sans-serif;
            cursor: pointer;
        }

        .back-button:hover {
            background: #fff8f0;
            transform: translateY(-2px);
            box-shadow: 0 6px 16px var(--shadow);
        }

        .mode-btn {
            background: var(--white);
            border: 3px solid var(--light-brown);
            border-radius: 12px;
            color: var(--primary-brown);
            transition: all 0.3s cubic-bezier(0.25, 0.46, 0.45, 0.94);
            padding: 0.5rem;
            font-size: 0.8rem;
            font-weight: 700;
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: 0 3px 8px var(--shadow);
            font-family: 'M PLUS Rounded 1c', sans-serif;
            cursor: pointer;
        }

        .mode-btn:hover {
            border-color: var(--soft-orange);
            transform: translateY(-2px);
            box-shadow: 0 6px 16px var(--shadow);
            background: #fff8f0;
        }

        .mode-btn.active {
            background: #ffe4cc;
            border-color: var(--soft-orange);
            color: var(--soft-orange);
            transform: translateY(-2px);
            box-shadow: 0 6px 16px var(--shadow);
        }

        /* ãƒ¢ãƒ¼ãƒ‰ã‚¢ã‚¤ã‚³ãƒ³ã‚‚å›è»¢ */
        .mode-icon {
            display: inline-block;
            margin-right: 4px;
            transition: transform 0.1s ease-out;
            --rotation: 0deg;
        }

        .mode-icon:not(.animating):not(.bounce) {
            transform: rotate(var(--rotation)) !important;
        }

        .stats-display {
            background: #fff8f0;
            border: 2px solid var(--light-brown);
            border-radius: 20px;
            padding: 1rem;
            text-align: center;
            box-shadow: 0 4px 12px var(--shadow);
        }

        .floating-button {
            position: fixed !important;
            bottom: 20px !important;
            left: 20px !important;
            right: auto !important;
            margin: 0 !important;
            transform: none !important;
            width: 56px;
            height: 56px;
            background: var(--light-brown);
            border: none;
            border-radius: 50%;
            color: white;
            font-size: 24px;
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: 0 6px 20px var(--shadow);
            transition: all 0.3s cubic-bezier(0.25, 0.46, 0.45, 0.94);
            z-index: 9998;
            cursor: pointer;
        }

        .floating-button.hidden {
            display: none !important;
        }

        .floating-button:hover {
            transform: translateY(-3px) !important;
            box-shadow: 0 8px 24px var(--shadow);
            background: var(--soft-orange);
        }

        /* ãƒ•ãƒ­ãƒ¼ãƒ†ã‚£ãƒ³ã‚°ãƒœã‚¿ãƒ³ã®ã‚¢ã‚¤ã‚³ãƒ³ã‚‚å›è»¢ */
        .floating-button-icon {
            display: inline-block;
            transition: transform 0.1s ease-out;
            --rotation: 0deg;
        }

        .floating-button-icon:not(.animating):not(.bounce) {
            transform: rotate(var(--rotation)) !important;
        }

        .notification {
            position: fixed;
            top: 20px;
            right: 20px;
            background: var(--white);
            color: var(--primary-brown);
            padding: 12px 16px;
            border-radius: 20px;
            border: 2px solid var(--light-brown);
            transform: translateX(400px);
            transition: transform 0.3s ease;
            z-index: 9001;
            box-shadow: 0 6px 20px var(--shadow);
            font-family: 'M PLUS Rounded 1c', sans-serif;
            font-weight: 700;
        }

        .notification.show {
            transform: translateX(0);
        }

        .subject-grid {
            grid-template-columns: repeat(3, 1fr);
            gap: 0.75rem;
        }

        .category-grid {
            grid-template-columns: repeat(auto-fit, minmax(160px, 1fr)) !important;
            gap: 0.4rem !important;
        }

        .section-divider {
            height: 2px;
            background: var(--light-brown);
            margin: 1rem 0;
            border-radius: 1px;
        }

        .grade-label {
            font-size: 0.7rem !important;
            font-weight: 700;
            color: var(--light-brown);
            text-align: center;
            margin: 0.5rem 0 0.3rem 0 !important;
            text-transform: uppercase;
            letter-spacing: 0.05em;
        }

        .score-pulse {
            animation: score-pulse 0.6s ease-in-out;
        }

        @keyframes score-pulse {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.2); filter: brightness(1.3); }
        }

        .tap-effect {
            position: relative;
            overflow: visible;
        }

        .tap-effect::after {
            content: '';
            position: absolute;
            top: 50%;
            left: 50%;
            width: 0;
            height: 0;
            background: var(--gold);
            border-radius: 50%;
            transform: translate(-50%, -50%);
            opacity: 0;
            pointer-events: none;
            z-index: 6000;
        }

        .tap-effect.tapped::after {
            animation: tap-ripple 0.6s ease-out;
        }

        @keyframes tap-ripple {
            0% {
                width: 0;
                height: 0;
                opacity: 0.8;
            }
            100% {
                width: 200px;
                height: 200px;
                opacity: 0;
            }
        }

        .subject-modal-content {
            max-height: 85vh;
            overflow-y: auto;
            padding-top: 0;
        }
        
        .modal .clean-card {
            margin: 2rem 1rem 1rem 1rem;
            max-height: 85vh;
            overflow-y: auto;
        }

        /* ä¿®æ­£â‘ : ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«å•é¡Œè§£æ±º - æˆ»ã‚‹ãƒœã‚¿ãƒ³ãŒè¦‹ãˆã‚‹ã‚ˆã†ä¸‹ã®ä½™ç™½ã‚’è¿½åŠ  */
        .modal.unit-modal .clean-card {
            margin: 0.25rem 1rem 8rem 1rem; /* ä¸‹ã®ä½™ç™½ã‚’8remã«å¢—åŠ  */
            max-height: 94vh;
            overflow-y: auto;
            padding: 1rem 1rem 3rem 1rem; /* ä¸‹ã®paddingã‚‚3remã«å¢—åŠ  */
        }

        /* é‡åŠ›æ„ŸçŸ¥ã®ãŸã‚ã®æ¨©é™è¦æ±‚ãƒãƒƒãƒ—ã‚¢ãƒƒãƒ— */
        .permission-popup {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%) scale(0.8);
            background: rgba(255,255,255,0.95);
            backdrop-filter: blur(20px);
            padding: 25px;
            border-radius: 20px;
            box-shadow: 0 20px 60px rgba(139,69,19,0.25);
            z-index: 10000;
            font-family: 'M PLUS Rounded 1c', sans-serif;
            text-align: center;
            max-width: 320px;
            line-height: 1.6;
            border: 1px solid rgba(255,255,255,0.3);
            opacity: 0;
            display: none;
        }

        .permission-popup.show {
            display: block;
            animation: popup-enter 0.8s ease-out forwards;
        }

        @keyframes popup-enter {
            0% { 
                opacity: 0; 
                transform: translate(-50%, -50%) scale(0.8) rotate(-5deg); 
            }
            60% { 
                opacity: 1; 
                transform: translate(-50%, -50%) scale(1.05) rotate(2deg); 
            }
            80% { 
                transform: translate(-50%, -50%) scale(0.98) rotate(-1deg); 
            }
            100% { 
                opacity: 1; 
                transform: translate(-50%, -50%) scale(1) rotate(0deg); 
            }
        }

        .permission-popup h3 {
            font-size: 20px;
            margin-bottom: 12px;
            color: #8b4513;
        }

        .permission-popup p {
            font-size: 15px;
            margin-bottom: 20px;
            color: #a0522d;
        }

        .permission-popup button {
            background: linear-gradient(145deg, #d2691e, #ff7f50);
            color: white;
            border: none;
            padding: 12px 20px;
            border-radius: 25px;
            font-size: 15px;
            font-weight: 700;
            cursor: pointer;
            margin: 8px 6px;
            width: 120px;
            transition: all 0.3s ease;
            box-shadow: 0 6px 20px rgba(210,105,30,0.3);
        }

        .permission-popup button:hover {
            background: linear-gradient(145deg, #ff7f50, #ff6347);
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(210,105,30,0.4);
        }

        @media (max-width: 640px) {
            .container-spacing {
                max-width: 95%;
                margin-bottom: 2rem;
            }

            .horizontal-points-display {
                bottom: 15px !important;
                gap: 8px;
                padding: 6px 20px;
            }

            .point-bubble {
                font-size: 14px;
                padding: 4px 6px;
                gap: 4px;
            }

            .modal .clean-card {
                margin: 1.5rem 0.25rem 0.25rem 0.25rem;
                padding: 0.75rem;
                max-height: 92vh;
            }

            /* ä¿®æ­£â‘ : ã‚¹ãƒãƒ›ã§ã‚‚ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«å•é¡Œè§£æ±º */
            .modal.unit-modal .clean-card {
                margin: 0.1rem 0.25rem 8rem 0.25rem !important; /* ä¸‹ã®ä½™ç™½ã‚’8remã«å¢—åŠ  */
                padding: 0.6rem 0.75rem 4rem 0.75rem !important; /* ä¸‹ã®paddingã‚‚4remã«å¢—åŠ  */
                max-height: 98vh !important;
            }

            .floating-button {
                bottom: 20px !important;
                left: 20px !important;
                right: auto !important;
                width: 52px;
                height: 52px;
                font-size: 20px;
            }

            .clean-card {
                margin: 0.5rem;
                padding: 1rem;
            }

            .clean-card:last-of-type {
                margin-bottom: 6rem;
            }

            body {
                padding-bottom: 7rem;
            }

            .game-title {
                font-size: clamp(1.2rem, 4.5vw, 1.6rem);
                letter-spacing: 1px;
            }
            
            .cat-icon {
                font-size: clamp(24px, 4.5vw, 32px);
                margin: 0 4px;
            }

            .subject-grid {
                grid-template-columns: repeat(3, 1fr);
                gap: 0.5rem;
            }

            .category-grid {
                grid-template-columns: 1fr !important;
                gap: 0.3rem !important;
            }

            .subject-btn, .category-btn {
                padding: 0.75rem 0.5rem;
                min-height: 70px;
                font-size: 0.8rem;
            }

            .category-btn {
                padding: 0.4rem 0.5rem !important;
                min-height: 45px !important;
                font-size: 0.8rem !important;
                line-height: 1.1 !important;
            }

            .quiz-option {
                padding: 0.5rem 0.75rem;
                font-size: 0.85rem;
            }

            #quizQ {
                font-size: 0.9rem;
                line-height: 1.3;
            }

            .quiz-explanation {
                height: 120px;
                padding: 0.5rem;
                font-size: 0.9rem;
                line-height: 1.3;
            }

            .quiz-explanation p {
                font-size: 0.9rem;
            }

            .grade-label {
                margin: 0.4rem 0 0.25rem 0 !important;
            }

            .floating-points {
                font-size: 14px;
            }

            .floating-points.bonus {
                font-size: 16px;
            }

            .floating-points.mega {
                font-size: 18px;
            }

            .floating-points.ultra {
                font-size: 20px;
            }
        }

        @media (max-width: 380px) {
            .game-title {
                font-size: clamp(1rem, 5vw, 1.4rem);
                letter-spacing: 0px;
            }
            
            .cat-icon {
                font-size: clamp(20px, 5vw, 28px);
                margin: 0 2px;
            }

            .horizontal-points-display {
                bottom: 10px !important;
                gap: 6px;
                padding: 4px 16px;
            }

            .point-bubble {
                font-size: 12px;
                padding: 3px 5px;
                gap: 3px;
            }
        }

        button, .subject-btn, .category-btn, .quiz-option, .clean-button, .back-button, .mode-btn {
            -webkit-touch-callout: none;
            -webkit-user-select: none;
            -webkit-tap-highlight-color: transparent;
            user-select: none;
            touch-action: manipulation;
            -webkit-appearance: none;
        }

        * {
            touch-action: manipulation;
        }

        input, select, textarea {
            font-size: 16px;
        }
    </style>
</head>
<body class="min-h-screen flex flex-col items-center pt-6 pb-12 gap-6 relative">
    <!-- æ¨ªä¸¦ã³ãƒã‚¤ãƒ³ãƒˆè¡¨ç¤ºï¼ˆç”»é¢ä¸‹éƒ¨ä¸­å¤®ï¼‰ -->
    <div class="horizontal-points-display">
        <div class="point-bubble clickable-element" id="sparklePointBubble">
            <span class="rotating-icon">âœ¨</span> <span id="sparklePointsMain">0</span>
        </div>
        <div class="point-bubble clickable-element" id="firePointBubble">
            <span class="rotating-icon">ğŸ”¥</span> <span id="firePointsMain">0</span>
        </div>
        <div class="point-bubble clickable-element" id="trophyPointBubble">
            <span class="rotating-icon">ğŸ†</span> <span id="trophyPointsMain">0</span>
        </div>
    </div>

    <!-- ãƒ¡ã‚¤ãƒ³ã®æ•™ç§‘é¸æŠãƒ¢ãƒ¼ãƒ€ãƒ« -->
    <div id="mainSubjectModal" class="modal show">
        <div class="clean-card p-6 container-spacing subject-modal-content">
            <div class="text-center mb-6">
                <h1 class="game-title clickable-element" id="gameTitle">
                    <span class="cat-icon clickable-element" id="leftCat">ğŸ±</span>
                    <span class="game-title-text">NEKOPON Quiz</span>
                    <span class="cat-icon clickable-element" id="rightCat">ğŸ±</span>
                </h1>
                <h2 class="text-lg font-semibold mb-3 text-gray-700 clickable-element">
                    <span class="rotating-icon">ğŸ“š</span> æ•™ç§‘ã‚’é¸ã¶ã«ã‚ƒã€œâ™ª
                </h2>
                <p class="text-gray-600 text-sm clickable-element">å­¦ç¿’ã—ãŸã„æ•™ç§‘ã‚’é¸ã‚“ã§ã»ã—ã„ã«ã‚ƒã‚“â™ª<br>ã©ã“ã§ã‚‚ã‚¯ãƒªãƒƒã‚¯ã§ãƒã‚¤ãƒ³ãƒˆã‚²ãƒƒãƒˆã«ã‚ƒã€œ<span class="rotating-icon">âœ¨</span></p>
            </div>
            <div class="grid subject-grid mb-6">
                <button class="subject-btn tap-effect clickable-element" data-subject="social">
                    <div class="subject-icon text-2xl mb-1">ğŸŒ</div>
                    <div class="subject-name font-semibold text-sm">ç¤¾ä¼š</div>
                </button>
                <button class="subject-btn tap-effect clickable-element" data-subject="science">
                    <div class="subject-icon text-2xl mb-1">ğŸ”¬</div>
                    <div class="subject-name font-semibold text-sm">ç†ç§‘</div>
                </button>
                <button class="subject-btn tap-effect clickable-element" data-subject="english">
                    <div class="subject-icon text-2xl mb-1">ğŸ“–</div>
                    <div class="subject-name font-semibold text-sm">è‹±èª</div>
                </button>
            </div>
        </div>
    </div>

    <!-- ç¤¾ä¼šãƒ¢ãƒ¼ãƒ€ãƒ« -->
    <div id="socialModal" class="modal">
        <div class="clean-card p-6 container-spacing subject-modal-content">
            <div class="text-center mb-6">
                <h2 class="text-lg font-semibold mb-3 text-gray-700 clickable-element">
                    <span class="rotating-icon">ğŸŒ</span> ç¤¾ä¼š
                </h2>
                <p class="text-gray-600 text-sm clickable-element">åˆ†é‡ã‚’é¸ã‚“ã§ã»ã—ã„ã«ã‚ƒã‚“â™ª</p>
            </div>
            <div class="grid subject-grid mb-6">
                <button class="subject-btn tap-effect clickable-element" data-category="geography">
                    <div class="subject-icon text-2xl mb-1">ğŸ—ºï¸</div>
                    <div class="subject-name font-semibold text-sm">åœ°ç†</div>
                </button>
                <button class="subject-btn tap-effect clickable-element" data-category="history">
                    <div class="subject-icon text-2xl mb-1">ğŸ›ï¸</div>
                    <div class="subject-name font-semibold text-sm">æ­´å²</div>
                </button>
                <button class="subject-btn tap-effect clickable-element" data-category="civics">
                    <div class="subject-icon text-2xl mb-1">âš–ï¸</div>
                    <div class="subject-name font-semibold text-sm">å…¬æ°‘</div>
                </button>
            </div>
            <div class="text-center">
                <button class="back-button tap-effect clickable-element" onclick="goBackToMain()">
                    â† æ•™ç§‘é¸æŠã«æˆ»ã‚‹ã«ã‚ƒã€œ
                </button>
            </div>
        </div>
    </div>

    <!-- ç†ç§‘ãƒ¢ãƒ¼ãƒ€ãƒ« -->
    <div id="scienceModal" class="modal">
        <div class="clean-card p-6 container-spacing subject-modal-content">
            <div class="text-center mb-6">
                <h2 class="text-lg font-semibold mb-3 text-gray-700 clickable-element">
                    <span class="rotating-icon">ğŸ”¬</span> ç†ç§‘
                </h2>
                <p class="text-gray-600 text-sm clickable-element">åˆ†é‡ã‚’é¸ã‚“ã§ã»ã—ã„ã«ã‚ƒã‚“â™ª</p>
            </div>
            <div class="grid subject-grid mb-6">
                <button class="subject-btn tap-effect clickable-element" data-category="chemistry">
                    <div class="subject-icon text-2xl mb-1">ğŸ§ª</div>
                    <div class="subject-name font-semibold text-sm">åŒ–å­¦</div>
                </button>
                <button class="subject-btn tap-effect clickable-element" data-category="biology">
                    <div class="subject-icon text-2xl mb-1">ğŸ§¬</div>
                    <div class="subject-name font-semibold text-sm">ç”Ÿç‰©</div>
                </button>
                <button class="subject-btn tap-effect clickable-element" data-category="physics">
                    <div class="subject-icon text-2xl mb-1">âš›ï¸</div>
                    <div class="subject-name font-semibold text-sm">ç‰©ç†</div>
                </button>
                <button class="subject-btn tap-effect clickable-element" data-category="earth">
                    <div class="subject-icon text-2xl mb-1">ğŸŒ</div>
                    <div class="subject-name font-semibold text-sm">åœ°å­¦</div>
                </button>
            </div>
            <div class="text-center">
                <button class="back-button tap-effect clickable-element" onclick="goBackToMain()">
                    â† æ•™ç§‘é¸æŠã«æˆ»ã‚‹ã«ã‚ƒã€œ
                </button>
            </div>
        </div>
    </div>

    <!-- è‹±èªãƒ¢ãƒ¼ãƒ€ãƒ« -->
    <div id="englishModal" class="modal">
        <div class="clean-card p-6 container-spacing subject-modal-content">
            <div class="text-center mb-6">
                <h2 class="text-lg font-semibold mb-3 text-gray-700 clickable-element">
                    <span class="rotating-icon">ğŸ“–</span> è‹±èª
                </h2>
                <p class="text-gray-600 text-sm clickable-element">åˆ†é‡ã‚’é¸ã‚“ã§ã»ã—ã„ã«ã‚ƒã‚“â™ª</p>
            </div>
            <div class="grid subject-grid mb-6">
                <button class="subject-btn tap-effect clickable-element" data-category="english_words">
                    <div class="subject-icon text-2xl mb-1">ğŸ“</div>
                    <div class="subject-name font-semibold text-sm">è‹±å˜èª</div>
                </button>
                <button class="subject-btn tap-effect clickable-element" data-category="english_phrases">
                    <div class="subject-icon text-2xl mb-1">ğŸ’¬</div>
                    <div class="subject-name font-semibold text-sm">è‹±ç†Ÿèª</div>
                </button>
                <button class="subject-btn tap-effect clickable-element" data-category="english_grammar">
                    <div class="subject-icon text-2xl mb-1">ğŸ“˜</div>
                    <div class="subject-name font-semibold text-sm">èªå½¢å¤‰åŒ–</div>
                </button>
            </div>
            <div class="text-center">
                <button class="back-button tap-effect clickable-element" onclick="goBackToMain()">
                    â† æ•™ç§‘é¸æŠã«æˆ»ã‚‹ã«ã‚ƒã€œ
                </button>
            </div>
        </div>
    </div>

    <!-- åœ°ç†ã®å˜å…ƒé¸æŠãƒ¢ãƒ¼ãƒ€ãƒ« -->
    <div id="geographyModal" class="modal unit-modal">
        <div class="clean-card p-6 container-spacing subject-modal-content">
            <div class="text-center mb-4">
                <h2 class="text-lg font-semibold mb-3 text-gray-700 clickable-element">
                    <span class="rotating-icon">ğŸ—ºï¸</span> åœ°ç†
                </h2>
                <p class="text-gray-600 text-sm clickable-element">å­¦ç¿’ã™ã‚‹å˜å…ƒã‚’é¸ã‚“ã§ã»ã—ã„ã«ã‚ƒã‚“â™ª<br>è¤‡æ•°é¸æŠã‚‚ã§ãã‚‹ã«ã‚ƒã€œâ™ª</p>
            </div>
            <div class="grid category-grid mb-4" id="geographyCategories"></div>
            <div class="text-center space-y-2">
                <button id="startGeographyQuiz" class="clean-button px-6 py-2 text-sm tap-effect clickable-element" disabled>
                    æ±ºå®šã™ã‚‹ã«ã‚ƒã€œâ™ª
                </button>
                <br>
                <button class="back-button tap-effect clickable-element" onclick="goBackToSocial()">
                    â† ç¤¾ä¼šã«æˆ»ã‚‹ã«ã‚ƒã€œ
                </button>
            </div>
        </div>
    </div>

    <!-- æ­´å²ã®å˜å…ƒé¸æŠãƒ¢ãƒ¼ãƒ€ãƒ« -->
    <div id="historyModal" class="modal unit-modal">
        <div class="clean-card p-6 container-spacing subject-modal-content">
            <div class="text-center mb-4">
                <h2 class="text-lg font-semibold mb-3 text-gray-700 clickable-element">
                    <span class="rotating-icon">ğŸ›ï¸</span> æ­´å²
                </h2>
                <p class="text-gray-600 text-sm clickable-element">å­¦ç¿’ã™ã‚‹å˜å…ƒã‚’é¸ã‚“ã§ã»ã—ã„ã«ã‚ƒã‚“â™ª<br>è¤‡æ•°é¸æŠã‚‚ã§ãã‚‹ã«ã‚ƒã€œâ™ª</p>
            </div>
            <div class="grid category-grid mb-4" id="historyCategories"></div>
            <div class="text-center space-y-2">
                <button id="startHistoryQuiz" class="clean-button px-6 py-2 text-sm tap-effect clickable-element" disabled>
                    æ±ºå®šã™ã‚‹ã«ã‚ƒã€œâ™ª
                </button>
                <br>
                <button class="back-button tap-effect clickable-element" onclick="goBackToSocial()">
                    â† ç¤¾ä¼šã«æˆ»ã‚‹ã«ã‚ƒã€œ
                </button>
            </div>
        </div>
    </div>

    <!-- å…¬æ°‘ã®å˜å…ƒé¸æŠãƒ¢ãƒ¼ãƒ€ãƒ« -->
    <div id="civicsModal" class="modal unit-modal">
        <div class="clean-card p-6 container-spacing subject-modal-content">
            <div class="text-center mb-4">
                <h2 class="text-lg font-semibold mb-3 text-gray-700 clickable-element">
                    <span class="rotating-icon">âš–ï¸</span> å…¬æ°‘
                </h2>
                <p class="text-gray-600 text-sm clickable-element">å­¦ç¿’ã™ã‚‹å˜å…ƒã‚’é¸ã‚“ã§ã»ã—ã„ã«ã‚ƒã‚“â™ª<br>è¤‡æ•°é¸æŠã‚‚ã§ãã‚‹ã«ã‚ƒã€œâ™ª</p>
            </div>
            <div class="grid category-grid mb-4" id="civicsCategories"></div>
            <div class="text-center space-y-2">
                <button id="startCivicsQuiz" class="clean-button px-6 py-2 text-sm tap-effect clickable-element" disabled>
                    æ±ºå®šã™ã‚‹ã«ã‚ƒã€œâ™ª
                </button>
                <br>
                <button class="back-button tap-effect clickable-element" onclick="goBackToSocial()">
                    â† ç¤¾ä¼šã«æˆ»ã‚‹ã«ã‚ƒã€œ
                </button>
            </div>
        </div>
    </div>

    <!-- åŒ–å­¦ã®å˜å…ƒé¸æŠãƒ¢ãƒ¼ãƒ€ãƒ« -->
    <div id="chemistryModal" class="modal unit-modal">
        <div class="clean-card p-6 container-spacing subject-modal-content">
            <div class="text-center mb-4">
                <h2 class="text-lg font-semibold mb-3 text-gray-700 clickable-element">
                    <span class="rotating-icon">ğŸ§ª</span> åŒ–å­¦
                </h2>
                <p class="text-gray-600 text-sm clickable-element">å­¦ç¿’ã™ã‚‹å˜å…ƒã‚’é¸ã‚“ã§ã»ã—ã„ã«ã‚ƒã‚“â™ª<br>è¤‡æ•°é¸æŠã‚‚ã§ãã‚‹ã«ã‚ƒã€œâ™ª</p>
            </div>
            <div class="grid category-grid mb-4" id="chemistryCategories"></div>
            <div class="text-center space-y-2">
                <button id="startChemistryQuiz" class="clean-button px-6 py-2 text-sm tap-effect clickable-element" disabled>
                    æ±ºå®šã™ã‚‹ã«ã‚ƒã€œâ™ª
                </button>
                <br>
                <button class="back-button tap-effect clickable-element" onclick="goBackToScience()">
                    â† ç†ç§‘ã«æˆ»ã‚‹ã«ã‚ƒã€œ
                </button>
            </div>
        </div>
    </div>

    <!-- ç”Ÿç‰©ã®å˜å…ƒé¸æŠãƒ¢ãƒ¼ãƒ€ãƒ« -->
    <div id="biologyModal" class="modal unit-modal">
        <div class="clean-card p-6 container-spacing subject-modal-content">
            <div class="text-center mb-4">
                <h2 class="text-lg font-semibold mb-3 text-gray-700 clickable-element">
                    <span class="rotating-icon">ğŸ§¬</span> ç”Ÿç‰©
                </h2>
                <p class="text-gray-600 text-sm clickable-element">å­¦ç¿’ã™ã‚‹å˜å…ƒã‚’é¸ã‚“ã§ã»ã—ã„ã«ã‚ƒã‚“â™ª<br>è¤‡æ•°é¸æŠã‚‚ã§ãã‚‹ã«ã‚ƒã€œâ™ª</p>
            </div>
            <div class="grid category-grid mb-4" id="biologyCategories"></div>
            <div class="text-center space-y-2">
                <button id="startBiologyQuiz" class="clean-button px-6 py-2 text-sm tap-effect clickable-element" disabled>
                    æ±ºå®šã™ã‚‹ã«ã‚ƒã€œâ™ª
                </button>
                <br>
                <button class="back-button tap-effect clickable-element" onclick="goBackToScience()">
                    â† ç†ç§‘ã«æˆ»ã‚‹ã«ã‚ƒã€œ
                </button>
            </div>
        </div>
    </div>

    <!-- ç‰©ç†ã®å˜å…ƒé¸æŠãƒ¢ãƒ¼ãƒ€ãƒ« -->
    <div id="physicsModal" class="modal unit-modal">
        <div class="clean-card p-6 container-spacing subject-modal-content">
            <div class="text-center mb-4">
                <h2 class="text-lg font-semibold mb-3 text-gray-700 clickable-element">
                    <span class="rotating-icon">âš›ï¸</span> ç‰©ç†
                </h2>
                <p class="text-gray-600 text-sm clickable-element">å­¦ç¿’ã™ã‚‹å˜å…ƒã‚’é¸ã‚“ã§ã»ã—ã„ã«ã‚ƒã‚“â™ª<br>è¤‡æ•°é¸æŠã‚‚ã§ãã‚‹ã«ã‚ƒã€œâ™ª</p>
            </div>
            <div class="grid category-grid mb-4" id="physicsCategories"></div>
            <div class="text-center space-y-2">
                <button id="startPhysicsQuiz" class="clean-button px-6 py-2 text-sm tap-effect clickable-element" disabled>
                    æ±ºå®šã™ã‚‹ã«ã‚ƒã€œâ™ª
                </button>
                <br>
                <button class="back-button tap-effect clickable-element" onclick="goBackToScience()">
                    â† ç†ç§‘ã«æˆ»ã‚‹ã«ã‚ƒã€œ
                </button>
            </div>
        </div>
    </div>

    <!-- åœ°å­¦ã®å˜å…ƒé¸æŠãƒ¢ãƒ¼ãƒ€ãƒ« -->
    <div id="earthModal" class="modal unit-modal">
        <div class="clean-card p-6 container-spacing subject-modal-content">
            <div class="text-center mb-4">
                <h2 class="text-lg font-semibold mb-3 text-gray-700 clickable-element">
                    <span class="rotating-icon">ğŸŒ</span> åœ°å­¦
                </h2>
                <p class="text-gray-600 text-sm clickable-element">å­¦ç¿’ã™ã‚‹å˜å…ƒã‚’é¸ã‚“ã§ã»ã—ã„ã«ã‚ƒã‚“â™ª<br>è¤‡æ•°é¸æŠã‚‚ã§ãã‚‹ã«ã‚ƒã€œâ™ª</p>
            </div>
            <div class="grid category-grid mb-4" id="earthCategories"></div>
            <div class="text-center space-y-2">
                <button id="startEarthQuiz" class="clean-button px-6 py-2 text-sm tap-effect clickable-element" disabled>
                    æ±ºå®šã™ã‚‹ã«ã‚ƒã€œâ™ª
                </button>
                <br>
                <button class="back-button tap-effect clickable-element" onclick="goBackToScience()">
                    â† ç†ç§‘ã«æˆ»ã‚‹ã«ã‚ƒã€œ
                </button>
            </div>
        </div>
    </div>

    <!-- è‹±å˜èªã®å˜å…ƒé¸æŠãƒ¢ãƒ¼ãƒ€ãƒ« -->
    <div id="englishWordsModal" class="modal unit-modal">
        <div class="clean-card p-6 container-spacing subject-modal-content">
            <div class="text-center mb-4">
                <h2 class="text-lg font-semibold mb-3 text-gray-700 clickable-element">
                    <span class="rotating-icon">ğŸ“</span> è‹±å˜èª
                </h2>
                <p class="text-gray-600 text-sm clickable-element">å­¦ç¿’ã™ã‚‹å˜å…ƒã‚’é¸ã‚“ã§ã»ã—ã„ã«ã‚ƒã‚“â™ª<br>è¤‡æ•°é¸æŠã‚‚ã§ãã‚‹ã«ã‚ƒã€œâ™ª</p>
            </div>
            <div class="grid category-grid mb-4" id="englishWordsCategories"></div>
            <div class="text-center space-y-2">
                <button id="startEnglishWordsQuiz" class="clean-button px-6 py-2 text-sm tap-effect clickable-element" disabled>
                    æ±ºå®šã™ã‚‹ã«ã‚ƒã€œâ™ª
                </button>
                <br>
                <button class="back-button tap-effect clickable-element" onclick="goBackToEnglish()">
                    â† è‹±èªã«æˆ»ã‚‹ã«ã‚ƒã€œ
                </button>
            </div>
        </div>
    </div>

    <!-- è‹±ç†Ÿèªã®å˜å…ƒé¸æŠãƒ¢ãƒ¼ãƒ€ãƒ« -->
    <div id="englishPhrasesModal" class="modal unit-modal">
        <div class="clean-card p-6 container-spacing subject-modal-content">
            <div class="text-center mb-4">
                <h2 class="text-lg font-semibold mb-3 text-gray-700 clickable-element">
                    <span class="rotating-icon">ğŸ’¬</span> è‹±ç†Ÿèª
                </h2>
                <p class="text-gray-600 text-sm clickable-element">å­¦ç¿’ã™ã‚‹å˜å…ƒã‚’é¸ã‚“ã§ã»ã—ã„ã«ã‚ƒã‚“â™ª<br>è¤‡æ•°é¸æŠã‚‚ã§ãã‚‹ã«ã‚ƒã€œâ™ª</p>
            </div>
            <div class="grid category-grid mb-4" id="englishPhrasesCategories"></div>
            <div class="text-center space-y-2">
                <button id="startEnglishPhrasesQuiz" class="clean-button px-6 py-2 text-sm tap-effect clickable-element" disabled>
                    æ±ºå®šã™ã‚‹ã«ã‚ƒã€œâ™ª
                </button>
                <br>
                <button class="back-button tap-effect clickable-element" onclick="goBackToEnglish()">
                    â† è‹±èªã«æˆ»ã‚‹ã«ã‚ƒã€œ
                </button>
            </div>
        </div>
    </div>

    <!-- èªå½¢å¤‰åŒ–ã®å˜å…ƒé¸æŠãƒ¢ãƒ¼ãƒ€ãƒ« -->
    <div id="englishGrammarModal" class="modal unit-modal">
        <div class="clean-card p-6 container-spacing subject-modal-content">
            <div class="text-center mb-4">
                <h2 class="text-lg font-semibold mb-3 text-gray-700 clickable-element">
                    <span class="rotating-icon">ğŸ“˜</span> èªå½¢å¤‰åŒ–
                </h2>
                <p class="text-gray-600 text-sm clickable-element">å­¦ç¿’ã™ã‚‹å˜å…ƒã‚’é¸ã‚“ã§ã»ã—ã„ã«ã‚ƒã‚“â™ª<br>è¤‡æ•°é¸æŠã‚‚ã§ãã‚‹ã«ã‚ƒã€œâ™ª</p>
            </div>
            <div class="grid category-grid mb-4" id="englishGrammarCategories"></div>
            <div class="text-center space-y-2">
                <button id="startEnglishGrammarQuiz" class="clean-button px-6 py-2 text-sm tap-effect clickable-element" disabled>
                    æ±ºå®šã™ã‚‹ã«ã‚ƒã€œâ™ª
                </button>
                <br>
                <button class="back-button tap-effect clickable-element" onclick="goBackToEnglish()">
                    â† è‹±èªã«æˆ»ã‚‹ã«ã‚ƒã€œ
                </button>
            </div>
        </div>
    </div>

    <!-- ã‚²ãƒ¼ãƒ ç”»é¢ -->
    <div id="gameScreen" class="hidden">
        <div class="clean-card p-6 text-center container-spacing mb-6">
            <h1 class="game-title clickable-element">
                <span class="cat-icon clickable-element" id="gameLeftCat">ğŸ±</span>
                <span class="game-title-text">NEKOPON Quiz</span>
                <span class="cat-icon clickable-element" id="gameRightCat">ğŸ±</span>
            </h1>
            <div id="currentCategory" class="text-lg font-semibold text-gray-700 mb-4 clickable-element"></div>
            <div class="stats-display clickable-element">
                <div class="grid grid-cols-3 gap-4 text-center mb-4">
                    <div class="clickable-element">
                        <div class="text-xl font-bold text-gray-800 clickable-element" id="correctCount">0</div>
                        <div class="text-xs text-gray-600 clickable-element">æ­£è§£æ•°ã ã«ã‚ƒâ™ª</div>
                    </div>
                    <div class="clickable-element">
                        <div class="text-xl font-bold text-gray-800 clickable-element" id="wrongCount">0</div>
                        <div class="text-xs text-gray-600 clickable-element">ä¸æ­£è§£æ•°ã ã«ã‚ƒ</div>
                    </div>
                    <div class="clickable-element">
                        <div class="text-xl font-bold text-gray-800 clickable-element" id="totalCount">0</div>
                        <div class="text-xs text-gray-600 clickable-element">ç·å•é¡Œæ•°ã ã«ã‚ƒã€œ</div>
                    </div>
                </div>
                
                <div class="section-divider clickable-element"></div>
                <div class="text-center">
                    <div class="text-sm font-semibold text-gray-700 mb-3 clickable-element"><span class="rotating-icon">ğŸ“‹</span> å‡ºé¡Œå½¢å¼ã ã«ã‚ƒã€œ</div>
                    <div class="grid grid-cols-2 gap-2">
                        <button id="randomModeBtn" class="mode-btn active tap-effect clickable-element" data-mode="random">
                            <span class="mode-icon">ğŸ²</span> ãƒ©ãƒ³ãƒ€ãƒ ã«ã‚ƒ
                        </button>
                        <button id="sequentialModeBtn" class="mode-btn tap-effect clickable-element" data-mode="sequential">
                            <span class="mode-icon">ğŸ“‹</span> é †ç•ªé€šã‚Šã«ã‚ƒ
                        </button>
                    </div>
                    <div class="text-xs text-gray-600 mt-2 clickable-element" id="modeDescription">
                        å•é¡Œã‚’ãƒ©ãƒ³ãƒ€ãƒ ã«å‡ºé¡Œã™ã‚‹ã«ã‚ƒã€œâ™ª
                    </div>
                </div>
            </div>
            <button id="startQuizButton" class="clean-button px-6 py-3 text-base font-semibold mt-6 tap-effect clickable-element">
                <span class="rotating-icon">âœ¨</span> ã‚¹ã‚¿ãƒ¼ãƒˆã«ã‚ƒã€œâ™ª
            </button>
        </div>
    </div>

    <!-- ã‚¯ã‚¤ã‚ºãƒ¢ãƒ¼ãƒ€ãƒ« -->
    <div id="quizModal" class="modal">
        <div class="clean-card p-4 w-full max-w-lg mx-4">
            <div class="text-center mb-4">
                <h2 class="font-semibold text-lg text-gray-700 clickable-element">
                    <span class="rotating-icon">ğŸ±</span> NEKOPON Quiz <span class="rotating-icon">ğŸ±</span>
                </h2>
            </div>
            <div class="space-y-4">
                <p id="quizQ" class="text-base font-medium text-center text-gray-800 leading-relaxed clickable-element"></p>
                <div id="quizOptions" class="space-y-2"></div>
                <div id="quizExplanation" class="quiz-explanation clickable-element">
                    <p id="quizMsg" class="font-semibold text-center text-base clickable-element"></p>
                </div>
                <div class="flex gap-2">
                    <button id="quizNext" class="flex-1 clean-button py-2 text-sm tap-effect clickable-element">
                        <span class="rotating-icon">ğŸŒŸ</span> æ¬¡ã®å•é¡Œã«ã‚ƒã€œ
                    </button>
                    <button id="quizBack" class="flex-1 back-button py-2 text-sm tap-effect clickable-element">
                        <span class="rotating-icon">ğŸ </span> æˆ»ã‚‹ã«ã‚ƒã€œ
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- ãƒ•ãƒ­ãƒ¼ãƒ†ã‚£ãƒ³ã‚°ãƒœã‚¿ãƒ³ -->
    <button id="changeSubject" class="floating-button hidden tap-effect clickable-element">
        <span class="floating-button-icon">ğŸ“š</span>
    </button>

    <!-- é€šçŸ¥ -->
    <div id="notification" class="notification">
        <div class="flex items-center gap-3">
            <span class="text-xl rotating-icon">âœ¨</span>
            <div>
                <div class="font-semibold text-sm">ğŸ± NEKOPON Quiz ğŸ±</div>
                <div id="notificationText" class="text-xs text-gray-600"></div>
            </div>
        </div>
    </div>

    <!-- é‡åŠ›æ„ŸçŸ¥ã®æ¨©é™è¦æ±‚ãƒãƒƒãƒ—ã‚¢ãƒƒãƒ— -->
    <div id="tiltPermissionPopup" class="permission-popup">
        <h3><span class="rotating-icon">ğŸ±</span> çŒ«åå¿œæ©Ÿèƒ½ <span class="rotating-icon">ğŸ±</span></h3>
        <p>ã‚¹ãƒãƒ›ã‚’å‚¾ã‘ã‚‹ã¨çŒ«ãŒã‚¯ãƒ«ã‚¯ãƒ«å›è»¢ã—ã¾ã™â™ª<br>å‹‰å¼·ãŒã‚‚ã£ã¨æ¥½ã—ããªã‚‹ã«ã‚ƒã€œ</p>
        <button onclick="requestTiltPermission()">æœ‰åŠ¹ã«ã™ã‚‹</button>
        <button onclick="skipTiltPermission()">ã‚¹ã‚­ãƒƒãƒ—</button>
    </div>

    <script>
        /* ----------------- é‡åŠ›æ„ŸçŸ¥ã‚·ã‚¹ãƒ†ãƒ ï¼ˆå®Œå…¨ç‰ˆãƒ»ã‚¢ã‚¤ã‚³ãƒ³å›è»¢å¯¾å¿œï¼‰ ----------------- */
        class UltimateTiltSystem {
            constructor() {
                this.tiltEnabled = false;
                this.currentTilt = { gamma: 0, beta: 0 };
                this.lastTiltTime = 0;
                this.permissionPopup = null;
                this.isMainPageDisplayed = false;
                this.emojiRegex = /[\u{1F600}-\u{1F64F}]|[\u{1F300}-\u{1F5FF}]|[\u{1F680}-\u{1F6FF}]|[\u{1F1E0}-\u{1F1FF}]|[\u{2600}-\u{26FF}]|[\u{2700}-\u{27BF}]/gu;
            }

            init() {
                // ãƒˆãƒƒãƒ—ãƒšãƒ¼ã‚¸ãŒè¡¨ç¤ºã•ã‚Œã¦ã‹ã‚‰é‡åŠ›æ„ŸçŸ¥ã‚’åˆæœŸåŒ–
                this.waitForMainPage();
            }

            waitForMainPage() {
                // ãƒ¡ã‚¤ãƒ³ãƒšãƒ¼ã‚¸ã®è¡¨ç¤ºã‚’ç¢ºèªã—ã¦ã‹ã‚‰æ¨©é™è¦æ±‚ã‚’è¡¨ç¤º
                const checkMainPage = () => {
                    const mainModal = document.getElementById('mainSubjectModal');
                    if (mainModal && mainModal.classList.contains('show')) {
                        this.isMainPageDisplayed = true;
                        setTimeout(() => {
                            this.showTiltPermissionPopup();
                        }, 2000); // ãƒ¡ã‚¤ãƒ³ãƒšãƒ¼ã‚¸è¡¨ç¤ºã‹ã‚‰2ç§’å¾Œã«æ¨©é™è¦æ±‚
                    } else {
                        setTimeout(checkMainPage, 200);
                    }
                };
                checkMainPage();
            }

            showTiltPermissionPopup() {
                // iOS 13ä»¥é™ã®è¨±å¯è¦æ±‚ãŒå¿…è¦ã‹ãƒã‚§ãƒƒã‚¯
                if (typeof DeviceOrientationEvent !== 'undefined' && typeof DeviceOrientationEvent.requestPermission === 'function') {
                    const popup = document.getElementById('tiltPermissionPopup');
                    popup.classList.add('show');
                    this.permissionPopup = popup;
                } else {
                    // Androidç­‰ã§ã¯ç›´æ¥æœ‰åŠ¹åŒ–
                    this.enableTiltSensor();
                }
            }

            async requestTiltPermission() {
                try {
                    const permission = await DeviceOrientationEvent.requestPermission();
                    if (permission === 'granted') {
                        this.enableTiltSensor();
                        showNekoMsg('çŒ«ãŒã‚¯ãƒ«ã‚¯ãƒ«å›è»¢â™ª', window.innerWidth/2, window.innerHeight/2);
                        showNotification('é‡åŠ›æ„ŸçŸ¥æ©Ÿèƒ½ãŒæœ‰åŠ¹ã«ãªã£ãŸã«ã‚ƒã€œâ™ª');
                    } else {
                        showNotification('é‡åŠ›æ„ŸçŸ¥ã¯ç„¡åŠ¹ã§ã™ãŒã€æ¥½ã—ãå­¦ç¿’ã§ãã‚‹ã«ã‚ƒã€œâ™ª');
                    }
                } catch (error) {
                    console.log('Permission denied or error occurred');
                    showNotification('é‡åŠ›æ„ŸçŸ¥ã¯ç„¡åŠ¹ã§ã™ãŒã€æ¥½ã—ãå­¦ç¿’ã§ãã‚‹ã«ã‚ƒã€œâ™ª');
                }
                this.closeTiltPermissionPopup();
            }

            skipTiltPermission() {
                this.closeTiltPermissionPopup();
                showNotification('é‡åŠ›æ„ŸçŸ¥ã‚’ã‚¹ã‚­ãƒƒãƒ—ã—ã¾ã—ãŸã€‚æ¥½ã—ãå­¦ç¿’ã«ã‚ƒã€œâ™ª');
            }

            closeTiltPermissionPopup() {
                if (this.permissionPopup) {
                    this.permissionPopup.classList.remove('show');
                    this.permissionPopup = null;
                }
            }

            enableTiltSensor() {
                this.tiltEnabled = true;

                // ãƒ‡ãƒã‚¤ã‚¹å‘ãå¤‰æ›´ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼
                window.addEventListener('deviceorientation', (event) => {
                    if (!this.tiltEnabled) return;

                    this.currentTilt.gamma = event.gamma || 0; // å·¦å³ã®å‚¾ã (-90 to 90)
                    this.currentTilt.beta = event.beta || 0;   // å‰å¾Œã®å‚¾ã (-180 to 180)
                    this.updateAllIconOrientations();
                });

                // PCç’°å¢ƒã‚„ãƒ†ã‚¹ãƒˆç”¨ã®è‡ªå‹•å›è»¢æ©Ÿèƒ½
                if (!window.DeviceOrientationEvent || navigator.userAgent.includes('Chrome')) {
                    this.startTestRotation();
                }
            }

            // PCç’°å¢ƒç”¨ã®è‡ªå‹•å›è»¢ãƒ†ã‚¹ãƒˆï¼ˆã‚ˆã‚Šè‡ªç„¶ãªå‹•ãï¼‰
            startTestRotation() {
                setInterval(() => {
                    if (!this.tiltEnabled) return;
                    
                    // ã‚ˆã‚Šè‡ªç„¶ãªç–‘ä¼¼çš„å‚¾ããƒ‡ãƒ¼ã‚¿ã‚’ç”Ÿæˆ
                    const time = Date.now() * 0.001;
                    this.currentTilt.gamma = Math.sin(time * 0.8) * 45 + Math.sin(time * 2.3) * 15; // -60åº¦ã€œ+60åº¦
                    this.currentTilt.beta = Math.cos(time * 0.6) * 30 + Math.cos(time * 1.7) * 10; // -40åº¦ã€œ+40åº¦
                    this.updateAllIconOrientations();
                }, 50); // 20FPS
            }

            updateAllIconOrientations() {
                const now = Date.now();
                if (now - this.lastTiltTime < 30) return; // 30FPSã«åˆ¶é™
                this.lastTiltTime = now;

                const gamma = this.currentTilt.gamma;
                const beta = this.currentTilt.beta;

                // åŸºæœ¬å›è»¢è§’åº¦ã‚’è¨ˆç®—ï¼ˆã‚ˆã‚Šè‡ªç„¶ãªæ„Ÿã˜ã«ï¼‰
                let baseRotation = gamma * 1.5;
                if (Math.abs(beta) > 60) {
                    baseRotation += beta * 0.3;
                }

                // å¾“æ¥ã®ã‚»ãƒ¬ã‚¯ã‚¿ãƒ¼ + æ‹¡å¼µã‚»ãƒ¬ã‚¯ã‚¿ãƒ¼
                const iconSelectors = [
                    '.rotating-icon',
                    '.cat-icon', 
                    '.subject-icon', 
                    '.category-icon', 
                    '.mode-icon', 
                    '.floating-button-icon'
                ];

                iconSelectors.forEach(selector => {
                    document.querySelectorAll(selector).forEach((element, index) => {
                        this.applyRotationToElement(element, baseRotation, index);
                    });
                });

                // è‡ªå‹•æ¤œå‡ºã•ã‚ŒãŸçµµæ–‡å­—ã‚¢ã‚¤ã‚³ãƒ³ã«ã‚‚é©ç”¨
                this.detectAndRotateEmojis(baseRotation);
            }

            detectAndRotateEmojis(baseRotation) {
                // ã™ã¹ã¦ã®ãƒ†ã‚­ã‚¹ãƒˆãƒãƒ¼ãƒ‰ã‚’æ¤œç´¢ã—ã¦çµµæ–‡å­—ã‚’è¦‹ã¤ã‘ã‚‹
                const walker = document.createTreeWalker(
                    document.body,
                    NodeFilter.SHOW_TEXT,
                    {
                        acceptNode: (node) => {
                            // æ—¢ã«å‡¦ç†æ¸ˆã¿ã®è¦ç´ ã‚„ã‚¹ã‚¯ãƒªãƒ—ãƒˆå†…ã¯é™¤å¤–
                            if (node.parentElement.tagName === 'SCRIPT' || 
                                node.parentElement.classList.contains('auto-rotating-emoji') ||
                                node.parentElement.closest('.permission-popup')) {
                                return NodeFilter.FILTER_REJECT;
                            }
                            return this.emojiRegex.test(node.textContent) ? 
                                NodeFilter.FILTER_ACCEPT : NodeFilter.FILTER_REJECT;
                        }
                    }
                );

                const textNodes = [];
                let node;
                while (node = walker.nextNode()) {
                    textNodes.push(node);
                }

                textNodes.forEach((textNode, index) => {
                    const parent = textNode.parentElement;
                    if (!parent || parent.classList.contains('processed-emoji')) return;

                    // çµµæ–‡å­—ã‚’å«ã‚€ãƒ†ã‚­ã‚¹ãƒˆã‚’å‡¦ç†
                    const text = textNode.textContent;
                    const emojiMatches = text.match(this.emojiRegex);
                    
                    if (emojiMatches && emojiMatches.length > 0) {
                        // çµµæ–‡å­—ã‚’ span ã§å›²ã‚“ã§å›è»¢å¯èƒ½ã«ã™ã‚‹
                        const newHTML = text.replace(this.emojiRegex, (emoji) => {
                            return `<span class="auto-rotating-emoji">${emoji}</span>`;
                        });
                        
                        parent.innerHTML = parent.innerHTML.replace(text, newHTML);
                        parent.classList.add('processed-emoji');
                        
                        // æ–°ã—ãä½œæˆã•ã‚ŒãŸçµµæ–‡å­—è¦ç´ ã«å›è»¢ã‚’é©ç”¨
                        parent.querySelectorAll('.auto-rotating-emoji').forEach((emojiElement, emojiIndex) => {
                            this.applyRotationToElement(emojiElement, baseRotation, index + emojiIndex);
                        });
                    }
                });
            }

            applyRotationToElement(element, baseRotation, index) {
                // ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ä¸­ã‚„ç‰¹åˆ¥ãªçŠ¶æ…‹ã®è¦ç´ ã¯ã‚¹ã‚­ãƒƒãƒ—
                if (this.shouldSkipElement(element)) {
                    return;
                }

                // å„è¦ç´ ã«å€‹åˆ¥ã®å›è»¢ã‚’é©ç”¨ï¼ˆã‚ˆã‚Šå¤šæ§˜æ€§ã‚’æŒãŸã›ã‚‹ï¼‰
                const individualRotation = baseRotation + (index % 12 - 6) * 8 + Math.sin(Date.now() * 0.001 + index) * 5;
                
                element.style.setProperty('--rotation', `${individualRotation}deg`);
                
                // cat-iconã¯ç‰¹åˆ¥å‡¦ç†ï¼ˆbounceã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ä¸­ã§ãªã‘ã‚Œã°ï¼‰
                if (element.classList.contains('cat-icon') && !element.classList.contains('bounce')) {
                    element.style.transform = `rotate(${individualRotation}deg)`;
                } else if (!element.classList.contains('cat-icon')) {
                    element.style.transform = `rotate(${individualRotation}deg)`;
                }
            }

            shouldSkipElement(element) {
                // ã‚ˆã‚ŠåŒ…æ‹¬çš„ãªã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³é™¤å¤–åˆ¤å®š
                return element.classList.contains('bounce') ||
                       element.classList.contains('animating') ||
                       element.closest('.tap-sparkle') ||
                       element.closest('.tap-fire') ||
                       element.closest('.tap-trophy') ||
                       element.closest('.cute-shake-effect') ||
                       element.closest('.title-bounce') ||
                       element.closest('.score-pulse') ||
                       element.closest('.tapped');
            }
        }

        // ã‚°ãƒ­ãƒ¼ãƒãƒ«é–¢æ•°ã¨ã—ã¦å®šç¾©ï¼ˆHTMLã‹ã‚‰å‘¼ã³å‡ºã•ã‚Œã‚‹ãŸã‚ï¼‰
        function requestTiltPermission() {
            tiltSystem.requestTiltPermission();
        }

        function skipTiltPermission() {
            tiltSystem.skipTiltPermission();
        }

        /* ----------------- ãƒã‚¤ãƒ³ãƒˆã‚·ã‚¹ãƒ†ãƒ ï¼ˆæ¨ªä¸¦ã³å¯¾å¿œãƒ»å°ã•ãªãƒã‚¤ãƒ³ãƒˆè¡¨ç¤ºï¼‰ ----------------- */
        class UltimateMegaPointSystem {
            constructor() {
                this.sparklePoints = 0;
                this.firePoints = 0;
                this.trophyPoints = 0;
                this.totalClicks = 0;
                this.comboCount = 0;
                this.lastClickTime = 0;
                this.multiplier = 1;
                this.isComboMode = false;
                
                this.sparkleMessages = [
                    'ãã‚ƒãƒ¼â™ª', 'ãã‚‰ãã‚‰ã€œ', 'ã¾ã¶ã—ã„ï¼', 'ã™ã¦ãâ™ª', 'ã´ã‹ã´ã‹ã€œ',
                    'ã²ã‹ã£ã¦ã‚‹ã€œ', 'ã¾ã»ã†â™ª', 'ã ã„ã™ãï¼', 'ãã‚Œã„ã€œ', 'ã‚ãƒ¼ã„â™ª',
                    'ã™ã”ã„ã«ã‚ƒã€œ', 'ã³ã£ãã‚Šï¼', 'ã‚„ã£ãŸãƒ¼ï¼', 'ã•ã„ã“ã†â™ª', 'ã¦ã‚“ã—ã€œ'
                ];

                this.fireMessages = [
                    'ã‚ã¤ã‚ã¤ã€œ', 'ã‚ã‚‰ã‚ã‚‰ï¼', 'ã‚‚ãˆã‚‚ãˆã€œ', 'ã½ã‹ã½ã‹â™ª', 'ã¯ãƒ¼ã¨â™ª',
                    'ã ã„ã™ãã€œ', 'ã‚‰ã¶ã‚‰ã¶â™ª', 'ã‚ã£ãŸã‹ã€œ', 'ã‚‚ãµã‚‚ãµã€œ', 'ãã‚…ãƒ¼ã‚“â™ª',
                    'ã°ãƒ¼ã«ã‚“ãâ™ª', 'ã»ã£ã¨ã€œ', 'ã‚Œã‚“ã‚ã„â™ª', 'ã©ãã©ãã€œ', 'ãã‚‚ã¡ã„ã„ã€œ'
                ];

                this.trophyMessages = [
                    'ã™ã”ã„ã­ï¼', 'ãˆã‚‰ã„ãˆã‚‰ã„â™ª', 'ã‚„ã£ãŸãƒ¼ï¼', 'ãŒã‚“ã°ã£ãŸï¼', 'æœ€é«˜ã ã­â™ª',
                    'ã•ã„ã“ã†ã€œ', 'ã§ã‚“ã›ã¤ï¼', 'ãã‚‡ã†ã‚Šã‚‡ãï¼', 'ã™ã°ã‚‰ã—ã„â™ª', 'ã‹ã‚“ã©ã†ã€œ',
                    'ã¡ã‚ƒã‚“ã´ãŠã‚“â™ª', 'ã™ãŸãƒ¼ï¼', 'ã²ãƒ¼ã‚ãƒ¼â™ª', 'ãŠã†ã•ã¾ã€œ', 'ã‹ã¿ã•ã¾â™ª'
                ];

                this.initializeSystem();
            }

            initializeSystem() {
                // ã™ã¹ã¦ã®ã‚¯ãƒªãƒƒã‚«ãƒ–ãƒ«è¦ç´ ã«ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼ã‚’è¿½åŠ 
                this.addGlobalClickListeners();
                
                // æ¨ªä¸¦ã³ãƒã‚¤ãƒ³ãƒˆãƒãƒ–ãƒ«ã®ã‚¯ãƒªãƒƒã‚¯ã‚¤ãƒ™ãƒ³ãƒˆ
                this.initPointBubbles();
                
                // å®šæœŸçš„ãªãƒœãƒ¼ãƒŠã‚¹å‡¦ç†
                setInterval(() => this.checkComboTimeout(), 100);
                setInterval(() => this.autoBonus(), 5000); // 5ç§’ã”ã¨ã«ã‚ªãƒ¼ãƒˆãƒœãƒ¼ãƒŠã‚¹
            }

            addGlobalClickListeners() {
                // å…¨ã¦ã®ã‚¯ãƒªãƒƒã‚«ãƒ–ãƒ«è¦ç´ ã‚’å–å¾—ã—ã¦ã‚¤ãƒ™ãƒ³ãƒˆè¿½åŠ 
                document.addEventListener('click', (e) => {
                    const element = e.target;
                    if (element.classList.contains('clickable-element') || 
                        element.closest('.clickable-element')) {
                        this.handleElementClick(e);
                    }
                });
            }

            initPointBubbles() {
                // æ¨ªä¸¦ã³ãƒã‚¤ãƒ³ãƒˆãƒãƒ–ãƒ«ã®ã‚¯ãƒªãƒƒã‚¯
                document.getElementById('sparklePointBubble').addEventListener('click', (e) => {
                    e.stopPropagation();
                    this.megaTapPointBubble('sparkle', e);
                });

                document.getElementById('firePointBubble').addEventListener('click', (e) => {
                    e.stopPropagation();
                    this.megaTapPointBubble('fire', e);
                });

                document.getElementById('trophyPointBubble').addEventListener('click', (e) => {
                    e.stopPropagation();
                    this.megaTapPointBubble('trophy', e);
                });
            }

            handleElementClick(e) {
                const element = e.target.closest('.clickable-element') || e.target;
                
                // ã‚³ãƒ³ãƒœåˆ¤å®š
                const now = Date.now();
                if (now - this.lastClickTime < 500) { // 0.5ç§’ä»¥å†…ãªã‚‰é€£ç¶šã‚¯ãƒªãƒƒã‚¯
                    this.comboCount++;
                    this.multiplier = Math.min(5, 1 + (this.comboCount * 0.1)); // æœ€å¤§5å€
                    this.isComboMode = true;
                } else {
                    this.comboCount = 0;
                    this.multiplier = 1;
                    this.isComboMode = false;
                }
                this.lastClickTime = now;

                // åŸºæœ¬ãƒã‚¤ãƒ³ãƒˆ
                let basePoints = 5;
                let particleType = 'normal';
                let messages = ['ã½ã¡ã£â™ª', 'ãŸã£ã¡ã€œ', 'ãºã¡ãºã¡â™ª'];

                // è¦ç´ ã‚¿ã‚¤ãƒ—åˆ¥ãƒœãƒ¼ãƒŠã‚¹
                if (element.classList.contains('game-title') || element.id === 'gameTitle') {
                    basePoints = 50;
                    particleType = 'mega';
                    messages = ['ãŸã„ã¨ã‚‹ã€œâ™ª', 'NEKOPONâ™ª', 'ã‚ã”ã€œï¼'];
                } else if (element.classList.contains('cat-icon')) {
                    basePoints = 25;
                    particleType = 'bonus';
                    messages = ['ã«ã‚ƒãƒ¼ã‚“â™ª', 'ã­ã“ã¡ã‚ƒã‚“â™ª', 'ã‹ã‚ã„ã„ã€œ'];
                } else if (element.classList.contains('subject-btn') || element.classList.contains('category-btn')) {
                    basePoints = 15;
                    particleType = 'bonus';
                    messages = ['ã¼ãŸã‚“â™ª', 'ã›ã‚“ãŸãã€œ', 'ãã‚Šã£ãï¼'];
                } else if (element.classList.contains('clean-button') || element.classList.contains('quiz-option')) {
                    basePoints = 12;
                    particleType = 'bonus';
                    messages = ['ãŸã£ã·â™ª', 'ã½ã¡ã£ã¨ã€œ', 'ãã£ã©ï¼'];
                }

                // ã‚³ãƒ³ãƒœãƒœãƒ¼ãƒŠã‚¹é©ç”¨
                const finalPoints = Math.floor(basePoints * this.multiplier);
                
                // ãƒã‚¤ãƒ³ãƒˆæŒ¯ã‚Šåˆ†ã‘ï¼ˆãƒ©ãƒ³ãƒ€ãƒ ï¼‰
                const distribution = Math.random();
                if (distribution < 0.4) {
                    this.sparklePoints += finalPoints;
                } else if (distribution < 0.7) {
                    this.firePoints += Math.floor(finalPoints * 0.7);
                } else {
                    this.trophyPoints += Math.floor(finalPoints * 1.5);
                }

                this.totalClicks++;

                // å¯æ„›ã„éœ‡ãˆã‚¨ãƒ•ã‚§ã‚¯ãƒˆè¿½åŠ ï¼ˆæ­£ç¢ºãªåº§æ¨™å–å¾—ï¼‰
                const rect = element.getBoundingClientRect();
                const centerX = rect.left + rect.width / 2;
                const centerY = rect.top + rect.height / 2;

                // è¦ç´ ã«å¯æ„›ã„éœ‡ãˆã‚¨ãƒ•ã‚§ã‚¯ãƒˆè¿½åŠ 
                element.classList.add('cute-shake-effect');
                setTimeout(() => element.classList.remove('cute-shake-effect'), 600);

                // ãƒ‘ãƒ¼ãƒ†ã‚£ã‚¯ãƒ«ç”Ÿæˆï¼ˆæ­£ç¢ºãªåº§æ¨™ï¼‰
                this.createCuteParticles(centerX, centerY, 
                    ['âœ¨', 'ğŸ’«', 'ğŸŒŸ', 'ğŸ’–', 'ğŸŠ', 'â­', 'ğŸ’'], 
                    this.isComboMode ? 8 : 4);

                // å°ã•ãªãƒ•ãƒ­ãƒ¼ãƒ†ã‚£ãƒ³ã‚°ãƒã‚¤ãƒ³ãƒˆè¡¨ç¤º
                this.showFloatingPoints(finalPoints, centerX, centerY, 
                    this.isComboMode ? 'ultra' : particleType);

                // ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸è¡¨ç¤º
                const message = this.isComboMode ? 
                    `ã‚³ãƒ³ãƒœÃ—${this.multiplier.toFixed(1)}` :
                    messages[Math.floor(Math.random() * messages.length)];
                showNekoMsg(message, centerX, centerY);

                // ã‚µã‚¦ãƒ³ãƒ‰
                soundSystem.playSound(this.isComboMode ? 'mega' : 'sparkle');
                soundSystem.vibrate(this.isComboMode ? [80, 40, 80, 40, 120] : [50]);

                this.updateAllPointDisplays();
            }

            megaTapPointBubble(type, event) {
                let bonusPoints, messages, particles, soundType;

                switch(type) {
                    case 'sparkle':
                        bonusPoints = 200;
                        messages = this.sparkleMessages;
                        particles = ['âœ¨', 'ğŸ’«', 'ğŸŒŸ', 'ğŸ’', 'â­', 'ğŸ”®'];
                        soundType = 'sparkle';
                        this.sparklePoints += bonusPoints;
                        break;
                    
                    case 'fire':
                        bonusPoints = 150;
                        messages = this.fireMessages;
                        particles = ['ğŸ”¥', 'ğŸ’•', 'â¤ï¸', 'ğŸ’–', 'ğŸ’', 'ğŸ’˜'];
                        soundType = 'fire';
                        this.firePoints += bonusPoints;
                        break;
                    
                    case 'trophy':
                        bonusPoints = 300;
                        messages = this.trophyMessages;
                        particles = ['ğŸ†', 'ğŸ‘‘', 'ğŸŠ', 'ğŸ‰', 'ğŸŒŸ', 'ğŸ’«', 'ğŸ†', 'ğŸ–ï¸'];
                        soundType = 'trophy';
                        this.trophyPoints += bonusPoints;
                        break;
                }

                this.totalClicks++;

                // ã‚µã‚¦ãƒ³ãƒ‰å†ç”Ÿ
                soundSystem.playSound(soundType);
                soundSystem.vibrate([200, 100, 200, 100, 300]);

                // ã‚¨ãƒ•ã‚§ã‚¯ãƒˆè¡¨ç¤ºï¼ˆã‚¤ãƒ™ãƒ³ãƒˆåº§æ¨™ä½¿ç”¨ï¼‰
                const element = event.target;
                const rect = element.getBoundingClientRect();
                const centerX = rect.left + rect.width / 2;
                const centerY = rect.top + rect.height / 2;

                // ãƒãƒ–ãƒ«ã«é©åˆ‡ãªã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ã‚¯ãƒ©ã‚¹è¿½åŠ 
                element.classList.add(`tap-${type}`);
                setTimeout(() => element.classList.remove(`tap-${type}`), 800);

                // ãƒ‘ãƒ¼ãƒ†ã‚£ã‚¯ãƒ«ç”Ÿæˆ
                this.createCuteParticles(centerX, centerY, particles, 10);

                // å°ã•ãªãƒ•ãƒ­ãƒ¼ãƒ†ã‚£ãƒ³ã‚°ãƒã‚¤ãƒ³ãƒˆ
                this.showFloatingPoints(bonusPoints, centerX, centerY, 'ultra');

                // ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸è¡¨ç¤º
                const message = messages[Math.floor(Math.random() * messages.length)];
                showNekoMsg(message, centerX, centerY);

                this.updateAllPointDisplays();
            }

            checkComboTimeout() {
                const now = Date.now();
                if (this.isComboMode && now - this.lastClickTime > 1000) {
                    this.comboCount = 0;
                    this.multiplier = 1;
                    this.isComboMode = false;
                }
            }

            autoBonus() {
                if (this.totalClicks > 0) {
                    const bonus = Math.floor(this.totalClicks * 0.05);
                    this.sparklePoints += bonus;
                    this.firePoints += bonus;
                    this.trophyPoints += bonus;
                    
                    // å°ã•ãªé€šçŸ¥
                    const messages = ['ãŠã¾ã‘ã«ã‚ƒã€œ', 'ã¼ãƒ¼ãªã™â™ª', 'ã•ãƒ¼ã³ã™ã€œ'];
                    showNekoMsg(messages[Math.floor(Math.random() * messages.length)], 
                              window.innerWidth - 100, 100);
                    
                    this.updateAllPointDisplays();
                }
            }

            createCuteParticles(x, y, emojis, count) {
                for (let i = 0; i < count; i++) {
                    setTimeout(() => {
                        const particle = document.createElement('div');
                        particle.className = 'cute-particle';
                        particle.textContent = emojis[Math.floor(Math.random() * emojis.length)];
                        particle.style.left = (x + (Math.random() - 0.5) * 60) + 'px';
                        particle.style.top = (y + (Math.random() - 0.5) * 60) + 'px';
                        particle.style.color = `hsl(${Math.random() * 360}, 70%, 60%)`;
                        document.body.appendChild(particle);
                        setTimeout(() => particle.remove(), 1500);
                    }, i * 40);
                }
            }

            showFloatingPoints(points, x, y, type = 'normal') {
                const element = document.createElement('div');
                element.className = `floating-points ${type}`;
                element.textContent = `+${this.formatNum(points)}`;
                element.style.left = Math.min(x, window.innerWidth - 80) + 'px';
                element.style.top = Math.min(y, window.innerHeight - 40) + 'px';
                document.body.appendChild(element);
                
                setTimeout(() => element.remove(), 2000);
            }

            updateAllPointDisplays() {
                document.getElementById('sparklePointsMain').textContent = this.formatNum(this.sparklePoints);
                document.getElementById('firePointsMain').textContent = this.formatNum(this.firePoints);
                document.getElementById('trophyPointsMain').textContent = this.formatNum(this.trophyPoints);
            }

            formatNum(n) {
                if (n >= 1e12) return Math.floor(n / 1e12) + 'T';
                if (n >= 1e9) return Math.floor(n / 1e9) + 'B';
                if (n >= 1e6) return Math.floor(n / 1e6) + 'M';
                if (n >= 1e3) return Math.floor(n / 1e3) + 'K';
                return Math.floor(n).toString();
            }

            getTotalPoints() {
                return this.sparklePoints + this.firePoints + this.trophyPoints;
            }
        }

        /* ----------------- éŸ³éŸ¿ã‚·ã‚¹ãƒ†ãƒ  ----------------- */
        class UltimateSoundSystem {
            constructor() {
                this.audioContext = null;
                this.sounds = {};
                this.initAudio();
            }

            initAudio() {
                try {
                    this.audioContext = new (window.AudioContext || window.webkitAudioContext)();
                } catch (e) {
                    console.log('éŸ³å£°ã‚·ã‚¹ãƒ†ãƒ ã‚’åˆæœŸåŒ–ã§ãã¾ã›ã‚“ã§ã—ãŸã«ã‚ƒã€œ');
                }
            }

            playClick() {
                this.createNekoTone(600, 0.2, 0.15, 'sine');
            }

            playCorrect() {
                this.createNekoTone(523, 0.15, 0.2);
                setTimeout(() => this.createNekoTone(659, 0.15, 0.2), 100);
                setTimeout(() => this.createNekoTone(784, 0.25, 0.25), 200);
                setTimeout(() => this.createNekoTone(1047, 0.3, 0.2), 350);
            }

            playWrong() {
                this.createNekoTone(400, 0.2, 0.15, 'sine');
                setTimeout(() => this.createNekoTone(300, 0.3, 0.2, 'sine'), 150);
            }

            playSuccess() {
                const notes = [523, 587, 659, 698, 784, 880, 988, 1047, 1175];
                notes.forEach((freq, i) => {
                    setTimeout(() => this.createNekoTone(freq, 0.15, 0.2, 'sine'), i * 80);
                });
            }

            playSound(type) {
                if (!this.audioContext) return;

                try {
                    if (this.audioContext.state === 'suspended') {
                        this.audioContext.resume();
                    }

                    const oscillator = this.audioContext.createOscillator();
                    const gainNode = this.audioContext.createGain();
                    const filterNode = this.audioContext.createBiquadFilter();

                    oscillator.connect(filterNode);
                    filterNode.connect(gainNode);
                    gainNode.connect(this.audioContext.destination);

                    let frequency, duration, filterFreq;

                    switch(type) {
                        case 'sparkle':
                            frequency = 1200 + Math.random() * 500;
                            duration = 0.8;
                            filterFreq = 2500;
                            oscillator.frequency.setValueAtTime(frequency, this.audioContext.currentTime);
                            oscillator.frequency.exponentialRampToValueAtTime(frequency * 0.4, this.audioContext.currentTime + duration);
                            break;
                        case 'fire':
                            frequency = 600 + Math.random() * 300;
                            duration = 1.0;
                            filterFreq = 1800;
                            oscillator.frequency.setValueAtTime(frequency, this.audioContext.currentTime);
                            oscillator.frequency.exponentialRampToValueAtTime(frequency * 1.3, this.audioContext.currentTime + duration * 0.5);
                            oscillator.frequency.exponentialRampToValueAtTime(frequency * 0.7, this.audioContext.currentTime + duration);
                            break;
                        case 'trophy':
                            frequency = 1500;
                            duration = 1.5;
                            filterFreq = 3500;
                            oscillator.frequency.setValueAtTime(frequency, this.audioContext.currentTime);
                            oscillator.frequency.exponentialRampToValueAtTime(frequency * 2, this.audioContext.currentTime + duration);
                            break;
                        case 'mega':
                            frequency = 1200;
                            duration = 1.2;
                            filterFreq = 3000;
                            oscillator.frequency.setValueAtTime(frequency, this.audioContext.currentTime);
                            oscillator.frequency.exponentialRampToValueAtTime(frequency * 2.5, this.audioContext.currentTime + duration * 0.3);
                            oscillator.frequency.exponentialRampToValueAtTime(frequency * 0.3, this.audioContext.currentTime + duration);
                            break;
                        default:
                            frequency = 440;
                            duration = 0.3;
                            filterFreq = 1000;
                            oscillator.frequency.setValueAtTime(frequency, this.audioContext.currentTime);
                            oscillator.frequency.exponentialRampToValueAtTime(frequency * 0.6, this.audioContext.currentTime + duration);
                    }

                    filterNode.frequency.setValueAtTime(filterFreq, this.audioContext.currentTime);
                    filterNode.Q.setValueAtTime(2, this.audioContext.currentTime);

                    gainNode.gain.setValueAtTime(0.12, this.audioContext.currentTime);
                    gainNode.gain.exponentialRampToValueAtTime(0.01, this.audioContext.currentTime + duration);

                    oscillator.start(this.audioContext.currentTime);
                    oscillator.stop(this.audioContext.currentTime + duration);
                } catch (e) {
                    // ã‚¨ãƒ©ãƒ¼ã¯ç„¡è¦–
                }
            }

            createNekoTone(frequency, duration, volume = 0.15, type = 'sine') {
                if (!this.audioContext) return;

                try {
                    if (this.audioContext.state === 'suspended') {
                        this.audioContext.resume();
                    }

                    const oscillator = this.audioContext.createOscillator();
                    const gainNode = this.audioContext.createGain();
                    const filterNode = this.audioContext.createBiquadFilter();

                    oscillator.connect(filterNode);
                    filterNode.connect(gainNode);
                    gainNode.connect(this.audioContext.destination);

                    oscillator.frequency.setValueAtTime(frequency, this.audioContext.currentTime);
                    oscillator.type = type;

                    filterNode.frequency.setValueAtTime(frequency * 2, this.audioContext.currentTime);
                    filterNode.Q.setValueAtTime(1, this.audioContext.currentTime);

                    gainNode.gain.setValueAtTime(0, this.audioContext.currentTime);
                    gainNode.gain.linearRampToValueAtTime(volume, this.audioContext.currentTime + 0.01);
                    gainNode.gain.exponentialRampToValueAtTime(0.001, this.audioContext.currentTime + duration);

                    oscillator.start(this.audioContext.currentTime);
                    oscillator.stop(this.audioContext.currentTime + duration);
                } catch (e) {
                    // ã‚¨ãƒ©ãƒ¼ã¯ç„¡è¦–
                }
            }

            vibrate(pattern) {
                if ('vibrate' in navigator) {
                    navigator.vibrate(pattern);
                }
            }
        }

        // ã‚°ãƒ­ãƒ¼ãƒãƒ«ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹
        const tiltSystem = new UltimateTiltSystem();
        const soundSystem = new UltimateSoundSystem();
        const pointSystem = new UltimateMegaPointSystem();

        /* ----------------- çŒ«èªãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ ----------------- */
        const nekoMessages = {
            correct: [
                'ã™ã”ã„ã«ã‚ƒã€œâ™ª', 'æ­£è§£ã ã«ã‚ƒï¼', 'ã‚„ã£ãŸã«ã‚ƒã€œï¼', 'å¤©æ‰ã«ã‚ƒâ™ª', 'ã‹ã—ã“ã„ã«ã‚ƒã€œ',
                'ã°ã£ã¡ã‚Šã«ã‚ƒï¼', 'ã™ã°ã‚‰ã—ã„ã«ã‚ƒâ™ª', 'ã•ã™ãŒã«ã‚ƒã€œ', 'ãˆã‚‰ã„ã«ã‚ƒï¼', 'ã±ãƒ¼ãµã‡ãã¨ã«ã‚ƒâ™ª'
            ],
            wrong: [
                'ã–ã‚“ã­ã‚“ã«ã‚ƒã€œ', 'ãŠã—ã„ã«ã‚ƒï¼', 'ã¤ããŒã‚“ã°ã‚‹ã«ã‚ƒã€œ', 'ã©ã‚“ã¾ã„ã«ã‚ƒâ™ª', 'ãŠã—ã‹ã£ãŸã«ã‚ƒã€œ',
                'ã‚‚ã†å°‘ã—ã«ã‚ƒï¼', 'ãƒ•ã‚¡ã‚¤ãƒˆã«ã‚ƒã€œâ™ª', 'ã¤ãã¯ã§ãã‚‹ã«ã‚ƒï¼', 'ãŒã‚“ã°ã‚‹ã«ã‚ƒã€œ', 'ã‚ãã‚‰ã‚ãªã„ã«ã‚ƒâ™ª'
            ],
            tap: [
                'ã«ã‚ƒã€œã‚“â™ª', 'ã½ã‚“ã½ã‚“â™ª', 'ãã‚ƒã‚ã„ã„ã€œ', 'ã‚‚ãµã‚‚ãµâ™ª', 'ãµã‚ãµã‚ã€œ',
                'ãºã‚ãºã‚â™ª', 'ã½ã‚ˆã½ã‚ˆã€œ', 'ãã‚‰ãã‚‰â™ª', 'ã´ã‹ã´ã‹ã€œ', 'ã‚ãã‚ãâ™ª'
            ],
            notification: [
                'ãŠçŸ¥ã‚‰ã›ã«ã‚ƒã€œâ™ª', 'ã ã„ã˜ãªã“ã¨ã«ã‚ƒï¼', 'ãã„ã¦ã»ã—ã„ã«ã‚ƒã€œ', 'ãƒã‚§ãƒƒã‚¯ã«ã‚ƒâ™ª', 'ã¿ã¦ã«ã‚ƒã€œ'
            ],
            start: [
                'ã¯ã˜ã¾ã‚‹ã«ã‚ƒã€œâ™ª', 'ãŒã‚“ã°ã‚‹ã«ã‚ƒï¼', 'ã‚ˆã‚ã—ãã«ã‚ƒã€œ', 'ãŸã®ã—ã‚‚ã†ã«ã‚ƒâ™ª', 'ã™ãŸãƒ¼ã¨ã«ã‚ƒã€œï¼'
            ]
        };

        /* ----------------- ã‚«ãƒ†ã‚´ãƒªãƒ¼å®šç¾©ï¼ˆå®Œå…¨å®Ÿè£…ï¼‰ ----------------- */
        const categories = {
            geography: [
                {id: 'geo_world_overview', name: '1.ä¸–ç•Œã®å§¿'},
                {id: 'geo_japan_overview', name: '2.æ—¥æœ¬ã®å§¿'},
                {id: 'geo_world_life', name: '3.ä¸–ç•Œå„åœ°ã®äººã€…ã®ç”Ÿæ´»ã¨ç’°å¢ƒ'},
                {id: 'geo_asia', name: '4.ä¸–ç•Œã®è«¸åœ°åŸŸã€€ã‚¢ã‚¸ã‚¢å·'},
                {id: 'geo_europe', name: '5.ä¸–ç•Œã®è«¸åœ°åŸŸã€€ãƒ¨ãƒ¼ãƒ­ãƒƒãƒ‘å·'},
                {id: 'geo_africa', name: '6.ä¸–ç•Œã®è«¸åœ°åŸŸã€€ã‚¢ãƒ•ãƒªã‚«å·'},
                {id: 'geo_north_america', name: '7.ä¸–ç•Œã®è«¸åœ°åŸŸã€€åŒ—ã‚¢ãƒ¡ãƒªã‚«å·'},
                {id: 'geo_south_america', name: '8.ä¸–ç•Œã®è«¸åœ°åŸŸã€€å—ã‚¢ãƒ¡ãƒªã‚«å·'},
                {id: 'geo_oceania', name: '9.ä¸–ç•Œã®è«¸åœ°åŸŸã€€ã‚ªã‚»ã‚¢ãƒ‹ã‚¢'},
                {id: 'geo_japan_features', name: '10.æ—¥æœ¬ã®åœ°åŸŸçš„ç‰¹è‰²'},
                {id: 'geo_japan_kyushu', name: '11.æ—¥æœ¬ã®è«¸åœ°åŸŸã€€ä¹å·åœ°æ–¹'},
                {id: 'geo_japan_chugoku', name: '12.æ—¥æœ¬ã®è«¸åœ°åŸŸã€€ä¸­å›½ãƒ»å››å›½åœ°æ–¹'},
                {id: 'geo_japan_kinki', name: '13.æ—¥æœ¬ã®è«¸åœ°åŸŸã€€è¿‘ç•¿åœ°æ–¹'},
                {id: 'geo_japan_chubu', name: '14.æ—¥æœ¬ã®è«¸åœ°åŸŸã€€ä¸­éƒ¨åœ°æ–¹'},
                {id: 'geo_japan_kanto', name: '15.æ—¥æœ¬ã®è«¸åœ°åŸŸã€€é–¢æ±åœ°æ–¹'},
                {id: 'geo_japan_tohoku', name: '16.æ—¥æœ¬ã®è«¸åœ°åŸŸã€€æ±åŒ—åœ°æ–¹'},
                {id: 'geo_japan_hokkaido', name: '17.æ—¥æœ¬ã®è«¸åœ°åŸŸã€€åŒ—æµ·é“åœ°æ–¹'}
            ],
            history: [
                {id: 'hist_ancient', name: '1.æ–‡æ˜ã®ãŠã“ã‚Šã¨æ—¥æœ¬ã®æˆã‚Šç«‹ã¡'},
                {id: 'hist_ancient_state', name: '2.å¤ä»£å›½å®¶ã®æ­©ã¿ã¨æ±ã‚¢ã‚¸ã‚¢'},
                {id: 'hist_kamakura', name: '3.æ­¦å£«ã®ãŠã“ã‚Šã¨éŒå€‰å¹•åºœ'},
                {id: 'hist_muromachi', name: '4.ãƒ¢ãƒ³ã‚´ãƒ«ã®è¥²æ¥ã¨å®¤ç”ºå¹•åºœ'},
                {id: 'hist_unification', name: '5.ãƒ¨ãƒ¼ãƒ­ãƒƒãƒ‘äººã¨ã®å‡ºä¼šã„ã¨å…¨å›½çµ±ä¸€'},
                {id: 'hist_edo_early', name: '6.æ±Ÿæˆ¸å¹•åºœã®æˆç«‹ã¨é–å›½'},
                {id: 'hist_edo_develop', name: '7.ç”£æ¥­ã®ç™ºé”ã¨å¹•åºœæ”¿æ²»ã®å±•é–‹'},
                {id: 'hist_opening', name: '8.æ¬§ç±³ã®é€²å‡ºã¨æ—¥æœ¬ã®é–‹å›½'},
                {id: 'hist_meiji', name: '9.æ˜æ²»ç¶­æ–°'},
                {id: 'hist_wars', name: '10.æ—¥æ¸…ãƒ»æ—¥éœ²æˆ¦äº‰ã¨æ—¥æœ¬ã®ç”£æ¥­é©å‘½'},
                {id: 'hist_wwi', name: '11.ç¬¬ä¸€æ¬¡ä¸–ç•Œå¤§æˆ¦ã¨æ—¥æœ¬'},
                {id: 'hist_wwii', name: '12.ä¸–ç•Œææ…Œã¨ç¬¬äºŒæ¬¡ä¸–ç•Œå¤§æˆ¦'},
                {id: 'hist_postwar', name: '13.æˆ¦å¾Œã®æ—¥æœ¬ã®ç™ºå±•ã¨å›½éš›ç¤¾ä¼š'}
            ],
            civics: [
                {id: 'civics_modern', name: '1.ç¾ä»£ç¤¾ä¼šã¨ç§ãŸã¡'},
                {id: 'civics_constitution', name: '2.äººé–“ã®å°Šé‡ã¨æ—¥æœ¬å›½æ†²æ³•'},
                {id: 'civics_democracy', name: '3.ç¾ä»£ã®æ°‘ä¸»æ”¿æ²»'},
                {id: 'civics_economy', name: '4.æš®ã‚‰ã—ã¨çµŒæ¸ˆ'}
            ],
            chemistry: [
                {id: 'chemistry_basic', name: '1.ç‰©è³ªã¨ãã®æ€§è³ª'},
                {id: 'chemistry_gas', name: '2.æ°—ä½“ã®æ€§è³ª'},
                {id: 'chemistry_solution', name: '3.æ°´æº¶æ¶²ã®æ€§è³ª'},
                {id: 'chemistry_state', name: '4.çŠ¶æ…‹å¤‰åŒ–'},
                {id: 'chemistry_change', name: '5.ç‰©è³ªã®å¤‰åŒ–'},
                {id: 'chemistry_structure', name: '6.ç‰©è³ªã®æˆã‚Šç«‹ã¡'},
                {id: 'chemistry_reaction', name: '7.ç‰©è³ªã©ã†ã—ã®åŒ–å­¦å¤‰åŒ–'},
                {id: 'chemistry_mass', name: '8.åŒ–å­¦å¤‰åŒ–ã¨è³ªé‡'},
                {id: 'chemistry_ion', name: '9.ã‚¤ã‚ªãƒ³ã¨é›»æ± '},
                {id: 'chemistry_acid', name: '10.é…¸ã€ã‚¢ãƒ«ã‚«ãƒªã€å¡©'}
            ],
            biology: [
                {id: 'biology_flower', name: '1.èŠ±ã®ã¤ãã‚Š'},
                {id: 'biology_plant', name: '2.æ ¹ãƒ»è‘‰ã®ã¤ãã‚Šã€æ¤ç‰©ã®ç‰¹å¾´ã¨åˆ†é¡'},
                {id: 'biology_animal', name: '3.å‹•ç‰©ã®ç‰¹å¾´ã¨åˆ†é¡'},
                {id: 'biology_microscope', name: '4.é¡•å¾®é¡ã®ä½¿ã„æ–¹'},
                {id: 'biology_cell', name: '5.ç”Ÿç‰©ã¨ç´°èƒ'},
                {id: 'biology_plant_body', name: '6.æ¤ç‰©ã®ã‹ã‚‰ã ã®ã¤ãã‚Šã€æ¤ç‰©ã¨æ—¥å…‰'},
                {id: 'biology_digestion', name: '7.æ¶ˆåŒ–ã¨å¸å'},
                {id: 'biology_breathing', name: '8.å‘¼å¸'},
                {id: 'biology_circulation', name: '9.è¡€æ¶²ã®å¾ªç’°ã€æ’å‡ºã®ã—ãã¿'},
                {id: 'biology_response', name: '10.åˆºæ¿€ã¨åå¿œã€å‹•ç‰©ã®ã‹ã‚‰ã '},
                {id: 'biology_growth', name: '11.ç”Ÿç‰©ã®æˆé•·ã¨ç´°èƒã®å¤‰åŒ–'},
                {id: 'biology_reproduction', name: '12.ç”Ÿç‰©ã®ç”Ÿæ®–'},
                {id: 'biology_heredity', name: '13.éºä¼ã®è¦å‰‡æ€§ã¨éºä¼å­'},
                {id: 'biology_evolution', name: '14.ç”Ÿç‰©ã®é€²åŒ–ã€ç”Ÿæ…‹ç³»ã¨é£Ÿç‰©é€£é–'},
                {id: 'biology_environment', name: '15.è‡ªç„¶ã¨ç’°å¢ƒã€äººé–“ã¨è‡ªç„¶ç’°å¢ƒ'}
            ],
            physics: [
                {id: 'physics_light', name: '1.å…‰ã«ã‚ˆã‚‹ç¾è±¡'},
                {id: 'physics_sound', name: '2.éŸ³ã«ã‚ˆã‚‹ç¾è±¡'},
                {id: 'physics_force', name: '3.åŠ›ã«ã‚ˆã‚‹ç¾è±¡'},
                {id: 'physics_current', name: '4.é›»æµã¨é›»åœ§'},
                {id: 'physics_energy', name: '5.é›»æ°—ã‚¨ãƒãƒ«ã‚®ãƒ¼'},
                {id: 'physics_magnetic', name: '6.é›»æµã¨ç£ç•Œ'},
                {id: 'physics_balance', name: '7.åŠ›ã®ã¤ã‚Šåˆã„ã¨åˆæˆãƒ»åˆ†è§£'},
                {id: 'physics_motion', name: '8.ç‰©ä½“ã®é‹å‹•'},
                {id: 'physics_pressure', name: '9.æ°´åœ§ã¨æµ®åŠ›'},
                {id: 'physics_work', name: '10.ã‚¨ãƒãƒ«ã‚®ãƒ¼ã¨ä»•äº‹'},
                {id: 'physics_energy_change', name: '11.ã‚¨ãƒãƒ«ã‚®ãƒ¼ã®ç§»ã‚Šå¤‰ã‚ã‚Š'},
                {id: 'physics_resources', name: '12.ã‚¨ãƒãƒ«ã‚®ãƒ¼è³‡æºã®åˆ©ç”¨'}
            ],
            earth: [
                {id: 'earth_volcano', name: '1.ç«å±±'},
                {id: 'earth_earthquake', name: '2.åœ°éœ‡'},
                {id: 'earth_strata', name: '3.åœ°å±¤ã®ã§ãæ–¹'},
                {id: 'earth_weather', name: '4.æ°—è±¡ã®è¦³æ¸¬ã€å¤§æ°—åœ§ã¨åœ§åŠ›'},
                {id: 'earth_front', name: '5.æ°—å›£ã¨å‰ç·šã€æ—¥æœ¬ã®å¤©æ°—'},
                {id: 'earth_cloud', name: '6.é›²ã®ã§ãæ–¹ã¨æ°´è’¸æ°—'},
                {id: 'earth_celestial', name: '7.åœ°çƒã®å‹•ãã¨å¤©ä½“ã®å‹•ã'},
                {id: 'earth_solar', name: '8.å¤ªé™½ç³»ã®å¤©ä½“'},
                {id: 'earth_moon', name: '9.æœˆã¨æƒ‘æ˜Ÿã®è¦‹ãˆæ–¹ã€è‡ªç„¶ã®æµã¿ã¨ç½å®³'}
            ],
            english_words: [
                {id: 'words_time', name: 'æœˆãƒ»åºæ•°'},
                {id: 'words_week', name: 'æ›œæ—¥'},
                {id: 'words_timeday', name: 'æ™‚ãƒ»æ™‚é–“å¸¯ãªã©'},
                {id: 'words_season', name: 'å­£ç¯€ãƒ»å®¶æ—'},
                {id: 'words_sports', name: 'ã‚¹ãƒãƒ¼ãƒ„ãƒ»æ•™ç§‘'},
                {id: 'words_job', name: 'è·æ¥­ãƒ»äººãƒ»å»ºç‰©ãƒ»æ–½è¨­'},
                {id: 'words_uncountable', name: 'æ•°ãˆã‚‰ã‚Œãªã„åè©'},
                {id: 'words_verb_important', name: 'å…¥è©¦å¿…å‡ºé‡è¦å‹•è©'},
                {id: 'words_verb_various', name: 'ã„ã‚ã„ã‚ãªæ„å‘³ã‚’ã‚‚ã¤å‹•è©'},
                {id: 'words_verb_set', name: 'ã‚»ãƒƒãƒˆã§è¦šãˆã¦ãŠããŸã„å‹•è©'},
                {id: 'words_verb_other', name: 'ãã®ä»–ã®é‡è¦å‹•è©'},
                {id: 'words_adj_quantity', name: 'æ•°ãƒ»é‡ã‚’è¡¨ã™å½¢å®¹è©'},
                {id: 'words_adj_various', name: 'ã„ã‚ã„ã‚ãªå½¢å®¹è©'},
                {id: 'words_adj_adv', name: 'ãã®ä»–ã®é‡è¦å½¢å®¹è©ãƒ»å‰¯è©'},
                {id: 'words_adv_manner', name: 'æ§˜å­ã‚’è¡¨ã™å‰¯è©'}
            ],
            english_phrases: [
                {id: 'phrases_verb', name: 'ã‚ˆãå‡ºã‚‹å‹•è©ã®ç†Ÿèª'},
                {id: 'phrases_set', name: 'ã‚»ãƒƒãƒˆã§è¦šãˆã¦ãŠããŸã„ç†Ÿèª'},
                {id: 'phrases_similar', name: 'æ„å‘³ã®ä¼¼ã¦ã„ã‚‹ç†Ÿèª'},
                {id: 'phrases_verb_other', name: 'ãã®ä»–ã®å‹•è©ã®ç†Ÿèª'},
                {id: 'phrases_be', name: 'be å‹•è©ã‚’ä½¿ã£ãŸç†Ÿèª'},
                {id: 'phrases_quantity', name: 'æ•°ã‚„é‡ã‚’è¡¨ã™ç†Ÿèª'},
                {id: 'phrases_time_place', name: 'æ™‚ãƒ»å ´æ‰€ã‚’è¡¨ã™ç†Ÿèª'},
                {id: 'phrases_important', name: 'ãã®ä»–ã®é‡è¦ç†Ÿèª'}
            ],
            english_grammar: [
                {id: 'grammar_irregular_past', name: 'ä¸è¦å‰‡å‹•è© - éå»å½¢ãƒ»éå»åˆ†è©'},
                {id: 'grammar_irregular_same', name: 'ä¸è¦å‰‡å‹•è© - éå»å½¢ã¨éå»åˆ†è©ãŒåŒã˜'},
                {id: 'grammar_irregular_special', name: 'ä¸è¦å‰‡å‹•è© - ç‰¹æ®Šãªã‚±ãƒ¼ã‚¹'},
                {id: 'grammar_be_past', name: 'be å‹•è© - éå»å½¢ãƒ»éå»åˆ†è©'},
                {id: 'grammar_regular', name: 'è¦å‰‡å‹•è© - éå»å½¢ãƒ»éå»åˆ†è©'},
                {id: 'grammar_third_person', name: 'ä¸‰äººç§°å˜æ•°ç¾åœ¨å½¢'},
                {id: 'grammar_ing', name: 'å‹•è©ã® -ing å½¢'},
                {id: 'grammar_comparative', name: 'å½¢å®¹è© - æ¯”è¼ƒç´šãƒ»æœ€ä¸Šç´š'},
                {id: 'grammar_more_most', name: 'moreã€most ã‚’ã¤ã‘ã‚‹å½¢å®¹è©'},
                {id: 'grammar_noun_plural', name: 'åè©ã®è¤‡æ•°å½¢'},
                {id: 'grammar_irregular_plural', name: 'ä¸è¦å‰‡ãªè¤‡æ•°å½¢'},
                {id: 'grammar_pronoun', name: 'äººç§°ä»£åè©'}
            ]
        };

        /* ----------------- ã‚²ãƒ¼ãƒ å¤‰æ•° ----------------- */
        let selectedCategories = [];
        let currentQuestionIndex = 0;
        let correctCount = 0;
        let wrongCount = 0;
        let totalCount = 0;
        let usedQuestions = [];
        let currentSubject = '';
        let questionMode = 'random';
        let sequentialIndex = 0;

        /* ----------------- ã‚¨ãƒ•ã‚§ã‚¯ãƒˆé–¢æ•° ----------------- */
        function createNekoParticle(text, color, x, y) {
            const particle = document.createElement('div');
            particle.className = 'cute-particle';
            particle.textContent = text;
            particle.style.color = color;
            particle.style.left = x + 'px';
            particle.style.top = y + 'px';
            particle.style.fontSize = '16px';
            document.body.appendChild(particle);

            setTimeout(() => {
                if (particle.parentNode) {
                    particle.parentNode.removeChild(particle);
                }
            }, 1500);
        }

        function createNekoParticles(x, y, emojis, count) {
            for (let i = 0; i < count; i++) {
                setTimeout(() => {
                    const emoji = emojis[Math.floor(Math.random() * emojis.length)];
                    const offsetX = (Math.random() - 0.5) * 50;
                    const offsetY = (Math.random() - 0.5) * 50;
                    createNekoParticle(emoji, '#d2691e', x + offsetX, y + offsetY);
                }, i * 40);
            }
        }

        function showNekoMsg(text, x, y) {
            const el = document.createElement('div');
            el.className = 'floating-msg';
            el.textContent = text;
            el.style.left = Math.min(x, window.innerWidth - 80) + 'px';
            el.style.top = Math.min(y, window.innerHeight - 40) + 'px';
            document.body.appendChild(el);
            setTimeout(() => el.remove(), 2000);
        }

        function showNotification(text) {
            const notification = document.getElementById('notification');
            const notificationText = document.getElementById('notificationText');
            
            const nekoText = text + (text.includes('ã«ã‚ƒ') ? '' : 'ã«ã‚ƒã€œâ™ª');
            notificationText.textContent = nekoText;
            notification.classList.add('show');
            
            soundSystem.playClick();
            soundSystem.vibrate([50, 30, 50]);
            
            setTimeout(() => {
                notification.classList.remove('show');
            }, 3000);
        }

        function addTapEffect(element) {
            element.addEventListener('click', function(e) {
                this.classList.add('tapped');
                setTimeout(() => this.classList.remove('tapped'), 600);
                
                const rect = this.getBoundingClientRect();
                const centerX = rect.left + rect.width / 2;
                const centerY = rect.top + rect.height / 2;
                
                createNekoParticles(centerX, centerY, ['âœ¨', 'ğŸŒŸ', 'ğŸ’«', 'ğŸ’–'], 3);
                
                const message = nekoMessages.tap[Math.floor(Math.random() * nekoMessages.tap.length)];
                showNekoMsg(message, centerX, centerY);
                
                soundSystem.playClick();
                soundSystem.vibrate([30]);
            });
        }

        /* ----------------- ã‚¿ã‚¤ãƒˆãƒ«çŒ«ã®ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ ----------------- */
        function bounceCat(side) {
            const catId = side === 'left' ? 'leftCat' : 'rightCat';
            const catElement = document.getElementById(catId);

            catElement.classList.add('bounce');
            soundSystem.playSuccess();
            soundSystem.vibrate([50]);

            const rect = catElement.getBoundingClientRect();
            createNekoParticles(rect.left + rect.width/2, rect.top + rect.height/2, ['ğŸ’«', 'âœ¨', 'ğŸŒŸ'], 3);
            const message = 'ã«ã‚ƒã€œã‚“â™ª';
            showNekoMsg(message, rect.left + rect.width/2, rect.top + rect.height/2);

            setTimeout(() => {
                catElement.classList.remove('bounce');
            }, 800);
        }

        function bounceTitle() {
            const titleElement = document.getElementById('gameTitle');
            titleElement.classList.add('title-bounce');

            soundSystem.playSuccess();
            soundSystem.vibrate([120, 60, 120, 60, 180]);

            const rect = titleElement.getBoundingClientRect();
            createNekoParticles(rect.left + rect.width/2, rect.top + rect.height/2, 
                              ['ğŸ’«', 'âœ¨', 'ğŸŒŸ', 'ğŸ’–', 'ğŸŠ', 'ğŸ†', 'ğŸŒˆ'], 8);

            const message = 'NEKOPON Quiz ã ã«ã‚ƒã€œâ™ª';
            showNekoMsg(message, rect.left + rect.width/2, rect.top + rect.height/2);

            setTimeout(() => {
                titleElement.classList.remove('title-bounce');
            }, 800);
        }

        /* ----------------- ã‚²ãƒ¼ãƒ ç”»é¢ã‚¿ã‚¤ãƒˆãƒ«çŒ«ã®ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ ----------------- */
        function bounceGameCat(side) {
            const catId = side === 'left' ? 'gameLeftCat' : 'gameRightCat';
            const catElement = document.getElementById(catId);

            if (!catElement) return;

            catElement.classList.add('bounce');
            soundSystem.playSuccess();
            soundSystem.vibrate([50]);

            const rect = catElement.getBoundingClientRect();
            createNekoParticles(rect.left + rect.width/2, rect.top + rect.height/2, ['ğŸ’«', 'âœ¨', 'ğŸŒŸ'], 3);
            const message = 'ã‚²ãƒ¼ãƒ ä¸­ã«ã‚ƒã€œã‚“â™ª';
            showNekoMsg(message, rect.left + rect.width/2, rect.top + rect.height/2);

            setTimeout(() => {
                catElement.classList.remove('bounce');
            }, 800);
        }

        function bounceGameTitle() {
            const titleElement = document.querySelector('#gameScreen .game-title');
            if (!titleElement) return;

            titleElement.classList.add('title-bounce');

            soundSystem.playSuccess();
            soundSystem.vibrate([120, 60, 120, 60, 180]);

            const rect = titleElement.getBoundingClientRect();
            createNekoParticles(rect.left + rect.width/2, rect.top + rect.height/2, 
                              ['ğŸ’«', 'âœ¨', 'ğŸŒŸ', 'ğŸ’–', 'ğŸŠ', 'ğŸ†', 'ğŸŒˆ'], 8);

            const message = 'ã‚¯ã‚¤ã‚ºä¸­ã ã«ã‚ƒã€œâ™ª';
            showNekoMsg(message, rect.left + rect.width/2, rect.top + rect.height/2);

            setTimeout(() => {
                titleElement.classList.remove('title-bounce');
            }, 800);
        }

        /* ----------------- è‹±èªç™ºéŸ³ã‚·ã‚¹ãƒ†ãƒ  ----------------- */
        function speakWord(wordToSpeak) {
            if (!('speechSynthesis' in window) || !wordToSpeak) return;
            
            const utterance = new SpeechSynthesisUtterance(wordToSpeak);
            const voices = speechSynthesis.getVoices();
            let preferredVoice = voices.find(v => /en-(US|GB)/.test(v.lang) && (v.name.includes('Google') || v.localService || v.default));
            if (!preferredVoice) preferredVoice = voices.find(v => /en-(US|GB)/.test(v.lang));
           
            utterance.voice = preferredVoice || voices.find(v => v.lang && v.lang.startsWith('en-')); 
            utterance.lang = utterance.voice ? utterance.voice.lang : 'en-US';
            utterance.rate = 0.9; 
            utterance.pitch = 1;
            speechSynthesis.cancel(); 
            speechSynthesis.speak(utterance);
        }

        function isEnglishCategory() {
            return selectedCategories.some(categoryId => 
                categoryId.startsWith('words_') || categoryId.startsWith('phrases_') || categoryId.startsWith('grammar_')
            );
        }

        /* ----------------- ç”»é¢é·ç§»é–¢æ•° ----------------- */
        function hideAllModals() {
            document.querySelectorAll('.modal').forEach(modal => {
                modal.classList.remove('show');
            });
        }

        function goBackToMain() {
            hideAllModals();
            document.getElementById('mainSubjectModal').classList.add('show');
            soundSystem.playClick();
        }

        function goBackToSocial() {
            hideAllModals();
            document.getElementById('socialModal').classList.add('show');
            soundSystem.playClick();
        }

        function goBackToScience() {
            hideAllModals();
            document.getElementById('scienceModal').classList.add('show');
            soundSystem.playClick();
        }

        function goBackToEnglish() {
            hideAllModals();
            document.getElementById('englishModal').classList.add('show');
            soundSystem.playClick();
        }

        /* ----------------- ã‚«ãƒ†ã‚´ãƒªãƒ¼é¸æŠã®åˆæœŸåŒ–ï¼ˆå®Œå…¨å®Ÿè£…ï¼‰ ----------------- */
        function initCategorySelection() {
            // åœ°ç†ã‚«ãƒ†ã‚´ãƒªãƒ¼
            const geographyContainer = document.getElementById('geographyCategories');
            categories.geography.forEach(category => {
                const btn = document.createElement('button');
                btn.className = 'category-btn tap-effect clickable-element';
                btn.innerHTML = category.name;
                btn.dataset.categoryId = category.id;
                btn.onclick = () => toggleCategorySelection('geography', category.id, btn);
                addTapEffect(btn);
                geographyContainer.appendChild(btn);
            });

            // æ­´å²ã‚«ãƒ†ã‚´ãƒªãƒ¼
            const historyContainer = document.getElementById('historyCategories');
            categories.history.forEach(category => {
                const btn = document.createElement('button');
                btn.className = 'category-btn tap-effect clickable-element';
                btn.innerHTML = category.name;
                btn.dataset.categoryId = category.id;
                btn.onclick = () => toggleCategorySelection('history', category.id, btn);
                addTapEffect(btn);
                historyContainer.appendChild(btn);
            });

            // å…¬æ°‘ã‚«ãƒ†ã‚´ãƒªãƒ¼
            const civicsContainer = document.getElementById('civicsCategories');
            categories.civics.forEach(category => {
                const btn = document.createElement('button');
                btn.className = 'category-btn tap-effect clickable-element';
                btn.innerHTML = category.name;
                btn.dataset.categoryId = category.id;
                btn.onclick = () => toggleCategorySelection('civics', category.id, btn);
                addTapEffect(btn);
                civicsContainer.appendChild(btn);
            });

            // åŒ–å­¦ã‚«ãƒ†ã‚´ãƒªãƒ¼ï¼ˆå­¦å¹´ã”ã¨ã«åˆ†ã‘ã¦è¡¨ç¤ºï¼‰
            const chemistryContainer = document.getElementById('chemistryCategories');
            // ä¸­1
            const grade1Label = document.createElement('div');
            grade1Label.className = 'grade-label clickable-element';
            grade1Label.textContent = 'ä¸­å­¦1å¹´ç”Ÿ';
            chemistryContainer.appendChild(grade1Label);
            categories.chemistry.slice(0, 4).forEach(category => {
                const btn = document.createElement('button');
                btn.className = 'category-btn tap-effect clickable-element';
                btn.innerHTML = category.name;
                btn.dataset.categoryId = category.id;
                btn.onclick = () => toggleCategorySelection('chemistry', category.id, btn);
                addTapEffect(btn);
                chemistryContainer.appendChild(btn);
            });
            // ä¸­2
            const grade2Label = document.createElement('div');
            grade2Label.className = 'grade-label clickable-element';
            grade2Label.textContent = 'ä¸­å­¦2å¹´ç”Ÿ';
            chemistryContainer.appendChild(grade2Label);
            categories.chemistry.slice(4, 8).forEach(category => {
                const btn = document.createElement('button');
                btn.className = 'category-btn tap-effect clickable-element';
                btn.innerHTML = category.name;
                btn.dataset.categoryId = category.id;
                btn.onclick = () => toggleCategorySelection('chemistry', category.id, btn);
                addTapEffect(btn);
                chemistryContainer.appendChild(btn);
            });
            // ä¸­3
            const grade3Label = document.createElement('div');
            grade3Label.className = 'grade-label clickable-element';
            grade3Label.textContent = 'ä¸­å­¦3å¹´ç”Ÿ';
            chemistryContainer.appendChild(grade3Label);
            categories.chemistry.slice(8).forEach(category => {
                const btn = document.createElement('button');
                btn.className = 'category-btn tap-effect clickable-element';
                btn.innerHTML = category.name;
                btn.dataset.categoryId = category.id;
                btn.onclick = () => toggleCategorySelection('chemistry', category.id, btn);
                addTapEffect(btn);
                chemistryContainer.appendChild(btn);
            });

            // ç”Ÿç‰©ã‚«ãƒ†ã‚´ãƒªãƒ¼ï¼ˆå­¦å¹´ã”ã¨ã«åˆ†ã‘ã¦è¡¨ç¤ºï¼‰
            const biologyContainer = document.getElementById('biologyCategories');
            // ä¸­1
            const bioGrade1Label = document.createElement('div');
            bioGrade1Label.className = 'grade-label clickable-element';
            bioGrade1Label.textContent = 'ä¸­å­¦1å¹´ç”Ÿ';
            biologyContainer.appendChild(bioGrade1Label);
            categories.biology.slice(0, 3).forEach(category => {
                const btn = document.createElement('button');
                btn.className = 'category-btn tap-effect clickable-element';
                btn.innerHTML = category.name;
                btn.dataset.categoryId = category.id;
                btn.onclick = () => toggleCategorySelection('biology', category.id, btn);
                addTapEffect(btn);
                biologyContainer.appendChild(btn);
            });
            // ä¸­2
            const bioGrade2Label = document.createElement('div');
            bioGrade2Label.className = 'grade-label clickable-element';
            bioGrade2Label.textContent = 'ä¸­å­¦2å¹´ç”Ÿ';
            biologyContainer.appendChild(bioGrade2Label);
            categories.biology.slice(3, 10).forEach(category => {
                const btn = document.createElement('button');
                btn.className = 'category-btn tap-effect clickable-element';
                btn.innerHTML = category.name;
                btn.dataset.categoryId = category.id;
                btn.onclick = () => toggleCategorySelection('biology', category.id, btn);
                addTapEffect(btn);
                biologyContainer.appendChild(btn);
            });
            // ä¸­3
            const bioGrade3Label = document.createElement('div');
            bioGrade3Label.className = 'grade-label clickable-element';
            bioGrade3Label.textContent = 'ä¸­å­¦3å¹´ç”Ÿ';
            biologyContainer.appendChild(bioGrade3Label);
            categories.biology.slice(10).forEach(category => {
                const btn = document.createElement('button');
                btn.className = 'category-btn tap-effect clickable-element';
                btn.innerHTML = category.name;
                btn.dataset.categoryId = category.id;
                btn.onclick = () => toggleCategorySelection('biology', category.id, btn);
                addTapEffect(btn);
                biologyContainer.appendChild(btn);
            });

            // ç‰©ç†ã‚«ãƒ†ã‚´ãƒªãƒ¼ï¼ˆå­¦å¹´ã”ã¨ã«åˆ†ã‘ã¦è¡¨ç¤ºï¼‰
            const physicsContainer = document.getElementById('physicsCategories');
            // ä¸­1
            const phyGrade1Label = document.createElement('div');
            phyGrade1Label.className = 'grade-label clickable-element';
            phyGrade1Label.textContent = 'ä¸­å­¦1å¹´ç”Ÿ';
            physicsContainer.appendChild(phyGrade1Label);
            categories.physics.slice(0, 3).forEach(category => {
                const btn = document.createElement('button');
                btn.className = 'category-btn tap-effect clickable-element';
                btn.innerHTML = category.name;
                btn.dataset.categoryId = category.id;
                btn.onclick = () => toggleCategorySelection('physics', category.id, btn);
                addTapEffect(btn);
                physicsContainer.appendChild(btn);
            });
            // ä¸­2
            const phyGrade2Label = document.createElement('div');
            phyGrade2Label.className = 'grade-label clickable-element';
            phyGrade2Label.textContent = 'ä¸­å­¦2å¹´ç”Ÿ';
            physicsContainer.appendChild(phyGrade2Label);
            categories.physics.slice(3, 6).forEach(category => {
                const btn = document.createElement('button');
                btn.className = 'category-btn tap-effect clickable-element';
                btn.innerHTML = category.name;
                btn.dataset.categoryId = category.id;
                btn.onclick = () => toggleCategorySelection('physics', category.id, btn);
                addTapEffect(btn);
                physicsContainer.appendChild(btn);
            });
            // ä¸­3
            const phyGrade3Label = document.createElement('div');
            phyGrade3Label.className = 'grade-label clickable-element';
            phyGrade3Label.textContent = 'ä¸­å­¦3å¹´ç”Ÿ';
            physicsContainer.appendChild(phyGrade3Label);
            categories.physics.slice(6).forEach(category => {
                const btn = document.createElement('button');
                btn.className = 'category-btn tap-effect clickable-element';
                btn.innerHTML = category.name;
                btn.dataset.categoryId = category.id;
                btn.onclick = () => toggleCategorySelection('physics', category.id, btn);
                addTapEffect(btn);
                physicsContainer.appendChild(btn);
            });

            // åœ°å­¦ã‚«ãƒ†ã‚´ãƒªãƒ¼ï¼ˆå­¦å¹´ã”ã¨ã«åˆ†ã‘ã¦è¡¨ç¤ºï¼‰
            const earthContainer = document.getElementById('earthCategories');
            // ä¸­1
            const earthGrade1Label = document.createElement('div');
            earthGrade1Label.className = 'grade-label clickable-element';
            earthGrade1Label.textContent = 'ä¸­å­¦1å¹´ç”Ÿ';
            earthContainer.appendChild(earthGrade1Label);
            categories.earth.slice(0, 3).forEach(category => {
                const btn = document.createElement('button');
                btn.className = 'category-btn tap-effect clickable-element';
                btn.innerHTML = category.name;
                btn.dataset.categoryId = category.id;
                btn.onclick = () => toggleCategorySelection('earth', category.id, btn);
                addTapEffect(btn);
                earthContainer.appendChild(btn);
            });
            // ä¸­2
            const earthGrade2Label = document.createElement('div');
            earthGrade2Label.className = 'grade-label clickable-element';
            earthGrade2Label.textContent = 'ä¸­å­¦2å¹´ç”Ÿ';
            earthContainer.appendChild(earthGrade2Label);
            categories.earth.slice(3, 6).forEach(category => {
                const btn = document.createElement('button');
                btn.className = 'category-btn tap-effect clickable-element';
                btn.innerHTML = category.name;
                btn.dataset.categoryId = category.id;
                btn.onclick = () => toggleCategorySelection('earth', category.id, btn);
                addTapEffect(btn);
                earthContainer.appendChild(btn);
            });
            // ä¸­3
            const earthGrade3Label = document.createElement('div');
            earthGrade3Label.className = 'grade-label clickable-element';
            earthGrade3Label.textContent = 'ä¸­å­¦3å¹´ç”Ÿ';
            earthContainer.appendChild(earthGrade3Label);
            categories.earth.slice(6).forEach(category => {
                const btn = document.createElement('button');
                btn.className = 'category-btn tap-effect clickable-element';
                btn.innerHTML = category.name;
                btn.dataset.categoryId = category.id;
                btn.onclick = () => toggleCategorySelection('earth', category.id, btn);
                addTapEffect(btn);
                earthContainer.appendChild(btn);
            });

            // è‹±å˜èªã‚«ãƒ†ã‚´ãƒªãƒ¼
            const englishWordsContainer = document.getElementById('englishWordsCategories');
            categories.english_words.forEach(category => {
                const btn = document.createElement('button');
                btn.className = 'category-btn tap-effect clickable-element';
                btn.innerHTML = category.name;
                btn.dataset.categoryId = category.id;
                btn.onclick = () => toggleCategorySelection('english_words', category.id, btn);
                addTapEffect(btn);
                englishWordsContainer.appendChild(btn);
            });

            // è‹±ç†Ÿèªã‚«ãƒ†ã‚´ãƒªãƒ¼
            const englishPhrasesContainer = document.getElementById('englishPhrasesCategories');
            categories.english_phrases.forEach(category => {
                const btn = document.createElement('button');
                btn.className = 'category-btn tap-effect clickable-element';
                btn.innerHTML = category.name;
                btn.dataset.categoryId = category.id;
                btn.onclick = () => toggleCategorySelection('english_phrases', category.id, btn);
                addTapEffect(btn);
                englishPhrasesContainer.appendChild(btn);
            });

            // èªå½¢å¤‰åŒ–ã‚«ãƒ†ã‚´ãƒªãƒ¼
            const englishGrammarContainer = document.getElementById('englishGrammarCategories');
            categories.english_grammar.forEach(category => {
                const btn = document.createElement('button');
                btn.className = 'category-btn tap-effect clickable-element';
                btn.innerHTML = category.name;
                btn.dataset.categoryId = category.id;
                btn.onclick = () => toggleCategorySelection('english_grammar', category.id, btn);
                addTapEffect(btn);
                englishGrammarContainer.appendChild(btn);
            });
        }

        function toggleCategorySelection(subject, categoryId, buttonElement) {
            soundSystem.playClick();
            if (selectedCategories.includes(categoryId)) {
                selectedCategories = selectedCategories.filter(id => id !== categoryId);
                buttonElement.classList.remove('active');
            } else {
                selectedCategories.push(categoryId);
                buttonElement.classList.add('active');
            }

            // ã‚¯ã‚¤ã‚ºé–‹å§‹ãƒœã‚¿ãƒ³ã®çŠ¶æ…‹ã‚’æ›´æ–°
            const camelCase = subject.split('_')
                .map((word, index) => index === 0 ? word.charAt(0).toUpperCase() + word.slice(1) : word.charAt(0).toUpperCase() + word.slice(1))
                .join('');
            const startButton = document.getElementById(`start${camelCase}Quiz`);

            if (startButton) {
                startButton.disabled = selectedCategories.length === 0;
                startButton.style.opacity = selectedCategories.length === 0 ? '0.5' : '1';
            }
        }

        function startSelectedQuiz(subject, subjectName) {
            currentSubject = subject;
            hideAllModals();
            document.getElementById('currentCategory').innerHTML = `<span class="rotating-icon">${subjectName}</span> - ${selectedCategories.length}å˜å…ƒé¸æŠä¸­ã ã«ã‚ƒã€œâ™ª`;
            document.getElementById('gameScreen').classList.remove('hidden');
            
            const floatingBtn = document.getElementById('changeSubject');
            floatingBtn.classList.remove('hidden');
            floatingBtn.style.display = 'flex';

            correctCount = 0;
            wrongCount = 0;
            totalCount = 0;
            usedQuestions = [];
            sequentialIndex = 0;
            updateStats();
            showNotification(`${subjectName}ã®${selectedCategories.length}å˜å…ƒã‚’é¸æŠã—ãŸã«ã‚ƒã€œâ™ª`);
        }

        function updateStats() {
            document.getElementById('correctCount').textContent = correctCount;
            document.getElementById('wrongCount').textContent = wrongCount;
            document.getElementById('totalCount').textContent = totalCount;
            
            document.querySelector('.stats-display').classList.add('score-pulse');
            setTimeout(() => {
                document.querySelector('.stats-display').classList.remove('score-pulse');
            }, 600);
        }

        function setQuestionMode(mode) {
            questionMode = mode;
            
            document.getElementById('randomModeBtn').classList.remove('active');
            document.getElementById('sequentialModeBtn').classList.remove('active');
            
            if (mode === 'random') {
                document.getElementById('randomModeBtn').classList.add('active');
                document.getElementById('modeDescription').textContent = 'å•é¡Œã‚’ãƒ©ãƒ³ãƒ€ãƒ ã«å‡ºé¡Œã™ã‚‹ã«ã‚ƒã€œâ™ª';
                usedQuestions = [];
                showNotification('ãƒ©ãƒ³ãƒ€ãƒ å‡ºé¡Œã«åˆ‡ã‚Šæ›¿ãˆãŸã«ã‚ƒã€œ');
            } else {
                document.getElementById('sequentialModeBtn').classList.add('active');
                document.getElementById('modeDescription').textContent = 'å•é¡Œã‚’é †ç•ªé€šã‚Šã«å‡ºé¡Œã™ã‚‹ã«ã‚ƒã€œâ™ª';
                sequentialIndex = 0;
                showNotification('é †ç•ªé€šã‚Šå‡ºé¡Œã«åˆ‡ã‚Šæ›¿ãˆãŸã«ã‚ƒã€œ');
            }
        }

        /* ----------------- ã‚¯ã‚¤ã‚ºæ©Ÿèƒ½ ----------------- */
        function openQuiz() {
            if (selectedCategories.length === 0) {
                showNotification('å˜å…ƒã‚’é¸æŠã—ã¦ã»ã—ã„ã«ã‚ƒã€œ');
                return;
            }

            let allProblems = [];
            selectedCategories.forEach(categoryId => {
                if (problemDatabase[categoryId]) {
                    allProblems = allProblems.concat(problemDatabase[categoryId]);
                }
            });

            if (allProblems.length === 0) {
                showNotification('å•é¡ŒãŒã¾ã æº–å‚™ä¸­ã ã«ã‚ƒã€œ');
                return;
            }

            if (usedQuestions.length >= allProblems.length) {
                usedQuestions = [];
                showNotification('å…¨å•ã‚¯ãƒªã‚¢ã ã«ã‚ƒã€œâ™ª ãƒªã‚»ãƒƒãƒˆã—ãŸã«ã‚ƒï¼');
            }

            let quiz;
            let remainingCount;
            
            if (questionMode === 'random') {
                const availableQuestions = allProblems.filter((_, index) => !usedQuestions.includes(index));
                if (availableQuestions.length === 0) return;
                
                const randomIndex = Math.floor(Math.random() * availableQuestions.length);
                quiz = availableQuestions[randomIndex];
                const originalIndex = allProblems.indexOf(quiz);
                usedQuestions.push(originalIndex);
                remainingCount = allProblems.length - usedQuestions.length;
            } else {
                if (sequentialIndex >= allProblems.length) {
                    sequentialIndex = 0;
                    showNotification('å…¨å•é¡Œã‚’ä¸€å‘¨ã—ãŸã«ã‚ƒã€œâ™ª æœ€åˆã‹ã‚‰å†é–‹ã«ã‚ƒï¼');
                }
                quiz = allProblems[sequentialIndex];
                sequentialIndex++;
                remainingCount = allProblems.length - sequentialIndex;
                if (remainingCount < 0) remainingCount = 0;
            }

            const modal = document.getElementById('quizModal');
            const qEl = document.getElementById('quizQ');
            const optDiv = document.getElementById('quizOptions');
            const msgEl = document.getElementById('quizMsg');
            const explanationEl = document.getElementById('quizExplanation');
            const nextBtn = document.getElementById('quizNext');
            const backBtn = document.getElementById('quizBack');

            qEl.textContent = `${quiz.q} (æ®‹ã‚Š${remainingCount}å•ã ã«ã‚ƒã€œ)`;
            optDiv.innerHTML = '';
            msgEl.textContent = '';
            explanationEl.classList.remove('has-content');

            if (isEnglishCategory()) {
                speakWord(quiz.q);
            }

            nextBtn.disabled = false;
            nextBtn.style.opacity = '1';
            backBtn.disabled = false;
            backBtn.style.opacity = '1';

            let firstAnswer = false;

            quiz.opts.forEach((txt, i) => {
                const btn = document.createElement('button');
                btn.textContent = txt;
                btn.className = 'quiz-option w-full tap-effect clickable-element';
                
                addTapEffect(btn);
                
                btn.onclick = () => {
                    if (isEnglishCategory()) {
                        speakWord(txt);
                    }
                    
                    if (!firstAnswer) {
                        firstAnswer = true;
                        totalCount++;
                        if (i === quiz.ans) {
                            correctCount++;
                            soundSystem.playCorrect();
                            soundSystem.vibrate([100, 50, 100, 50, 150]);
                            
                            const correctMsg = nekoMessages.correct[Math.floor(Math.random() * nekoMessages.correct.length)];
                            showNotification(correctMsg);
                            
                            const rect = btn.getBoundingClientRect();
                            createNekoParticles(rect.left + rect.width/2, rect.top + rect.height/2, 
                                              ['âœ¨', 'ğŸŒŸ', 'ğŸ’«', 'ğŸ‰', 'ğŸŠ'], 5);

                            // æ­£è§£ã§ãƒœãƒ¼ãƒŠã‚¹
                            pointSystem.sparklePoints += 500;
                            pointSystem.firePoints += 250;
                            pointSystem.trophyPoints += 1000;
                            pointSystem.updateAllPointDisplays();
                            pointSystem.showFloatingPoints(1750, rect.left + rect.width/2, rect.top + rect.height/2, 'ultra');
                        } else {
                            wrongCount++;
                            soundSystem.playWrong();
                            soundSystem.vibrate([80, 40, 80]);
                            
                            const wrongMsg = nekoMessages.wrong[Math.floor(Math.random() * nekoMessages.wrong.length)];
                            showNotification(wrongMsg);

                            // ä¸æ­£è§£ã§ã‚‚åŠ±ã¾ã—ãƒœãƒ¼ãƒŠã‚¹
                            pointSystem.sparklePoints += 50;
                            pointSystem.firePoints += 25;
                            pointSystem.trophyPoints += 100;
                            pointSystem.updateAllPointDisplays();
                            pointSystem.showFloatingPoints(175, rect.left + rect.width/2, rect.top + rect.height/2, 'bonus');
                        }
                        updateStats();
                    }
                    
                    if (i === quiz.ans) {
                        msgEl.innerHTML = `ğŸ‰ æ­£è§£ã ã«ã‚ƒã€œâ™ª ${quiz.exp || ''}`;
                        msgEl.style.color = 'var(--light-brown)';
                    } else {
                        msgEl.innerHTML = `âŒ æ®‹å¿µã«ã‚ƒã€œ...æ­£è§£ã¯ã€Œ${quiz.opts[quiz.ans]}ã€ã ã«ã‚ƒâ™ª ${quiz.exp || ''}`;
                        msgEl.style.color = '#cd5c5c';
                    }
                    explanationEl.classList.add('has-content');
                };
                optDiv.appendChild(btn);
            });

            nextBtn.onclick = () => {
                soundSystem.playSuccess();
                modal.classList.remove('show');
                loadNextQuiz();
            };

            backBtn.onclick = () => {
                soundSystem.playClick();
                modal.classList.remove('show');
                showNotification('ãŠç–²ã‚Œæ§˜ã ã£ãŸã«ã‚ƒã€œâ™ª');
            };

            modal.classList.add('show');
        }

        function loadNextQuiz() {
            openQuiz();
        }

        /* ----------------- ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼è¨­å®šï¼ˆå®Œå…¨ç‰ˆï¼‰ ----------------- */
        function initEventListeners() {
            // ã‚¿ã‚¤ãƒˆãƒ«ã‚¿ãƒƒãƒ—ã‚¤ãƒ™ãƒ³ãƒˆ
            document.getElementById('gameTitle').addEventListener('click', (e) => {
                e.stopPropagation();
                bounceTitle();
            });

            // ã‚¿ã‚¤ãƒˆãƒ«çŒ«ã®ã‚¿ãƒƒãƒ—ï¼ˆãƒ›ãƒ¼ãƒ ç”»é¢ï¼‰
            document.getElementById('leftCat').addEventListener('click', (e) => {
                e.stopPropagation();
                bounceCat('left');
            });

            document.getElementById('rightCat').addEventListener('click', (e) => {
                e.stopPropagation();
                bounceCat('right');
            });

            // ã‚²ãƒ¼ãƒ ç”»é¢ã®ã‚¿ã‚¤ãƒˆãƒ«ã‚¿ãƒƒãƒ—ã‚¤ãƒ™ãƒ³ãƒˆ
            const gameTitle = document.querySelector('#gameScreen .game-title');
            if (gameTitle) {
                gameTitle.addEventListener('click', (e) => {
                    e.stopPropagation();
                    bounceGameTitle();
                });
            }

            // ã‚²ãƒ¼ãƒ ç”»é¢ã®çŒ«ã®ã‚¿ãƒƒãƒ—ã‚¤ãƒ™ãƒ³ãƒˆ
            document.getElementById('gameLeftCat').addEventListener('click', (e) => {
                e.stopPropagation();
                bounceGameCat('left');
            });

            document.getElementById('gameRightCat').addEventListener('click', (e) => {
                e.stopPropagation();
                bounceGameCat('right');
            });

            // ãƒ¡ã‚¤ãƒ³æ•™ç§‘é¸æŠ
            document.querySelectorAll('[data-subject]').forEach(btn => {
                btn.addEventListener('click', (e) => {
                    soundSystem.playSuccess();
                    const subject = e.currentTarget.dataset.subject;
                    hideAllModals();
                    document.getElementById(subject + 'Modal').classList.add('show');
                });
            });

            // è©³ç´°ã‚«ãƒ†ã‚´ãƒªé¸æŠ
            document.querySelectorAll('[data-category]').forEach(btn => {
                btn.addEventListener('click', (e) => {
                    soundSystem.playClick();
                    const category = e.currentTarget.dataset.category;
                    selectedCategories = [];
                    hideAllModals();
                    
                    const modalId = category.split('_')
                        .map((word, index) => index === 0 ? word : word.charAt(0).toUpperCase() + word.slice(1))
                        .join('');
                    
                    const modal = document.getElementById(modalId + 'Modal');
                    modal.classList.add('show');
                    
                    // ãƒ¢ãƒ¼ãƒ€ãƒ«è¡¨ç¤ºå¾Œã€ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«ä½ç½®ã‚’æœ€ä¸Šéƒ¨ã«ãƒªã‚»ãƒƒãƒˆ
                    setTimeout(() => {
                        const modalCard = modal.querySelector('.clean-card');
                        if (modalCard) {
                            modalCard.scrollTop = 0;
                        }
                    }, 50);
                });
            });

            // ã‚¯ã‚¤ã‚ºé–‹å§‹ãƒœã‚¿ãƒ³ç¾¤
            document.getElementById('startGeographyQuiz').addEventListener('click', () => {
                soundSystem.playSuccess();
                startSelectedQuiz('geography', 'ğŸ—ºï¸ åœ°ç†');
            });
            document.getElementById('startHistoryQuiz').addEventListener('click', () => {
                soundSystem.playSuccess();
                startSelectedQuiz('history', 'ğŸ›ï¸ æ­´å²');
            });
            document.getElementById('startCivicsQuiz').addEventListener('click', () => {
                soundSystem.playSuccess();
                startSelectedQuiz('civics', 'âš–ï¸ å…¬æ°‘');
            });
            document.getElementById('startChemistryQuiz').addEventListener('click', () => {
                soundSystem.playSuccess();
                startSelectedQuiz('chemistry', 'ğŸ§ª åŒ–å­¦');
            });
            document.getElementById('startBiologyQuiz').addEventListener('click', () => {
                soundSystem.playSuccess();
                startSelectedQuiz('biology', 'ğŸ§¬ ç”Ÿç‰©');
            });
            document.getElementById('startPhysicsQuiz').addEventListener('click', () => {
                soundSystem.playSuccess();
                startSelectedQuiz('physics', 'âš›ï¸ ç‰©ç†');
            });
            document.getElementById('startEarthQuiz').addEventListener('click', () => {
                soundSystem.playSuccess();
                startSelectedQuiz('earth', 'ğŸŒ åœ°å­¦');
            });
            document.getElementById('startEnglishWordsQuiz').addEventListener('click', () => {
                soundSystem.playSuccess();
                startSelectedQuiz('english_words', 'ğŸ“ è‹±å˜èª');
            });
            document.getElementById('startEnglishPhrasesQuiz').addEventListener('click', () => {
                soundSystem.playSuccess();
                startSelectedQuiz('english_phrases', 'ğŸ’¬ è‹±ç†Ÿèª');
            });
            document.getElementById('startEnglishGrammarQuiz').addEventListener('click', () => {
                soundSystem.playSuccess();
                startSelectedQuiz('english_grammar', 'ğŸ“˜ èªå½¢å¤‰åŒ–');
            });

            // å‡ºé¡Œå½¢å¼åˆ‡ã‚Šæ›¿ãˆãƒœã‚¿ãƒ³
            document.getElementById('randomModeBtn').addEventListener('click', () => {
                soundSystem.playClick();
                setQuestionMode('random');
            });
            
            document.getElementById('sequentialModeBtn').addEventListener('click', () => {
                soundSystem.playClick();
                setQuestionMode('sequential');
            });

            // ãƒ¡ã‚¤ãƒ³ã‚¯ã‚¤ã‚ºã‚¹ã‚¿ãƒ¼ãƒˆãƒœã‚¿ãƒ³
            document.getElementById('startQuizButton').addEventListener('click', () => {
                soundSystem.playSuccess();
                const startMsg = nekoMessages.start[Math.floor(Math.random() * nekoMessages.start.length)];
                showNotification(startMsg);
                openQuiz();
            });

            // æ•™ç§‘å¤‰æ›´ãƒœã‚¿ãƒ³
            document.getElementById('changeSubject').addEventListener('click', (e) => {
                e.preventDefault();
                e.stopPropagation();
                soundSystem.playClick();
                selectedCategories = [];
                sequentialIndex = 0;
                usedQuestions = [];
                document.getElementById('gameScreen').classList.add('hidden');
                document.getElementById('changeSubject').classList.add('hidden');
                goBackToMain();
                showNotification('æ•™ç§‘é¸æŠã«æˆ»ã£ãŸã«ã‚ƒã€œâ™ª');
            });
        }

        /* ----------------- åˆæœŸåŒ–ï¼ˆå®Œå…¨ç‰ˆï¼‰ ----------------- */
        document.addEventListener('DOMContentLoaded', () => {
            // åŸºæœ¬ã‚·ã‚¹ãƒ†ãƒ ã®åˆæœŸåŒ–
            initCategorySelection();
            initEventListeners();
            
            document.getElementById('changeSubject').classList.add('hidden');
            
            // ã‚¿ãƒƒãƒ—ã‚¨ãƒ•ã‚§ã‚¯ãƒˆã®è¿½åŠ 
            document.querySelectorAll('.tap-effect').forEach(addTapEffect);

            // é‡åŠ›æ„ŸçŸ¥ã‚·ã‚¹ãƒ†ãƒ ã®åˆæœŸåŒ–ï¼ˆæœ€å„ªå…ˆãƒ»ãƒˆãƒƒãƒ—ãƒšãƒ¼ã‚¸è¡¨ç¤ºå¾Œï¼‰
            tiltSystem.init();

            // éŸ³å£°ã‚·ã‚¹ãƒ†ãƒ ã®åˆæœŸåŒ–
            document.addEventListener('click', () => {
                if (soundSystem.audioContext && soundSystem.audioContext.state === 'suspended') {
                    soundSystem.audioContext.resume();
                }
            }, { once: true });

            // éŸ³å£°åˆæˆã®åˆæœŸåŒ–
            if ('speechSynthesis' in window && typeof speechSynthesis.getVoices === 'function') {
                const voicePolling = setInterval(() => {
                    if (speechSynthesis.getVoices().length) {
                        clearInterval(voicePolling);
                    } else {
                        speechSynthesis.getVoices(); 
                    }
                }, 200);
            }

            // ã‚¦ã‚§ãƒ«ã‚«ãƒ ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã¨ã‚¨ãƒ•ã‚§ã‚¯ãƒˆ
            setTimeout(() => {
                showNotification('NEKOPON Quizã¸ã‚ˆã†ã“ãã«ã‚ƒã€œâ™ª');
                
                // ç”»é¢å…¨ä½“ã«ã‚¦ã‚§ãƒ«ã‚«ãƒ ãƒ‘ãƒ¼ãƒ†ã‚£ã‚¯ãƒ«
                for (let i = 0; i < 15; i++) {
                    setTimeout(() => {
                        const x = Math.random() * window.innerWidth;
                        const y = Math.random() * window.innerHeight;
                        pointSystem.createCuteParticles(x, y, 
                            ['ğŸ‰', 'ğŸŠ', 'âœ¨', 'ğŸŒŸ', 'ğŸ’«', 'ğŸ±', 'ğŸ“š', 'ğŸ“'], 3);
                    }, i * 200);
                }
            }, 1000);
            
            // ã‚¯ãƒªãƒƒã‚«ãƒ¼èª¬æ˜
            setTimeout(() => {
                showNotification('ã©ã“ã§ã‚‚ã‚¿ãƒƒãƒ—ã§ãƒã‚¤ãƒ³ãƒˆã‚²ãƒƒãƒˆã«ã‚ƒã€œâ™ª');
            }, 4000);
            
            // é‡åŠ›æ„ŸçŸ¥èª¬æ˜ï¼ˆæœ‰åŠ¹ã«ãªã£ãŸå¾Œã«è¡¨ç¤ºï¼‰
            setTimeout(() => {
                if (tiltSystem.tiltEnabled) {
                    showNotification('ã‚¹ãƒãƒ›ã‚’å‚¾ã‘ã‚‹ã¨ã‚¢ã‚¤ã‚³ãƒ³ãŒã‚¯ãƒ«ã‚¯ãƒ«å›ã‚‹ã«ã‚ƒã€œâ™ª');
                }
            }, 7000);

            // è¿½åŠ ã®ãƒ’ãƒ³ãƒˆ
            setTimeout(() => {
                showNotification('ãƒã‚¤ãƒ³ãƒˆãƒãƒ–ãƒ«ã‚‚ç›´æ¥ã‚¿ãƒƒãƒ—ã§ãã‚‹ã«ã‚ƒã€œâ™ª');
            }, 10000);
        });
    </script>
</body>
</html>