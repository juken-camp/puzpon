<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>ğŸ§ª Chemi Quiz - è»½å¿«ãªåŒ–å­¦å¼ã‚²ãƒ¼ãƒ  ğŸ§ª</title>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=M+PLUS+Rounded+1c:wght@400;700&display=swap');
        
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            -webkit-user-select: none;
            -moz-user-select: none;
            -ms-user-select: none;
            user-select: none;
            -webkit-touch-callout: none;
            -webkit-tap-highlight-color: transparent;
        }
        
        :root {
            --primary-purple: #6b46c1;
            --light-purple: #a78bfa;
            --cream: #fef7ff;
            --white: #ffffff;
            --soft-pink: #fce7f3;
            --gold: #fbbf24;
            --green: #10b981;
            --blue: #3b82f6;
            --shadow: rgba(107,70,193,0.25);
            --neon-pink: #ff1493;
            --neon-blue: #00bfff;
            --neon-green: #00ff00;
        }
        
        body {
            font-family: 'M PLUS Rounded 1c', sans-serif;
            background: linear-gradient(135deg, #fef7ff 0%, #fce7f3 50%, #e0e7ff 100%);
            color: var(--primary-purple);
            font-weight: 700;
            height: 100vh;
            height: 100dvh;
            touch-action: manipulation;
            overflow: hidden;
            position: fixed;
            width: 100%;
        }

        .kawaii-container {
            height: 100vh;
            height: 100dvh;
            display: flex;
            flex-direction: column;
            position: relative;
            overflow: hidden;
        }

        /* æ”¹å–„ã•ã‚ŒãŸãƒ˜ãƒƒãƒ€ãƒ¼ */
        .header {
            background: rgba(255,255,255,0.95);
            backdrop-filter: blur(10px);
            border-radius: 0 0 15px 15px;
            box-shadow: 0 2px 10px var(--shadow);
            z-index: 1000;
            padding: 12px 10px; /* ãƒ‘ãƒ‡ã‚£ãƒ³ã‚°ã‚’èª¿æ•´ */
            flex-shrink: 0;
        }

        /* ã‚¿ã‚¤ãƒˆãƒ«ã‚¨ãƒªã‚¢ */
        .title-area {
            text-align: center;
            margin-bottom: 10px;
        }

        .game-title {
            font-size: 1.3rem;
            background: linear-gradient(45deg, var(--primary-purple), var(--light-purple), var(--gold));
            background-size: 200% 200%;
            -webkit-background-clip: text;
            background-clip: text;
            -webkit-text-fill-color: transparent;
            animation: rainbow-shift 3s ease-in-out infinite;
            cursor: pointer;
            transition: all 0.3s ease;
            margin-bottom: 8px;
        }

        @keyframes rainbow-shift {
            0%, 100% { background-position: 0% 50%; }
            50% { background-position: 100% 50%; }
        }

        .chemistry-icon {
            display: inline-block;
            font-size: 1em;
            margin: 0 4px;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        /* ã‚³ãƒ³ãƒ‘ã‚¯ãƒˆãªã‚¹ã‚³ã‚¢ã‚¨ãƒªã‚¢ */
        .score-area {
            display: flex;
            justify-content: center;
            gap: 20px;
            padding: 5px;
            background: rgba(255,255,255,0.7);
            border-radius: 8px;
            backdrop-filter: blur(10px);
            margin-bottom: 10px;
        }

        .score-item {
            text-align: center;
            cursor: pointer;
            transition: all 0.3s ease;
            padding: 2px 6px;
            border-radius: 4px;
            min-width: 45px;
        }

        .score-number {
            font-size: 0.85rem;
            font-weight: 700;
            color: var(--primary-purple);
            line-height: 1;
        }

        .score-label {
            font-size: 0.6em;
            color: var(--light-purple);
            line-height: 1;
            margin-top: 1px;
        }

        /* ãƒœã‚¿ãƒ³ã‚¨ãƒªã‚¢ - æ ¹æœ¬çš„æ”¹å–„ */
        .buttons-area {
            display: flex;
            flex-direction: column;
            gap: 8px;
            max-width: 100%; /* æœ€å¤§å¹…ã‚’100%ã« */
            margin: 0;
            width: 100%;
            padding: 0 15px; /* å¤§å¹…ã«ãƒ‘ãƒ‡ã‚£ãƒ³ã‚°ã‚’å¢—åŠ  */
        }

        /* ãƒ¢ãƒ¼ãƒ‰é¸æŠãƒœã‚¿ãƒ³ç¾¤ - å®Œå…¨åˆ‡ã‚Œé˜²æ­¢å¯¾å¿œ */
        .mode-selector {
            display: flex;
            gap: 2px; /* ã‚®ãƒ£ãƒƒãƒ—ã‚’å°ã•ã */
            justify-content: center;
            overflow-x: auto;
            overflow-y: hidden;
            padding: 2px 15px; /* å·¦å³ã®ãƒ‘ãƒ‡ã‚£ãƒ³ã‚°ã‚’å¤§å¹…å¢—åŠ  */
            margin: 0; /* ãƒãƒ¼ã‚¸ãƒ³ã‚’å‰Šé™¤ */
            scroll-behavior: smooth;
            -webkit-overflow-scrolling: touch;
            scrollbar-width: none;
            -ms-overflow-style: none;
        }

        .mode-selector::-webkit-scrollbar {
            display: none;
        }

        .mode-btn {
            background: rgba(255,255,255,0.9);
            border: 2px solid var(--light-purple);
            border-radius: 10px;
            padding: 4px 5px; /* ãƒ‘ãƒ‡ã‚£ãƒ³ã‚°ã‚’èª¿æ•´ */
            cursor: pointer;
            transition: all 0.3s ease;
            color: var(--primary-purple);
            font-weight: 700;
            backdrop-filter: blur(10px);
            text-align: center;
            font-size: 0.58em; /* ã•ã‚‰ã«ãƒ•ã‚©ãƒ³ãƒˆã‚µã‚¤ã‚ºã‚’ç¸®å° */
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            min-width: 42px; /* æœ€å°å¹…ã‚’å°ã•ã */
            line-height: 1.1;
            white-space: nowrap;
            flex-shrink: 0;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 1px; /* ã‚®ãƒ£ãƒƒãƒ—ã‚’å°ã•ã */
        }

        .mode-btn:hover {
            background: rgba(255,255,255,0.95);
            transform: scale(1.02);
            box-shadow: 0 3px 12px rgba(0,0,0,0.2);
        }

        .mode-btn.active {
            background: var(--light-purple);
            color: white;
            border-color: var(--primary-purple);
            transform: scale(1.05);
        }

        /* å…¨ç¯„å›²ãƒ¢ãƒ¼ãƒ‰ã®ã‚¹ã‚¿ã‚¤ãƒ« */
        .mode-btn.mixed-mode {
            background: linear-gradient(135deg, var(--gold), #f59e0b);
            color: white;
            border-color: var(--gold);
        }

        .mode-btn.mixed-mode.active {
            background: linear-gradient(135deg, var(--primary-purple), var(--light-purple));
            border-color: var(--gold);
        }

        .mode-icon {
            font-size: 1em; /* ã‚¢ã‚¤ã‚³ãƒ³ã‚µã‚¤ã‚ºã‚’å°ã•ã */
            line-height: 1;
        }

        .mode-text {
            font-size: 0.75em; /* ãƒ†ã‚­ã‚¹ãƒˆã‚µã‚¤ã‚ºã‚’å°ã•ã */
            line-height: 1;
            font-weight: 600;
        }

        /* ã‚³ãƒ³ãƒˆãƒ­ãƒ¼ãƒ«ãƒœã‚¿ãƒ³ç¾¤ - å¹…ã‚’æƒãˆã‚‹ */
        .controls {
            display: flex;
            justify-content: center;
            gap: 8px;
        }

        .control-btn {
            flex: 1;
            max-width: 65px;
            height: 50px;
            border-radius: 12px;
            border: none;
            color: white;
            font-size: 0.75em;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 3px 12px rgba(0,0,0,0.3);
            backdrop-filter: blur(10px);
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            line-height: 1;
            font-weight: 600;
            padding: 4px;
            gap: 2px;
        }

        .btn-check { background: linear-gradient(135deg, var(--green), #059669); }
        .btn-clear { background: linear-gradient(135deg, #ef4444, #dc2626); }
        .btn-hint { background: linear-gradient(135deg, var(--gold), #f59e0b); }
        .btn-answer { background: linear-gradient(135deg, #8b5cf6, #7c3aed); }
        .btn-next { background: linear-gradient(135deg, var(--blue), #2563eb); }

        .control-btn:hover {
            transform: scale(1.05);
        }

        .control-btn:active {
            transform: scale(0.95);
        }

        .control-icon {
            font-size: 1.4em;
            line-height: 1;
        }

        .control-text {
            font-size: 0.8em;
            line-height: 1;
            margin-top: 1px;
        }

        /* ãƒ¡ã‚¤ãƒ³ã‚²ãƒ¼ãƒ ã‚¨ãƒªã‚¢ */
        .game-area {
            position: relative;
            flex: 1;
            overflow: hidden;
            margin: 8px;
            border-radius: 20px;
            background: rgba(255,255,255,0.4);
            backdrop-filter: blur(15px);
            border: 2px solid rgba(255,255,255,0.6);
        }

        /* ã‚«ãƒ¼ãƒ‰ã‚¨ãƒªã‚¢ */
        .cards-section {
            position: relative;
            width: 100%;
            height: 100%;
            border-radius: 15px;
            background: rgba(255,255,255,0.2);
            overflow: hidden;
        }

        /* ã•ã‚‰ã«æ‹¡å¤§ã•ã‚ŒãŸå›ç­”ã‚¨ãƒªã‚¢ - 2è¡Œå®Œå…¨å¯¾å¿œ */
        .answer-section {
            background: rgba(255,255,255,0.95);
            margin: 10px;
            padding: 25px;
            border-radius: 15px;
            box-shadow: 0 4px 15px var(--shadow);
            min-height: 140px;
            max-height: 200px;
            transition: all 0.3s ease;
            position: relative;
            z-index: 800;
            overflow-y: auto;
            flex-shrink: 0;
            border: 3px dashed var(--light-purple);
        }

        .answer-section.has-answer {
            border-color: var(--green);
            background: rgba(16, 185, 129, 0.15);
        }

        /* æ­£è§£çŠ¶æ…‹ã®ã‚¹ã‚¿ã‚¤ãƒ« */
        .answer-section.correct-state {
            border-color: var(--gold);
            background: linear-gradient(135deg, rgba(251, 191, 36, 0.2), rgba(245, 158, 11, 0.2));
            box-shadow: 0 8px 25px rgba(251, 191, 36, 0.4);
            animation: correct-glow 2s ease-in-out infinite;
        }

        @keyframes correct-glow {
            0%, 100% { 
                box-shadow: 0 8px 25px rgba(251, 191, 36, 0.4);
                transform: scale(1);
            }
            50% { 
                box-shadow: 0 12px 35px rgba(251, 191, 36, 0.6);
                transform: scale(1.02);
            }
        }

        /* å•é¡Œè¡¨ç¤º - å›ç­”ã‚¨ãƒªã‚¢å†… */
        .question-in-answer {
            font-size: 1rem;
            font-weight: 700;
            color: var(--primary-purple);
            margin-bottom: 15px;
            text-align: center;
            line-height: 1.3;
        }

        /* å›ç­”ã‚¨ãƒªã‚¢å†…ã®è¦ç´ é…ç½® */
        .answer-content {
            display: flex;
            align-items: center;
            justify-content: center;
            flex-wrap: wrap;
            gap: 8px;
            min-height: 70px;
        }

        .answer-piece {
            background: linear-gradient(45deg, var(--blue), var(--light-purple));
            color: white;
            padding: 8px 12px;
            border-radius: 12px;
            font-weight: 700;
            font-size: 1rem;
            box-shadow: 0 3px 10px rgba(0,0,0,0.2);
            cursor: pointer;
            transition: all 0.3s ease;
            animation: piece-appear 0.5s ease-out;
        }

        @keyframes piece-appear {
            0% { transform: scale(0) rotate(180deg); opacity: 0; }
            100% { transform: scale(1) rotate(0deg); opacity: 1; }
        }

        .answer-piece:hover {
            transform: scale(1.1);
            filter: brightness(1.2);
        }

        /* æ­£è§£æ™‚ã®å¤‰æ›ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ */
        .answer-piece.transforming {
            animation: piece-transform 0.8s ease-out forwards;
        }

        @keyframes piece-transform {
            0% { 
                transform: scale(1) rotate(0deg);
                background: linear-gradient(45deg, var(--blue), var(--light-purple));
            }
            25% { 
                transform: scale(1.3) rotate(180deg);
                background: linear-gradient(45deg, var(--gold), #fbbf24);
            }
            50% { 
                transform: scale(1.5) rotate(360deg);
                background: linear-gradient(45deg, var(--gold), #f59e0b);
                box-shadow: 0 8px 25px rgba(251, 191, 36, 0.6);
            }
            75% { 
                transform: scale(1.2) rotate(540deg);
                background: linear-gradient(45deg, var(--green), #059669);
            }
            100% { 
                transform: scale(1) rotate(720deg);
                background: linear-gradient(45deg, var(--green), #10b981);
                box-shadow: 0 5px 15px rgba(16, 185, 129, 0.4);
            }
        }

        /* æ­£è§£è¡¨ç¤ºãƒ†ã‚­ã‚¹ãƒˆ - å®Œå…¨æ°¸ç¶šè¡¨ç¤º */
        .correct-answer-display {
            background: linear-gradient(45deg, var(--gold), #f59e0b);
            color: white;
            padding: 15px 25px;
            border-radius: 15px;
            font-weight: 700;
            font-size: 1.1rem;
            box-shadow: 0 8px 25px rgba(251, 191, 36, 0.4);
            text-shadow: 1px 1px 3px rgba(0,0,0,0.3);
            animation: correct-text-appear 1s ease-out;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            margin: 0;
            text-align: center;
            flex-wrap: wrap;
            line-height: 1.4;
        }

        /* æ­£è§£ãƒœã‚¿ãƒ³ç”¨ã®ãƒ†ã‚­ã‚¹ãƒˆè¡¨ç¤º */
        .answer-button-display {
            background: linear-gradient(45deg, var(--blue), var(--light-purple));
            color: white;
            padding: 15px 25px;
            border-radius: 15px;
            font-weight: 700;
            font-size: 1.2rem;
            box-shadow: 0 8px 25px rgba(59, 130, 246, 0.4);
            text-shadow: 1px 1px 3px rgba(0,0,0,0.3);
            animation: answer-text-appear 1s ease-out;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            margin: 0;
            text-align: center;
            flex-wrap: wrap;
            line-height: 1.4;
        }

        @keyframes correct-text-appear {
            0% { 
                transform: scale(0) rotate(-180deg); 
                opacity: 0; 
            }
            50% { 
                transform: scale(1.2) rotate(0deg); 
                opacity: 1; 
            }
            100% { 
                transform: scale(1) rotate(0deg); 
                opacity: 1; 
            }
        }

        @keyframes answer-text-appear {
            0% { 
                transform: scale(0) rotate(-90deg); 
                opacity: 0; 
            }
            50% { 
                transform: scale(1.1) rotate(0deg); 
                opacity: 1; 
            }
            100% { 
                transform: scale(1) rotate(0deg); 
                opacity: 1; 
            }
        }

        /* åŸå­ã‚«ãƒ¼ãƒ‰ - ãƒ•ã‚©ãƒ³ãƒˆã‚µã‚¤ã‚ºã‚’å¤§å¹…æ‹¡å¤§ */
        .atom-card {
            position: absolute;
            width: 60px;
            height: 60px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            font-size: 1.3em;
            cursor: grab;
            transition: all 0.3s ease;
            box-shadow: 0 5px 15px rgba(0,0,0,0.3);
            border: 3px solid rgba(255,255,255,0.4);
            backdrop-filter: blur(10px);
            color: white;
            text-shadow: 1px 1px 3px rgba(0,0,0,0.6);
            user-select: none;
            z-index: 100;
            touch-action: none;
        }

        /* ç‰¹æ®Šè¨˜å·ã®å ´åˆã¯ã•ã‚‰ã«å¤§ãã */
        .atom-card.symbol-large {
            font-size: 1.5em;
        }

        .atom-card:active {
            cursor: grabbing;
        }

        .atom-card.dragging {
            z-index: 500;
            transform: scale(1.2);
            filter: brightness(1.2);
            box-shadow: 0 8px 25px rgba(0,0,0,0.4);
            cursor: grabbing;
        }

        .atom-card:hover {
            transform: scale(1.2);
            z-index: 200;
            box-shadow: 0 8px 20px rgba(0,0,0,0.4);
        }

        .atom-card.selected {
            transform: scale(1.4);
            z-index: 300;
            filter: brightness(1.3);
            animation: selected-pulse 0.6s ease-out;
        }

        @keyframes selected-pulse {
            0% { transform: scale(1); }
            50% { transform: scale(1.6); }
            100% { transform: scale(1.4); }
        }

        .atom-card.spawn-animation {
            animation: spawn-in 0.8s ease-out;
        }

        @keyframes spawn-in {
            0% { 
                transform: scale(0) rotate(0deg); 
                opacity: 0; 
            }
            50% { 
                transform: scale(1.3) rotate(180deg); 
                opacity: 1; 
            }
            100% { 
                transform: scale(1) rotate(360deg); 
                opacity: 1; 
            }
        }

        /* å…ƒç´ åˆ¥ã‚«ãƒ©ãƒ¼ãƒªãƒ³ã‚° */
        .atom-hydrogen { background: linear-gradient(135deg, #ff6b6b, #ff8e8e); }
        .atom-oxygen { background: linear-gradient(135deg, #4ecdc4, #44a08d); }
        .atom-carbon { background: linear-gradient(135deg, #45484d, #6c757d); }
        .atom-nitrogen { background: linear-gradient(135deg, #3498db, #2980b9); }
        .atom-chlorine { background: linear-gradient(135deg, #2ecc71, #27ae60); }
        .atom-sulfur { background: linear-gradient(135deg, #f39c12, #e67e22); }
        .atom-metal { background: linear-gradient(135deg, #95a5a6, #7f8c8d); }
        .atom-number { background: linear-gradient(135deg, #9b59b6, #8e44ad); }
        .atom-special { background: linear-gradient(135deg, #e74c3c, #c0392b); }
        .atom-ion { background: linear-gradient(135deg, #00d2ff, #3a7bd5); }

        /* ä¸‹éƒ¨ã‚¹ãƒšãƒ¼ã‚¹ */
        .bottom-space {
            height: 10px;
            flex-shrink: 0;
        }

        /* ãƒ•ã‚£ãƒ¼ãƒ‰ãƒãƒƒã‚¯ - æ¨ªå¹…ã‚’æ‹¡å¤§ã—ã¦1è¡Œè¡¨ç¤º */
        .feedback {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: rgba(255,255,255,0.95);
            padding: 15px 25px;
            border-radius: 18px;
            font-size: 1em;
            font-weight: 700;
            text-align: center;
            box-shadow: 0 10px 30px rgba(0,0,0,0.3);
            z-index: 1000;
            backdrop-filter: blur(15px);
            opacity: 0;
            pointer-events: none;
            transition: all 0.5s ease;
            max-width: 85%;
            white-space: nowrap;
        }

        .feedback.show {
            opacity: 1;
            pointer-events: auto;
            animation: feedback-bounce 0.6s ease-out;
        }

        @keyframes feedback-bounce {
            0% { transform: translate(-50%, -50%) scale(0.3); }
            50% { transform: translate(-50%, -50%) scale(1.1); }
            100% { transform: translate(-50%, -50%) scale(1); }
        }

        .feedback.correct {
            color: var(--green);
            border: 2px solid var(--green);
        }

        .feedback.incorrect {
            color: #ef4444;
            border: 2px solid #ef4444;
        }

        /* ãƒ‘ãƒ¼ãƒ†ã‚£ã‚¯ãƒ« */
        .kawaii-particle {
            position: absolute;
            pointer-events: none;
            font-size: 1.4em;
            z-index: 2000;
            animation: particle-float 2s ease-out forwards;
        }

        @keyframes particle-float {
            0% { 
                opacity: 1; 
                transform: scale(0) rotate(0deg); 
            }
            50% { 
                opacity: 1; 
                transform: scale(1.2) rotate(180deg); 
            }
            100% { 
                opacity: 0; 
                transform: scale(0.5) rotate(360deg) translateY(-80px); 
            }
        }

        /* æˆåŠŸæ™‚ã®ãŠç¥ã„ */
        .celebration {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.6);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 3000;
        }

        .celebration.show {
            display: flex;
            animation: celebration-in 0.5s ease-out;
        }

        .celebration-content {
            background: white;
            padding: 30px;
            border-radius: 25px;
            text-align: center;
            box-shadow: 0 15px 40px rgba(0,0,0,0.3);
            animation: celebration-bounce 0.8s ease-out;
            max-width: 90%;
        }

        @keyframes celebration-bounce {
            0% { transform: scale(0.3); }
            50% { transform: scale(1.1); }
            100% { transform: scale(1); }
        }

        /* ã‚¨ãƒ•ã‚§ã‚¯ãƒˆ */
        .hearts-rain {
            position: absolute;
            font-size: 1.3em;
            pointer-events: none;
            animation: hearts-fall 3s linear forwards;
        }

        @keyframes hearts-fall {
            0% { transform: translateY(-100px) rotate(0deg); opacity: 1; }
            100% { transform: translateY(150vh) rotate(360deg); opacity: 0; }
        }

        /* ãƒ©ãƒ³ãƒ€ãƒ é…ç½®ã®ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ */
        .atom-card.floating {
            animation: float-gentle 3s ease-in-out infinite;
        }

        @keyframes float-gentle {
            0%, 100% { transform: translateY(0px); }
            50% { transform: translateY(-10px); }
        }

        /* ãƒ¢ãƒã‚¤ãƒ«å¯¾å¿œã®å¼·åŒ– - å®Œå…¨åˆ‡ã‚Œé˜²æ­¢ */
        @media (max-width: 768px) {
            .header {
                padding: 12px 8px; /* ãƒ˜ãƒƒãƒ€ãƒ¼ã®ãƒ‘ãƒ‡ã‚£ãƒ³ã‚°ã‚’èª¿æ•´ */
            }

            .buttons-area {
                padding: 0 12px; /* ãƒ¢ãƒã‚¤ãƒ«ã§ã‚‚ãƒ‘ãƒ‡ã‚£ãƒ³ã‚°ã‚’ç¢ºä¿ */
            }

            .mode-selector {
                padding: 2px 12px; /* ãƒ¢ãƒã‚¤ãƒ«ã§ã®ãƒ‘ãƒ‡ã‚£ãƒ³ã‚°ã‚’ç¢ºä¿ */
            }

            .mode-btn {
                min-width: 38px;
                padding: 3px 4px;
                font-size: 0.55em;
            }

            .mode-icon {
                font-size: 0.9em;
            }

            .mode-text {
                font-size: 0.7em;
            }

            .atom-card {
                width: 55px;
                height: 55px;
                font-size: 1.2em;
            }

            .atom-card.symbol-large {
                font-size: 1.4em;
            }

            .control-btn {
                height: 45px;
                font-size: 0.7em;
            }

            .control-icon {
                font-size: 1.3em;
            }

            .question-in-answer {
                font-size: 0.9rem;
            }

            .answer-section {
                min-height: 130px;
                max-height: 180px;
                padding: 20px;
            }

            .feedback {
                font-size: 0.9em;
                padding: 12px 20px;
                max-width: 90%;
            }
        }

        @media (max-width: 480px) {
            .header {
                padding: 12px 5px; /* å°ç”»é¢ã§ã®ãƒ‘ãƒ‡ã‚£ãƒ³ã‚° */
            }

            .buttons-area {
                padding: 0 8px; /* å°ç”»é¢ã§ã®ãƒ‘ãƒ‡ã‚£ãƒ³ã‚° */
            }

            .mode-selector {
                padding: 2px 8px; /* å°ç”»é¢ã§ã®ãƒ‘ãƒ‡ã‚£ãƒ³ã‚° */
                gap: 1px; /* ã‚®ãƒ£ãƒƒãƒ—ã‚’å°ã•ã */
            }

            .mode-btn {
                min-width: 36px;
                font-size: 0.52em;
                padding: 3px 4px;
            }

            .mode-icon {
                font-size: 0.85em;
            }

            .mode-text {
                font-size: 0.65em;
            }

            .control-btn {
                height: 42px;
            }
        }

        @media (max-width: 390px) {
            .header {
                padding: 12px 3px; /* è¶…å°ç”»é¢ã§ã®ãƒ‘ãƒ‡ã‚£ãƒ³ã‚° */
            }

            .buttons-area {
                padding: 0 5px; /* è¶…å°ç”»é¢ã§ã®ãƒ‘ãƒ‡ã‚£ãƒ³ã‚° */
            }

            .mode-selector {
                padding: 2px 5px; /* è¶…å°ç”»é¢ã§ã®ãƒ‘ãƒ‡ã‚£ãƒ³ã‚° */
                gap: 1px; /* ã‚®ãƒ£ãƒƒãƒ—ã‚’ã•ã‚‰ã«å°ã•ã */
            }

            .mode-btn {
                min-width: 34px;
                font-size: 0.5em;
                padding: 2px;
            }

            .mode-icon {
                font-size: 0.8em;
            }

            .mode-text {
                font-size: 0.6em;
            }
        }

        @media (max-width: 360px) {
            .header {
                padding: 12px 2px; /* æœ€å°ç”»é¢ã§ã®ãƒ‘ãƒ‡ã‚£ãƒ³ã‚° */
            }

            .buttons-area {
                padding: 0 3px; /* æœ€å°ç”»é¢ã§ã®ãƒ‘ãƒ‡ã‚£ãƒ³ã‚° */
            }

            .mode-selector {
                padding: 2px 3px; /* æœ€å°ç”»é¢ã§ã®ãƒ‘ãƒ‡ã‚£ãƒ³ã‚° */
                gap: 1px;
            }

            .mode-btn {
                min-width: 32px;
                font-size: 0.48em;
                padding: 1px 2px;
            }

            .mode-icon {
                font-size: 0.75em;
            }

            .mode-text {
                font-size: 0.58em;
            }
        }

        @media (max-height: 700px) {
            .answer-section {
                margin: 8px;
                padding: 20px;
                min-height: 120px;
                max-height: 160px;
            }

            .atom-card {
                width: 50px;
                height: 50px;
                font-size: 1.1em;
            }

            .atom-card.symbol-large {
                font-size: 1.3em;
            }

            .control-btn {
                height: 40px;
                font-size: 0.65em;
            }

            .control-icon {
                font-size: 1.2em;
            }
        }

        @media (max-height: 600px) {
            .atom-card {
                width: 45px;
                height: 45px;
                font-size: 1em;
            }

            .atom-card.symbol-large {
                font-size: 1.2em;
            }

            .answer-section {
                min-height: 110px;
                max-height: 140px;
                padding: 15px;
            }

            .question-in-answer {
                font-size: 0.85rem;
                margin-bottom: 10px;
            }

            .control-btn {
                height: 35px;
                font-size: 0.6em;
            }
        }
    </style>
</head>
<body>
    <div class="kawaii-container">
        <!-- æ”¹å–„ã•ã‚ŒãŸãƒ˜ãƒƒãƒ€ãƒ¼ -->
        <div class="header">
            <!-- ã‚¿ã‚¤ãƒˆãƒ«ã‚¨ãƒªã‚¢ -->
            <div class="title-area">
                <h1 class="game-title" id="gameTitle">
                    <span class="chemistry-icon" id="leftIcon">ğŸ§ª</span>
                    Chemi Quiz
                    <span class="chemistry-icon" id="rightIcon">âš—ï¸</span>
                </h1>
            </div>

            <!-- ã‚³ãƒ³ãƒ‘ã‚¯ãƒˆãªã‚¹ã‚³ã‚¢ã‚¨ãƒªã‚¢ -->
            <div class="score-area">
                <div class="score-item" id="correctScore">
                    <div class="score-number" id="correctCount">0</div>
                    <div class="score-label">æ­£è§£</div>
                </div>
                <div class="score-item" id="totalScore">
                    <div class="score-number" id="totalCount">0</div>
                    <div class="score-label">å•é¡Œæ•°</div>
                </div>
                <div class="score-item" id="comboScore">
                    <div class="score-number" id="comboCount">0</div>
                    <div class="score-label">ã‚³ãƒ³ãƒœ</div>
                </div>
            </div>

            <!-- æ•´åˆ—ã•ã‚ŒãŸãƒœã‚¿ãƒ³ã‚¨ãƒªã‚¢ -->
            <div class="buttons-area">
                <!-- ãƒ¢ãƒ¼ãƒ‰é¸æŠ - å®Œå…¨åˆ‡ã‚Œé˜²æ­¢å¯¾å¿œ -->
                <div class="mode-selector">
                    <button class="mode-btn" data-mode="elements">
                        <div class="mode-icon">ğŸ§ª</div>
                        <div class="mode-text">å…ƒç´ è¨˜å·</div>
                    </button>
                    <button class="mode-btn" data-mode="compounds">
                        <div class="mode-icon">âš—ï¸</div>
                        <div class="mode-text">åŒ–å­¦å¼</div>
                    </button>
                    <button class="mode-btn" data-mode="reactions">
                        <div class="mode-icon">ğŸ”¬</div>
                        <div class="mode-text">åŒ–å­¦åå¿œå¼</div>
                    </button>
                    <button class="mode-btn" data-mode="ions">
                        <div class="mode-icon">âš¡</div>
                        <div class="mode-text">ã‚¤ã‚ªãƒ³</div>
                    </button>
                    <button class="mode-btn" data-mode="ionicReactions">
                        <div class="mode-icon">ğŸŒ</div>
                        <div class="mode-text">ã‚¤ã‚ªãƒ³åå¿œå¼</div>
                    </button>
                    <button class="mode-btn mixed-mode" data-mode="mixed">
                        <div class="mode-icon">ğŸ¯</div>
                        <div class="mode-text">å…¨ç¯„å›²ã‹ã‚‰å‡ºé¡Œ</div>
                    </button>
                </div>

                <!-- ã‚³ãƒ³ãƒˆãƒ­ãƒ¼ãƒ«ãƒœã‚¿ãƒ³ - ã‚»ãƒ³ã‚¿ãƒªãƒ³ã‚° -->
                <div class="controls">
                    <button class="control-btn btn-check" id="checkBtn" title="ç­”ãˆã‚’ãƒã‚§ãƒƒã‚¯">
                        <div class="control-icon">âœ…</div>
                        <div class="control-text">ãƒã‚§ãƒƒã‚¯</div>
                    </button>
                    <button class="control-btn btn-clear" id="clearBtn" title="ã‚¯ãƒªã‚¢">
                        <div class="control-icon">ğŸ—‘ï¸</div>
                        <div class="control-text">ã‚¯ãƒªã‚¢</div>
                    </button>
                    <button class="control-btn btn-hint" id="hintBtn" title="ãƒ’ãƒ³ãƒˆ">
                        <div class="control-icon">ğŸ’¡</div>
                        <div class="control-text">ãƒ’ãƒ³ãƒˆ</div>
                    </button>
                    <button class="control-btn btn-answer" id="answerBtn" title="æ­£è§£ã‚’è¡¨ç¤º">
                        <div class="control-icon">ğŸ“–</div>
                        <div class="control-text">æ­£è§£</div>
                    </button>
                    <button class="control-btn btn-next" id="nextBtn" title="æ¬¡ã®å•é¡Œ">
                        <div class="control-icon">â¡ï¸</div>
                        <div class="control-text">æ¬¡ã¸</div>
                    </button>
                </div>
            </div>
        </div>

        <!-- ãƒ¡ã‚¤ãƒ³ã‚²ãƒ¼ãƒ ã‚¨ãƒªã‚¢ -->
        <div class="game-area" id="gameArea">
            <!-- åŸå­ã‚«ãƒ¼ãƒ‰ã‚¨ãƒªã‚¢ -->
            <div class="cards-section" id="cardsSection">
                <!-- åŸå­ã‚«ãƒ¼ãƒ‰ãŒãƒ©ãƒ³ãƒ€ãƒ ãªä½ç½®ã«é…ç½®ã•ã‚Œã‚‹ -->
            </div>
        </div>

        <!-- ã•ã‚‰ã«æ‹¡å¤§ã•ã‚ŒãŸå›ç­”ã‚¨ãƒªã‚¢ -->
        <div class="answer-section" id="answerArea">
            <div class="question-in-answer" id="questionInAnswer">
                ã‚²ãƒ¼ãƒ ãƒ¢ãƒ¼ãƒ‰ã‚’é¸ã‚“ã§ã­ ğŸ’•
            </div>
            <div class="answer-content" id="answerContent">
                <div style="color: var(--light-purple); font-size: 0.9em;">ã‚«ãƒ¼ãƒ‰ã‚’ã‚¿ãƒƒãƒ—ã—ã¦åŒ–å­¦å¼ã‚’ä½œã‚ã† âœ¨</div>
            </div>
        </div>

        <!-- ä¸‹éƒ¨ã‚¹ãƒšãƒ¼ã‚¹ -->
        <div class="bottom-space"></div>

        <!-- ãƒ•ã‚£ãƒ¼ãƒ‰ãƒãƒƒã‚¯ -->
        <div class="feedback" id="feedback"></div>

        <!-- æˆåŠŸæ™‚ã®ãŠç¥ã„ -->
        <div class="celebration" id="celebration">
            <div class="celebration-content">
                <h2 style="color: var(--primary-purple);">ğŸ‰ ç´ æ™´ã‚‰ã—ã„ï¼ ğŸ‰</h2>
                <p style="color: var(--light-purple); margin: 15px 0;">åŒ–å­¦ãƒã‚¹ã‚¿ãƒ¼ã«ä¸€æ­©è¿‘ã¥ã„ãŸã­ï¼</p>
                <button class="mode-btn" onclick="nextProblem()" style="margin: 10px auto; display: block;">æ¬¡ã®å•é¡Œã¸ âœ¨</button>
            </div>
        </div>
    </div>

    <script>
        // ã‚²ãƒ¼ãƒ ãƒ‡ãƒ¼ã‚¿ï¼ˆå…¨ç¯„å›²ãƒ¢ãƒ¼ãƒ‰è¿½åŠ ï¼‰
        const gameData = {
            elements: [
                { question: "æ°´ç´ ã®å…ƒç´ è¨˜å·ã¯ï¼Ÿ", answer: ["H"], pool: ["He", "Li", "Be", "B", "C", "N", "O", "F", "Ne", "Na", "Mg", "Al", "Si", "P", "S"] },
                { question: "é…¸ç´ ã®å…ƒç´ è¨˜å·ã¯ï¼Ÿ", answer: ["O"], pool: ["H", "C", "N", "F", "Ne", "Na", "Mg", "Al", "Si", "P", "S", "Cl", "Ar", "K", "Ca"] },
                { question: "ç‚­ç´ ã®å…ƒç´ è¨˜å·ã¯ï¼Ÿ", answer: ["C"], pool: ["H", "O", "N", "S", "P", "Cl", "Ar", "K", "Ca", "Sc", "Ti", "V", "Cr", "Mn", "Fe"] },
                { question: "çª’ç´ ã®å…ƒç´ è¨˜å·ã¯ï¼Ÿ", answer: ["N"], pool: ["O", "F", "Ne", "Na", "Mg", "Al", "Si", "P", "S", "Cl", "Ar", "K", "Ca", "Sc", "Ti"] },
                { question: "å¡©ç´ ã®å…ƒç´ è¨˜å·ã¯ï¼Ÿ", answer: ["Cl"], pool: ["F", "Br", "I", "S", "P", "N", "O", "H", "C", "Na", "K", "Ca", "Mg", "Al", "Si"] }
            ],

            compounds: [
                { question: "æ°´ç´ åˆ†å­ã®åŒ–å­¦å¼ã¯ï¼Ÿ", answer: ["H", "â‚‚"], pool: ["H", "O", "N", "C", "â‚ƒ", "â‚„", "â‚…", "â‚†", "â‚‡", "â‚ˆ", "â‚‰", "â‚", "â‚€", "Cl", "S"] },
                { question: "æ°´åˆ†å­ã®åŒ–å­¦å¼ã¯ï¼Ÿ", answer: ["H", "â‚‚", "O"], pool: ["H", "O", "N", "C", "S", "â‚‚", "â‚ƒ", "â‚„", "â‚…", "â‚†", "Cl", "F", "Br", "I", "P"] },
                { question: "å¡©åŒ–ãƒŠãƒˆãƒªã‚¦ãƒ ã®åŒ–å­¦å¼ã¯ï¼Ÿ", answer: ["Na", "Cl"], pool: ["Na", "K", "Br", "I", "F", "Ca", "Mg", "Sr", "Ba", "Li", "Rb", "Cs", "Fr", "At", "H"] },
                { question: "äºŒé…¸åŒ–ç‚­ç´ ã®åŒ–å­¦å¼ã¯ï¼Ÿ", answer: ["C", "O", "â‚‚"], pool: ["C", "O", "H", "N", "S", "P", "Cl", "F", "Br", "I", "â‚‚", "â‚ƒ", "â‚„", "â‚…", "â‚"] }
            ],

            reactions: [
                { 
                    question: "æ°´ã®é›»æ°—åˆ†è§£ã®å¼ã¯ï¼Ÿ", 
                    answer: ["2", "H", "â‚‚", "O", "â†’", "2", "H", "â‚‚", "+", "O", "â‚‚"], 
                    pool: ["H", "O", "â†’", "+", "2", "3", "4", "5", "6", "C", "N", "S", "Fe", "Cu", "â‚‚"]
                },
                { 
                    question: "é‰„ã¨ç¡«é»„ã®åŒ–åˆã®å¼ã¯ï¼Ÿ", 
                    answer: ["Fe", "+", "S", "â†’", "Fe", "S"], 
                    pool: ["Fe", "S", "â†’", "+", "Cu", "O", "H", "N", "C", "Cl", "F", "Br", "I", "P", "Zn"]
                }
            ],

            ions: [
                { question: "éŠ…ã‚¤ã‚ªãƒ³ã®åŒ–å­¦å¼ã¯ï¼Ÿ", answer: ["Cu", "Â²âº"], pool: ["Cu", "Fe", "Ag", "Au", "Zn", "Ni", "Co", "Mn", "Cr", "Â²âº", "âº", "Â²â»", "Â³âº", "Â³â»", "â»"] },
                { question: "æ°´ç´ ã‚¤ã‚ªãƒ³ã®åŒ–å­¦å¼ã¯ï¼Ÿ", answer: ["H", "âº"], pool: ["H", "O", "N", "C", "Li", "Na", "K", "Mg", "Ca", "âº", "Â²âº", "â»", "Â²â»", "Â³âº", "Â³â»"] }
            ],

            ionicReactions: [
                {
                    question: "å¡©é…¸ã¨æ°´é…¸åŒ–ãƒŠãƒˆãƒªã‚¦ãƒ ã®ä¸­å’Œåå¿œã¯ï¼Ÿ",
                    answer: ["H", "âº", "+", "O", "H", "â»", "â†’", "H", "â‚‚", "O"],
                    pool: ["H", "O", "Na", "Cl", "K", "Ca", "Mg", "âº", "â»", "Â²âº", "Â²â»", "â†’", "+", "â‚‚", "â‚ƒ"]
                }
            ],

            // å…¨ç¯„å›²ãƒ¢ãƒ¼ãƒ‰ - å…¨ã¦ã®å•é¡Œã‚’ãƒ©ãƒ³ãƒ€ãƒ ã«å‡ºé¡Œ
            mixed: [] // å‹•çš„ã«ç”Ÿæˆã•ã‚Œã‚‹
        };

        // å…¨ç¯„å›²ãƒ¢ãƒ¼ãƒ‰ã®å•é¡Œã‚’å‹•çš„ã«ç”Ÿæˆ
        function generateMixedProblems() {
            const allProblems = [];
            Object.keys(gameData).forEach(mode => {
                if (mode !== 'mixed') {
                    allProblems.push(...gameData[mode]);
                }
            });
            return shuffleArray(allProblems);
        }

        // ã‚²ãƒ¼ãƒ çŠ¶æ…‹
        let currentMode = '';
        let currentProblem = null;
        let currentProblemIndex = 0;
        let correctCount = 0;
        let totalCount = 0;
        let comboCount = 0;
        let currentAnswer = [];
        let isCorrectAnswerShowing = false;
        let hasCheckedCurrentProblem = false;
        let isAnswerButtonUsed = false; // æ­£è§£ãƒœã‚¿ãƒ³ä½¿ç”¨ãƒ•ãƒ©ã‚°

        // ãƒ‰ãƒ©ãƒƒã‚°çŠ¶æ…‹
        let isDragging = false;
        let dragElement = null;
        let dragOffset = { x: 0, y: 0 };
        let dragStartTime = 0;
        let hasMoved = false;
        let startPosition = { x: 0, y: 0 };
        let interactionInProgress = false;
        let dragThreshold = 10;

        // éŸ³éŸ¿ã‚·ã‚¹ãƒ†ãƒ 
        class KawaiiSoundSystem {
            constructor() {
                this.audioContext = null;
                this.initAudio();
            }

            initAudio() {
                try {
                    this.audioContext = new (window.AudioContext || window.webkitAudioContext)();
                } catch (e) {
                    console.log('éŸ³å£°ã‚·ã‚¹ãƒ†ãƒ ã‚’åˆæœŸåŒ–ã§ãã¾ã›ã‚“ã§ã—ãŸ');
                }
            }

            playTone(frequency, duration, type = 'sine', volume = 0.3) {
                if (!this.audioContext) return;

                try {
                    if (this.audioContext.state === 'suspended') {
                        this.audioContext.resume();
                    }

                    const oscillator = this.audioContext.createOscillator();
                    const gainNode = this.audioContext.createGain();

                    oscillator.connect(gainNode);
                    gainNode.connect(this.audioContext.destination);

                    oscillator.frequency.setValueAtTime(frequency, this.audioContext.currentTime);
                    oscillator.type = type;

                    gainNode.gain.setValueAtTime(0, this.audioContext.currentTime);
                    gainNode.gain.linearRampToValueAtTime(volume, this.audioContext.currentTime + 0.01);
                    gainNode.gain.exponentialRampToValueAtTime(0.001, this.audioContext.currentTime + duration);

                    oscillator.start(this.audioContext.currentTime);
                    oscillator.stop(this.audioContext.currentTime + duration);
                } catch (e) {
                    // ã‚¨ãƒ©ãƒ¼ã¯ç„¡è¦–
                }
            }

            playClick() {
                this.playTone(800, 0.15, 'sine', 0.2);
            }

            playCorrect() {
                const notes = [523, 659, 784, 1047];
                notes.forEach((freq, i) => {
                    setTimeout(() => this.playTone(freq, 0.2, 'sine', 0.25), i * 100);
                });
            }

            playIncorrect() {
                this.playTone(300, 0.5, 'sawtooth', 0.2);
            }

            playMagical() {
                const notes = [1047, 1175, 1319, 1568, 1760];
                notes.forEach((freq, i) => {
                    setTimeout(() => this.playTone(freq, 0.3, 'sine', 0.2), i * 80);
                });
            }

            playVictory() {
                const victoryNotes = [523, 659, 784, 1047, 1319, 1568];
                victoryNotes.forEach((freq, i) => {
                    setTimeout(() => this.playTone(freq, 0.3, 'sine', 0.3), i * 150);
                });
                
                setTimeout(() => {
                    for (let i = 0; i < 8; i++) {
                        setTimeout(() => {
                            this.playTone(2093 + Math.random() * 500, 0.2, 'sine', 0.2);
                        }, i * 100);
                    }
                }, 900);
            }

            playTransform() {
                this.playTone(440, 0.1, 'square', 0.15);
                setTimeout(() => this.playTone(880, 0.1, 'square', 0.15), 100);
                setTimeout(() => this.playTone(1320, 0.1, 'square', 0.15), 200);
            }

            vibrate(pattern) {
                if ('vibrate' in navigator) {
                    navigator.vibrate(pattern);
                }
            }
        }

        const soundSystem = new KawaiiSoundSystem();

        // ãƒ‘ãƒ¼ãƒ†ã‚£ã‚¯ãƒ«ã‚·ã‚¹ãƒ†ãƒ 
        class KawaiiParticleSystem {
            constructor() {
                this.particles = [];
            }

            createParticle(x, y, emoji, color = null) {
                const particle = document.createElement('div');
                particle.className = 'kawaii-particle';
                particle.textContent = emoji;
                if (color) particle.style.color = color;
                particle.style.left = x + 'px';
                particle.style.top = y + 'px';
                document.body.appendChild(particle);

                setTimeout(() => {
                    if (particle.parentNode) {
                        particle.parentNode.removeChild(particle);
                    }
                }, 2000);
            }

            createExplosion(x, y, emojis, count = 8) {
                for (let i = 0; i < count; i++) {
                    setTimeout(() => {
                        const emoji = emojis[Math.floor(Math.random() * emojis.length)];
                        const offsetX = (Math.random() - 0.5) * 60;
                        const offsetY = (Math.random() - 0.5) * 60;
                        this.createParticle(x + offsetX, y + offsetY, emoji);
                    }, i * 50);
                }
            }
        }

        const particleSystem = new KawaiiParticleSystem();

        // ãƒ‰ãƒ©ãƒƒã‚°ãƒ»ã‚¿ãƒƒãƒ—æ©Ÿèƒ½
        function setupDragEvents(card, atom) {
            card.addEventListener('mousedown', (e) => {
                e.preventDefault();
                startInteraction(e, card, atom);
            });
            
            card.addEventListener('touchstart', (e) => {
                e.preventDefault();
                startInteraction(e.touches[0], card, atom);
            }, { passive: false });
        }

        function startInteraction(e, card, atom) {
            if (interactionInProgress) return;

            dragStartTime = Date.now();
            hasMoved = false;
            isDragging = false;
            startPosition = { x: e.clientX, y: e.clientY };
            
            const rect = card.getBoundingClientRect();
            dragOffset.x = e.clientX - rect.left;
            dragOffset.y = e.clientY - rect.top;
            
            dragElement = card;
            
            const onMove = (moveEvent) => onInteractionMove(moveEvent, card, atom);
            const onEnd = (endEvent) => onInteractionEnd(endEvent, atom, card);
            
            const mouseMoveHandler = (e) => onMove(e);
            const mouseUpHandler = (e) => onEnd(e);
            
            const touchMoveHandler = (e) => {
                e.preventDefault();
                onMove(e.touches[0]);
            };
            const touchEndHandler = (e) => onEnd(e.changedTouches[0]);
            
            document.addEventListener('mousemove', mouseMoveHandler);
            document.addEventListener('mouseup', mouseUpHandler);
            document.addEventListener('touchmove', touchMoveHandler, { passive: false });
            document.addEventListener('touchend', touchEndHandler);
            
            card._removeListeners = () => {
                document.removeEventListener('mousemove', mouseMoveHandler);
                document.removeEventListener('mouseup', mouseUpHandler);
                document.removeEventListener('touchmove', touchMoveHandler);
                document.removeEventListener('touchend', touchEndHandler);
            };
        }

        function onInteractionMove(e, card, atom) {
            if (!dragElement) return;
            
            const currentPos = { x: e.clientX, y: e.clientY };
            const distance = Math.sqrt(
                Math.pow(currentPos.x - startPosition.x, 2) + 
                Math.pow(currentPos.y - startPosition.y, 2)
            );
            
            if (distance > dragThreshold && !isDragging) {
                isDragging = true;
                hasMoved = true;
                dragElement.classList.add('dragging');
            }
            
            if (isDragging) {
                const cardsSection = document.getElementById('cardsSection');
                const rect = cardsSection.getBoundingClientRect();
                
                let x = e.clientX - rect.left - dragOffset.x;
                let y = e.clientY - rect.top - dragOffset.y;
                
                x = Math.max(0, Math.min(x, rect.width - dragElement.offsetWidth));
                y = Math.max(0, Math.min(y, rect.height - dragElement.offsetHeight));
                
                dragElement.style.left = x + 'px';
                dragElement.style.top = y + 'px';
            }
        }

        function onInteractionEnd(e, atom, card) {
            const interactionTime = Date.now() - dragStartTime;
            
            if (dragElement) {
                dragElement.classList.remove('dragging');
            }
            
            if (card._removeListeners) {
                card._removeListeners();
                delete card._removeListeners;
            }
            
            if (!isDragging && !hasMoved && interactionTime < 500 && !interactionInProgress) {
                interactionInProgress = true;
                selectAtomCard(atom, card);
                setTimeout(() => {
                    interactionInProgress = false;
                }, 100);
            }
            
            isDragging = false;
            dragElement = null;
            hasMoved = false;
        }

        // ã‚²ãƒ¼ãƒ åˆæœŸåŒ–
        function initGame() {
            setupEventListeners();
            setTimeout(() => {
                selectMode('elements');
            }, 100);
        }

        // ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼è¨­å®šï¼ˆæ­£è§£è¡¨ç¤ºã®æ°¸ç¶šåŒ–å¯¾å¿œï¼‰
        function setupEventListeners() {
            document.querySelectorAll('.mode-btn').forEach(btn => {
                btn.addEventListener('click', (e) => {
                    const mode = e.target.dataset.mode || e.target.closest('.mode-btn').dataset.mode;
                    selectMode(mode);
                });
            });

            document.getElementById('checkBtn').addEventListener('click', checkAnswer);
            
            // ã‚¯ãƒªã‚¢ãƒœã‚¿ãƒ³ã§æ­£è§£è¡¨ç¤ºã‚‚ã‚¯ãƒªã‚¢
            document.getElementById('clearBtn').addEventListener('click', () => {
                clearAnswer();
                if (isCorrectAnswerShowing || isAnswerButtonUsed) {
                    isCorrectAnswerShowing = false;
                    isAnswerButtonUsed = false;
                    updateAnswerDisplay();
                }
            });
            
            document.getElementById('hintBtn').addEventListener('click', showHint);
            document.getElementById('answerBtn').addEventListener('click', showCorrectAnswer);
            
            // æ¬¡ã¸ãƒœã‚¿ãƒ³ã§æ­£è§£è¡¨ç¤ºã‚‚ã‚¯ãƒªã‚¢
            document.getElementById('nextBtn').addEventListener('click', () => {
                if (isCorrectAnswerShowing || isAnswerButtonUsed) {
                    isCorrectAnswerShowing = false;
                    isAnswerButtonUsed = false;
                }
                nextProblem();
            });

            document.getElementById('gameTitle').addEventListener('click', () => {
                soundSystem.playMagical();
                soundSystem.vibrate([100, 50, 100, 50, 150]);
                
                const rect = document.getElementById('gameTitle').getBoundingClientRect();
                particleSystem.createExplosion(
                    rect.left + rect.width / 2,
                    rect.top + rect.height / 2,
                    ['ğŸ§ª', 'âš—ï¸', 'ğŸ”¬', 'ğŸ’•', 'âœ¨', 'ğŸŒŸ'],
                    6
                );
            });

            document.addEventListener('click', () => {
                if (soundSystem.audioContext && soundSystem.audioContext.state === 'suspended') {
                    soundSystem.audioContext.resume();
                }
            }, { once: true });
        }

        // ãƒ¢ãƒ¼ãƒ‰é¸æŠï¼ˆæ­£è§£è¡¨ç¤ºã‚’ã‚¯ãƒªã‚¢ï¼‰
        function selectMode(mode) {
            if (mode === 'mixed') {
                gameData.mixed = generateMixedProblems();
            }
            
            if (!gameData[mode] || gameData[mode].length === 0) return;
            
            currentMode = mode;
            currentProblemIndex = 0;
            
            // æ­£è§£è¡¨ç¤ºçŠ¶æ…‹ã‚’ã‚¯ãƒªã‚¢
            if (isCorrectAnswerShowing || isAnswerButtonUsed) {
                isCorrectAnswerShowing = false;
                isAnswerButtonUsed = false;
            }
            
            document.querySelectorAll('.mode-btn').forEach(btn => {
                btn.classList.remove('active');
            });
            
            const selectedBtn = document.querySelector(`[data-mode="${mode}"]`);
            if (selectedBtn) {
                selectedBtn.classList.add('active');
            }

            soundSystem.playMagical();
            soundSystem.vibrate([100, 50, 100]);

            loadProblem();

            if (selectedBtn) {
                const rect = selectedBtn.getBoundingClientRect();
                particleSystem.createExplosion(
                    rect.left + rect.width / 2,
                    rect.top + rect.height / 2,
                    ['ğŸ‰', 'âœ¨', 'ğŸ’•', 'ğŸŒŸ'],
                    4
                );
            }
        }

        // å•é¡Œèª­ã¿è¾¼ã¿ï¼ˆæ­£è§£è¡¨ç¤ºã‚’ã‚¯ãƒªã‚¢ï¼‰
        function loadProblem() {
            if (!currentMode || !gameData[currentMode]) return;

            const problems = gameData[currentMode];
            if (currentProblemIndex >= problems.length) {
                if (currentMode === 'mixed') {
                    gameData.mixed = generateMixedProblems();
                }
                currentProblemIndex = 0;
            }

            currentProblem = problems[currentProblemIndex];
            isCorrectAnswerShowing = false;
            isAnswerButtonUsed = false;
            hasCheckedCurrentProblem = false;
            
            clearAnswer();
            
            setTimeout(() => {
                createAtomCards();
            }, 100);
            
            document.getElementById('questionInAnswer').textContent = currentProblem.question;
        }

        // åŸå­ã‚«ãƒ¼ãƒ‰ä½œæˆï¼ˆãƒ•ã‚©ãƒ³ãƒˆã‚µã‚¤ã‚ºæ‹¡å¤§å¯¾å¿œï¼‰
        function createAtomCards() {
            const cardsSection = document.getElementById('cardsSection');
            cardsSection.innerHTML = '';

            if (!currentProblem) return;

            let selectedAtoms = [...currentProblem.answer];
            
            const uniquePool = currentProblem.pool.filter(atom => !selectedAtoms.includes(atom));
            const targetCount = 18;
            const additionalCount = Math.min(targetCount - selectedAtoms.length, uniquePool.length);
            
            const shuffledPool = shuffleArray(uniquePool);
            selectedAtoms = [...selectedAtoms, ...shuffledPool.slice(0, additionalCount)];
            
            const finalAtoms = shuffleArray(selectedAtoms);

            const cardsSection_rect = cardsSection.getBoundingClientRect();
            const cardSize = 60;
            const margin = 10;

            finalAtoms.forEach((atom, index) => {
                const card = document.createElement('div');
                card.className = `atom-card ${getAtomClass(atom)}`;
                
                if (isSpecialSymbol(atom)) {
                    card.classList.add('symbol-large');
                }
                
                card.textContent = atom;

                let x, y;
                let attempts = 0;
                let validPosition = false;

                while (!validPosition && attempts < 50) {
                    x = Math.random() * (cardsSection_rect.width - cardSize - margin * 2) + margin;
                    y = Math.random() * (cardsSection_rect.height - cardSize - margin * 2) + margin;

                    validPosition = true;
                    const existingCards = cardsSection.children;
                    for (let i = 0; i < existingCards.length; i++) {
                        const existingCard = existingCards[i];
                        const existingX = parseFloat(existingCard.style.left);
                        const existingY = parseFloat(existingCard.style.top);
                        const distance = Math.sqrt(Math.pow(x - existingX, 2) + Math.pow(y - existingY, 2));
                        if (distance < cardSize * 0.7) {
                            validPosition = false;
                            break;
                        }
                    }
                    attempts++;
                }

                if (!validPosition) {
                    x = Math.random() * (cardsSection_rect.width - cardSize - margin * 2) + margin;
                    y = Math.random() * (cardsSection_rect.height - cardSize - margin * 2) + margin;
                }

                card.style.left = x + 'px';
                card.style.top = y + 'px';

                setupDragEvents(card, atom);

                card.classList.add('spawn-animation');
                setTimeout(() => {
                    card.classList.remove('spawn-animation');
                    card.classList.add('floating');
                }, 400 + index * 25);

                cardsSection.appendChild(card);
            });
        }

        // ç‰¹æ®Šè¨˜å·åˆ¤å®šï¼ˆå¤§ããè¡¨ç¤ºã™ã¹ãè¨˜å·ï¼‰
        function isSpecialSymbol(atom) {
            const specialSymbols = ['+', 'â†’', 'âº', 'â»', 'Â²âº', 'Â²â»', 'Â³âº', 'Â³â»', 'â‚', 'â‚‚', 'â‚ƒ', 'â‚„', 'â‚…', 'â‚†', 'â‚‡', 'â‚ˆ', 'â‚‰', 'â‚€'];
            return specialSymbols.includes(atom);
        }

        // é…åˆ—ã‚’ã‚·ãƒ£ãƒƒãƒ•ãƒ«
        function shuffleArray(array) {
            const shuffled = [...array];
            for (let i = shuffled.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [shuffled[i], shuffled[j]] = [shuffled[j], shuffled[i]];
            }
            return shuffled;
        }

        // åŸå­ã‚«ãƒ¼ãƒ‰é¸æŠ
        function selectAtomCard(atom, cardElement) {
            if (isCorrectAnswerShowing || isAnswerButtonUsed) return;
            
            cardElement.classList.add('selected');
            setTimeout(() => {
                cardElement.classList.remove('selected');
            }, 600);

            addToAnswer(atom);

            soundSystem.playClick();
            soundSystem.vibrate([50]);

            const rect = cardElement.getBoundingClientRect();
            particleSystem.createParticle(
                rect.left + rect.width / 2,
                rect.top + rect.height / 2,
                'âœ¨'
            );
        }

        // åŸå­ã‚¯ãƒ©ã‚¹å–å¾—
        function getAtomClass(atom) {
            if (['H'].includes(atom)) return 'atom-hydrogen';
            if (['O'].includes(atom)) return 'atom-oxygen';
            if (['C'].includes(atom)) return 'atom-carbon';
            if (['N'].includes(atom)) return 'atom-nitrogen';
            if (['Cl', 'Br', 'I', 'F'].includes(atom)) return 'atom-chlorine';
            if (['S', 'P'].includes(atom)) return 'atom-sulfur';
            if (['Fe', 'Cu', 'Na', 'Mg', 'Ba', 'Ag', 'K', 'Ca', 'Zn', 'Al', 'Ti', 'Mn', 'Ni', 'Co', 'Cr', 'V', 'Sc', 'Sr', 'Ra', 'Be', 'Li', 'Rb', 'Cs', 'Fr', 'Pb'].includes(atom)) return 'atom-metal';
            if (['1', '2', '3', '4', '5', '6', '7', '8', '9', '0', 'â‚', 'â‚‚', 'â‚ƒ', 'â‚„', 'â‚…', 'â‚†', 'â‚‡', 'â‚ˆ', 'â‚‰', 'â‚€'].includes(atom)) return 'atom-number';
            if (['âº', 'â»', 'Â²âº', 'Â²â»', 'Â³âº', 'Â³â»', 'e'].includes(atom)) return 'atom-ion';
            if (['â†’', '+', '(', ')'].includes(atom)) return 'atom-special';
            return 'atom-carbon';
        }

        // å›ç­”ã«è¿½åŠ 
        function addToAnswer(atom) {
            currentAnswer.push(atom);
            updateAnswerDisplay();
        }

        // å›ç­”è¡¨ç¤ºæ›´æ–°ï¼ˆæ­£è§£è¡¨ç¤ºã®æ°¸ç¶šåŒ–å¯¾å¿œï¼‰
        function updateAnswerDisplay() {
            const answerContent = document.getElementById('answerContent');
            
            if (isCorrectAnswerShowing || isAnswerButtonUsed) {
                // æ­£è§£è¡¨ç¤ºä¸­ã¯è¡¨ç¤ºã‚’ãã®ã¾ã¾ç¶­æŒ
                return;
            }
            
            if (currentAnswer.length === 0) {
                answerContent.innerHTML = '<div style="color: var(--light-purple); font-size: 0.9em;">ã‚«ãƒ¼ãƒ‰ã‚’ã‚¿ãƒƒãƒ—ã—ã¦åŒ–å­¦å¼ã‚’ä½œã‚ã† âœ¨</div>';
                document.getElementById('answerArea').classList.remove('has-answer');
                document.getElementById('answerArea').classList.remove('correct-state');
            } else {
                answerContent.innerHTML = currentAnswer.map((atom, index) => 
                    `<span class="answer-piece" onclick="removeFromAnswer(${index})">${atom}</span>`
                ).join('');
                document.getElementById('answerArea').classList.add('has-answer');
            }
        }

        // æ­£è§£æ™‚ã®ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³å‡¦ç†
        function animateCorrectAnswer() {
            const answerPieces = document.querySelectorAll('.answer-piece');
            const answerContent = document.getElementById('answerContent');
            const answerArea = document.getElementById('answerArea');
            
            answerArea.classList.add('correct-state');
            isCorrectAnswerShowing = true;
            
            answerPieces.forEach((piece, index) => {
                setTimeout(() => {
                    soundSystem.playTransform();
                    
                    piece.classList.add('transforming');
                    
                    if (index === answerPieces.length - 1) {
                        setTimeout(() => {
                            showFinalCorrectAnswer();
                        }, 800);
                    }
                }, index * 200);
            });
        }

        // æœ€çµ‚çš„ãªæ­£è§£è¡¨ç¤ºï¼ˆå®Œå…¨æ°¸ç¶šè¡¨ç¤ºï¼‰
        function showFinalCorrectAnswer() {
            const answerContent = document.getElementById('answerContent');
            const correctAnswerText = currentProblem.answer.join('');
            
            soundSystem.playVictory();
            soundSystem.vibrate([100, 50, 100, 50, 200, 50, 300]);
            
            // å®Œå…¨æ°¸ç¶šè¡¨ç¤ºï¼ˆãƒ¦ãƒ¼ã‚¶ãƒ¼ã®ã‚¢ã‚¯ã‚·ãƒ§ãƒ³ã¾ã§è¡¨ç¤ºã—ç¶šã‘ã‚‹ï¼‰
            answerContent.innerHTML = `
                <div class="correct-answer-display">
                    <span>ğŸ‰</span>
                    <span>æ­£è§£: ${correctAnswerText}</span>
                    <span>ğŸ‰</span>
                </div>
            `;
            
            const rect = answerContent.getBoundingClientRect();
            particleSystem.createExplosion(
                rect.left + rect.width / 2,
                rect.top + rect.height / 2,
                ['ğŸ‰', 'ğŸŠ', 'âœ¨', 'ğŸŒŸ', 'ğŸ’•', 'ğŸ’–', 'ğŸ†', 'ğŸ¥‡'],
                12
            );
        }

        // å›ç­”ã‹ã‚‰å‰Šé™¤
        function removeFromAnswer(index) {
            if (isCorrectAnswerShowing || isAnswerButtonUsed) return;
            
            currentAnswer.splice(index, 1);
            updateAnswerDisplay();
            soundSystem.playClick();
            soundSystem.vibrate([30]);
        }

        // å›ç­”ã‚’ã‚¯ãƒªã‚¢
        function clearAnswer() {
            currentAnswer = [];
            hasCheckedCurrentProblem = false;
            updateAnswerDisplay();
            soundSystem.playClick();
            soundSystem.vibrate([50]);
        }

        // ç­”ãˆã‚’ãƒã‚§ãƒƒã‚¯
        function checkAnswer() {
            if (!currentProblem || currentAnswer.length === 0) {
                showFeedback('ç­”ãˆã‚’å…¥åŠ›ã—ã¦ã­ ğŸ¤”', 'incorrect');
                return;
            }

            if (hasCheckedCurrentProblem) {
                showFeedback('ã‚‚ã†ä¸€åº¦ãƒã‚§ãƒƒã‚¯ã™ã‚‹ã«ã¯æ¬¡ã®å•é¡Œã¸ â¡ï¸', 'incorrect');
                return;
            }

            hasCheckedCurrentProblem = true;
            totalCount++;
            const isCorrect = arraysEqual(currentAnswer, currentProblem.answer);

            if (isCorrect) {
                correctCount++;
                comboCount++;
                
                animateCorrectAnswer();
                
                showFeedback(`æ­£è§£ï¼ğŸ‰ ã‚³ãƒ³ãƒœ${comboCount}`, 'correct');

            } else {
                comboCount = 0;
                soundSystem.playIncorrect();
                soundSystem.vibrate([80, 40, 80]);
                
                const correctStr = currentProblem.answer.join('');
                showFeedback(`æ®‹å¿µ...æ­£è§£ã¯ã€Œ${correctStr}ã€ã ã‚ˆ ğŸ˜…`, 'incorrect');
            }

            updateScoreDisplay();
        }

        // æ­£è§£ã‚’è¡¨ç¤ºã™ã‚‹æ–°æ©Ÿèƒ½ï¼ˆãƒ†ã‚­ã‚¹ãƒˆè¡¨ç¤ºç‰ˆï¼‰
        function showCorrectAnswer() {
            if (!currentProblem) {
                showFeedback('å•é¡Œã‚’é¸ã‚“ã§ã­ ğŸ’•', 'incorrect');
                return;
            }

            soundSystem.playMagical();
            soundSystem.vibrate([100, 50, 100, 50, 100]);

            const correctAnswer = currentProblem.answer.join('');
            
            // å›ç­”ã‚¨ãƒªã‚¢ã«ç›´æ¥ãƒ†ã‚­ã‚¹ãƒˆè¡¨ç¤º
            const answerContent = document.getElementById('answerContent');
            const answerArea = document.getElementById('answerArea');
            
            answerArea.classList.add('has-answer');
            isAnswerButtonUsed = true;
            
            answerContent.innerHTML = `
                <div class="answer-button-display">
                    <span>ğŸ“–</span>
                    <span>æ­£è§£: ${correctAnswer}</span>
                    <span>ğŸ“–</span>
                </div>
            `;

            const answerBtn = document.getElementById('answerBtn');
            const rect = answerBtn.getBoundingClientRect();
            particleSystem.createExplosion(
                rect.left + rect.width / 2,
                rect.top + rect.height / 2,
                ['ğŸ“–', 'âœ¨', 'ğŸ’¡', 'ğŸŒŸ', 'ğŸ’•'],
                4
            );
        }

        // é…åˆ—æ¯”è¼ƒ
        function arraysEqual(a, b) {
            return a.length === b.length && a.every((val, i) => val === b[i]);
        }

        // ãƒ’ãƒ³ãƒˆè¡¨ç¤º
        function showHint() {
            if (!currentProblem) return;

            soundSystem.playClick();
            soundSystem.vibrate([100, 50, 100]);

            const hint = currentProblem.answer[0];
            showFeedback(`ãƒ’ãƒ³ãƒˆ: æœ€åˆã¯ã€Œ${hint}ã€ã ã‚ˆ ğŸ’¡`, 'correct');

            const questionInAnswer = document.getElementById('questionInAnswer');
            const rect = questionInAnswer.getBoundingClientRect();
            particleSystem.createExplosion(
                rect.left + rect.width / 2,
                rect.top + rect.height / 2,
                ['ğŸ’¡', 'âœ¨', 'ğŸŒŸ'],
                3
            );
        }

        // æ¬¡ã®å•é¡Œ
        function nextProblem() {
            currentProblemIndex++;
            hasCheckedCurrentProblem = false;
            document.getElementById('celebration').classList.remove('show');
            loadProblem();
            
            soundSystem.playMagical();
            soundSystem.vibrate([100, 50, 100]);
        }

        // ã‚¹ã‚³ã‚¢è¡¨ç¤ºæ›´æ–°
        function updateScoreDisplay() {
            document.getElementById('correctCount').textContent = correctCount;
            document.getElementById('totalCount').textContent = totalCount;
            document.getElementById('comboCount').textContent = comboCount;
        }

        // ãƒ•ã‚£ãƒ¼ãƒ‰ãƒãƒƒã‚¯è¡¨ç¤º
        function showFeedback(message, type) {
            const feedback = document.getElementById('feedback');
            feedback.textContent = message;
            feedback.className = `feedback ${type} show`;
            
            setTimeout(() => {
                feedback.classList.remove('show');
            }, 3000);
        }

        // åˆæœŸåŒ–å®Ÿè¡Œ
        document.addEventListener('DOMContentLoaded', () => {
            initGame();
        });
    </script>
</body>
</html>