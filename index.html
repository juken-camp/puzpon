<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no, maximum-scale=1.0, minimum-scale=1.0">
    <title>ONE WORLD Quiz</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="problems.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=Noto+Sans+JP:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --primary-coral: #f4a261;
            --primary-sage: #7fb069;
            --primary-sky: #6bb6ff;
            --primary-lavender: #a584c7;
            --accent-peach: #f9b6a3;
            --accent-mint: #b8e6b8;
            --bg-cream: #fdf8f3;
            --bg-white: #ffffff;
            --text-dark: #2d3748;
            --text-warm: #5d4e75;
            --border-soft: #e6ddd4;
            --shadow-gentle: rgba(116, 139, 141, 0.15);
        }
        body {
            font-family: "Noto Sans JP", "Inter", sans-serif;
            background: #faf7f2;
            min-height: 100vh;
            touch-action: manipulation;
            overflow-x: hidden;
            color: var(--text-dark);
            -webkit-touch-callout: none;
            -webkit-user-select: none;
            -webkit-tap-highlight-color: transparent;
            user-select: none;
        }
        .container-spacing {
            margin: 0 auto;
            max-width: 95%;
            width: 100%;
        }
        @media (min-width: 640px) {
            .container-spacing {
                max-width: 500px;
            }
        }
        @media (min-width: 768px) {
            .container-spacing {
                max-width: 600px;
            }
        }
        @media (min-width: 1024px) {
            .container-spacing {
                max-width: 700px;
            }
        }
        .game-title {
            font-family: 'Inter', sans-serif;
            font-weight: 700;
            font-size: clamp(1.5rem, 4vw, 2.5rem);
            color: var(--primary-coral);
            text-align: center;
            letter-spacing: -0.025em;
            margin-bottom: 0.5rem;
        }
        .warm-card {
            background: var(--bg-white);
            border: 3px solid var(--border-soft);
            border-radius: 24px;
            box-shadow: 0 8px 32px var(--shadow-gentle);
            position: relative;
            overflow: hidden;
        }
        .warm-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 6px;
            background: var(--primary-coral);
            border-radius: 24px 24px 0 0;
        }
        .warm-button {
            background: var(--primary-coral);
            border: none;
            color: white;
            font-weight: 600;
            border-radius: 16px;
            transition: all 0.3s ease;
            box-shadow: 0 4px 16px rgba(244, 162, 97, 0.3);
        }
        .warm-button:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 24px rgba(244, 162, 97, 0.4);
            background: #f19a4e;
        }
        .warm-button:active {
            transform: translateY(0);
            box-shadow: 0 4px 16px rgba(244, 162, 97, 0.3);
        }
        .warm-button:disabled {
            background: #d1d5db;
            color: #9ca3af;
            transform: none;
            box-shadow: none;
            cursor: not-allowed;
        }
        .grade-btn {
            background: #fef9f5;
            border: 3px solid var(--border-soft);
            border-radius: 20px;
            color: var(--text-warm);
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
            padding: 1rem 0.75rem;
            min-height: 80px;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            box-shadow: 0 4px 16px var(--shadow-gentle);
        }
        .grade-btn:hover {
            border-color: var(--primary-coral);
            transform: translateY(-3px);
            box-shadow: 0 8px 24px rgba(244, 162, 97, 0.25);
            background: #fdf5ef;
        }
        .grade-btn.active {
            background: #fdf0e7;
            border-color: var(--primary-coral);
            color: var(--primary-coral);
            transform: translateY(-3px);
            box-shadow: 0 8px 24px rgba(244, 162, 97, 0.3);
        }
        .lesson-btn {
            background: #f0f8ff;
            border: 2px solid #b8d4f0;
            border-radius: 16px;
            color: var(--text-dark);
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
            padding: 0.75rem 0.5rem;
            display: flex;
            align-items: center;
            justify-content: center;
            text-align: center;
            min-height: 60px;
            box-shadow: 0 4px 12px rgba(107, 182, 255, 0.15);
            font-size: 0.8rem;
            font-weight: 500;
        }
        .lesson-btn:hover {
            border-color: var(--primary-sky);
            transform: translateY(-2px);
            box-shadow: 0 6px 16px rgba(107, 182, 255, 0.25);
            background: #e6f3ff;
        }
        .lesson-btn.active {
            background: #d9edff;
            border-color: var(--primary-sky);
            color: var(--primary-sky);
            transform: translateY(-2px);
            box-shadow: 0 6px 16px rgba(107, 182, 255, 0.3);
        }
        .grammar-btn {
            background: #f8f5ff;
            border: 2px solid #d6c9e3;
            border-radius: 12px;
            color: var(--text-dark);
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
            padding: 0.6rem 0.4rem;
            display: flex;
            align-items: center;
            justify-content: center;
            text-align: center;
            min-height: 50px;
            box-shadow: 0 3px 10px rgba(165, 132, 199, 0.15);
            font-size: 0.75rem;
            font-weight: 500;
        }
        .grammar-btn:hover {
            border-color: var(--primary-lavender);
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(165, 132, 199, 0.25);
            background: #f0ebff;
        }
        .grammar-btn.active {
            background: #e9dff7;
            border-color: var(--primary-lavender);
            color: var(--primary-lavender);
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(165, 132, 199, 0.3);
        }
        .modal {
            display: none;
            position: fixed;
            inset: 0;
            background: rgba(0, 0, 0, 0.4);
            backdrop-filter: blur(12px);
            align-items: center;
            justify-content: center;
            z-index: 1000;
            padding: 1rem;
        }
        .modal.show {
            display: flex;
            animation: modalFadeIn 0.4s ease-out;
        }
        @keyframes modalFadeIn {
            from {
                opacity: 0;
                transform: scale(0.9) translateY(20px);
            }
            to {
                opacity: 1;
                transform: scale(1) translateY(0);
            }
        }
        .particle {
            position: absolute;
            pointer-events: none;
            font-weight: 600;
            z-index: 100;
            animation: particleFloat 2.5s ease-out forwards;
            font-size: 20px;
        }
        @keyframes particleFloat {
            0% {
                transform: translateY(0) scale(1) rotate(0deg);
                opacity: 1;
            }
            50% {
                transform: translateY(-40px) scale(1.3) rotate(180deg);
                opacity: 0.8;
            }
            100% {
                transform: translateY(-100px) scale(1.5) rotate(360deg);
                opacity: 0;
            }
        }
        .notification {
            position: fixed;
            top: 20px;
            right: 20px;
            background: var(--bg-white);
            color: var(--text-dark);
            padding: 16px 20px;
            border-radius: 16px;
            border: 3px solid var(--border-soft);
            transform: translateX(400px);
            transition: transform 0.4s cubic-bezier(0.68, -0.55, 0.265, 1.55);
            z-index: 1001;
            box-shadow: 0 8px 24px var(--shadow-gentle);
        }
        .notification.show {
            transform: translateX(0);
        }
        .floating-button {
            position: fixed;
            bottom: 24px;
            left: 24px;
            width: 64px;
            height: 64px;
            background: var(--accent-peach);
            border: 3px solid var(--border-soft);
            border-radius: 50%;
            color: white;
            font-size: 28px;
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: 0 8px 24px rgba(249, 182, 163, 0.4);
            transition: all 0.3s ease;
            z-index: 1002;
            cursor: pointer;
        }
        
        .floating-button.hidden {
            display: none !important;
        }
        .floating-button:hover {
            transform: translateY(-4px) scale(1.1);
            box-shadow: 0 12px 32px rgba(249, 182, 163, 0.5);
        }
        
        /* タイマー関連のスタイル */
        .timer-display {
            font-size: 3rem;
            font-weight: 900;
            text-align: center;
            padding: 1.5rem;
            border-radius: 20px;
            margin: 1rem 0;
            transition: all 0.3s ease;
            border: 4px solid;
        }
        .timer-normal {
            background: linear-gradient(135deg, #e8f5e8, #f0fdf0);
            color: var(--primary-sage);
            border-color: var(--primary-sage);
        }
        .timer-warning {
            background: linear-gradient(135deg, #fef3cd, #fefce8);
            color: #d97706;
            border-color: #d97706;
            animation: timerPulse 1s infinite;
        }
        .timer-danger {
            background: linear-gradient(135deg, #fee2e2, #fef2f2);
            color: #dc2626;
            border-color: #dc2626;
            animation: timerPulse 0.5s infinite;
        }
        @keyframes timerPulse {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.05); }
        }
        
        .timer-btn {
            background: var(--bg-white);
            border: 3px solid var(--border-soft);
            border-radius: 12px;
            color: var(--text-dark);
            transition: all 0.3s ease;
            padding: 0.75rem;
            font-size: 0.8rem;
            font-weight: 500;
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: 0 3px 10px var(--shadow-gentle);
        }
        .timer-btn:hover {
            border-color: var(--primary-coral);
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(244, 162, 97, 0.25);
        }
        .timer-btn.active {
            background: #fdf0e7;
            border-color: var(--primary-coral);
            color: var(--primary-coral);
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(244, 162, 97, 0.3);
        }
        
        .answer-display {
            background: var(--bg-cream);
            border-radius: 16px;
            padding: 1.5rem;
            margin-top: 1rem;
            border: 3px solid var(--border-soft);
            text-align: center;
            font-size: 1.1rem;
            line-height: 1.6;
            box-shadow: 0 4px 12px var(--shadow-gentle);
            min-height: 120px;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
        }
        .answer-display.show {
            border-color: var(--primary-sage);
            background: #f0f9f0;
            box-shadow: 0 4px 12px rgba(127, 176, 105, 0.2);
        }
        .answer-text {
            font-weight: 700;
            font-size: 1.3rem;
            color: var(--primary-sage);
            margin-bottom: 0.5rem;
        }
        .explanation-text {
            color: var(--text-dark);
            font-size: 1rem;
        }
        
        .show-answer-btn {
            background: var(--primary-sky);
            border: none;
            color: white;
            font-weight: 600;
            border-radius: 16px;
            padding: 1rem 2rem;
            font-size: 1.1rem;
            transition: all 0.3s ease;
            box-shadow: 0 4px 16px rgba(107, 182, 255, 0.3);
            margin: 1rem 0;
        }
        .show-answer-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 24px rgba(107, 182, 255, 0.4);
            background: #5aa3f0;
        }
        .show-answer-btn:disabled {
            background: #d1d5db;
            color: #9ca3af;
            transform: none;
            box-shadow: none;
            cursor: not-allowed;
        }
        
        .quiz-question {
            background: #f8fafc;
            border: 3px solid #e2e8f0;
            border-radius: 16px;
            padding: 1.5rem;
            text-align: center;
            font-size: 1.2rem;
            font-weight: 600;
            color: var(--text-dark);
            line-height: 1.5;
            margin-bottom: 1rem;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
        }
        
        .modal-content {
            max-height: 85vh;
            overflow-y: auto;
            padding-top: 0;
        }
        
        .modal .warm-card {
            margin: 2rem 1rem 1rem 1rem;
            max-height: 85vh;
            overflow-y: auto;
        }
        
        .grade-grid {
            grid-template-columns: repeat(3, 1fr);
            gap: 1rem;
        }
        .lesson-grid {
            grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
            gap: 0.75rem;
        }
        .grammar-grid {
            grid-template-columns: 1fr;
            gap: 0.5rem;
        }
        .back-button {
            background: #f1f5f9;
            border: 3px solid #cbd5e1;
            color: var(--text-dark);
            border-radius: 16px;
            padding: 0.75rem 1.25rem;
            font-weight: 500;
            transition: all 0.3s ease;
            font-size: 0.9rem;
            box-shadow: 0 3px 10px rgba(0, 0, 0, 0.1);
        }
        .back-button:hover {
            background: #e2e8f0;
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
        }
        .stats-display {
            background: var(--bg-cream);
            border: 3px solid var(--border-soft);
            border-radius: 20px;
            padding: 1.25rem;
            text-align: center;
            box-shadow: 0 6px 20px var(--shadow-gentle);
        }
        .section-divider {
            height: 2px;
            background: var(--border-soft);
            margin: 1.25rem 0;
        }
        .mode-btn {
            background: var(--bg-white);
            border: 3px solid var(--border-soft);
            border-radius: 12px;
            color: var(--text-dark);
            transition: all 0.3s ease;
            padding: 0.75rem;
            font-size: 0.8rem;
            font-weight: 500;
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: 0 3px 10px var(--shadow-gentle);
        }
        .mode-btn:hover {
            border-color: var(--primary-coral);
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(244, 162, 97, 0.25);
        }
        .mode-btn.active {
            background: #fdf0e7;
            border-color: var(--primary-coral);
            color: var(--primary-coral);
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(244, 162, 97, 0.3);
        }
        .direction-btn {
            background: var(--bg-white);
            border: 3px solid #d6c9e3;
            border-radius: 12px;
            color: var(--text-dark);
            transition: all 0.3s ease;
            padding: 0.75rem;
            font-size: 0.8rem;
            font-weight: 500;
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: 0 3px 10px rgba(165, 132, 199, 0.15);
        }
        .direction-btn:hover {
            border-color: var(--primary-lavender);
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(165, 132, 199, 0.25);
        }
        .direction-btn.active {
            background: #e9dff7;
            border-color: var(--primary-lavender);
            color: var(--primary-lavender);
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(165, 132, 199, 0.3);
        }
        
        /* クリックカウンター表示 */
        .click-counter {
            background: linear-gradient(135deg, #f3e8ff, #faf5ff);
            border: 3px solid var(--primary-lavender);
            border-radius: 16px;
            padding: 1rem;
            text-align: center;
            box-shadow: 0 4px 12px rgba(165, 132, 199, 0.2);
            margin: 1rem 0;
        }
        .click-number {
            font-size: 2rem;
            font-weight: 900;
            color: var(--primary-lavender);
            display: block;
        }
        .click-label {
            font-size: 0.8rem;
            color: var(--text-warm);
            margin-top: 0.25rem;
        }
        
        @media (max-width: 640px) {
            .container-spacing {
                max-width: 95%;
                margin-bottom: 2rem;
            }
            .modal .warm-card {
                margin: 0.25rem;
                padding: 0.75rem;
                max-height: 92vh;
            }
            
            .modal-content {
                max-height: 92vh;
                padding-top: 0;
            }
            
            .floating-button {
                bottom: 20px;
                left: 20px;
                width: 56px;
                height: 56px;
                font-size: 24px;
            }
            .warm-card {
                margin: 0.5rem;
                padding: 1rem;
            }
            .warm-card:last-of-type {
                margin-bottom: 4rem;
            }
            body {
                padding-bottom: 5rem;
            }
            .game-title {
                font-size: clamp(1.25rem, 6vw, 2rem);
            }
            .grade-grid {
                grid-template-columns: repeat(3, 1fr);
                gap: 0.75rem;
            }
            .lesson-grid {
                grid-template-columns: 1fr;
                gap: 0.5rem;
            }
            .grammar-grid {
                grid-template-columns: 1fr;
                gap: 0.4rem;
            }
            .grade-btn {
                padding: 0.75rem 0.5rem;
                min-height: 70px;
                font-size: 0.8rem;
            }
            .lesson-btn {
                padding: 0.6rem 0.4rem;
                min-height: 50px;
                font-size: 0.75rem;
            }
            .grammar-btn {
                padding: 0.5rem 0.3rem;
                min-height: 45px;
                font-size: 0.7rem;
            }
            .timer-display {
                font-size: 2.5rem;
                padding: 1rem;
            }
            .quiz-question {
                font-size: 1rem;
                padding: 1rem;
            }
            .answer-display {
                padding: 1rem;
                min-height: 100px;
            }
            .answer-text {
                font-size: 1.1rem;
            }
            .explanation-text {
                font-size: 0.9rem;
            }
            .click-number {
                font-size: 1.5rem;
            }
        }
        
        button, .grade-btn, .lesson-btn, .grammar-btn, .warm-button, .back-button, .mode-btn, .direction-btn, .timer-btn, .show-answer-btn {
            -webkit-touch-callout: none;
            -webkit-user-select: none;
            -webkit-tap-highlight-color: transparent;
            user-select: none;
            touch-action: manipulation;
            -webkit-appearance: none;
        }
        
        * {
            touch-action: manipulation;
        }
        
        input, select, textarea {
            font-size: 16px;
        }
        
        .modal {
            padding: 0.5rem;
        }
        
        .modal .warm-card {
            position: relative;
            top: 0;
        }
        
        @media (max-width: 640px) {
            .modal {
                padding: 0.25rem;
            }
            
            .modal .warm-card {
                margin-top: 2rem;
            }
        }

        /* 特別な装飾効果 */
        .sparkle {
            position: relative;
            overflow: visible;
        }
        .sparkle::before,
        .sparkle::after {
            content: '✨';
            position: absolute;
            opacity: 0;
            animation: sparkleFloat 3s infinite ease-in-out;
        }
        .sparkle::before {
            top: -10px;
            left: -10px;
            animation-delay: 0s;
        }
        .sparkle::after {
            bottom: -10px;
            right: -10px;
            animation-delay: 1.5s;
        }
        @keyframes sparkleFloat {
            0%, 100% { opacity: 0; transform: translateY(0) scale(0.8); }
            50% { opacity: 1; transform: translateY(-20px) scale(1.2); }
        }
    </style>
</head>
<body class="min-h-screen flex flex-col items-center pt-6 pb-12 gap-6 relative">
    <!-- メイン学年選択モーダル -->
    <div id="mainGradeModal" class="modal show">
        <div class="warm-card p-6 container-spacing modal-content">
            <div class="text-center mb-6">
                <h1 class="game-title sparkle">🌍 ONE WORLD Quiz ✨</h1>
                <h2 class="text-lg font-semibold mb-3 text-gray-700">
                    🎓 学年を選択しよう
                </h2>
                <p class="text-gray-600 text-sm">あなたの学習レベルを選んでください。</p>
                
                <!-- 総クリック数表示 -->
                <div class="click-counter mt-4">
                    <span class="click-number" id="totalClickDisplay">0</span>
                    <div class="click-label">🖱️ 総クリック数（学習の証！）</div>
                </div>
            </div>
            <div class="grid grade-grid mb-6">
                <button class="grade-btn" data-grade="grade1">
                    <div class="text-3xl mb-1">🌱</div>
                    <div class="font-semibold text-sm">中学1年生</div>
                </button>
                <button class="grade-btn" data-grade="grade2">
                    <div class="text-3xl mb-1">🌿</div>
                    <div class="font-semibold text-sm">中学2年生</div>
                </button>
                <button class="grade-btn" data-grade="grade3">
                    <div class="text-3xl mb-1">🌳</div>
                    <div class="font-semibold text-sm">中学3年生</div>
                </button>
            </div>
        </div>
    </div>

    <!-- 中学1年生レッスン選択モーダル -->
    <div id="grade1Modal" class="modal">
        <div class="warm-card p-6 container-spacing modal-content">
            <div class="text-center mb-6">
                <h2 class="text-lg font-semibold mb-3 text-gray-700">
                    🌱 中学1年生のレッスン
                </h2>
                <p class="text-gray-600 text-sm">学習したいレッスンを選んでください。</p>
            </div>
            <div class="grid lesson-grid mb-6" id="grade1Lessons">
                <!-- JavaScriptで動的に生成 -->
            </div>
            <div class="text-center">
                <button class="back-button" onclick="goBackToMain()">
                    🏠 学年選択に戻る
                </button>
            </div>
        </div>
    </div>

    <!-- 中学2年生レッスン選択モーダル -->
    <div id="grade2Modal" class="modal">
        <div class="warm-card p-6 container-spacing modal-content">
            <div class="text-center mb-6">
                <h2 class="text-lg font-semibold mb-3 text-gray-700">
                    🌿 中学2年生のレッスン
                </h2>
                <p class="text-gray-600 text-sm">学習したいレッスンを選んでください。</p>
            </div>
            <div class="grid lesson-grid mb-6" id="grade2Lessons">
                <!-- JavaScriptで動的に生成 -->
            </div>
            <div class="text-center">
                <button class="back-button" onclick="goBackToMain()">
                    🏠 学年選択に戻る
                </button>
            </div>
        </div>
    </div>

    <!-- 中学3年生レッスン選択モーダル -->
    <div id="grade3Modal" class="modal">
        <div class="warm-card p-6 container-spacing modal-content">
            <div class="text-center mb-6">
                <h2 class="text-lg font-semibold mb-3 text-gray-700">
                    🌳 中学3年生のレッスン
                </h2>
                <p class="text-gray-600 text-sm">学習したいレッスンを選んでください。</p>
            </div>
            <div class="grid lesson-grid mb-6" id="grade3Lessons">
                <!-- JavaScriptで動的に生成 -->
            </div>
            <div class="text-center">
                <button class="back-button" onclick="goBackToMain()">
                    🏠 学年選択に戻る
                </button>
            </div>
        </div>
    </div>

    <!-- 文法項目選択モーダル（動的に生成されるため、テンプレートとして1つ定義） -->
    <div id="grammarModal" class="modal">
        <div class="warm-card p-6 container-spacing modal-content">
            <div class="text-center mb-4">
                <h2 id="grammarModalTitle" class="text-lg font-semibold mb-3 text-gray-700"></h2>
                <p class="text-gray-600 text-sm">学習する内容を選んでください。<br>複数選択もできます。</p>
            </div>
            <div class="grid grammar-grid mb-4" id="grammarCategories">
                <!-- JavaScriptで動的に生成 -->
            </div>
            <div class="text-center space-y-2">
                <button id="startGrammarQuiz" class="warm-button px-8 py-3 text-sm sparkle" disabled>
                    🚀 クイズスタート！
                </button>
                <br>
                <button id="grammarBackButton" class="back-button">
                    ← レッスン選択に戻る
                </button>
            </div>
        </div>
    </div>

    <!-- ゲーム画面 -->
    <div id="gameScreen" class="hidden">
        <div class="warm-card p-6 text-center container-spacing mb-6">
            <h1 class="game-title sparkle">🌍 ONE WORLD Quiz ✨</h1>
            <div id="currentCategory" class="text-lg font-semibold text-gray-700 mb-4"></div>
            <div class="stats-display">
                <div class="grid grid-cols-2 gap-4 text-center mb-4">
                    <div>
                        <div class="text-2xl font-bold text-blue-600" id="studyCount">0</div>
                        <div class="text-xs text-gray-600">📚 学習回数</div>
                    </div>
                    <div>
                        <div class="text-2xl font-bold text-purple-600" id="clickCount">0</div>
                        <div class="text-xs text-gray-600">🖱️ クリック数</div>
                    </div>
                </div>
                
                <!-- 制限時間設定 -->
                <div class="section-divider"></div>
                <div class="text-center">
                    <div class="text-sm font-semibold text-gray-700 mb-3">⏰ 制限時間設定</div>
                    <div class="grid grid-cols-3 gap-2 mb-3">
                        <button id="timer3Btn" class="timer-btn active" data-time="3">
                            ⚡ 3秒
                        </button>
                        <button id="timer5Btn" class="timer-btn" data-time="5">
                            🔥 5秒
                        </button>
                        <button id="timer10Btn" class="timer-btn" data-time="10">
                            🌟 10秒
                        </button>
                    </div>
                    <div class="text-xs text-gray-600 mb-3" id="timerDescription">
                        3秒で制限時間切れ！ドキドキチャレンジ
                    </div>
                </div>
                
                <!-- 出題形式選択 -->
                <div class="section-divider"></div>
                <div class="text-center">
                    <div class="text-sm font-semibold text-gray-700 mb-3">🎲 出題スタイル</div>
                    <div class="grid grid-cols-2 gap-2 mb-3">
                        <button id="randomModeBtn" class="mode-btn active" data-mode="random">
                            🎯 ランダム
                        </button>
                        <button id="sequentialModeBtn" class="mode-btn" data-mode="sequential">
                            📖 順番通り
                        </button>
                    </div>
                    <div class="text-xs text-gray-600 mb-3" id="modeDescription">
                        問題をランダムにシャッフルして出題します
                    </div>
                </div>

                <!-- 出題方向選択 -->
                <div class="section-divider"></div>
                <div class="text-center">
                    <div class="text-sm font-semibold text-gray-700 mb-3">🌏 言語方向</div>
                    <div class="grid grid-cols-2 gap-2 mb-3">
                        <button id="jpToEnBtn" class="direction-btn active" data-direction="jp_to_en">
                            🇯🇵→🇺🇸 日→英
                        </button>
                        <button id="enToJpBtn" class="direction-btn" data-direction="en_to_jp">
                            🇺🇸→🇯🇵 英→日
                        </button>
                    </div>
                    <div class="grid grid-cols-1 gap-2">
                        <button id="mixedBtn" class="direction-btn" data-direction="mixed">
                            🔀 ミックスモード
                        </button>
                    </div>
                    <div class="text-xs text-gray-600 mt-2" id="directionDescription">
                        日本語を英語に変換する問題
                    </div>
                </div>
            </div>
            <button id="startQuizButton" class="warm-button px-8 py-4 text-base font-semibold mt-6 sparkle">
                🌟 レッツスタート！
            </button>
        </div>
    </div>

    <!-- クイズモーダル -->
    <div id="quizModal" class="modal">
        <div class="warm-card p-4 w-full max-w-lg mx-4">
            <div class="text-center mb-4">
                <h2 class="font-semibold text-lg text-gray-700">
                    🌍 ONE WORLD Quiz Challenge
                </h2>
                <div id="remainingCount" class="text-sm text-gray-600 mt-1"></div>
            </div>
            
            <!-- 問題表示エリア -->
            <div id="quizQuestion" class="quiz-question"></div>
            
            <!-- タイマー表示エリア -->
            <div id="timerDisplay" class="timer-display timer-normal">
                <div id="timerValue">準備中...</div>
            </div>
            
            <!-- 解答表示ボタン -->
            <div class="text-center">
                <button id="showAnswerBtn" class="show-answer-btn">
                    💡 解答を見る
                </button>
            </div>
            
            <!-- 解答・解説表示エリア -->
            <div id="answerDisplay" class="answer-display">
                <div id="answerContent">
                    <div class="text-gray-500">頭で考えてから解答ボタンを押してね！</div>
                </div>
            </div>
            
            <!-- 操作ボタン -->
            <div class="flex gap-2 mt-4">
                <button id="quizNext" class="flex-1 warm-button py-3 text-sm" disabled>
                    ⭐ 次のチャレンジ
                </button>
                <button id="quizBack" class="flex-1 back-button py-3 text-sm">
                    🏠 ホームへ
                </button>
            </div>
        </div>
    </div>

    <!-- フローティングボタン -->
    <button id="changeSubject" class="floating-button hidden">
        🏠
    </button>

    <!-- 通知 -->
    <div id="notification" class="notification">
        <div class="flex items-center gap-3">
            <span class="text-2xl">🌟</span>
            <div>
                <div class="font-semibold text-sm">ONE WORLD Quiz</div>
                <div id="notificationText" class="text-xs text-gray-600"></div>
            </div>
        </div>
    </div>

    <script>
        /* ----------------- 効果音システム（完全新規） ----------------- */
        class SoundSystem {
            constructor() {
                this.audioContext = null;
                this.sounds = {};
                this.initAudio();
            }

            initAudio() {
                try {
                    this.audioContext = new (window.AudioContext || window.webkitAudioContext)();
                } catch (e) {
                    console.log('音声システムを初期化できませんでした');
                }
            }

            // 優しいクリック音
            playClick() {
                this.createBell(660, 0.08, 0.15);
                setTimeout(() => this.createBell(880, 0.06, 0.1), 30);
            }

            // 学習完了時の優しいメロディ
            playStudyComplete() {
                const harmony = [
                    { freq: 440, delay: 0 },
                    { freq: 550, delay: 120 },
                    { freq: 660, delay: 240 }
                ];
                harmony.forEach(note => {
                    setTimeout(() => this.createSoftTone(note.freq, 0.25, 0.2), note.delay);
                });
            }

            // 成功時の華やかだが優しい音
            playSuccess() {
                const celebration = [
                    { freq: 523, delay: 0 },
                    { freq: 659, delay: 100 },
                    { freq: 784, delay: 200 },
                    { freq: 1047, delay: 300 },
                    { freq: 659, delay: 400 },
                    { freq: 784, delay: 500 },
                    { freq: 1047, delay: 600 },
                    { freq: 1319, delay: 700 }
                ];
                celebration.forEach(note => {
                    setTimeout(() => {
                        this.createSoftTone(note.freq, 0.15, 0.18);
                        // エコーエフェクト
                        setTimeout(() => this.createSoftTone(note.freq * 0.5, 0.1, 0.08), 50);
                    }, note.delay);
                });
            }

            // タイマー音
            playTick() {
                this.createBell(800, 0.05, 0.1);
            }

            // 時間切れ音
            playTimeUp() {
                this.createWarmTone(220, 0.4, 0.3);
                setTimeout(() => this.createWarmTone(196, 0.6, 0.25), 200);
            }

            // ベル系の音色
            createBell(frequency, duration, volume = 0.2) {
                if (!this.audioContext) return;

                const oscillator = this.audioContext.createOscillator();
                const gainNode = this.audioContext.createGain();
                const filter = this.audioContext.createBiquadFilter();

                oscillator.connect(filter);
                filter.connect(gainNode);
                gainNode.connect(this.audioContext.destination);

                oscillator.frequency.setValueAtTime(frequency, this.audioContext.currentTime);
                oscillator.type = 'sine';
                
                filter.type = 'lowpass';
                filter.frequency.setValueAtTime(frequency * 2, this.audioContext.currentTime);

                gainNode.gain.setValueAtTime(0, this.audioContext.currentTime);
                gainNode.gain.linearRampToValueAtTime(volume, this.audioContext.currentTime + 0.01);
                gainNode.gain.exponentialRampToValueAtTime(0.001, this.audioContext.currentTime + duration);

                oscillator.start(this.audioContext.currentTime);
                oscillator.stop(this.audioContext.currentTime + duration);
            }

            // 柔らかい音色
            createSoftTone(frequency, duration, volume = 0.2) {
                if (!this.audioContext) return;

                const oscillator = this.audioContext.createOscillator();
                const gainNode = this.audioContext.createGain();

                oscillator.connect(gainNode);
                gainNode.connect(this.audioContext.destination);

                oscillator.frequency.setValueAtTime(frequency, this.audioContext.currentTime);
                oscillator.type = 'triangle';

                gainNode.gain.setValueAtTime(0, this.audioContext.currentTime);
                gainNode.gain.linearRampToValueAtTime(volume, this.audioContext.currentTime + 0.02);
                gainNode.gain.exponentialRampToValueAtTime(0.001, this.audioContext.currentTime + duration);

                oscillator.start(this.audioContext.currentTime);
                oscillator.stop(this.audioContext.currentTime + duration);
            }

            // 温かみのある音色
            createWarmTone(frequency, duration, volume = 0.2) {
                if (!this.audioContext) return;

                const oscillator = this.audioContext.createOscillator();
                const gainNode = this.audioContext.createGain();

                oscillator.connect(gainNode);
                gainNode.connect(this.audioContext.destination);

                oscillator.frequency.setValueAtTime(frequency, this.audioContext.currentTime);
                oscillator.type = 'square';

                gainNode.gain.setValueAtTime(0, this.audioContext.currentTime);
                gainNode.gain.linearRampToValueAtTime(volume, this.audioContext.currentTime + 0.05);
                gainNode.gain.exponentialRampToValueAtTime(0.001, this.audioContext.currentTime + duration);

                oscillator.start(this.audioContext.currentTime);
                oscillator.stop(this.audioContext.currentTime + duration);
            }
        }

        const soundSystem = new SoundSystem();

        /* ----------------- レッスン・文法項目定義 ----------------- */
        const lessons = {
            grade1: [
                {
                    id: 'lesson1',
                    name: 'Lesson1 - 文の基本',
                    grammar: [
                        {id: 'word_order', name: '1. 日本語と英語の語順'},
                        {id: 'sentence_types', name: '2. 英語の文の代表的な2つの型'},
                        {id: 'personal_statements', name: '3. 自分のことを述べたり相手のことをたずねる'},
                        {id: 'various_questions', name: '4. さまざまな疑問文'},
                        {id: 'requests', name: '5. お願いするとき'}
                    ]
                },
                {
                    id: 'lesson2',
                    name: 'Lesson2 - 代名詞',
                    grammar: [
                        {id: 'she_he_it', name: '1. she, he, it などの使い方'},
                        {id: 'pronoun_questions', name: '2. she, he などを使った文の疑問文'},
                        {id: 'this_that', name: '3. this と that の使い方'},
                        {id: 'this_that_questions', name: '4. this, that を使った文の疑問文'},
                        {id: 'we_you_they', name: '5. We, you, they の使い方'},
                        {id: 'can_usage', name: '6. can の意味と用法'},
                        {id: 'some_any', name: '7. some と any'}
                    ]
                },
                {
                    id: 'lesson3',
                    name: 'Lesson3 - 一般動詞',
                    grammar: [
                        {id: 'general_verbs', name: '1. 一般動詞には、どんなものがある？'},
                        {id: 'verb_s_es', name: '2. 一般動詞につく s, es'},
                        {id: 'verb_s_es_rules', name: '3. 一般動詞の s, es のつけ方'},
                        {id: 'noun_singular_plural', name: '4. 「1つ（単数）」なのか「2つ以上（複数）」なのかを表す名詞につく s, es'},
                        {id: 'plural_rules', name: '5. 複数形のつくり方'},
                        {id: 'pronoun_i', name: '6. 「私」を表す2つの形'},
                        {id: 'pronoun_cases', name: '7. 主語として使う場合と主語以外で使う「あなた」「彼」など'}
                    ]
                },
                {
                    id: 'lesson4',
                    name: 'Lesson4 - 過去形',
                    grammar: [
                        {id: 'past_statements', name: '1. 過去のことを言うとき'},
                        {id: 'past_questions', name: '2. 過去のことをたずねるとき（疑問文）'},
                        {id: 'past_negative', name: '3. 過去のことで「しなかった」「でなかった」ことを言うとき（否定文）'}
                    ]
                },
                {
                    id: 'lesson5',
                    name: 'Lesson5 - 現在進行形',
                    grammar: [
                        {id: 'present_continuous', name: '1. 今していることを伝えるとき'},
                        {id: 'present_continuous_negative', name: '2. 「〜していません」ということを伝えるとき'},
                        {id: 'present_continuous_questions', name: '3. 「〜しているのですか」、「何をしているのですか」と質問するとき'}
                    ]
                },
                {
                    id: 'lesson6',
                    name: 'Lesson6 - 疑問詞',
                    grammar: [
                        {id: 'why_because', name: '1. 「理由」を質問するとき、「理由」を述べるとき'},
                        {id: 'how_often', name: '2. 「どのくらいよく〜するか」を質問するとき、答えるとき'},
                        {id: 'which_who_whose', name: '3. 「どの〜」を質問するとき、「どちらを」「だれが」「だれの〜」を質問するとき'}
                    ]
                },
                {
                    id: 'lesson7',
                    name: 'Lesson7 - 助動詞',
                    grammar: [
                        {id: 'must_prohibition', name: '1. 「強い命令」や「禁止」を伝えるとき'},
                        {id: 'have_to_necessity', name: '2. 「〜する必要がある」「〜する必要はない」と伝えるとき'},
                        {id: 'may_able_to', name: '3. 「〜かもしれない」と述べるとき、「〜することができる」と述べるとき'}
                    ]
                },
                {
                    id: 'lesson8',
                    name: 'Lesson8 - 未来表現',
                    grammar: [
                        {id: 'be_going_to', name: '1. 予定や計画を述べるとき'},
                        {id: 'will_prediction', name: '2. 未来のことについて「〜だろう」という予想を述べるとき'},
                        {id: 'should', name: '3. 「〜すべきだ」と述べるとき'}
                    ]
                },
                {
                    id: 'lesson9',
                    name: 'Lesson9 - There is/are文',
                    grammar: [
                        {id: 'there_is_are', name: '1. 「〜に・・・がある（いる）」を伝えるとき'},
                        {id: 'there_is_are_questions', name: '2. 「〜に・・・はありますか」「〜に・・・はいくつありますか」と質問する場合'},
                        {id: 'look_sound', name: '3. 「〜そうに見える／聞こえる」と述べるとき'}
                    ]
                }
            ],
            grade2: [
                {
                    id: 'review_lesson',
                    name: 'Review Lesson - 1年生の復習',
                    grammar: [
                        {id: 'have_to_must_review', name: '1. 「〜する必要がある」や「強い命令」を伝えるとき（have [has] to と must）'},
                        {id: 'future_review', name: '2. 予定や未来についての予想を述べるとき（be going to と will）'},
                        {id: 'there_is_are_review', name: '3. ものがあることや、人がいることを述べるとき（There is [are] ~.）'},
                        {id: 'there_is_are_transformation', name: '4. There is [are] ~. の文の書き換え'}
                    ]
                },
                {
                    id: 'lesson1',
                    name: 'Lesson1 - 目的語2つ/接続詞that',
                    grammar: [
                        {id: 'double_object', name: '1. 「＜人＞に＜もの＞をあげる・送る」などと述べるとき（目的語を２つとる動詞）'},
                        {id: 'that_opinion', name: '2. 自分の意見や知っていることを伝えるとき（接続詞のthat）'},
                        {id: 'that_feeling', name: '3. 自分の気持ちとその理由を伝えるとき（接続詞のthat）'}
                    ]
                },
                {
                    id: 'lesson2',
                    name: 'Lesson2 - 過去進行形/接続詞',
                    grammar: [
                        {id: 'past_continuous', name: '1. 過去のある時点でしていたことを述べるとき（過去進行形）'},
                        {id: 'when_conjunction', name: '2. どんな時のことかを述べるとき（接続詞のwhen）'},
                        {id: 'if_because', name: '3. 条件を述べるとき、理由を述べるとき（接続詞のif）'}
                    ]
                },
                {
                    id: 'lesson3',
                    name: 'Lesson3 - 不定詞',
                    grammar: [
                        {id: 'infinitive_noun', name: '1. したいこと、なりたいものを述べるとき（名詞的用法「〜すること」）'},
                        {id: 'infinitive_adverb', name: '2. 目的を述べるとき（副詞的用法「〜するために」）'},
                        {id: 'infinitive_adjective', name: '3. 「ものの用途、何をするためのものか」を述べるとき（形容詞的用法「〜するための」）'}
                    ]
                },
                {
                    id: 'lesson4',
                    name: 'Lesson4 - 動名詞',
                    grammar: [
                        {id: 'gerund_object', name: '1. 「〜することを終える・楽しむ・好む」などを伝えるとき（動名詞）'},
                        {id: 'gerund_subject', name: '2. 「〜すること」を主語にして述べるとき（動名詞）'},
                        {id: 'teach_tell_that', name: '3. 「だれがだれにどんなことを教えたか・伝えたか」などを述べるとき（接続詞のthat）'}
                    ]
                },
                {
                    id: 'lesson5',
                    name: 'Lesson5 - 不定詞の発展',
                    grammar: [
                        {id: 'how_to_what_to', name: '1. 「〜の仕方」や「すべきこと」などを述べるとき'},
                        {id: 'it_is_to', name: '2. 「〜することはおもしろい・難しい・不可能だ」などを述べるとき（It is + 形容詞 + to + 動詞の原形〜.）'},
                        {id: 'teach_ask_how_to', name: '3. 「だれに〜の仕方、何をすべきかなどを伝える・教える・たずねるか」を述べるとき'}
                    ]
                },
                {
                    id: 'lesson6',
                    name: 'Lesson6 - 比較',
                    grammar: [
                        {id: 'comparative', name: '1. 2つのものを比べて、その違いを伝えるとき（比較級）'},
                        {id: 'superlative', name: '2. 3つ以上のものを比べて、「いちばん〜だ」と伝えるとき（最上級）'},
                        {id: 'as_as', name: '3. 「同じくらい〜だ」「いちばん好きだ」などを伝えるとき（原級など）'},
                        {id: 'comparison_rules', name: '4. 比較級・最上級の作り方'},
                        {id: 'comparison_transformation', name: '5. 比較表現の書き換え'},
                        {id: 'comparison_notes', name: '6. その他に注意すること'}
                    ]
                },
                {
                    id: 'lesson7',
                    name: 'Lesson7 - 受動態',
                    grammar: [
                        {id: 'passive_voice', name: '1. 「...は〜される」「...は〜されている」のような表現を伝えるとき'},
                        {id: 'passive_questions', name: '2. 「…は〜されますか」「...は〜されていますか」などと質問するとき'},
                        {id: 'passive_modal', name: '3. 「〜されるべきだ」「〜されることが可能だ」などを伝えるとき'},
                        {id: 'past_participle_rules', name: '4. 過去分詞形の作り方'},
                        {id: 'passive_transformation', name: '5. 受け身の文の書き換え例'}
                    ]
                },
                {
                    id: 'lesson8',
                    name: 'Lesson8 - 間接疑問文/感嘆文',
                    grammar: [
                        {id: 'indirect_questions_know', name: '1. 「いつ・どこで」などの情報を「知っている・知らない」などと表現するとき'},
                        {id: 'indirect_questions_tell', name: '2. 「いつ・どこで」などの情報を「だれに言ったか・聞いたか」などと表現するとき'},
                        {id: 'exclamatory', name: '3. 驚きや感動を表現するとき'}
                    ]
                },
                {
                    id: 'lesson9',
                    name: 'Lesson9 - 動詞の様々な使い方',
                    grammar: [
                        {id: 'make_call', name: '1. 「どんな気持ちになったか」「呼び名は何か」などを伝えるとき'},
                        {id: 'want_ask_to', name: '2. 人にしてほしいことを伝えたり頼んだりするとき'},
                        {id: 'let_help', name: '3. 許可を得るとき、だれが手伝ってくれるのかを述べるとき'}
                    ]
                }
            ],
            grade3: [
                {
                    id: 'review_lesson',
                    name: 'Review Lesson - 2年生の復習',
                    grammar: [
                        {id: 'how_to_what_to_review', name: '1. 「〜の仕方」や「すべきこと」などを述べるとき'},
                        {id: 'make_call_review', name: '2. 「呼び名は何か」「どんな気持ちになったか」などを述べるとき'},
                        {id: 'it_is_to_review', name: '3. 「〜することは難しい・やさしい」などを述べるとき'}
                    ]
                },
                {
                    id: 'lesson1',
                    name: 'Lesson1 - 現在完了形(1)',
                    grammar: [
                        {id: 'present_perfect_completion', name: '1. 「〜し終えた」ことを伝えるとき（現在完了形の完了用法）'},
                        {id: 'present_perfect_experience', name: '2. 「〜した経験がある」ことを伝えるとき（現在完了形の経験用法）'},
                        {id: 'present_perfect_experience_questions', name: '3. 「〜した経験があるか」を質問するとき（現在完了形の経験用法）'}
                    ]
                },
                {
                    id: 'lesson2',
                    name: 'Lesson2 - 現在完了形(2)',
                    grammar: [
                        {id: 'present_perfect_continuation', name: '1. 「ずっと〜している」ことを伝えるとき（現在完了形の継続用法）'},
                        {id: 'present_perfect_continuation_questions', name: '2. 「どのくらい〜していますか」と質問するとき（現在完了形の継続用法）'},
                        {id: 'present_perfect_continuous', name: '3. 「ずっと〜している」ことを伝えるとき（現在完了進行形）'}
                    ]
                },
                {
                    id: 'lesson3',
                    name: 'Lesson3 - 後置修飾',
                    grammar: [
                        {id: 'participle_present', name: '1. 「どんな人か・どんなものか」を説明するとき（その1：現在分詞による後置修飾）'},
                        {id: 'participle_past', name: '2. 「どんな人か・どんなものか」を説明するとき（その2：過去分詞による後置修飾）'},
                        {id: 'relative_pronoun_omission', name: '3. 「どんな人か・どんなものか」を説明するとき（その3：目的格の関係代名詞の省略）'}
                    ]
                },
                {
                    id: 'lesson4',
                    name: 'Lesson4 - 関係代名詞',
                    grammar: [
                        {id: 'relative_pronoun_who', name: '1. 「どんな人か」を説明するとき（主格の関係代名詞）'},
                        {id: 'relative_pronoun_which', name: '2. 「どんなものか」を説明するとき（主格の関係代名詞）'},
                        {id: 'relative_pronoun_object', name: '3. 「どんな人か・どんなものか」を説明するとき（目的格の関係代名詞）'}
                    ]
                },
                {
                    id: 'lesson5',
                    name: 'Lesson5 - 仮定法',
                    grammar: [
                        {id: 'subjunctive_1', name: '1. 実現する可能性がない、または可能性が低いことを「〜ならなあ」と表現する場合（その1）'},
                        {id: 'subjunctive_2', name: '2. 実現する可能性がない、または可能性が低いことを「〜ならなあ」と表現する場合（その2）'},
                        {id: 'subjunctive_3', name: '3. 実現する可能性がない、または可能性が低いことを「〜ならなあ」と表現する場合（その3）'}
                    ]
                },
                {
                    id: 'lesson6',
                    name: 'Lesson6 - 後置修飾と関係代名詞のまとめ',
                    grammar: [
                        {id: 'postposition_ing', name: '1. 〈名詞 ＋ 動詞の-ing形 ＋ 語句〉（現在分詞による後置修飾）'},
                        {id: 'postposition_past_participle', name: '2. 〈名詞 ＋ 動詞の過去分詞形 ＋ 語句〉（過去分詞による後置修飾）'},
                        {id: 'postposition_omission', name: '3. 〈名詞 ＋ 主語 ＋ 動詞 〜〉（目的格の関係代名詞の省略）'},
                        {id: 'relative_summary', name: '4. 〈名詞 ＋ 関係代名詞（who, which, that） ＋ 語句〉（主格の関係代名詞と目的格の関係代名詞）'},
                        {id: 'sentence_transformation', name: '5. 文の書き換え'}
                    ]
                }
            ]
        };

        /* ----------------- ゲーム変数 ----------------- */
        let selectedGrammarItems = [];
        let currentQuestionIndex = 0;
        let studyCount = 0; // 学習回数（問題を見た回数）
        let totalClickCount = 0; // 総クリック数
        let sessionClickCount = 0; // セッション内クリック数
        let usedQuestions = [];
        let particleOffset = 0;
        let currentGrade = '';
        let currentLesson = '';
        
        // 出題形式関連の変数
        let questionMode = 'random'; // 'random' または 'sequential'
        let sequentialIndex = 0;
        let questionDirection = 'jp_to_en'; // 'jp_to_en', 'en_to_jp', 'mixed'
        
        // タイマー関連の変数
        let timerLimit = 3; // デフォルト3秒
        let timerInterval = null;
        let currentTimerValue = 0;
        let isTimerRunning = false;
        let isQuizAnswered = false;

        /* ----------------- クリック数管理機能 ----------------- */
        function incrementClickCount() {
            totalClickCount++;
            sessionClickCount++;
            updateClickDisplays();
            saveClickCount();
            
            // 10クリックごとに嬉しい通知
            if (totalClickCount % 10 === 0) {
                showNotification(`🎉 ${totalClickCount}回クリック達成！学習が積み重なってますね！`);
                createParticle('✨', '#a584c7', window.innerWidth / 2, window.innerHeight / 2);
            }
            
            // 100クリックごとに特別な効果
            if (totalClickCount % 100 === 0) {
                soundSystem.playSuccess();
                showNotification(`🏆 ${totalClickCount}回クリック記念！素晴らしい継続力です！`);
                createParticle('🏆', '#f4a261', window.innerWidth / 2, window.innerHeight / 2);
                createParticle('🎊', '#7fb069', window.innerWidth / 2 - 50, window.innerHeight / 2 - 30);
                createParticle('✨', '#6bb6ff', window.innerWidth / 2 + 50, window.innerHeight / 2 - 30);
            }
        }

        function updateClickDisplays() {
            // メイン画面の総クリック数表示
            const totalDisplay = document.getElementById('totalClickDisplay');
            if (totalDisplay) {
                totalDisplay.textContent = totalClickCount;
            }
            
            // ゲーム画面のクリック数表示
            const sessionDisplay = document.getElementById('clickCount');
            if (sessionDisplay) {
                sessionDisplay.textContent = sessionClickCount;
            }
        }

        function saveClickCount() {
            try {
                localStorage.setItem('oneWorldQuizTotalClicks', totalClickCount.toString());
            } catch (e) {
                console.log('クリック数の保存に失敗しました');
            }
        }

        function loadClickCount() {
            try {
                const saved = localStorage.getItem('oneWorldQuizTotalClicks');
                if (saved) {
                    totalClickCount = parseInt(saved, 10) || 0;
                    updateClickDisplays();
                }
            } catch (e) {
                console.log('クリック数の読み込みに失敗しました');
            }
        }

        /* ----------------- エフェクト関数 ----------------- */
        function createParticle(text, color, x, y) {
            const particle = document.createElement('div');
            particle.className = 'particle';
            particle.textContent = text;
            particle.style.color = color;
            particle.style.left = (x + particleOffset) + 'px';
            particle.style.top = (y + particleOffset) + 'px';
            particle.style.fontSize = '20px';
            document.body.appendChild(particle);

            particleOffset += 40;
            if (particleOffset > 160) particleOffset = 0;

            setTimeout(() => {
                if (particle.parentNode) {
                    particle.parentNode.removeChild(particle);
                }
            }, 2500);
        }

        function showNotification(text) {
            const notification = document.getElementById('notification');
            const notificationText = document.getElementById('notificationText');
            notificationText.textContent = text;
            notification.classList.add('show');
            setTimeout(() => {
                notification.classList.remove('show');
            }, 3500);
        }

        /* ----------------- タイマー関数 ----------------- */
        function setTimerLimit(seconds) {
            timerLimit = seconds;
            
            document.getElementById('timer3Btn').classList.remove('active');
            document.getElementById('timer5Btn').classList.remove('active');
            document.getElementById('timer10Btn').classList.remove('active');
            
            if (seconds === 3) {
                document.getElementById('timer3Btn').classList.add('active');
                document.getElementById('timerDescription').textContent = '3秒で制限時間切れ！ドキドキチャレンジ';
                showNotification('⚡ 3秒チャレンジ！超高速モードです');
            } else if (seconds === 5) {
                document.getElementById('timer5Btn').classList.add('active');
                document.getElementById('timerDescription').textContent = '5秒で考える！適度にドキドキ';
                showNotification('🔥 5秒チャレンジ！いい感じの緊張感');
            } else {
                document.getElementById('timer10Btn').classList.add('active');
                document.getElementById('timerDescription').textContent = '10秒でじっくり考えよう';
                showNotification('🌟 10秒チャレンジ！じっくり考えられます');
            }
        }

        function startTimer() {
            if (isTimerRunning) return;
            
            isTimerRunning = true;
            isQuizAnswered = false;
            currentTimerValue = timerLimit;
            
            const timerDisplay = document.getElementById('timerDisplay');
            const timerValueEl = document.getElementById('timerValue');
            
            // 初期表示
            timerValueEl.textContent = currentTimerValue;
            updateTimerStyle();
            
            timerInterval = setInterval(() => {
                currentTimerValue--;
                timerValueEl.textContent = currentTimerValue;
                updateTimerStyle();
                
                // 最後の3秒間はチック音
                if (currentTimerValue <= 3 && currentTimerValue > 0) {
                    soundSystem.playTick();
                }
                
                if (currentTimerValue <= 0) {
                    stopTimer();
                    timeUp();
                }
            }, 1000);
        }

        function stopTimer() {
            if (timerInterval) {
                clearInterval(timerInterval);
                timerInterval = null;
            }
            isTimerRunning = false;
        }

        function updateTimerStyle() {
            const timerDisplay = document.getElementById('timerDisplay');
            const percentage = currentTimerValue / timerLimit;
            
            timerDisplay.classList.remove('timer-normal', 'timer-warning', 'timer-danger');
            
            if (percentage > 0.6) {
                timerDisplay.classList.add('timer-normal');
            } else if (percentage > 0.3) {
                timerDisplay.classList.add('timer-warning');
            } else {
                timerDisplay.classList.add('timer-danger');
            }
        }

        function timeUp() {
            if (isQuizAnswered) return;
            
            soundSystem.playTimeUp();
            showNotification('⏰ 時間切れ！解答を表示します');
            showAnswerForced();
        }

        function showAnswerForced() {
            if (isQuizAnswered) return;
            
            isQuizAnswered = true;
            studyCount++; // 学習回数をカウント
            updateStats();
            
            showAnswerContent();
            
            // ボタンを有効化
            document.getElementById('quizNext').disabled = false;
            document.getElementById('showAnswerBtn').disabled = true;
            document.getElementById('showAnswerBtn').textContent = '⏰ 時間切れ';
            
            createParticle('⏰ 時間切れ', '#f9b6a3', window.innerWidth / 2, window.innerHeight / 2);
        }

        /* ----------------- 画面遷移関数 ----------------- */
        function hideAllModals() {
            document.querySelectorAll('.modal').forEach(modal => {
                modal.classList.remove('show');
            });
        }

        function goBackToMain() {
            hideAllModals();
            document.getElementById('mainGradeModal').classList.add('show');
            soundSystem.playClick();
        }

        function goBackToGrade(grade) {
            hideAllModals();
            document.getElementById(`${grade}Modal`).classList.add('show');
            soundSystem.playClick();
        }

        /* ----------------- レッスン・文法項目の初期化 ----------------- */
        function initLessonsAndGrammar() {
            // 各学年のレッスンを初期化
            ['grade1', 'grade2', 'grade3'].forEach(grade => {
                const container = document.getElementById(`${grade}Lessons`);
                lessons[grade].forEach(lesson => {
                    const btn = document.createElement('button');
                    btn.className = 'lesson-btn';
                    btn.innerHTML = lesson.name;
                    btn.dataset.lessonId = lesson.id;
                    btn.onclick = () => openGrammarSelection(grade, lesson);
                    container.appendChild(btn);
                });
            });
        }

        function openGrammarSelection(grade, lesson) {
            soundSystem.playClick();
            currentGrade = grade;
            currentLesson = lesson.id;
            selectedGrammarItems = [];
            
            hideAllModals();
            
            const modal = document.getElementById('grammarModal');
            const title = document.getElementById('grammarModalTitle');
            const container = document.getElementById('grammarCategories');
            const backButton = document.getElementById('grammarBackButton');
            const startButton = document.getElementById('startGrammarQuiz');
            
            // タイトル設定
            const gradeNames = {
                'grade1': '🌱 中学1年生',
                'grade2': '🌿 中学2年生',
                'grade3': '🌳 中学3年生'
            };
            title.textContent = `${gradeNames[grade]} - ${lesson.name}`;
            
            // 文法項目ボタン生成
            container.innerHTML = '';
            lesson.grammar.forEach(grammarItem => {
                const btn = document.createElement('button');
                btn.className = 'grammar-btn';
                btn.innerHTML = grammarItem.name;
                btn.dataset.grammarId = grammarItem.id;
                btn.onclick = () => toggleGrammarSelection(grammarItem.id, btn);
                container.appendChild(btn);
            });
            
            // 戻るボタンの設定
            backButton.onclick = () => goBackToGrade(grade);
            
            // 開始ボタンの初期状態
            startButton.disabled = true;
            
            modal.classList.add('show');
        }

        function toggleGrammarSelection(grammarId, buttonElement) {
            soundSystem.playClick();
            if (selectedGrammarItems.includes(grammarId)) {
                selectedGrammarItems = selectedGrammarItems.filter(id => id !== grammarId);
                buttonElement.classList.remove('active');
            } else {
                selectedGrammarItems.push(grammarId);
                buttonElement.classList.add('active');
            }

            // 開始ボタンの状態を更新
            const startButton = document.getElementById('startGrammarQuiz');
            startButton.disabled = selectedGrammarItems.length === 0;
        }

        function startSelectedQuiz() {
            hideAllModals();
            
            const gradeNames = {
                'grade1': '🌱 中学1年生',
                'grade2': '🌿 中学2年生',
                'grade3': '🌳 中学3年生'
            };
            
            const lessonName = lessons[currentGrade].find(l => l.id === currentLesson).name;
            document.getElementById('currentCategory').textContent = `${gradeNames[currentGrade]} - ${lessonName} (${selectedGrammarItems.length}項目選択)`;
            document.getElementById('gameScreen').classList.remove('hidden');
            
            // フローティングボタンを表示
            const floatingBtn = document.getElementById('changeSubject');
            floatingBtn.classList.remove('hidden');
            floatingBtn.style.display = 'flex';

            // 統計をリセット
            studyCount = 0;
            sessionClickCount = 0;
            usedQuestions = [];
            sequentialIndex = 0;
            updateStats();
            showNotification(`🎯 ${selectedGrammarItems.length}項目を選択しました！学習スタート！`);
        }

        function updateStats() {
            document.getElementById('studyCount').textContent = studyCount;
            document.getElementById('clickCount').textContent = sessionClickCount;
        }

        function setQuestionMode(mode) {
            questionMode = mode;
            
            document.getElementById('randomModeBtn').classList.remove('active');
            document.getElementById('sequentialModeBtn').classList.remove('active');
            
            if (mode === 'random') {
                document.getElementById('randomModeBtn').classList.add('active');
                document.getElementById('modeDescription').textContent = '問題をランダムにシャッフルして出題します';
                usedQuestions = [];
                showNotification('🎲 ランダムモードに切り替わりました！');
            } else {
                document.getElementById('sequentialModeBtn').classList.add('active');
                document.getElementById('modeDescription').textContent = '問題を順番通りに学習できます';
                sequentialIndex = 0;
                showNotification('📖 順番学習モードに切り替わりました！');
            }
        }

        function setQuestionDirection(direction) {
            questionDirection = direction;
            
            document.getElementById('jpToEnBtn').classList.remove('active');
            document.getElementById('enToJpBtn').classList.remove('active');
            document.getElementById('mixedBtn').classList.remove('active');
            
            if (direction === 'jp_to_en') {
                document.getElementById('jpToEnBtn').classList.add('active');
                document.getElementById('directionDescription').textContent = '日本語を英語に変換する問題';
                showNotification('🇯🇵→🇺🇸 日本語→英語モードに設定しました！');
            } else if (direction === 'en_to_jp') {
                document.getElementById('enToJpBtn').classList.add('active');
                document.getElementById('directionDescription').textContent = '英語を日本語に変換する問題';
                showNotification('🇺🇸→🇯🇵 英語→日本語モードに設定しました！');
            } else {
                document.getElementById('mixedBtn').classList.add('active');
                document.getElementById('directionDescription').textContent = '日本語→英語、英語→日本語をランダムに出題';
                showNotification('🔀 ミックスモードで挑戦しましょう！');
            }
        }

        /* ----------------- クイズ機能 ----------------- */
        function openQuiz() {
            if (selectedGrammarItems.length === 0) {
                showNotification('📚 文法項目を選択してください');
                return;
            }

            // デモ用の問題データ（problems.jsが読み込まれていない場合）
            const demoData = [
                { q: "私は音楽が好きです。", ans: "I like music.", exp: "英語では（主語 + 動詞 + 目的語）の語順になります。「私は」がI、「好きです」がlike、「音楽を」がmusicですね。" },
                { q: "彼は先生です。", ans: "He is a teacher.", exp: "「彼は」がHe、「です」がis、「先生」がteacherとなります。" },
                { q: "これは私の本です。", ans: "This is my book.", exp: "「これは」がThis is、「私の」がmy、「本」がbookです。" }
            ];

            // 問題データの取得
            let allProblems = [];
            
            if (typeof problemDatabase !== 'undefined') {
                // problems.jsが読み込まれている場合
                selectedGrammarItems.forEach(grammarId => {
                    const fullId = `${currentGrade}_${currentLesson}_${grammarId}`;
                    if (problemDatabase[fullId]) {
                        allProblems = allProblems.concat(problemDatabase[fullId]);
                    }
                });
            }
            
            // データがない場合はデモデータを使用
            if (allProblems.length === 0) {
                allProblems = demoData;
                showNotification('🔧 デモ問題を表示中です（problems.jsを読み込んでください）');
            }

            if (usedQuestions.length >= allProblems.length) {
                usedQuestions = [];
                showNotification('🎊 全問クリア！問題をリセットしました');
            }

            // 出題形式に応じた問題選択
            let quiz;
            let remainingCount;
            
            if (questionMode === 'random') {
                const availableQuestions = allProblems.filter((_, index) => !usedQuestions.includes(index));
                if (availableQuestions.length === 0) return;
                
                const randomIndex = Math.floor(Math.random() * availableQuestions.length);
                quiz = availableQuestions[randomIndex];
                const originalIndex = allProblems.indexOf(quiz);
                usedQuestions.push(originalIndex);
                remainingCount = allProblems.length - usedQuestions.length;
            } else {
                if (sequentialIndex >= allProblems.length) {
                    sequentialIndex = 0;
                    showNotification('🔄 全問題を一周しました！最初から再開します');
                }
                quiz = allProblems[sequentialIndex];
                sequentialIndex++;
                remainingCount = allProblems.length - sequentialIndex;
                if (remainingCount < 0) remainingCount = 0;
            }

            // 出題方向に応じて問題を調整
            let actualQuiz = quiz;
            if (questionDirection === 'en_to_jp' && quiz.reverse) {
                actualQuiz = quiz.reverse;
            } else if (questionDirection === 'mixed') {
                if (Math.random() < 0.5 && quiz.reverse) {
                    actualQuiz = quiz.reverse;
                }
            }

            displayQuiz(actualQuiz, remainingCount);
        }

        function displayQuiz(quiz, remainingCount) {
            const modal = document.getElementById('quizModal');
            const questionEl = document.getElementById('quizQuestion');
            const remainingEl = document.getElementById('remainingCount');
            const timerValueEl = document.getElementById('timerValue');
            const showAnswerBtn = document.getElementById('showAnswerBtn');
            const answerDisplayEl = document.getElementById('answerDisplay');
            const answerContentEl = document.getElementById('answerContent');
            const nextBtn = document.getElementById('quizNext');
            const backBtn = document.getElementById('quizBack');

            // 問題表示
            questionEl.textContent = quiz.q;
            remainingEl.textContent = `残り${remainingCount}問`;

            // タイマー初期化
            timerValueEl.textContent = timerLimit;
            document.getElementById('timerDisplay').classList.remove('timer-warning', 'timer-danger');
            document.getElementById('timerDisplay').classList.add('timer-normal');

            // ボタンの初期状態
            showAnswerBtn.disabled = false;
            showAnswerBtn.textContent = '💡 解答を見る';
            nextBtn.disabled = true;
            
            // 解答表示エリアの初期化
            answerDisplayEl.classList.remove('show');
            answerContentEl.innerHTML = '<div class="text-gray-500">頭で考えてから解答ボタンを押してね！</div>';

            // 現在のクイズデータを保存
            modal.currentQuiz = quiz;

            // イベントリスナー設定
            showAnswerBtn.onclick = () => showAnswer();
            nextBtn.onclick = () => {
                soundSystem.playClick();
                stopTimer();
                openQuiz(); // 新しい問題を表示
            };
            backBtn.onclick = () => {
                soundSystem.playClick();
                stopTimer();
                modal.classList.remove('show');
                showNotification('🏠 お疲れさまでした！また挑戦してくださいね');
            };

            // モーダル表示
            modal.classList.add('show');
            
            // 少し遅れてタイマーを開始（ユーザーが問題を読む時間を作る）
            setTimeout(() => {
                startTimer();
            }, 500);
        }

        function showAnswer() {
            if (isQuizAnswered) return;
            
            soundSystem.playClick();
            soundSystem.playStudyComplete(); // 学習完了音
            stopTimer();
            isQuizAnswered = true;
            
            // 学習回数をカウント
            studyCount++;
            updateStats();
            
            showAnswerContent();
            
            // ボタンを更新
            document.getElementById('showAnswerBtn').disabled = true;
            document.getElementById('showAnswerBtn').textContent = '📖 解答済み';
            document.getElementById('quizNext').disabled = false;
            
            createParticle('📚 学習完了！', '#7fb069', window.innerWidth / 2, window.innerHeight / 2);
        }

        function showAnswerContent() {
            const modal = document.getElementById('quizModal');
            const quiz = modal.currentQuiz;
            const answerDisplayEl = document.getElementById('answerDisplay');
            const answerContentEl = document.getElementById('answerContent');
            
            answerDisplayEl.classList.add('show');
            answerContentEl.innerHTML = `
                <div class="answer-text">${quiz.ans}</div>
                <div class="explanation-text">${quiz.exp || 'がんばりました！'}</div>
            `;
        }

        /* ----------------- イベントリスナー ----------------- */
        function initEventListeners() {
            // 学年選択
            document.querySelectorAll('[data-grade]').forEach(btn => {
                btn.addEventListener('click', (e) => {
                    incrementClickCount();
                    soundSystem.playClick();
                    const grade = e.currentTarget.dataset.grade;
                    hideAllModals();
                    document.getElementById(grade + 'Modal').classList.add('show');
                });
            });

            // 文法クイズ開始ボタン
            document.getElementById('startGrammarQuiz').addEventListener('click', () => {
                incrementClickCount();
                soundSystem.playSuccess();
                startSelectedQuiz();
            });

            // メインクイズスタートボタン
            document.getElementById('startQuizButton').addEventListener('click', () => {
                incrementClickCount();
                soundSystem.playSuccess();
                openQuiz();
            });

            // タイマー設定ボタン
            document.getElementById('timer3Btn').addEventListener('click', () => {
                incrementClickCount();
                soundSystem.playClick();
                setTimerLimit(3);
            });
            
            document.getElementById('timer5Btn').addEventListener('click', () => {
                incrementClickCount();
                soundSystem.playClick();
                setTimerLimit(5);
            });
            
            document.getElementById('timer10Btn').addEventListener('click', () => {
                incrementClickCount();
                soundSystem.playClick();
                setTimerLimit(10);
            });

            // 出題形式切り替えボタン
            document.getElementById('randomModeBtn').addEventListener('click', () => {
                incrementClickCount();
                soundSystem.playClick();
                setQuestionMode('random');
            });
            
            document.getElementById('sequentialModeBtn').addEventListener('click', () => {
                incrementClickCount();
                soundSystem.playClick();
                setQuestionMode('sequential');
            });

            // 出題方向切り替えボタン
            document.getElementById('jpToEnBtn').addEventListener('click', () => {
                incrementClickCount();
                soundSystem.playClick();
                setQuestionDirection('jp_to_en');
            });
            
            document.getElementById('enToJpBtn').addEventListener('click', () => {
                incrementClickCount();
                soundSystem.playClick();
                setQuestionDirection('en_to_jp');
            });
            
            document.getElementById('mixedBtn').addEventListener('click', () => {
                incrementClickCount();
                soundSystem.playClick();
                setQuestionDirection('mixed');
            });

            // 教科変更ボタン
            document.getElementById('changeSubject').addEventListener('click', (e) => {
                e.preventDefault();
                e.stopPropagation();
                incrementClickCount();
                soundSystem.playClick();
                stopTimer();
                selectedGrammarItems = [];
                sequentialIndex = 0;
                usedQuestions = [];
                document.getElementById('gameScreen').classList.add('hidden');
                document.getElementById('changeSubject').classList.add('hidden');
                goBackToMain();
            });
        }

        function addClickCounterToAllButtons() {
            // 動的に生成されるボタンも含めてすべてのボタンにクリックカウンターを追加
            document.addEventListener('click', (e) => {
                if (e.target.matches('button') && !e.target.hasAttribute('data-click-counted')) {
                    e.target.setAttribute('data-click-counted', 'true');
                    incrementClickCount();
                }
            });
            
            document.addEventListener('touchstart', (e) => {
                if (e.touches.length > 1) {
                    e.preventDefault();
                }
            }, { passive: false });
            
            document.addEventListener('gesturestart', (e) => {
                e.preventDefault();
            });
        }

        document.addEventListener('DOMContentLoaded', () => {
            loadClickCount(); // 保存されたクリック数を読み込み
            initLessonsAndGrammar();
            initEventListeners();
            addClickCounterToAllButtons();
            
            document.getElementById('changeSubject').classList.add('hidden');
            
            document.body.style.webkitTouchCallout = 'none';
            document.body.style.webkitUserSelect = 'none';
            document.body.style.userSelect = 'none';

            document.addEventListener('click', () => {
                if (soundSystem.audioContext && soundSystem.audioContext.state === 'suspended') {
                    soundSystem.audioContext.resume();
                }
            }, { once: true });
            
            // 初回表示時の特別メッセージ
            if (totalClickCount === 0) {
                setTimeout(() => {
                    showNotification('🌟 ようこそ！ボタンを押すたびにクリック数が増えて、学習の記録になります！');
                }, 1000);
            }
        });
    </script>
</body>
</html>