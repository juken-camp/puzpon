<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
  <title>JUKEN★QUEST – Ultimate Edition</title>
  <style>
    body {
      background: linear-gradient(135deg, #0a0a0f 0%, #1a0a2e 50%, #0a0a0f 100%);
      font-family: Arial, sans-serif;
      min-height: 100vh;
      color: white;
      margin: 0;
      padding: 20px;
    }
    
    /* 超軽量ボタンスタイル */
    .neon-button {
      background: linear-gradient(45deg, rgba(0, 255, 255, 0.2), rgba(255, 0, 255, 0.2));
      border: 1px solid #00ffff;
      color: white;
      border-radius: 12px;
      cursor: pointer;
      padding: 12px 20px;
      font-weight: bold;
      transition: none; /* アニメーション完全削除 */
    }
    
    .neon-button:hover {
      background: linear-gradient(45deg, rgba(0, 255, 255, 0.4), rgba(255, 0, 255, 0.4));
    }
    
    .neon-button:disabled {
      opacity: 0.4;
      cursor: not-allowed;
    }
    
    .subject-btn {
      background: rgba(255, 255, 255, 0.1);
      border: 1px solid rgba(255, 255, 255, 0.2);
      border-radius: 8px;
      color: white;
      padding: 12px 8px;
      margin: 4px;
      cursor: pointer;
      text-align: center;
      display: inline-block;
      width: 140px;
      transition: none; /* アニメーション削除 */
    }
    
    .subject-btn:hover {
      background: rgba(0, 255, 255, 0.2);
      border-color: #00ffff;
    }
    
    .subject-btn.active {
      background: rgba(139, 92, 246, 0.6);
      border-color: #8b5cf6;
    }
    
    .modal {
      display: none;
      position: fixed;
      inset: 0;
      background: rgba(0, 0, 0, 0.9);
      align-items: center;
      justify-content: center;
      z-index: 1000;
      padding: 1rem;
    }
    
    .modal.show {
      display: flex;
    }
    
    .game-card {
      background: rgba(15, 15, 25, 0.95);
      border: 1px solid rgba(0, 255, 255, 0.3);
      border-radius: 15px;
      padding: 20px;
      margin: 10px;
      max-width: 800px;
      width: 100%;
    }
    
    .notification {
      position: fixed;
      top: 20px;
      right: 20px;
      background: rgba(0, 255, 65, 0.9);
      color: white;
      padding: 15px 20px;
      border-radius: 10px;
      transform: translateX(400px);
      transition: transform 0.3s ease;
      z-index: 1001;
      max-width: 300px;
    }
    
    .notification.show {
      transform: translateX(0);
    }
    
    /* 基本レイアウト用CSS */
    .text-center { text-align: center; }
    .mb-4 { margin-bottom: 1rem; }
    .mb-6 { margin-bottom: 1.5rem; }
    .mt-2 { margin-top: 0.5rem; }
    .p-3 { padding: 0.75rem; }
    .px-6 { padding-left: 1.5rem; padding-right: 1.5rem; }
    .py-3 { padding-top: 0.75rem; padding-bottom: 0.75rem; }
    .ml-4 { margin-left: 1rem; }
    .grid { display: grid; }
    .grid-2 { grid-template-columns: 1fr 1fr; }
    .grid-3 { grid-template-columns: 1fr 1fr 1fr; }
    .gap-4 { gap: 1rem; }
    .w-full { width: 100%; }
    .flex { display: flex; }
    .space-y-4 > * + * { margin-top: 1rem; }
    .space-y-2 > * + * { margin-top: 0.5rem; }
    .bg-gray-800 { background-color: rgb(31, 41, 55); }
    .rounded { border-radius: 0.5rem; }
    .text-lg { font-size: 1.125rem; }
    .text-xl { font-size: 1.25rem; }
    .text-2xl { font-size: 1.5rem; }
    .text-3xl { font-size: 1.875rem; }
    .font-bold { font-weight: bold; }
    .justify-between { justify-content: space-between; }
    .items-center { align-items: center; }
    .text-yellow-400 { color: rgb(251, 191, 36); }
    .text-red-400 { color: rgb(248, 113, 113); }
    .text-purple-400 { color: rgb(196, 181, 253); }
    .text-cyan-400 { color: rgb(34, 211, 238); }
    .text-gray-300 { color: rgb(209, 213, 219); }
    .opacity-70 { opacity: 0.7; }
    .min-h-60 { min-height: 60px; }
    .flex-1 { flex: 1; }
    .py-2 { padding-top: 0.5rem; padding-bottom: 0.5rem; }
    .gap-2 { gap: 0.5rem; }
    .text-sm { font-size: 0.875rem; }
    
    @media (max-width: 640px) {
      .subject-btn {
        width: 120px;
        padding: 10px 6px;
        margin: 2px;
      }
      .grid-3 { grid-template-columns: 1fr; }
    }
  </style>
</head>
<body>

<!-- 教科選択モーダル -->
<div id="subjectModal" class="modal show">
  <div class="game-card">
    <h2 class="text-2xl font-bold text-center mb-4 text-cyan-400">🎯 教科選択</h2>
    <p class="text-center text-gray-300 mb-6">学習したい分野を選んでクエストを開始！</p>
    
    <div id="subjectContainer" class="text-center mb-6">
      <!-- JavaScriptで生成 -->
    </div>
    
    <div class="text-center">
      <button id="startGame" class="neon-button text-lg font-bold">
        🚀 クエスト開始
      </button>
    </div>
  </div>
</div>

<!-- メインゲーム画面 -->
<div id="gameArea" style="display: none;">
  <div class="game-card text-center mb-4">
    <h1 class="text-3xl font-bold text-cyan-400">JUKEN★QUEST</h1>
    <div id="currentSubject" class="mt-2 text-xl font-bold text-yellow-400"></div>
  </div>
  
  <div class="game-card mb-4">
    <h3 class="font-bold text-xl mb-4 text-cyan-400">📊 ステータス</h3>
    <div id="stats" class="grid grid-2 gap-4 text-sm">
      <!-- JavaScriptで更新 -->
    </div>
  </div>
  
  <div class="game-card mb-4">
    <h3 class="font-bold text-xl mb-4 text-cyan-400">⚡ パワーアップ</h3>
    <div class="grid grid-3 gap-4">
      <button id="upgradeAttack" class="neon-button p-3">
        <div>⚔️ 攻撃力強化</div>
        <div class="text-sm opacity-70">コスト: ¥<span id="attackCost">100</span></div>
      </button>
      
      <button id="upgradeCrit" class="neon-button p-3">
        <div>💥 クリティカル強化</div>
        <div class="text-sm opacity-70">コスト: ¥<span id="critCost">200</span></div>
      </button>
      
      <button id="upgradeDefense" class="neon-button p-3">
        <div>🛡️ 防御力強化</div>
        <div class="text-sm opacity-70">コスト: ¥<span id="defenseCost">150</span></div>
      </button>
    </div>
  </div>
  
  <div class="text-center">
    <button id="manualQuizButton" class="neon-button px-6 py-3 text-lg">
      🧠 問題にチャレンジ！
    </button>
    <button id="changeSubject" class="neon-button px-6 py-3 text-lg ml-4">
      📚 教科変更
    </button>
  </div>
</div>

<!-- クイズモーダル -->
<div id="quizModal" class="modal">
  <div class="game-card" style="max-width: 600px;">
    <h2 class="font-bold text-xl text-center mb-4 text-cyan-400">🧠 ナレッジバトル！</h2>
    
    <div class="space-y-4">
      <p id="quizQ" class="text-lg font-bold text-center"></p>
      <div id="quizOptions" class="space-y-2"></div>
      
      <div id="quizExplanation" class="bg-gray-800 rounded p-3 min-h-60 flex items-center">
        <p id="quizMsg" class="text-center text-sm w-full"></p>
      </div>
      
      <div class="flex gap-2">
        <button id="quizNext" class="flex-1 neon-button py-2">🔥 次の問題</button>
        <button id="quizBack" class="flex-1 neon-button py-2">🏠 戻る</button>
      </div>
    </div>
  </div>
</div>

<!-- 通知 -->
<div id="notification" class="notification">
  <div id="notificationText"></div>
</div>

<script>
// 超軽量サウンドシステム
class SimpleSound {
  playClick() { /* サウンド削除で軽量化 */ }
  playCorrect() { /* サウンド削除で軽量化 */ }
  playWrong() { /* サウンド削除で軽量化 */ }
}

const soundSystem = new SimpleSound();

// 問題データベース（18教科完全版）
const problemDatabase = {
  'geography_1': [
    {q:"三大洋のうち、最も面積が大きい海洋は？", opts:["大西洋","インド洋","太平洋","北極海"], ans:2, exp:"太平洋は地球の約3分の1を占める最大の海洋です。"},
    {q:"面積が最も大きい大陸は？", opts:["アフリカ大陸","ユーラシア大陸","北アメリカ大陸","南極大陸"], ans:1, exp:"アジア州とヨーロッパ州を含む巨大大陸です。"},
    {q:"日本の最北端の島は？", opts:["択捉島","沖ノ鳥島","与那国島","南鳥島"], ans:0, exp:"北方領土の一つで日本最北端の島です。"},
    {q:"日本の最南端の島は？", opts:["択捉島","与那国島","沖ノ鳥島","南鳥島"], ans:2, exp:"東京都小笠原村にある日本最南端の島です。"},
    {q:"温帯の中で、日本の気候の特徴は？", opts:["地中海性気候","西岸海洋性気候","温暖湿潤気候","ステップ気候"], ans:2, exp:"日本のような湿潤で四季がある気候です。"}
  ],
  'geography_2': [
    {q:"地図上で、気圧が等しい地点を結んだ曲線は？", opts:["等高線","等圧線","等温線","前線"], ans:1, exp:"同じ気圧の場所をつないだ線です。"},
    {q:"高気圧の中心付近では、どんな気流が生じる？", opts:["上昇気流","下降気流","水平気流","渦巻き気流"], ans:1, exp:"高気圧では上空から空気が下降します。"},
    {q:"低気圧の中心付近では、どんな気流が生じる？", opts:["下降気流","上昇気流","無風","乱気流"], ans:1, exp:"低気圧では地表の空気が上昇します。"}
  ],
  'history_1': [
    {q:"1603年に江戸幕府を開いた人物は？", opts:["織田信長","徳川家康","豊臣秀吉","徳川家光"], ans:1, exp:"関ヶ原の戦いに勝利して江戸に幕府を開きました。"},
    {q:"1192年に鎌倉幕府を開いた人物は？", opts:["平清盛","源頼朝","北条時政","足利尊氏"], ans:1, exp:"日本初の武家政権を樹立した武将です。"},
    {q:"794年に都を移した天皇は？", opts:["聖武天皇","桓武天皇","天武天皇","光仁天皇"], ans:1, exp:"平安京を建設して都を移した天皇です。"}
  ],
  'history_2': [
    {q:"1637年に九州地方で起こった一揆は？", opts:["大塩平八郎の乱","島原・天草一揆","応仁の乱","本能寺の変"], ans:1, exp:"キリシタン弾圧に対する大規模な一揆です。"},
    {q:"江戸幕府が行った外国との交流制限政策は？", opts:["開国","鎖国","南蛮貿易","朱印船貿易"], ans:1, exp:"外国との交流を制限した江戸幕府の政策です。"}
  ],
  'history_3': [
    {q:"1914年に始まった世界大戦は？", opts:["日露戦争","第一次世界大戦","第二次世界大戦","普仏戦争"], ans:1, exp:"サラエボ事件をきっかけに始まった世界大戦です。"},
    {q:"1945年8月6日に原子爆弾を投下された都市は？", opts:["長崎","広島","東京","沖縄"], ans:1, exp:"人類史上初の原子爆弾が投下された都市です。"}
  ],
  'civics': [
    {q:"日本国憲法の三大原理の一つで、主権が国民にあることは？", opts:["基本的人権の尊重","国民主権","平和主義","天皇主権"], ans:1, exp:"政治の最終決定権が国民にある原理です。"},
    {q:"国民が直接、政治に参加する権利は？", opts:["自由権","参政権","社会権","請求権"], ans:1, exp:"民主政治に参加するための基本的権利です。"}
  ],
  'chemistry_1': [
    {q:"石灰石と塩酸の反応で発生する気体は？", opts:["酸素","二酸化炭素","水素","アンモニア"], ans:1, exp:"石灰石と塩酸の反応で二酸化炭素が発生します。"},
    {q:"亜鉛と塩酸の反応で発生する気体は？", opts:["酸素","水素","二酸化炭素","塩素"], ans:1, exp:"金属と酸の反応で水素が発生します。"},
    {q:"空気の成分で約78%を占める気体は？", opts:["酸素","窒素","二酸化炭素","アルゴン"], ans:1, exp:"空気の約8割は窒素です。"}
  ],
  'chemistry_2': [
    {q:"もとの物質とは違う別の物質ができる変化は？", opts:["状態変化","化学変化","物理変化","混合"], ans:1, exp:"別の物質ができる変化が化学変化です。"},
    {q:"物質が2種類以上の別の物質に分かれる化学変化は？", opts:["化合","分解","酸化","還元"], ans:1, exp:"1つの物質が複数に分かれる反応です。"}
  ],
  'chemistry_3': [
    {q:"水にとかしたときに、電流が流れる物質は？", opts:["非電解質","電解質","導体","半導体"], ans:1, exp:"イオンに分かれて電流を通す物質です。"},
    {q:"原子がプラス、マイナスどちらかの電気を帯びたものは？", opts:["原子","イオン","分子","同位体"], ans:1, exp:"電子の過不足により電荷を帯びた原子です。"}
  ],
  'biology_1': [
    {q:"花のめしべの下のふくらんでいる部分は？", opts:["柱頭","子房","やく","胚珠"], ans:1, exp:"受精後に果実になる部分が子房です。"},
    {q:"コイやメダカなどの脊椎動物は何類？", opts:["両生類","魚類","は虫類","哺乳類"], ans:1, exp:"水中に住みえらで呼吸する脊椎動物です。"}
  ],
  'biology_2': [
    {q:"植物が光を受け、デンプンなどの栄養分をつくる働きは？", opts:["呼吸","光合成","蒸散","窒素同化"], ans:1, exp:"光エネルギーを使って有機物を作る働きです。"},
    {q:"血液を循環させるポンプの働きをする器官は？", opts:["肺","心臓","肝臓","腎臓"], ans:1, exp:"心臓が血液循環のポンプの役割をします。"}
  ],
  'biology_3': [
    {q:"1つの細胞が2つに分かれることは？", opts:["細胞融合","細胞分裂","細胞分化","細胞増殖"], ans:1, exp:"細胞が分かれて数を増やす過程です。"},
    {q:"親のもつ形質が子や子孫などに伝わることは？", opts:["進化","遺伝","適応","変異"], ans:1, exp:"親から子へ性質が受け継がれることです。"}
  ],
  'physics_1': [
    {q:"光が鏡などの表面に当たってはね返ることは？", opts:["光の屈折","光の反射","光の直進","光の分散"], ans:1, exp:"光が境界面で跳ね返る現象です。"},
    {q:"物体が受ける力の単位は？", opts:["ジュール（J）","ニュートン（N）","ワット（W）","パスカル（Pa）"], ans:1, exp:"力の国際単位はニュートンです。"}
  ],
  'physics_2': [
    {q:"電流の道すじが途中で枝分かれした回路は？", opts:["直列回路","並列回路","短絡回路","開回路"], ans:1, exp:"電流が複数の経路に分かれる回路です。"},
    {q:"電流の単位は？", opts:["ボルト（V）","アンペア（A）","オーム（Ω）","ワット（W）"], ans:1, exp:"電流の大きさを表す国際単位です。"}
  ],
  'physics_3': [
    {q:"2つの力を同じ働きをする1つの力に合わせることは？", opts:["力の分解","力の合成","力のつり合い","力のモーメント"], ans:1, exp:"複数の力を1つの力にまとめることです。"},
    {q:"運動している物体がもつエネルギーは？", opts:["位置エネルギー","運動エネルギー","熱エネルギー","化学エネルギー"], ans:1, exp:"動いている物体が持つエネルギーです。"}
  ],
  'earth_1': [
    {q:"マグマが地表に流れ出たものは？", opts:["マグマ","溶岩","火山ガス","火砕流"], ans:1, exp:"地表に出たマグマを溶岩と呼びます。"},
    {q:"マグマが冷え固まってできた岩石は？", opts:["堆積岩","火成岩","変成岩","凝灰岩"], ans:1, exp:"マグマの冷却固化でできる岩石の総称です。"}
  ],
  'earth_2': [
    {q:"雨や雪が降っておらず、雲量が8のときの天気は？", opts:["くもり","晴れ","雨","快晴"], ans:0, exp:"雲量8は空の8割が雲に覆われた状態です。"},
    {q:"大気による圧力は？", opts:["水圧","大気圧","気圧","風圧"], ans:1, exp:"大気の重さによって生じる圧力です。"}
  ],
  'earth_3': [
    {q:"天体が真南にくることは？", opts:["日の出","南中","日の入り","天頂通過"], ans:1, exp:"天体が観測地点の真南を通過することです。"},
    {q:"地球が太陽のまわりを回る運動は？", opts:["自転","公転","年周運動","惑星運動"], ans:1, exp:"地球が太陽を中心に回る運動です。"}
  ]
};

// ゲーム変数
let coins = 0;
let dps = 10;
let critRate = 5;
let defense = 0;
let killCount = 0;
let currentSubject = '';

let attackCost = 100;
let critCost = 200;
let defenseCost = 150;

let gameTimer = null;

// 通知機能
function showNotification(text) {
  const notification = document.getElementById('notification');
  const notificationText = document.getElementById('notificationText');
  
  notificationText.textContent = text;
  notification.classList.add('show');
  
  setTimeout(() => {
    notification.classList.remove('show');
  }, 3000);
}

// ステータス更新（超軽量版）
function renderStats() {
  const statsDiv = document.getElementById('stats');
  statsDiv.innerHTML = `
    <div class="bg-gray-800 rounded p-3">
      <div class="flex justify-between">
        <span>💰 コイン</span>
        <span class="text-yellow-400">${coins.toLocaleString()}</span>
      </div>
    </div>
    <div class="bg-gray-800 rounded p-3">
      <div class="flex justify-between">
        <span>⚔️ 攻撃力</span>
        <span class="text-red-400">${dps}/秒</span>
      </div>
    </div>
    <div class="bg-gray-800 rounded p-3">
      <div class="flex justify-between">
        <span>💥 クリティカル</span>
        <span class="text-yellow-400">${critRate}%</span>
      </div>
    </div>
    <div class="bg-gray-800 rounded p-3">
      <div class="flex justify-between">
        <span>🏆 撃破数</span>
        <span class="text-purple-400">${killCount}</span>
      </div>
    </div>
  `;
  
  // コスト表示更新
  document.getElementById('attackCost').textContent = attackCost;
  document.getElementById('critCost').textContent = critCost;
  document.getElementById('defenseCost').textContent = defenseCost;
  
  // ボタン有効/無効
  document.getElementById('upgradeAttack').disabled = coins < attackCost;
  document.getElementById('upgradeCrit').disabled = coins < critCost;
  document.getElementById('upgradeDefense').disabled = coins < defenseCost;
}

// 教科選択（最速版）
function initSubjectSelection() {
  const container = document.getElementById('subjectContainer');
  const startButton = document.getElementById('startGame');
  let selectedSubject = '';
  let activeButton = null;
  
  const subjects = [
    {id: 'geography_1', icon: '🗺️', name: '中１地理'},
    {id: 'geography_2', icon: '🗺️', name: '中２地理'},
    {id: 'history_1', icon: '🏛️', name: '中１歴史'},
    {id: 'history_2', icon: '🏛️', name: '中２歴史'},
    {id: 'history_3', icon: '🏛️', name: '中３歴史'},
    {id: 'civics', icon: '⚖️', name: '公民'},
    {id: 'chemistry_1', icon: '🧪', name: '中１化学'},
    {id: 'chemistry_2', icon: '🧪', name: '中２化学'},
    {id: 'chemistry_3', icon: '🧪', name: '中３化学'},
    {id: 'biology_1', icon: '🧬', name: '中１生物'},
    {id: 'biology_2', icon: '🧬', name: '中２生物'},
    {id: 'biology_3', icon: '🧬', name: '中３生物'},
    {id: 'physics_1', icon: '⚛️', name: '中１物理'},
    {id: 'physics_2', icon: '⚛️', name: '中２物理'},
    {id: 'physics_3', icon: '⚛️', name: '中３物理'},
    {id: 'earth_1', icon: '🌍', name: '中１地学'},
    {id: 'earth_2', icon: '🌍', name: '中２地学'},
    {id: 'earth_3', icon: '🌍', name: '中３地学'}
  ];
  
  container.innerHTML = "";
  
  subjects.forEach(subject => {
    const btn = document.createElement('button');
    btn.className = 'subject-btn';
    btn.innerHTML = `
      <div style="font-size: 1.5rem; margin-bottom: 4px;">${subject.icon}</div>
      <div style="font-size: 0.8rem; font-weight: bold;">${subject.name}</div>
    `;
    
    // 最速クリックハンドラー
    btn.onclick = function() {
      // 前のアクティブボタンがあれば削除
      if (activeButton && activeButton !== this) {
        activeButton.classList.remove('active');
      }
      
      // 新しいボタンをアクティブに
      this.classList.add('active');
      activeButton = this;
      selectedSubject = subject.id;
      startButton.disabled = false;
    };
    
    container.appendChild(btn);
  });
  
  startButton.disabled = true;
  startButton.onclick = function() {
    if (selectedSubject) {
      currentSubject = selectedSubject;
      
      // 瞬時画面切り替え
      document.getElementById('subjectModal').classList.remove('show');
      document.getElementById('gameArea').style.display = 'block';
      
      const subjectNames = {
        'geography_1': '🗺️ 中１地理クエスト', 'geography_2': '🗺️ 中２地理クエスト',
        'history_1': '🏛️ 中１歴史クエスト', 'history_2': '🏛️ 中２歴史クエスト', 'history_3': '🏛️ 中３歴史クエスト',
        'civics': '⚖️ 公民クエスト',
        'chemistry_1': '🧪 中１化学クエスト', 'chemistry_2': '🧪 中２化学クエスト', 'chemistry_3': '🧪 中３化学クエスト',
        'biology_1': '🧬 中１生物クエスト', 'biology_2': '🧬 中２生物クエスト', 'biology_3': '🧬 中３生物クエスト',
        'physics_1': '⚛️ 中１物理クエスト', 'physics_2': '⚛️ 中２物理クエスト', 'physics_3': '⚛️ 中３物理クエスト',
        'earth_1': '🌍 中１地学クエスト', 'earth_2': '🌍 中２地学クエスト', 'earth_3': '🌍 中３地学クエスト'
      };
      
      document.getElementById('currentSubject').textContent = subjectNames[currentSubject];
      startGameLoop();
    }
  };
}

// ゲームループ（軽量版）
function startGameLoop() {
  renderStats();
  showNotification('🚀 クエスト開始！');
  
  // 軽量化されたバトルループ（5秒間隔）
  gameTimer = setInterval(() => {
    const isCrit = Math.random() * 100 < critRate;
    const damage = isCrit ? dps * 2 : dps;
    
    const coinReward = 50;
    coins += coinReward;
    killCount++;
    
    if (isCrit) {
      showNotification('💥 クリティカルヒット！');
    }
    
    renderStats();
  }, 5000); // 5秒間隔
}

// 強化ボタン
function initUpgradeButtons() {
  document.getElementById('upgradeAttack').onclick = () => {
    if (coins >= attackCost) {
      coins -= attackCost;
      dps += 10;
      attackCost = Math.floor(attackCost * 1.5);
      showNotification('⚔️ 攻撃力が強化されました！');
      renderStats();
    }
  };

  document.getElementById('upgradeCrit').onclick = () => {
    if (coins >= critCost) {
      coins -= critCost;
      critRate += 5;
      critCost = Math.floor(critCost * 1.8);
      showNotification('💥 クリティカル率が向上しました！');
      renderStats();
    }
  };

  document.getElementById('upgradeDefense').onclick = () => {
    if (coins >= defenseCost) {
      coins -= defenseCost;
      defense += 10;
      defenseCost = Math.floor(defenseCost * 1.6);
      showNotification('🛡️ 防御力が向上しました！');
      renderStats();
    }
  };
}

// クイズ機能（軽量版）
function openQuiz() {
  const problems = problemDatabase[currentSubject];
  if (!problems || problems.length === 0) return;
  
  const quiz = problems[Math.floor(Math.random() * problems.length)];
  
  const modal = document.getElementById('quizModal');
  const qEl = document.getElementById('quizQ');
  const optDiv = document.getElementById('quizOptions');
  const msgEl = document.getElementById('quizMsg');
  const nextBtn = document.getElementById('quizNext');
  const backBtn = document.getElementById('quizBack');
  
  qEl.textContent = quiz.q;
  optDiv.innerHTML = '';
  msgEl.textContent = '';
  
  nextBtn.disabled = true;
  nextBtn.style.opacity = '0.3';
  backBtn.disabled = true;
  backBtn.style.opacity = '0.3';
  
  quiz.opts.forEach((txt, i) => {
    const btn = document.createElement('button');
    btn.textContent = txt;
    btn.className = 'neon-button w-full p-3';
    btn.onclick = () => {
      if (i === quiz.ans) {
        msgEl.innerHTML = `🎉 正解！${quiz.exp || ''}`;
        msgEl.style.color = '#00ff41';
        coins += 100;
        showNotification('正解！ボーナスコインを獲得！');
      } else {
        msgEl.innerHTML = `❌ 不正解。正解は「${quiz.opts[quiz.ans]}」です。`;
        msgEl.style.color = '#ff8800';
      }
      
      [...optDiv.children].forEach(b => b.disabled = true);
      nextBtn.disabled = false;
      nextBtn.style.opacity = '1';
      backBtn.disabled = false;
      backBtn.style.opacity = '1';
      renderStats();
    };
    optDiv.appendChild(btn);
  });
  
  nextBtn.onclick = () => openQuiz();
  backBtn.onclick = () => modal.classList.remove('show');
  
  modal.classList.add('show');
}

// 初期化
document.addEventListener('DOMContentLoaded', () => {
  initSubjectSelection();
  initUpgradeButtons();
  
  document.getElementById('manualQuizButton').onclick = () => openQuiz();
  
  document.getElementById('changeSubject').onclick = () => {
    if (gameTimer) {
      clearInterval(gameTimer);
      gameTimer = null;
    }
    document.getElementById('gameArea').style.display = 'none';
    document.getElementById('subjectModal').classList.add('show');
  };
});
</script>

</body>
</html>