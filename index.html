<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no, maximum-scale=1.0, minimum-scale=1.0">
    <title>ONE WORLD Quiz</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="problems.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=Noto+Sans+JP:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --primary-coral: #f4a261;
            --primary-sage: #7fb069;
            --primary-sky: #6bb6ff;
            --primary-lavender: #a584c7;
            --accent-peach: #f9b6a3;
            --accent-mint: #b8e6b8;
            --bg-cream: #fdf8f3;
            --bg-white: #ffffff;
            --text-dark: #2d3748;
            --text-warm: #5d4e75;
            --border-soft: #e6ddd4;
            --shadow-gentle: rgba(116, 139, 141, 0.15);
        }
        body {
            font-family: "Noto Sans JP", "Inter", sans-serif;
            background: #faf7f2;
            min-height: 100vh;
            touch-action: manipulation;
            overflow-x: hidden;
            color: var(--text-dark);
            -webkit-touch-callout: none;
            -webkit-user-select: none;
            -webkit-tap-highlight-color: transparent;
            user-select: none;
        }
        .container-spacing {
            margin: 0 auto;
            max-width: 95%;
            width: 100%;
        }
        @media (min-width: 640px) {
            .container-spacing {
                max-width: 500px;
            }
        }
        @media (min-width: 768px) {
            .container-spacing {
                max-width: 600px;
            }
        }
        @media (min-width: 1024px) {
            .container-spacing {
                max-width: 700px;
            }
        }
        .game-title {
            font-family: 'Inter', sans-serif;
            font-weight: 700;
            font-size: clamp(1.5rem, 4vw, 2.5rem);
            color: var(--primary-coral);
            text-align: center;
            letter-spacing: -0.025em;
            margin-bottom: 0.5rem;
        }
        .warm-card {
            background: var(--bg-white);
            border: 3px solid var(--border-soft);
            border-radius: 24px;
            box-shadow: 0 8px 32px var(--shadow-gentle);
            position: relative;
            overflow: hidden;
        }
        .warm-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 6px;
            background: var(--primary-coral);
            border-radius: 24px 24px 0 0;
        }
        .warm-button {
            background: var(--primary-coral);
            border: none;
            color: white;
            font-weight: 600;
            border-radius: 16px;
            transition: all 0.3s ease;
            box-shadow: 0 4px 16px rgba(244, 162, 97, 0.3);
        }
        .warm-button:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 24px rgba(244, 162, 97, 0.4);
            background: #f19a4e;
        }
        .warm-button:active {
            transform: translateY(0);
            box-shadow: 0 4px 16px rgba(244, 162, 97, 0.3);
        }
        .warm-button:disabled {
            background: #d1d5db;
            color: #9ca3af;
            transform: none;
            box-shadow: none;
            cursor: not-allowed;
        }
        .grade-btn {
            background: #fef9f5;
            border: 3px solid var(--border-soft);
            border-radius: 20px;
            color: var(--text-warm);
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
            padding: 1rem 0.75rem;
            min-height: 80px;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            box-shadow: 0 4px 16px var(--shadow-gentle);
        }
        .grade-btn:hover {
            border-color: var(--primary-coral);
            transform: translateY(-3px);
            box-shadow: 0 8px 24px rgba(244, 162, 97, 0.25);
            background: #fdf5ef;
        }
        .grade-btn.active {
            background: #fdf0e7;
            border-color: var(--primary-coral);
            color: var(--primary-coral);
            transform: translateY(-3px);
            box-shadow: 0 8px 24px rgba(244, 162, 97, 0.3);
        }
        .lesson-btn {
            background: #f0f8ff;
            border: 2px solid #b8d4f0;
            border-radius: 16px;
            color: var(--text-dark);
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
            padding: 0.75rem 0.5rem;
            display: flex;
            align-items: center;
            justify-content: center;
            text-align: center;
            min-height: 60px;
            box-shadow: 0 4px 12px rgba(107, 182, 255, 0.15);
            font-size: 0.8rem;
            font-weight: 500;
        }
        .lesson-btn:hover {
            border-color: var(--primary-sky);
            transform: translateY(-2px);
            box-shadow: 0 6px 16px rgba(107, 182, 255, 0.25);
            background: #e6f3ff;
        }
        .lesson-btn.active {
            background: #d9edff;
            border-color: var(--primary-sky);
            color: var(--primary-sky);
            transform: translateY(-2px);
            box-shadow: 0 6px 16px rgba(107, 182, 255, 0.3);
        }
        .grammar-btn {
            background: #f8f5ff;
            border: 2px solid #d6c9e3;
            border-radius: 12px;
            color: var(--text-dark);
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
            padding: 0.6rem 0.4rem;
            display: flex;
            align-items: center;
            justify-content: center;
            text-align: center;
            min-height: 50px;
            box-shadow: 0 3px 10px rgba(165, 132, 199, 0.15);
            font-size: 0.75rem;
            font-weight: 500;
        }
        .grammar-btn:hover {
            border-color: var(--primary-lavender);
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(165, 132, 199, 0.25);
            background: #f0ebff;
        }
        .grammar-btn.active {
            background: #e9dff7;
            border-color: var(--primary-lavender);
            color: var(--primary-lavender);
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(165, 132, 199, 0.3);
        }
        .modal {
            display: none;
            position: fixed;
            inset: 0;
            background: rgba(0, 0, 0, 0.4);
            backdrop-filter: blur(12px);
            align-items: center;
            justify-content: center;
            z-index: 1000;
            padding: 1rem;
        }
        .modal.show {
            display: flex;
            animation: modalFadeIn 0.4s ease-out;
        }
        @keyframes modalFadeIn {
            from {
                opacity: 0;
                transform: scale(0.9) translateY(20px);
            }
            to {
                opacity: 1;
                transform: scale(1) translateY(0);
            }
        }
        .particle {
            position: absolute;
            pointer-events: none;
            font-weight: 600;
            z-index: 100;
            animation: particleFloat 2.5s ease-out forwards;
            font-size: 20px;
        }
        @keyframes particleFloat {
            0% {
                transform: translateY(0) scale(1) rotate(0deg);
                opacity: 1;
            }
            50% {
                transform: translateY(-40px) scale(1.3) rotate(180deg);
                opacity: 0.8;
            }
            100% {
                transform: translateY(-100px) scale(1.5) rotate(360deg);
                opacity: 0;
            }
        }
        .notification {
            position: fixed;
            top: 20px;
            right: 20px;
            background: var(--bg-white);
            color: var(--text-dark);
            padding: 16px 20px;
            border-radius: 16px;
            border: 3px solid var(--border-soft);
            transform: translateX(400px);
            transition: transform 0.4s cubic-bezier(0.68, -0.55, 0.265, 1.55);
            z-index: 1001;
            box-shadow: 0 8px 24px var(--shadow-gentle);
        }
        .notification.show {
            transform: translateX(0);
        }
        .floating-button {
            position: fixed;
            bottom: 24px;
            left: 24px;
            width: 64px;
            height: 64px;
            background: var(--accent-peach);
            border: 3px solid var(--border-soft);
            border-radius: 50%;
            color: white;
            font-size: 28px;
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: 0 8px 24px rgba(249, 182, 163, 0.4);
            transition: all 0.3s ease;
            z-index: 1002;
            cursor: pointer;
        }
        
        .floating-button.hidden {
            display: none !important;
        }
        .floating-button:hover {
            transform: translateY(-4px) scale(1.1);
            box-shadow: 0 12px 32px rgba(249, 182, 163, 0.5);
        }
        
        /* éŸ³å£°è¨­å®šãƒ•ãƒ­ãƒ¼ãƒ†ã‚£ãƒ³ã‚°ãƒœã‚¿ãƒ³ */
        .voice-settings-button {
            position: fixed;
            bottom: 24px;
            right: 24px;
            width: 64px;
            height: 64px;
            background: var(--primary-lavender);
            border: 3px solid var(--border-soft);
            border-radius: 50%;
            color: white;
            font-size: 28px;
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: 0 8px 24px rgba(165, 132, 199, 0.4);
            transition: all 0.3s ease;
            z-index: 1002;
            cursor: pointer;
        }
        .voice-settings-button:hover {
            transform: translateY(-4px) scale(1.1);
            box-shadow: 0 12px 32px rgba(165, 132, 199, 0.5);
        }
        
        /* éŸ³å£°è¨­å®šãƒ¢ãƒ¼ãƒ€ãƒ« */
        .voice-section {
            margin-bottom: 1.5rem;
        }
        .voice-category-title {
            font-size: 1.1rem;
            font-weight: 600;
            color: var(--text-dark);
            margin-bottom: 0.75rem;
            text-align: center;
            padding: 0.5rem;
            background: linear-gradient(135deg, #f3e8ff, #faf5ff);
            border-radius: 12px;
        }
        .voice-option {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 0.75rem;
            background: var(--bg-white);
            border: 2px solid var(--border-soft);
            border-radius: 12px;
            margin-bottom: 0.5rem;
            transition: all 0.3s ease;
        }
        .voice-option:hover {
            border-color: var(--primary-lavender);
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(165, 132, 199, 0.15);
        }
        .voice-option.selected {
            border-color: var(--primary-lavender);
            background: #f0ebff;
            box-shadow: 0 4px 12px rgba(165, 132, 199, 0.25);
        }
        .voice-info {
            flex: 1;
        }
        .voice-name {
            font-weight: 600;
            color: var(--text-dark);
            margin-bottom: 0.25rem;
        }
        .voice-description {
            font-size: 0.8rem;
            color: var(--text-warm);
        }
        .voice-controls {
            display: flex;
            gap: 0.5rem;
            align-items: center;
        }
        .preview-btn {
            background: var(--primary-sky);
            border: none;
            color: white;
            padding: 0.4rem 0.8rem;
            border-radius: 8px;
            font-size: 0.8rem;
            font-weight: 500;
            transition: all 0.3s ease;
        }
        .preview-btn:hover {
            background: #5aa3f0;
            transform: translateY(-1px);
        }
        .voice-toggle {
            margin-bottom: 1rem;
            text-align: center;
        }
        .toggle-switch {
            position: relative;
            display: inline-block;
            width: 60px;
            height: 34px;
        }
        .toggle-switch input {
            opacity: 0;
            width: 0;
            height: 0;
        }
        .toggle-slider {
            position: absolute;
            cursor: pointer;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: #ccc;
            transition: .4s;
            border-radius: 34px;
        }
        .toggle-slider:before {
            position: absolute;
            content: "";
            height: 26px;
            width: 26px;
            left: 4px;
            bottom: 4px;
            background-color: white;
            transition: .4s;
            border-radius: 50%;
        }
        input:checked + .toggle-slider {
            background-color: var(--primary-sage);
        }
        input:checked + .toggle-slider:before {
            transform: translateX(26px);
        }
        
        /* è‹±èªãƒ†ã‚­ã‚¹ãƒˆå†…ã®ã‚¹ãƒ”ãƒ¼ã‚«ãƒ¼ãƒœã‚¿ãƒ³ */
        .speak-btn {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            width: 28px;
            height: 28px;
            background: var(--primary-sage);
            border: none;
            border-radius: 50%;
            color: white;
            font-size: 14px;
            margin-left: 8px;
            cursor: pointer;
            transition: all 0.3s ease;
            vertical-align: middle;
        }
        .speak-btn:hover {
            background: #6fa055;
            transform: scale(1.1);
        }
        .speak-btn.speaking {
            animation: speakPulse 1s infinite;
        }
        @keyframes speakPulse {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.15); }
        }
        
        /* å°ã•ãã—ãŸã‚¿ã‚¤ãƒãƒ¼é–¢é€£ã®ã‚¹ã‚¿ã‚¤ãƒ« */
        .timer-display {
            font-size: 1.5rem;
            font-weight: 700;
            text-align: center;
            padding: 0.75rem;
            border-radius: 12px;
            margin: 0.5rem 0;
            transition: all 0.3s ease;
            border: 2px solid;
            display: inline-block;
            min-width: 80px;
        }
        .timer-normal {
            background: linear-gradient(135deg, #e8f5e8, #f0fdf0);
            color: var(--primary-sage);
            border-color: var(--primary-sage);
        }
        .timer-warning {
            background: linear-gradient(135deg, #fef3cd, #fefce8);
            color: #d97706;
            border-color: #d97706;
            animation: timerPulse 1s infinite;
        }
        .timer-danger {
            background: linear-gradient(135deg, #fee2e2, #fef2f2);
            color: #dc2626;
            border-color: #dc2626;
            animation: timerPulse 0.5s infinite;
        }
        @keyframes timerPulse {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.05); }
        }
        
        .timer-btn {
            background: var(--bg-white);
            border: 3px solid var(--border-soft);
            border-radius: 12px;
            color: var(--text-dark);
            transition: all 0.3s ease;
            padding: 0.75rem;
            font-size: 0.8rem;
            font-weight: 500;
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: 0 3px 10px var(--shadow-gentle);
        }
        .timer-btn:hover {
            border-color: var(--primary-coral);
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(244, 162, 97, 0.25);
        }
        .timer-btn.active {
            background: #fdf0e7;
            border-color: var(--primary-coral);
            color: var(--primary-coral);
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(244, 162, 97, 0.3);
        }
        
        /* æ‹¡å¤§ã—ãŸè§£ç­”è¡¨ç¤ºã‚¨ãƒªã‚¢ */
        .answer-display {
            background: var(--bg-cream);
            border-radius: 16px;
            padding: 2rem;
            margin-top: 1rem;
            border: 3px solid var(--border-soft);
            text-align: left;
            font-size: 1.1rem;
            line-height: 1.8;
            box-shadow: 0 4px 12px var(--shadow-gentle);
            min-height: 200px;
            max-height: 400px;
            overflow-y: auto;
            display: flex;
            flex-direction: column;
            align-items: flex-start;
            justify-content: flex-start;
        }
        .answer-display.show {
            border-color: var(--primary-sage);
            background: #f0f9f0;
            box-shadow: 0 4px 12px rgba(127, 176, 105, 0.2);
        }
        .answer-text {
            font-weight: 700;
            font-size: 1.4rem;
            color: var(--primary-sage);
            margin-bottom: 1rem;
            text-align: center;
            width: 100%;
            padding: 1rem;
            background: rgba(127, 176, 105, 0.1);
            border-radius: 12px;
            position: relative;
        }
        .explanation-text {
            color: var(--text-dark);
            font-size: 1.1rem;
            line-height: 1.8;
            text-align: left;
            width: 100%;
        }
        
        .show-answer-btn {
            background: var(--primary-sky);
            border: none;
            color: white;
            font-weight: 600;
            border-radius: 16px;
            padding: 0.75rem 1.5rem;
            font-size: 1rem;
            transition: all 0.3s ease;
            box-shadow: 0 4px 16px rgba(107, 182, 255, 0.3);
            margin: 0.5rem 0;
        }
        .show-answer-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 24px rgba(107, 182, 255, 0.4);
            background: #5aa3f0;
        }
        .show-answer-btn:disabled {
            background: #d1d5db;
            color: #9ca3af;
            transform: none;
            box-shadow: none;
            cursor: not-allowed;
        }
        
        .quiz-question {
            background: #f8fafc;
            border: 3px solid #e2e8f0;
            border-radius: 16px;
            padding: 1.5rem;
            text-align: center;
            font-size: 1.2rem;
            font-weight: 600;
            color: var(--text-dark);
            line-height: 1.5;
            margin-bottom: 1rem;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
            position: relative;
        }
        
        .modal-content {
            max-height: 85vh;
            overflow-y: auto;
            padding-top: 0;
        }
        
        .modal .warm-card {
            margin: 2rem 1rem 1rem 1rem;
            max-height: 85vh;
            overflow-y: auto;
        }
        
        .grade-grid {
            grid-template-columns: repeat(3, 1fr);
            gap: 1rem;
        }
        .lesson-grid {
            grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
            gap: 0.75rem;
        }
        .grammar-grid {
            grid-template-columns: 1fr;
            gap: 0.5rem;
        }
        .back-button {
            background: #f1f5f9;
            border: 3px solid #cbd5e1;
            color: var(--text-dark);
            border-radius: 16px;
            padding: 0.75rem 1.25rem;
            font-weight: 500;
            transition: all 0.3s ease;
            font-size: 0.9rem;
            box-shadow: 0 3px 10px rgba(0, 0, 0, 0.1);
        }
        .back-button:hover {
            background: #e2e8f0;
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
        }
        .stats-display {
            background: var(--bg-cream);
            border: 3px solid var(--border-soft);
            border-radius: 20px;
            padding: 1.25rem;
            text-align: center;
            box-shadow: 0 6px 20px var(--shadow-gentle);
        }
        .section-divider {
            height: 2px;
            background: var(--border-soft);
            margin: 1.25rem 0;
        }
        .mode-btn {
            background: var(--bg-white);
            border: 3px solid var(--border-soft);
            border-radius: 12px;
            color: var(--text-dark);
            transition: all 0.3s ease;
            padding: 0.75rem;
            font-size: 0.8rem;
            font-weight: 500;
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: 0 3px 10px var(--shadow-gentle);
        }
        .mode-btn:hover {
            border-color: var(--primary-coral);
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(244, 162, 97, 0.25);
        }
        .mode-btn.active {
            background: #fdf0e7;
            border-color: var(--primary-coral);
            color: var(--primary-coral);
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(244, 162, 97, 0.3);
        }
        .direction-btn {
            background: var(--bg-white);
            border: 3px solid #d6c9e3;
            border-radius: 12px;
            color: var(--text-dark);
            transition: all 0.3s ease;
            padding: 0.75rem;
            font-size: 0.8rem;
            font-weight: 500;
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: 0 3px 10px rgba(165, 132, 199, 0.15);
        }
        .direction-btn:hover {
            border-color: var(--primary-lavender);
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(165, 132, 199, 0.25);
        }
        .direction-btn.active {
            background: #e9dff7;
            border-color: var(--primary-lavender);
            color: var(--primary-lavender);
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(165, 132, 199, 0.3);
        }
        
        /* è©³ç´°ã‚¯ãƒªãƒƒã‚¯çµ±è¨ˆè¡¨ç¤º */
        .click-stats-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 0.75rem;
            margin: 1rem 0;
        }
        .click-stat-item {
            background: linear-gradient(135deg, #f3e8ff, #faf5ff);
            border: 2px solid var(--primary-lavender);
            border-radius: 12px;
            padding: 0.75rem;
            text-align: center;
            box-shadow: 0 3px 10px rgba(165, 132, 199, 0.15);
        }
        .click-stat-number {
            font-size: 1.25rem;
            font-weight: 700;
            color: var(--primary-lavender);
            display: block;
        }
        .click-stat-label {
            font-size: 0.7rem;
            color: var(--text-warm);
            margin-top: 0.25rem;
        }
        
        .selected-lessons-display {
            background: #e8f5e8;
            border: 2px solid var(--primary-sage);
            border-radius: 12px;
            padding: 1rem;
            margin: 1rem 0;
            text-align: center;
        }
        .selected-lessons-count {
            font-size: 1.1rem;
            font-weight: 600;
            color: var(--primary-sage);
        }
        .selected-lessons-list {
            font-size: 0.9rem;
            color: var(--text-dark);
            margin-top: 0.5rem;
            line-height: 1.4;
        }
        
        @media (max-width: 640px) {
            .container-spacing {
                max-width: 95%;
                margin-bottom: 2rem;
            }
            .modal .warm-card {
                margin: 0.25rem;
                padding: 0.75rem;
                max-height: 92vh;
            }
            
            .modal-content {
                max-height: 92vh;
                padding-top: 0;
            }
            
            .floating-button, .voice-settings-button {
                bottom: 20px;
                width: 56px;
                height: 56px;
                font-size: 24px;
            }
            .floating-button {
                left: 20px;
            }
            .voice-settings-button {
                right: 20px;
            }
            .warm-card {
                margin: 0.5rem;
                padding: 1rem;
            }
            .warm-card:last-of-type {
                margin-bottom: 4rem;
            }
            body {
                padding-bottom: 5rem;
            }
            .game-title {
                font-size: clamp(1.25rem, 6vw, 2rem);
            }
            .grade-grid {
                grid-template-columns: repeat(3, 1fr);
                gap: 0.75rem;
            }
            .lesson-grid {
                grid-template-columns: 1fr;
                gap: 0.5rem;
            }
            .grammar-grid {
                grid-template-columns: 1fr;
                gap: 0.4rem;
            }
            .grade-btn {
                padding: 0.75rem 0.5rem;
                min-height: 70px;
                font-size: 0.8rem;
            }
            .lesson-btn {
                padding: 0.6rem 0.4rem;
                min-height: 50px;
                font-size: 0.75rem;
            }
            .grammar-btn {
                padding: 0.5rem 0.3rem;
                min-height: 45px;
                font-size: 0.7rem;
            }
            .timer-display {
                font-size: 1.25rem;
                padding: 0.5rem;
                min-width: 60px;
            }
            .quiz-question {
                font-size: 1rem;
                padding: 1rem;
            }
            .answer-display {
                padding: 1.5rem;
                min-height: 150px;
                max-height: 300px;
            }
            .answer-text {
                font-size: 1.2rem;
                padding: 0.75rem;
            }
            .explanation-text {
                font-size: 1rem;
            }
            .click-stats-grid {
                grid-template-columns: repeat(2, 1fr);
                gap: 0.5rem;
            }
            .click-stat-number {
                font-size: 1rem;
            }
            .click-stat-label {
                font-size: 0.65rem;
            }
        }
        
        button, .grade-btn, .lesson-btn, .grammar-btn, .warm-button, .back-button, .mode-btn, .direction-btn, .timer-btn, .show-answer-btn {
            -webkit-touch-callout: none;
            -webkit-user-select: none;
            -webkit-tap-highlight-color: transparent;
            user-select: none;
            touch-action: manipulation;
            -webkit-appearance: none;
        }
        
        * {
            touch-action: manipulation;
        }
        
        input, select, textarea {
            font-size: 16px;
        }
        
        .modal {
            padding: 0.5rem;
        }
        
        .modal .warm-card {
            position: relative;
            top: 0;
        }
        
        @media (max-width: 640px) {
            .modal {
                padding: 0.25rem;
            }
            
            .modal .warm-card {
                margin-top: 2rem;
            }
        }

        /* ç‰¹åˆ¥ãªè£…é£¾åŠ¹æœ */
        .sparkle {
            position: relative;
            overflow: visible;
        }
        .sparkle::before,
        .sparkle::after {
            content: 'âœ¨';
            position: absolute;
            opacity: 0;
            animation: sparkleFloat 3s infinite ease-in-out;
        }
        .sparkle::before {
            top: -10px;
            left: -10px;
            animation-delay: 0s;
        }
        .sparkle::after {
            bottom: -10px;
            right: -10px;
            animation-delay: 1.5s;
        }
        @keyframes sparkleFloat {
            0%, 100% { opacity: 0; transform: translateY(0) scale(0.8); }
            50% { opacity: 1; transform: translateY(-20px) scale(1.2); }
        }
    </style>
</head>
<body class="min-h-screen flex flex-col items-center pt-6 pb-12 gap-6 relative">
    <!-- ãƒ¡ã‚¤ãƒ³å­¦å¹´é¸æŠãƒ¢ãƒ¼ãƒ€ãƒ« -->
    <div id="mainGradeModal" class="modal show">
        <div class="warm-card p-6 container-spacing modal-content">
            <div class="text-center mb-6">
                <h1 class="game-title sparkle">ğŸŒ ONE WORLD Quiz âœ¨</h1>
                <h2 class="text-lg font-semibold mb-3 text-gray-700">
                    ğŸ“ å­¦å¹´ã‚’é¸æŠã—ã‚ˆã†
                </h2>
                <p class="text-gray-600 text-sm">ã‚ãªãŸã®å­¦ç¿’ãƒ¬ãƒ™ãƒ«ã‚’é¸ã‚“ã§ãã ã•ã„ã€‚</p>
                
                <!-- è©³ç´°ã‚¯ãƒªãƒƒã‚¯çµ±è¨ˆè¡¨ç¤º -->
                <div class="click-stats-grid">
                    <div class="click-stat-item">
                        <span class="click-stat-number" id="todayClickDisplay">0</span>
                        <div class="click-stat-label">ğŸ“… ä»Šæ—¥ã®ã‚¯ãƒªãƒƒã‚¯</div>
                    </div>
                    <div class="click-stat-item">
                        <span class="click-stat-number" id="yesterdayClickDisplay">0</span>
                        <div class="click-stat-label">ğŸŒ™ æ˜¨æ—¥ã®ã‚¯ãƒªãƒƒã‚¯</div>
                    </div>
                    <div class="click-stat-item">
                        <span class="click-stat-number" id="weekClickDisplay">0</span>
                        <div class="click-stat-label">ğŸ“Š éå»1é€±é–“</div>
                    </div>
                    <div class="click-stat-item">
                        <span class="click-stat-number" id="totalClickDisplay">0</span>
                        <div class="click-stat-label">ğŸ† ç·ã‚¯ãƒªãƒƒã‚¯æ•°</div>
                    </div>
                </div>
            </div>
            <div class="grid grade-grid mb-6">
                <button class="grade-btn" data-grade="grade1">
                    <div class="text-3xl mb-1">ğŸŒ±</div>
                    <div class="font-semibold text-sm">ä¸­å­¦1å¹´ç”Ÿ</div>
                </button>
                <button class="grade-btn" data-grade="grade2">
                    <div class="text-3xl mb-1">ğŸŒ¿</div>
                    <div class="font-semibold text-sm">ä¸­å­¦2å¹´ç”Ÿ</div>
                </button>
                <button class="grade-btn" data-grade="grade3">
                    <div class="text-3xl mb-1">ğŸŒ³</div>
                    <div class="font-semibold text-sm">ä¸­å­¦3å¹´ç”Ÿ</div>
                </button>
            </div>
        </div>
    </div>

    <!-- ä¸­å­¦1å¹´ç”Ÿãƒ¬ãƒƒã‚¹ãƒ³é¸æŠãƒ¢ãƒ¼ãƒ€ãƒ« -->
    <div id="grade1Modal" class="modal">
        <div class="warm-card p-6 container-spacing modal-content">
            <div class="text-center mb-6">
                <h2 class="text-lg font-semibold mb-3 text-gray-700">
                    ğŸŒ± ä¸­å­¦1å¹´ç”Ÿã®ãƒ¬ãƒƒã‚¹ãƒ³
                </h2>
                <p class="text-gray-600 text-sm">å­¦ç¿’ã—ãŸã„ãƒ¬ãƒƒã‚¹ãƒ³ã‚’é¸ã‚“ã§ãã ã•ã„ã€‚<br><strong>å·¦ã‚¯ãƒªãƒƒã‚¯ï¼šå˜ä¸€é¸æŠã€å³ã‚¯ãƒªãƒƒã‚¯ï¼šè¤‡æ•°é¸æŠ</strong></p>
                
                <!-- é¸æŠãƒ¬ãƒƒã‚¹ãƒ³è¡¨ç¤º -->
                <div id="selectedLessonsDisplay1" class="selected-lessons-display hidden">
                    <div class="selected-lessons-count" id="selectedLessonsCount1">0å€‹ã®ãƒ¬ãƒƒã‚¹ãƒ³ã‚’é¸æŠä¸­</div>
                    <div class="selected-lessons-list" id="selectedLessonsList1"></div>
                </div>
            </div>
            <div class="grid lesson-grid mb-6" id="grade1Lessons">
                <!-- JavaScriptã§å‹•çš„ã«ç”Ÿæˆ -->
            </div>
            <div class="text-center space-y-2">
                <button id="startMultipleLessons1" class="warm-button px-8 py-3 text-sm sparkle hidden" disabled>
                    ğŸš€ é¸æŠãƒ¬ãƒƒã‚¹ãƒ³ã§ã‚¹ã‚¿ãƒ¼ãƒˆï¼
                </button>
                <br>
                <button class="back-button" onclick="goBackToMain()">
                    ğŸ  å­¦å¹´é¸æŠã«æˆ»ã‚‹
                </button>
            </div>
        </div>
    </div>

    <!-- ä¸­å­¦2å¹´ç”Ÿãƒ¬ãƒƒã‚¹ãƒ³é¸æŠãƒ¢ãƒ¼ãƒ€ãƒ« -->
    <div id="grade2Modal" class="modal">
        <div class="warm-card p-6 container-spacing modal-content">
            <div class="text-center mb-6">
                <h2 class="text-lg font-semibold mb-3 text-gray-700">
                    ğŸŒ¿ ä¸­å­¦2å¹´ç”Ÿã®ãƒ¬ãƒƒã‚¹ãƒ³
                </h2>
                <p class="text-gray-600 text-sm">å­¦ç¿’ã—ãŸã„ãƒ¬ãƒƒã‚¹ãƒ³ã‚’é¸ã‚“ã§ãã ã•ã„ã€‚<br><strong>å·¦ã‚¯ãƒªãƒƒã‚¯ï¼šå˜ä¸€é¸æŠã€å³ã‚¯ãƒªãƒƒã‚¯ï¼šè¤‡æ•°é¸æŠ</strong></p>
                
                <!-- é¸æŠãƒ¬ãƒƒã‚¹ãƒ³è¡¨ç¤º -->
                <div id="selectedLessonsDisplay2" class="selected-lessons-display hidden">
                    <div class="selected-lessons-count" id="selectedLessonsCount2">0å€‹ã®ãƒ¬ãƒƒã‚¹ãƒ³ã‚’é¸æŠä¸­</div>
                    <div class="selected-lessons-list" id="selectedLessonsList2"></div>
                </div>
            </div>
            <div class="grid lesson-grid mb-6" id="grade2Lessons">
                <!-- JavaScriptã§å‹•çš„ã«ç”Ÿæˆ -->
            </div>
            <div class="text-center space-y-2">
                <button id="startMultipleLessons2" class="warm-button px-8 py-3 text-sm sparkle hidden" disabled>
                    ğŸš€ é¸æŠãƒ¬ãƒƒã‚¹ãƒ³ã§ã‚¹ã‚¿ãƒ¼ãƒˆï¼
                </button>
                <br>
                <button class="back-button" onclick="goBackToMain()">
                    ğŸ  å­¦å¹´é¸æŠã«æˆ»ã‚‹
                </button>
            </div>
        </div>
    </div>

    <!-- ä¸­å­¦3å¹´ç”Ÿãƒ¬ãƒƒã‚¹ãƒ³é¸æŠãƒ¢ãƒ¼ãƒ€ãƒ« -->
    <div id="grade3Modal" class="modal">
        <div class="warm-card p-6 container-spacing modal-content">
            <div class="text-center mb-6">
                <h2 class="text-lg font-semibold mb-3 text-gray-700">
                    ğŸŒ³ ä¸­å­¦3å¹´ç”Ÿã®ãƒ¬ãƒƒã‚¹ãƒ³
                </h2>
                <p class="text-gray-600 text-sm">å­¦ç¿’ã—ãŸã„ãƒ¬ãƒƒã‚¹ãƒ³ã‚’é¸ã‚“ã§ãã ã•ã„ã€‚<br><strong>å·¦ã‚¯ãƒªãƒƒã‚¯ï¼šå˜ä¸€é¸æŠã€å³ã‚¯ãƒªãƒƒã‚¯ï¼šè¤‡æ•°é¸æŠ</strong></p>
                
                <!-- é¸æŠãƒ¬ãƒƒã‚¹ãƒ³è¡¨ç¤º -->
                <div id="selectedLessonsDisplay3" class="selected-lessons-display hidden">
                    <div class="selected-lessons-count" id="selectedLessonsCount3">0å€‹ã®ãƒ¬ãƒƒã‚¹ãƒ³ã‚’é¸æŠä¸­</div>
                    <div class="selected-lessons-list" id="selectedLessonsList3"></div>
                </div>
            </div>
            <div class="grid lesson-grid mb-6" id="grade3Lessons">
                <!-- JavaScriptã§å‹•çš„ã«ç”Ÿæˆ -->
            </div>
            <div class="text-center space-y-2">
                <button id="startMultipleLessons3" class="warm-button px-8 py-3 text-sm sparkle hidden" disabled>
                    ğŸš€ é¸æŠãƒ¬ãƒƒã‚¹ãƒ³ã§ã‚¹ã‚¿ãƒ¼ãƒˆï¼
                </button>
                <br>
                <button class="back-button" onclick="goBackToMain()">
                    ğŸ  å­¦å¹´é¸æŠã«æˆ»ã‚‹
                </button>
            </div>
        </div>
    </div>

    <!-- æ–‡æ³•é …ç›®é¸æŠãƒ¢ãƒ¼ãƒ€ãƒ«ï¼ˆå‹•çš„ã«ç”Ÿæˆã•ã‚Œã‚‹ãŸã‚ã€ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆã¨ã—ã¦1ã¤å®šç¾©ï¼‰ -->
    <div id="grammarModal" class="modal">
        <div class="warm-card p-6 container-spacing modal-content">
            <div class="text-center mb-4">
                <h2 id="grammarModalTitle" class="text-lg font-semibold mb-3 text-gray-700"></h2>
                <p class="text-gray-600 text-sm">å­¦ç¿’ã™ã‚‹å†…å®¹ã‚’é¸ã‚“ã§ãã ã•ã„ã€‚<br>è¤‡æ•°é¸æŠã‚‚ã§ãã¾ã™ã€‚</p>
            </div>
            <div class="grid grammar-grid mb-4" id="grammarCategories">
                <!-- JavaScriptã§å‹•çš„ã«ç”Ÿæˆ -->
            </div>
            <div class="text-center space-y-2">
                <button id="startGrammarQuiz" class="warm-button px-8 py-3 text-sm sparkle" disabled>
                    ğŸš€ ã‚¯ã‚¤ã‚ºã‚¹ã‚¿ãƒ¼ãƒˆï¼
                </button>
                <br>
                <button id="grammarBackButton" class="back-button">
                    â† ãƒ¬ãƒƒã‚¹ãƒ³é¸æŠã«æˆ»ã‚‹
                </button>
            </div>
        </div>
    </div>

    <!-- éŸ³å£°è¨­å®šãƒ¢ãƒ¼ãƒ€ãƒ« -->
    <div id="voiceSettingsModal" class="modal">
        <div class="warm-card p-6 container-spacing modal-content">
            <div class="text-center mb-6">
                <h2 class="text-lg font-semibold mb-3 text-gray-700">
                    ğŸ¤ éŸ³å£°è¨­å®š
                </h2>
                <p class="text-gray-600 text-sm">ãŠå¥½ã¿ã®éŸ³å£°ã‚’é¸ã‚“ã§ã€è‹±èªã®ç™ºéŸ³ã‚’èãã“ã¨ãŒã§ãã¾ã™ã€‚</p>
            </div>
            
            <!-- éŸ³å£°ON/OFFåˆ‡ã‚Šæ›¿ãˆ -->
            <div class="voice-toggle">
                <div class="text-sm font-semibold text-gray-700 mb-3">ğŸ”Š éŸ³å£°æ©Ÿèƒ½</div>
                <label class="toggle-switch">
                    <input type="checkbox" id="voiceEnabled" checked>
                    <span class="toggle-slider"></span>
                </label>
                <div class="text-xs text-gray-600 mt-2" id="voiceToggleDescription">éŸ³å£°æ©Ÿèƒ½ãŒæœ‰åŠ¹ã§ã™</div>
            </div>
            
            <!-- å¥³æ€§éŸ³å£°ã‚»ã‚¯ã‚·ãƒ§ãƒ³ -->
            <div class="voice-section">
                <div class="voice-category-title">ğŸ‘© å¥³æ€§éŸ³å£°</div>
                <div class="voice-option" data-voice="Samantha">
                    <div class="voice-info">
                        <div class="voice-name">Samantha</div>
                        <div class="voice-description">è‡ªç„¶ã§èãå–ã‚Šã‚„ã™ã„</div>
                    </div>
                    <div class="voice-controls">
                        <button class="preview-btn" onclick="previewVoice('Samantha')">è©¦è´</button>
                    </div>
                </div>
                <div class="voice-option" data-voice="Google US English Female">
                    <div class="voice-info">
                        <div class="voice-name">Google Female</div>
                        <div class="voice-description">ã‚¯ãƒªã‚¢ã§ç™ºéŸ³ãŒæ­£ç¢º</div>
                    </div>
                    <div class="voice-controls">
                        <button class="preview-btn" onclick="previewVoice('Google US English Female')">è©¦è´</button>
                    </div>
                </div>
                <div class="voice-option" data-voice="Microsoft Zira">
                    <div class="voice-info">
                        <div class="voice-name">Microsoft Zira</div>
                        <div class="voice-description">è¦ªã—ã¿ã‚„ã™ã„å£°</div>
                    </div>
                    <div class="voice-controls">
                        <button class="preview-btn" onclick="previewVoice('Microsoft Zira')">è©¦è´</button>
                    </div>
                </div>
            </div>
            
            <!-- ç”·æ€§éŸ³å£°ã‚»ã‚¯ã‚·ãƒ§ãƒ³ -->
            <div class="voice-section">
                <div class="voice-category-title">ğŸ‘¨ ç”·æ€§éŸ³å£°</div>
                <div class="voice-option" data-voice="Alex">
                    <div class="voice-info">
                        <div class="voice-name">Alex</div>
                        <div class="voice-description">æ¨™æº–çš„ã§èãå–ã‚Šã‚„ã™ã„</div>
                    </div>
                    <div class="voice-controls">
                        <button class="preview-btn" onclick="previewVoice('Alex')">è©¦è´</button>
                    </div>
                </div>
                <div class="voice-option" data-voice="Google US English Male">
                    <div class="voice-info">
                        <div class="voice-name">Google Male</div>
                        <div class="voice-description">ã¯ã£ãã‚Šã—ãŸç™ºéŸ³</div>
                    </div>
                    <div class="voice-controls">
                        <button class="preview-btn" onclick="previewVoice('Google US English Male')">è©¦è´</button>
                    </div>
                </div>
                <div class="voice-option" data-voice="Microsoft David">
                    <div class="voice-info">
                        <div class="voice-name">Microsoft David</div>
                        <div class="voice-description">è½ã¡ç€ã„ãŸå£°</div>
                    </div>
                    <div class="voice-controls">
                        <button class="preview-btn" onclick="previewVoice('Microsoft David')">è©¦è´</button>
                    </div>
                </div>
            </div>
            
            <div class="text-center mt-6">
                <button class="warm-button px-8 py-3 text-sm" onclick="closeVoiceSettings()">
                    âœ… è¨­å®šå®Œäº†
                </button>
            </div>
        </div>
    </div>

    <!-- ã‚²ãƒ¼ãƒ ç”»é¢ -->
    <div id="gameScreen" class="hidden">
        <div class="warm-card p-6 text-center container-spacing mb-6">
            <h1 class="game-title sparkle">ğŸŒ ONE WORLD Quiz âœ¨</h1>
            <div id="currentCategory" class="text-lg font-semibold text-gray-700 mb-4"></div>
            <div class="stats-display">
                <div class="grid grid-cols-2 gap-4 text-center mb-4">
                    <div>
                        <div class="text-2xl font-bold text-blue-600" id="studyCount">0</div>
                        <div class="text-xs text-gray-600">ğŸ“š å­¦ç¿’å›æ•°</div>
                    </div>
                    <div>
                        <div class="text-2xl font-bold text-purple-600" id="clickCount">0</div>
                        <div class="text-xs text-gray-600">ğŸ–±ï¸ ã‚¯ãƒªãƒƒã‚¯æ•°</div>
                    </div>
                </div>
                
                <!-- åˆ¶é™æ™‚é–“è¨­å®š -->
                <div class="section-divider"></div>
                <div class="text-center">
                    <div class="text-sm font-semibold text-gray-700 mb-3">â° åˆ¶é™æ™‚é–“è¨­å®š</div>
                    <div class="grid grid-cols-3 gap-2 mb-3">
                        <button id="timer3Btn" class="timer-btn active" data-time="3">
                            âš¡ 3ç§’
                        </button>
                        <button id="timer5Btn" class="timer-btn" data-time="5">
                            ğŸ”¥ 5ç§’
                        </button>
                        <button id="timer10Btn" class="timer-btn" data-time="10">
                            ğŸŒŸ 10ç§’
                        </button>
                    </div>
                    <div class="text-xs text-gray-600 mb-3" id="timerDescription">
                        3ç§’ã§åˆ¶é™æ™‚é–“åˆ‡ã‚Œï¼ãƒ‰ã‚­ãƒ‰ã‚­ãƒãƒ£ãƒ¬ãƒ³ã‚¸
                    </div>
                </div>
                
                <!-- å‡ºé¡Œå½¢å¼é¸æŠ -->
                <div class="section-divider"></div>
                <div class="text-center">
                    <div class="text-sm font-semibold text-gray-700 mb-3">ğŸ² å‡ºé¡Œã‚¹ã‚¿ã‚¤ãƒ«</div>
                    <div class="grid grid-cols-2 gap-2 mb-3">
                        <button id="randomModeBtn" class="mode-btn active" data-mode="random">
                            ğŸ¯ ãƒ©ãƒ³ãƒ€ãƒ 
                        </button>
                        <button id="sequentialModeBtn" class="mode-btn" data-mode="sequential">
                            ğŸ“– é †ç•ªé€šã‚Š
                        </button>
                    </div>
                    <div class="text-xs text-gray-600 mb-3" id="modeDescription">
                        å•é¡Œã‚’ãƒ©ãƒ³ãƒ€ãƒ ã«ã‚·ãƒ£ãƒƒãƒ•ãƒ«ã—ã¦å‡ºé¡Œã—ã¾ã™
                    </div>
                </div>

                <!-- å‡ºé¡Œæ–¹å‘é¸æŠ -->
                <div class="section-divider"></div>
                <div class="text-center">
                    <div class="text-sm font-semibold text-gray-700 mb-3">ğŸŒ è¨€èªæ–¹å‘</div>
                    <div class="grid grid-cols-2 gap-2 mb-3">
                        <button id="jpToEnBtn" class="direction-btn active" data-direction="jp_to_en">
                            ğŸ‡¯ğŸ‡µâ†’ğŸ‡ºğŸ‡¸ æ—¥â†’è‹±
                        </button>
                        <button id="enToJpBtn" class="direction-btn" data-direction="en_to_jp">
                            ğŸ‡ºğŸ‡¸â†’ğŸ‡¯ğŸ‡µ è‹±â†’æ—¥
                        </button>
                    </div>
                    <div class="grid grid-cols-1 gap-2">
                        <button id="mixedBtn" class="direction-btn" data-direction="mixed">
                            ğŸ”€ ãƒŸãƒƒã‚¯ã‚¹ãƒ¢ãƒ¼ãƒ‰
                        </button>
                    </div>
                    <div class="text-xs text-gray-600 mt-2" id="directionDescription">
                        æ—¥æœ¬èªã‚’è‹±èªã«å¤‰æ›ã™ã‚‹å•é¡Œ
                    </div>
                </div>
            </div>
            <button id="startQuizButton" class="warm-button px-8 py-4 text-base font-semibold mt-6 sparkle">
                ğŸŒŸ ãƒ¬ãƒƒãƒ„ã‚¹ã‚¿ãƒ¼ãƒˆï¼
            </button>
        </div>
    </div>

    <!-- ã‚¯ã‚¤ã‚ºãƒ¢ãƒ¼ãƒ€ãƒ« -->
    <div id="quizModal" class="modal">
        <div class="warm-card p-4 w-full max-w-lg mx-4">
            <div class="text-center mb-4">
                <h2 class="font-semibold text-lg text-gray-700">
                    ğŸŒ ONE WORLD Quiz Challenge
                </h2>
                <div class="flex items-center justify-between mt-2">
                    <div id="remainingCount" class="text-sm text-gray-600"></div>
                    <div id="timerDisplay" class="timer-display timer-normal">
                        <span id="timerValue">æº–å‚™ä¸­</span>
                    </div>
                </div>
            </div>
            
            <!-- å•é¡Œè¡¨ç¤ºã‚¨ãƒªã‚¢ -->
            <div id="quizQuestion" class="quiz-question"></div>
            
            <!-- è§£ç­”è¡¨ç¤ºãƒœã‚¿ãƒ³ -->
            <div class="text-center">
                <button id="showAnswerBtn" class="show-answer-btn">
                    ğŸ’¡ è§£ç­”ã‚’è¦‹ã‚‹
                </button>
            </div>
            
            <!-- è§£ç­”ãƒ»è§£èª¬è¡¨ç¤ºã‚¨ãƒªã‚¢ï¼ˆæ‹¡å¤§ç‰ˆï¼‰ -->
            <div id="answerDisplay" class="answer-display">
                <div id="answerContent">
                    <div class="text-gray-500" style="text-align: center;">é ­ã§è€ƒãˆã¦ã‹ã‚‰è§£ç­”ãƒœã‚¿ãƒ³ã‚’æŠ¼ã—ã¦ã­ï¼</div>
                </div>
            </div>
            
            <!-- æ“ä½œãƒœã‚¿ãƒ³ -->
            <div class="flex gap-2 mt-4">
                <button id="quizNext" class="flex-1 warm-button py-3 text-sm" disabled>
                    â­ æ¬¡ã®ãƒãƒ£ãƒ¬ãƒ³ã‚¸
                </button>
                <button id="quizBack" class="flex-1 back-button py-3 text-sm">
                    ğŸ  ãƒ›ãƒ¼ãƒ ã¸
                </button>
            </div>
        </div>
    </div>

    <!-- ãƒ•ãƒ­ãƒ¼ãƒ†ã‚£ãƒ³ã‚°ãƒœã‚¿ãƒ³ -->
    <button id="changeSubject" class="floating-button hidden">
        ğŸ 
    </button>

    <!-- éŸ³å£°è¨­å®šãƒ•ãƒ­ãƒ¼ãƒ†ã‚£ãƒ³ã‚°ãƒœã‚¿ãƒ³ -->
    <button id="voiceSettingsBtn" class="voice-settings-button">
        ğŸ¤
    </button>

    <!-- é€šçŸ¥ -->
    <div id="notification" class="notification">
        <div class="flex items-center gap-3">
            <span class="text-2xl">ğŸŒŸ</span>
            <div>
                <div class="font-semibold text-sm">ONE WORLD Quiz</div>
                <div id="notificationText" class="text-xs text-gray-600"></div>
            </div>
        </div>
    </div>

    <script>
        /* ----------------- åŠ¹æœéŸ³ã‚·ã‚¹ãƒ†ãƒ ï¼ˆå®Œå…¨æ–°è¦ï¼‰ ----------------- */
        class SoundSystem {
            constructor() {
                this.audioContext = null;
                this.sounds = {};
                this.initAudio();
            }

            initAudio() {
                try {
                    this.audioContext = new (window.AudioContext || window.webkitAudioContext)();
                } catch (e) {
                    console.log('éŸ³å£°ã‚·ã‚¹ãƒ†ãƒ ã‚’åˆæœŸåŒ–ã§ãã¾ã›ã‚“ã§ã—ãŸ');
                }
            }

            // å„ªã—ã„ã‚¯ãƒªãƒƒã‚¯éŸ³
            playClick() {
                this.createBell(660, 0.08, 0.15);
                setTimeout(() => this.createBell(880, 0.06, 0.1), 30);
            }

            // å­¦ç¿’å®Œäº†æ™‚ã®å„ªã—ã„ãƒ¡ãƒ­ãƒ‡ã‚£
            playStudyComplete() {
                const harmony = [
                    { freq: 440, delay: 0 },
                    { freq: 550, delay: 120 },
                    { freq: 660, delay: 240 }
                ];
                harmony.forEach(note => {
                    setTimeout(() => this.createSoftTone(note.freq, 0.25, 0.2), note.delay);
                });
            }

            // æˆåŠŸæ™‚ã®è¯ã‚„ã‹ã ãŒå„ªã—ã„éŸ³
            playSuccess() {
                const celebration = [
                    { freq: 523, delay: 0 },
                    { freq: 659, delay: 100 },
                    { freq: 784, delay: 200 },
                    { freq: 1047, delay: 300 },
                    { freq: 659, delay: 400 },
                    { freq: 784, delay: 500 },
                    { freq: 1047, delay: 600 },
                    { freq: 1319, delay: 700 }
                ];
                celebration.forEach(note => {
                    setTimeout(() => {
                        this.createSoftTone(note.freq, 0.15, 0.18);
                        // ã‚¨ã‚³ãƒ¼ã‚¨ãƒ•ã‚§ã‚¯ãƒˆ
                        setTimeout(() => this.createSoftTone(note.freq * 0.5, 0.1, 0.08), 50);
                    }, note.delay);
                });
            }

            // ã‚¿ã‚¤ãƒãƒ¼éŸ³
            playTick() {
                this.createBell(800, 0.05, 0.1);
            }

            // æ™‚é–“åˆ‡ã‚ŒéŸ³
            playTimeUp() {
                this.createWarmTone(220, 0.4, 0.3);
                setTimeout(() => this.createWarmTone(196, 0.6, 0.25), 200);
            }

            // ãƒ™ãƒ«ç³»ã®éŸ³è‰²
            createBell(frequency, duration, volume = 0.2) {
                if (!this.audioContext) return;

                const oscillator = this.audioContext.createOscillator();
                const gainNode = this.audioContext.createGain();
                const filter = this.audioContext.createBiquadFilter();

                oscillator.connect(filter);
                filter.connect(gainNode);
                gainNode.connect(this.audioContext.destination);

                oscillator.frequency.setValueAtTime(frequency, this.audioContext.currentTime);
                oscillator.type = 'sine';
                
                filter.type = 'lowpass';
                filter.frequency.setValueAtTime(frequency * 2, this.audioContext.currentTime);

                gainNode.gain.setValueAtTime(0, this.audioContext.currentTime);
                gainNode.gain.linearRampToValueAtTime(volume, this.audioContext.currentTime + 0.01);
                gainNode.gain.exponentialRampToValueAtTime(0.001, this.audioContext.currentTime + duration);

                oscillator.start(this.audioContext.currentTime);
                oscillator.stop(this.audioContext.currentTime + duration);
            }

            // æŸ”ã‚‰ã‹ã„éŸ³è‰²
            createSoftTone(frequency, duration, volume = 0.2) {
                if (!this.audioContext) return;

                const oscillator = this.audioContext.createOscillator();
                const gainNode = this.audioContext.createGain();

                oscillator.connect(gainNode);
                gainNode.connect(this.audioContext.destination);

                oscillator.frequency.setValueAtTime(frequency, this.audioContext.currentTime);
                oscillator.type = 'triangle';

                gainNode.gain.setValueAtTime(0, this.audioContext.currentTime);
                gainNode.gain.linearRampToValueAtTime(volume, this.audioContext.currentTime + 0.02);
                gainNode.gain.exponentialRampToValueAtTime(0.001, this.audioContext.currentTime + duration);

                oscillator.start(this.audioContext.currentTime);
                oscillator.stop(this.audioContext.currentTime + duration);
            }

            // æ¸©ã‹ã¿ã®ã‚ã‚‹éŸ³è‰²
            createWarmTone(frequency, duration, volume = 0.2) {
                if (!this.audioContext) return;

                const oscillator = this.audioContext.createOscillator();
                const gainNode = this.audioContext.createGain();

                oscillator.connect(gainNode);
                gainNode.connect(this.audioContext.destination);

                oscillator.frequency.setValueAtTime(frequency, this.audioContext.currentTime);
                oscillator.type = 'square';

                gainNode.gain.setValueAtTime(0, this.audioContext.currentTime);
                gainNode.gain.linearRampToValueAtTime(volume, this.audioContext.currentTime + 0.05);
                gainNode.gain.exponentialRampToValueAtTime(0.001, this.audioContext.currentTime + duration);

                oscillator.start(this.audioContext.currentTime);
                oscillator.stop(this.audioContext.currentTime + duration);
            }
        }

        const soundSystem = new SoundSystem();

        /* ----------------- éŸ³å£°åˆæˆã‚·ã‚¹ãƒ†ãƒ  ----------------- */
        class VoiceSystem {
            constructor() {
                this.synth = window.speechSynthesis;
                this.voices = [];
                this.selectedVoice = null;
                this.isEnabled = true;
                this.loadVoices();
                this.loadSettings();
                
                // éŸ³å£°ãƒªã‚¹ãƒˆãŒèª­ã¿è¾¼ã¾ã‚Œã‚‹ã¾ã§å¾…æ©Ÿ
                if (this.synth.onvoiceschanged !== undefined) {
                    this.synth.onvoiceschanged = () => {
                        this.loadVoices();
                    };
                }
            }

            loadVoices() {
                this.voices = this.synth.getVoices();
                
                // æ¨å¥¨éŸ³å£°ã®å„ªå…ˆé †ä½
                const preferredVoices = [
                    'Samantha',
                    'Alex', 
                    'Google US English Female',
                    'Google US English Male',
                    'Microsoft Zira',
                    'Microsoft David'
                ];

                // ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆéŸ³å£°ã‚’è¨­å®šï¼ˆæœ€åˆã«è¦‹ã¤ã‹ã£ãŸæ¨å¥¨éŸ³å£°ï¼‰
                if (!this.selectedVoice) {
                    for (const voiceName of preferredVoices) {
                        const voice = this.voices.find(v => v.name.includes(voiceName));
                        if (voice) {
                            this.selectedVoice = voice;
                            break;
                        }
                    }
                    
                    // æ¨å¥¨éŸ³å£°ãŒè¦‹ã¤ã‹ã‚‰ãªã„å ´åˆã¯è‹±èªéŸ³å£°ã‚’æ¢ã™
                    if (!this.selectedVoice) {
                        this.selectedVoice = this.voices.find(v => v.lang.startsWith('en')) || this.voices[0];
                    }
                }
            }

            speak(text) {
                if (!this.isEnabled || !text.trim()) return;
                
                // æ—¢å­˜ã®éŸ³å£°ã‚’åœæ­¢
                this.synth.cancel();
                
                const utterance = new SpeechSynthesisUtterance(text);
                
                if (this.selectedVoice) {
                    utterance.voice = this.selectedVoice;
                }
                
                utterance.rate = 0.9;
                utterance.pitch = 1.0;
                utterance.volume = 0.8;
                
                this.synth.speak(utterance);
                
                return utterance;
            }

            setVoice(voiceName) {
                const voice = this.voices.find(v => v.name.includes(voiceName));
                if (voice) {
                    this.selectedVoice = voice;
                    this.saveSettings();
                    return true;
                }
                return false;
            }

            setEnabled(enabled) {
                this.isEnabled = enabled;
                this.saveSettings();
                
                if (!enabled) {
                    this.synth.cancel();
                }
            }

            previewVoice(voiceName) {
                const originalVoice = this.selectedVoice;
                const originalEnabled = this.isEnabled;
                
                // ä¸€æ™‚çš„ã«è¨­å®šã‚’å¤‰æ›´ã—ã¦ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼
                this.setVoice(voiceName);
                this.isEnabled = true;
                
                const utterance = this.speak("Hello! This is a voice preview. I hope you like this voice.");
                
                // ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼çµ‚äº†å¾Œã«å…ƒã®è¨­å®šã«æˆ»ã™
                utterance.onend = () => {
                    this.selectedVoice = originalVoice;
                    this.isEnabled = originalEnabled;
                };
            }

            saveSettings() {
                const settings = {
                    voiceName: this.selectedVoice ? this.selectedVoice.name : null,
                    isEnabled: this.isEnabled
                };
                localStorage.setItem('oneWorldQuizVoiceSettings', JSON.stringify(settings));
            }

            loadSettings() {
                try {
                    const saved = localStorage.getItem('oneWorldQuizVoiceSettings');
                    if (saved) {
                        const settings = JSON.parse(saved);
                        this.isEnabled = settings.isEnabled !== false; // ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã¯true
                        
                        if (settings.voiceName) {
                            // ä¿å­˜ã•ã‚ŒãŸéŸ³å£°ã‚’æ¢ã—ã¦è¨­å®š
                            setTimeout(() => {
                                this.setVoice(settings.voiceName);
                            }, 100);
                        }
                    }
                } catch (e) {
                    console.log('éŸ³å£°è¨­å®šã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸ');
                }
            }

            getSelectedVoiceName() {
                return this.selectedVoice ? this.selectedVoice.name : 'ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆ';
            }
        }

        const voiceSystem = new VoiceSystem();

        /* ----------------- éŸ³å£°æ©Ÿèƒ½é–¢æ•° ----------------- */
        function openVoiceSettings() {
            const modal = document.getElementById('voiceSettingsModal');
            const enabledCheckbox = document.getElementById('voiceEnabled');
            const toggleDescription = document.getElementById('voiceToggleDescription');
            
            // ç¾åœ¨ã®è¨­å®šã‚’åæ˜ 
            enabledCheckbox.checked = voiceSystem.isEnabled;
            toggleDescription.textContent = voiceSystem.isEnabled ? 'éŸ³å£°æ©Ÿèƒ½ãŒæœ‰åŠ¹ã§ã™' : 'éŸ³å£°æ©Ÿèƒ½ãŒç„¡åŠ¹ã§ã™';
            
            // é¸æŠã•ã‚ŒãŸéŸ³å£°ã‚’ãƒã‚¤ãƒ©ã‚¤ãƒˆ
            document.querySelectorAll('.voice-option').forEach(option => {
                option.classList.remove('selected');
                const voiceName = option.dataset.voice;
                if (voiceSystem.selectedVoice && voiceSystem.selectedVoice.name.includes(voiceName)) {
                    option.classList.add('selected');
                }
            });
            
            modal.classList.add('show');
        }

        function closeVoiceSettings() {
            document.getElementById('voiceSettingsModal').classList.remove('show');
            showNotification('ğŸ¤ éŸ³å£°è¨­å®šã‚’ä¿å­˜ã—ã¾ã—ãŸï¼');
        }

        function previewVoice(voiceName) {
            voiceSystem.previewVoice(voiceName);
            
            // é¸æŠçŠ¶æ…‹ã‚’æ›´æ–°
            document.querySelectorAll('.voice-option').forEach(option => {
                option.classList.remove('selected');
            });
            document.querySelector(`[data-voice="${voiceName}"]`).classList.add('selected');
            
            // å®Ÿéš›ã®è¨­å®šã‚‚æ›´æ–°
            voiceSystem.setVoice(voiceName);
        }

        function toggleVoiceEnabled() {
            const checkbox = document.getElementById('voiceEnabled');
            const description = document.getElementById('voiceToggleDescription');
            
            voiceSystem.setEnabled(checkbox.checked);
            description.textContent = checkbox.checked ? 'éŸ³å£°æ©Ÿèƒ½ãŒæœ‰åŠ¹ã§ã™' : 'éŸ³å£°æ©Ÿèƒ½ãŒç„¡åŠ¹ã§ã™';
        }

        function addSpeakButton(text, container) {
            // è‹±èªãƒ†ã‚­ã‚¹ãƒˆã‚’æ¤œå‡ºï¼ˆç°¡å˜ãªæ­£è¦è¡¨ç¾ï¼‰
            const englishRegex = /[a-zA-Z]/;
            if (!englishRegex.test(text)) return container;
            
            const speakBtn = document.createElement('button');
            speakBtn.className = 'speak-btn';
            speakBtn.innerHTML = 'ğŸ”Š';
            speakBtn.title = 'è‹±èªã§èª­ã¿ä¸Šã’';
            speakBtn.onclick = (e) => {
                e.stopPropagation();
                speakEnglishText(text, speakBtn);
            };
            
            const wrapper = document.createElement('span');
            wrapper.style.display = 'inline-flex';
            wrapper.style.alignItems = 'center';
            wrapper.appendChild(document.createTextNode(text));
            wrapper.appendChild(speakBtn);
            
            return wrapper;
        }

        function speakEnglishText(text, button = null) {
            if (!voiceSystem.isEnabled) {
                showNotification('ğŸ”‡ éŸ³å£°æ©Ÿèƒ½ãŒç„¡åŠ¹ã«ãªã£ã¦ã„ã¾ã™ã€‚è¨­å®šã§æœ‰åŠ¹ã«ã—ã¦ãã ã•ã„ã€‚');
                return;
            }
            
            // ãƒœã‚¿ãƒ³ã®ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³
            if (button) {
                button.classList.add('speaking');
            }
            
            const utterance = voiceSystem.speak(text);
            
            if (utterance) {
                utterance.onend = () => {
                    if (button) {
                        button.classList.remove('speaking');
                    }
                };
            }
        }

        /* ----------------- ãƒ¬ãƒƒã‚¹ãƒ³ãƒ»æ–‡æ³•é …ç›®å®šç¾© ----------------- */
        const lessons = {
            grade1: [
                {
                    id: 'lesson1',
                    name: 'Lesson1 - æ–‡ã®åŸºæœ¬',
                    grammar: [
                        {id: 'word_order', name: '1. æ—¥æœ¬èªã¨è‹±èªã®èªé †'},
                        {id: 'sentence_types', name: '2. è‹±èªã®æ–‡ã®ä»£è¡¨çš„ãª2ã¤ã®å‹'},
                        {id: 'personal_statements', name: '3. è‡ªåˆ†ã®ã“ã¨ã‚’è¿°ã¹ãŸã‚Šç›¸æ‰‹ã®ã“ã¨ã‚’ãŸãšã­ã‚‹'},
                        {id: 'various_questions', name: '4. ã•ã¾ã–ã¾ãªç–‘å•æ–‡'},
                        {id: 'requests', name: '5. ãŠé¡˜ã„ã™ã‚‹ã¨ã'}
                    ]
                },
                {
                    id: 'lesson2',
                    name: 'Lesson2 - ä»£åè©',
                    grammar: [
                        {id: 'she_he_it', name: '1. she, he, it ãªã©ã®ä½¿ã„æ–¹'},
                        {id: 'pronoun_questions', name: '2. she, he ãªã©ã‚’ä½¿ã£ãŸæ–‡ã®ç–‘å•æ–‡'},
                        {id: 'this_that', name: '3. this ã¨ that ã®ä½¿ã„æ–¹'},
                        {id: 'this_that_questions', name: '4. this, that ã‚’ä½¿ã£ãŸæ–‡ã®ç–‘å•æ–‡'},
                        {id: 'we_you_they', name: '5. We, you, they ã®ä½¿ã„æ–¹'},
                        {id: 'can_usage', name: '6. can ã®æ„å‘³ã¨ç”¨æ³•'},
                        {id: 'some_any', name: '7. some ã¨ any'}
                    ]
                },
                {
                    id: 'lesson3',
                    name: 'Lesson3 - ä¸€èˆ¬å‹•è©',
                    grammar: [
                        {id: 'general_verbs', name: '1. ä¸€èˆ¬å‹•è©ã«ã¯ã€ã©ã‚“ãªã‚‚ã®ãŒã‚ã‚‹ï¼Ÿ'},
                        {id: 'verb_s_es', name: '2. ä¸€èˆ¬å‹•è©ã«ã¤ã s, es'},
                        {id: 'verb_s_es_rules', name: '3. ä¸€èˆ¬å‹•è©ã® s, es ã®ã¤ã‘æ–¹'},
                        {id: 'noun_singular_plural', name: '4. ã€Œ1ã¤ï¼ˆå˜æ•°ï¼‰ã€ãªã®ã‹ã€Œ2ã¤ä»¥ä¸Šï¼ˆè¤‡æ•°ï¼‰ã€ãªã®ã‹ã‚’è¡¨ã™åè©ã«ã¤ã s, es'},
                        {id: 'plural_rules', name: '5. è¤‡æ•°å½¢ã®ã¤ãã‚Šæ–¹'},
                        {id: 'pronoun_i', name: '6. ã€Œç§ã€ã‚’è¡¨ã™2ã¤ã®å½¢'},
                        {id: 'pronoun_cases', name: '7. ä¸»èªã¨ã—ã¦ä½¿ã†å ´åˆã¨ä¸»èªä»¥å¤–ã§ä½¿ã†ã€Œã‚ãªãŸã€ã€Œå½¼ã€ãªã©'}
                    ]
                },
                {
                    id: 'lesson4',
                    name: 'Lesson4 - éå»å½¢',
                    grammar: [
                        {id: 'past_statements', name: '1. éå»ã®ã“ã¨ã‚’è¨€ã†ã¨ã'},
                        {id: 'past_questions', name: '2. éå»ã®ã“ã¨ã‚’ãŸãšã­ã‚‹ã¨ãï¼ˆç–‘å•æ–‡ï¼‰'},
                        {id: 'past_negative', name: '3. éå»ã®ã“ã¨ã§ã€Œã—ãªã‹ã£ãŸã€ã€Œã§ãªã‹ã£ãŸã€ã“ã¨ã‚’è¨€ã†ã¨ãï¼ˆå¦å®šæ–‡ï¼‰'}
                    ]
                },
                {
                    id: 'lesson5',
                    name: 'Lesson5 - ç¾åœ¨é€²è¡Œå½¢',
                    grammar: [
                        {id: 'present_continuous', name: '1. ä»Šã—ã¦ã„ã‚‹ã“ã¨ã‚’ä¼ãˆã‚‹ã¨ã'},
                        {id: 'present_continuous_negative', name: '2. ã€Œã€œã—ã¦ã„ã¾ã›ã‚“ã€ã¨ã„ã†ã“ã¨ã‚’ä¼ãˆã‚‹ã¨ã'},
                        {id: 'present_continuous_questions', name: '3. ã€Œã€œã—ã¦ã„ã‚‹ã®ã§ã™ã‹ã€ã€ã€Œä½•ã‚’ã—ã¦ã„ã‚‹ã®ã§ã™ã‹ã€ã¨è³ªå•ã™ã‚‹ã¨ã'}
                    ]
                },
                {
                    id: 'lesson6',
                    name: 'Lesson6 - ç–‘å•è©',
                    grammar: [
                        {id: 'why_because', name: '1. ã€Œç†ç”±ã€ã‚’è³ªå•ã™ã‚‹ã¨ãã€ã€Œç†ç”±ã€ã‚’è¿°ã¹ã‚‹ã¨ã'},
                        {id: 'how_often', name: '2. ã€Œã©ã®ãã‚‰ã„ã‚ˆãã€œã™ã‚‹ã‹ã€ã‚’è³ªå•ã™ã‚‹ã¨ãã€ç­”ãˆã‚‹ã¨ã'},
                        {id: 'which_who_whose', name: '3. ã€Œã©ã®ã€œã€ã‚’è³ªå•ã™ã‚‹ã¨ãã€ã€Œã©ã¡ã‚‰ã‚’ã€ã€Œã ã‚ŒãŒã€ã€Œã ã‚Œã®ã€œã€ã‚’è³ªå•ã™ã‚‹ã¨ã'}
                    ]
                },
                {
                    id: 'lesson7',
                    name: 'Lesson7 - åŠ©å‹•è©',
                    grammar: [
                        {id: 'must_prohibition', name: '1. ã€Œå¼·ã„å‘½ä»¤ã€ã‚„ã€Œç¦æ­¢ã€ã‚’ä¼ãˆã‚‹ã¨ã'},
                        {id: 'have_to_necessity', name: '2. ã€Œã€œã™ã‚‹å¿…è¦ãŒã‚ã‚‹ã€ã€Œã€œã™ã‚‹å¿…è¦ã¯ãªã„ã€ã¨ä¼ãˆã‚‹ã¨ã'},
                        {id: 'may_able_to', name: '3. ã€Œã€œã‹ã‚‚ã—ã‚Œãªã„ã€ã¨è¿°ã¹ã‚‹ã¨ãã€ã€Œã€œã™ã‚‹ã“ã¨ãŒã§ãã‚‹ã€ã¨è¿°ã¹ã‚‹ã¨ã'}
                    ]
                },
                {
                    id: 'lesson8',
                    name: 'Lesson8 - æœªæ¥è¡¨ç¾',
                    grammar: [
                        {id: 'be_going_to', name: '1. äºˆå®šã‚„è¨ˆç”»ã‚’è¿°ã¹ã‚‹ã¨ã'},
                        {id: 'will_prediction', name: '2. æœªæ¥ã®ã“ã¨ã«ã¤ã„ã¦ã€Œã€œã ã‚ã†ã€ã¨ã„ã†äºˆæƒ³ã‚’è¿°ã¹ã‚‹ã¨ã'},
                        {id: 'should', name: '3. ã€Œã€œã™ã¹ãã ã€ã¨è¿°ã¹ã‚‹ã¨ã'}
                    ]
                },
                {
                    id: 'lesson9',
                    name: 'Lesson9 - There is/areæ–‡',
                    grammar: [
                        {id: 'there_is_are', name: '1. ã€Œã€œã«ãƒ»ãƒ»ãƒ»ãŒã‚ã‚‹ï¼ˆã„ã‚‹ï¼‰ã€ã‚’ä¼ãˆã‚‹ã¨ã'},
                        {id: 'there_is_are_questions', name: '2. ã€Œã€œã«ãƒ»ãƒ»ãƒ»ã¯ã‚ã‚Šã¾ã™ã‹ã€ã€Œã€œã«ãƒ»ãƒ»ãƒ»ã¯ã„ãã¤ã‚ã‚Šã¾ã™ã‹ã€ã¨è³ªå•ã™ã‚‹å ´åˆ'},
                        {id: 'look_sound', name: '3. ã€Œã€œãã†ã«è¦‹ãˆã‚‹ï¼èã“ãˆã‚‹ã€ã¨è¿°ã¹ã‚‹ã¨ã'}
                    ]
                }
            ],
            grade2: [
                {
                    id: 'review_lesson',
                    name: 'Review Lesson - 1å¹´ç”Ÿã®å¾©ç¿’',
                    grammar: [
                        {id: 'have_to_must_review', name: '1. ã€Œã€œã™ã‚‹å¿…è¦ãŒã‚ã‚‹ã€ã‚„ã€Œå¼·ã„å‘½ä»¤ã€ã‚’ä¼ãˆã‚‹ã¨ãï¼ˆhave [has] to ã¨ mustï¼‰'},
                        {id: 'future_review', name: '2. äºˆå®šã‚„æœªæ¥ã«ã¤ã„ã¦ã®äºˆæƒ³ã‚’è¿°ã¹ã‚‹ã¨ãï¼ˆbe going to ã¨ willï¼‰'},
                        {id: 'there_is_are_review', name: '3. ã‚‚ã®ãŒã‚ã‚‹ã“ã¨ã‚„ã€äººãŒã„ã‚‹ã“ã¨ã‚’è¿°ã¹ã‚‹ã¨ãï¼ˆThere is [are] ~.ï¼‰'},
                        {id: 'there_is_are_transformation', name: '4. There is [are] ~. ã®æ–‡ã®æ›¸ãæ›ãˆ'}
                    ]
                },
                {
                    id: 'lesson1',
                    name: 'Lesson1 - ç›®çš„èª2ã¤/æ¥ç¶šè©that',
                    grammar: [
                        {id: 'double_object', name: '1. ã€Œï¼œäººï¼ã«ï¼œã‚‚ã®ï¼ã‚’ã‚ã’ã‚‹ãƒ»é€ã‚‹ã€ãªã©ã¨è¿°ã¹ã‚‹ã¨ãï¼ˆç›®çš„èªã‚’ï¼’ã¤ã¨ã‚‹å‹•è©ï¼‰'},
                        {id: 'that_opinion', name: '2. è‡ªåˆ†ã®æ„è¦‹ã‚„çŸ¥ã£ã¦ã„ã‚‹ã“ã¨ã‚’ä¼ãˆã‚‹ã¨ãï¼ˆæ¥ç¶šè©ã®thatï¼‰'},
                        {id: 'that_feeling', name: '3. è‡ªåˆ†ã®æ°—æŒã¡ã¨ãã®ç†ç”±ã‚’ä¼ãˆã‚‹ã¨ãï¼ˆæ¥ç¶šè©ã®thatï¼‰'}
                    ]
                },
                {
                    id: 'lesson2',
                    name: 'Lesson2 - éå»é€²è¡Œå½¢/æ¥ç¶šè©',
                    grammar: [
                        {id: 'past_continuous', name: '1. éå»ã®ã‚ã‚‹æ™‚ç‚¹ã§ã—ã¦ã„ãŸã“ã¨ã‚’è¿°ã¹ã‚‹ã¨ãï¼ˆéå»é€²è¡Œå½¢ï¼‰'},
                        {id: 'when_conjunction', name: '2. ã©ã‚“ãªæ™‚ã®ã“ã¨ã‹ã‚’è¿°ã¹ã‚‹ã¨ãï¼ˆæ¥ç¶šè©ã®whenï¼‰'},
                        {id: 'if_because', name: '3. æ¡ä»¶ã‚’è¿°ã¹ã‚‹ã¨ãã€ç†ç”±ã‚’è¿°ã¹ã‚‹ã¨ãï¼ˆæ¥ç¶šè©ã®ifï¼‰'}
                    ]
                },
                {
                    id: 'lesson3',
                    name: 'Lesson3 - ä¸å®šè©',
                    grammar: [
                        {id: 'infinitive_noun', name: '1. ã—ãŸã„ã“ã¨ã€ãªã‚ŠãŸã„ã‚‚ã®ã‚’è¿°ã¹ã‚‹ã¨ãï¼ˆåè©çš„ç”¨æ³•ã€Œã€œã™ã‚‹ã“ã¨ã€ï¼‰'},
                        {id: 'infinitive_adverb', name: '2. ç›®çš„ã‚’è¿°ã¹ã‚‹ã¨ãï¼ˆå‰¯è©çš„ç”¨æ³•ã€Œã€œã™ã‚‹ãŸã‚ã«ã€ï¼‰'},
                        {id: 'infinitive_adjective', name: '3. ã€Œã‚‚ã®ã®ç”¨é€”ã€ä½•ã‚’ã™ã‚‹ãŸã‚ã®ã‚‚ã®ã‹ã€ã‚’è¿°ã¹ã‚‹ã¨ãï¼ˆå½¢å®¹è©çš„ç”¨æ³•ã€Œã€œã™ã‚‹ãŸã‚ã®ã€ï¼‰'}
                    ]
                },
                {
                    id: 'lesson4',
                    name: 'Lesson4 - å‹•åè©',
                    grammar: [
                        {id: 'gerund_object', name: '1. ã€Œã€œã™ã‚‹ã“ã¨ã‚’çµ‚ãˆã‚‹ãƒ»æ¥½ã—ã‚€ãƒ»å¥½ã‚€ã€ãªã©ã‚’ä¼ãˆã‚‹ã¨ãï¼ˆå‹•åè©ï¼‰'},
                        {id: 'gerund_subject', name: '2. ã€Œã€œã™ã‚‹ã“ã¨ã€ã‚’ä¸»èªã«ã—ã¦è¿°ã¹ã‚‹ã¨ãï¼ˆå‹•åè©ï¼‰'},
                        {id: 'teach_tell_that', name: '3. ã€Œã ã‚ŒãŒã ã‚Œã«ã©ã‚“ãªã“ã¨ã‚’æ•™ãˆãŸã‹ãƒ»ä¼ãˆãŸã‹ã€ãªã©ã‚’è¿°ã¹ã‚‹ã¨ãï¼ˆæ¥ç¶šè©ã®thatï¼‰'}
                    ]
                },
                {
                    id: 'lesson5',
                    name: 'Lesson5 - ä¸å®šè©ã®ç™ºå±•',
                    grammar: [
                        {id: 'how_to_what_to', name: '1. ã€Œã€œã®ä»•æ–¹ã€ã‚„ã€Œã™ã¹ãã“ã¨ã€ãªã©ã‚’è¿°ã¹ã‚‹ã¨ã'},
                        {id: 'it_is_to', name: '2. ã€Œã€œã™ã‚‹ã“ã¨ã¯ãŠã‚‚ã—ã‚ã„ãƒ»é›£ã—ã„ãƒ»ä¸å¯èƒ½ã ã€ãªã©ã‚’è¿°ã¹ã‚‹ã¨ãï¼ˆIt is + å½¢å®¹è© + to + å‹•è©ã®åŸå½¢ã€œ.ï¼‰'},
                        {id: 'teach_ask_how_to', name: '3. ã€Œã ã‚Œã«ã€œã®ä»•æ–¹ã€ä½•ã‚’ã™ã¹ãã‹ãªã©ã‚’ä¼ãˆã‚‹ãƒ»æ•™ãˆã‚‹ãƒ»ãŸãšã­ã‚‹ã‹ã€ã‚’è¿°ã¹ã‚‹ã¨ã'}
                    ]
                },
                {
                    id: 'lesson6',
                    name: 'Lesson6 - æ¯”è¼ƒ',
                    grammar: [
                        {id: 'comparative', name: '1. 2ã¤ã®ã‚‚ã®ã‚’æ¯”ã¹ã¦ã€ãã®é•ã„ã‚’ä¼ãˆã‚‹ã¨ãï¼ˆæ¯”è¼ƒç´šï¼‰'},
                        {id: 'superlative', name: '2. 3ã¤ä»¥ä¸Šã®ã‚‚ã®ã‚’æ¯”ã¹ã¦ã€ã€Œã„ã¡ã°ã‚“ã€œã ã€ã¨ä¼ãˆã‚‹ã¨ãï¼ˆæœ€ä¸Šç´šï¼‰'},
                        {id: 'as_as', name: '3. ã€ŒåŒã˜ãã‚‰ã„ã€œã ã€ã€Œã„ã¡ã°ã‚“å¥½ãã ã€ãªã©ã‚’ä¼ãˆã‚‹ã¨ãï¼ˆåŸç´šãªã©ï¼‰'},
                        {id: 'comparison_rules', name: '4. æ¯”è¼ƒç´šãƒ»æœ€ä¸Šç´šã®ä½œã‚Šæ–¹'},
                        {id: 'comparison_transformation', name: '5. æ¯”è¼ƒè¡¨ç¾ã®æ›¸ãæ›ãˆ'},
                        {id: 'comparison_notes', name: '6. ãã®ä»–ã«æ³¨æ„ã™ã‚‹ã“ã¨'}
                    ]
                },
                {
                    id: 'lesson7',
                    name: 'Lesson7 - å—å‹•æ…‹',
                    grammar: [
                        {id: 'passive_voice', name: '1. ã€Œ...ã¯ã€œã•ã‚Œã‚‹ã€ã€Œ...ã¯ã€œã•ã‚Œã¦ã„ã‚‹ã€ã®ã‚ˆã†ãªè¡¨ç¾ã‚’ä¼ãˆã‚‹ã¨ã'},
                        {id: 'passive_questions', name: '2. ã€Œâ€¦ã¯ã€œã•ã‚Œã¾ã™ã‹ã€ã€Œ...ã¯ã€œã•ã‚Œã¦ã„ã¾ã™ã‹ã€ãªã©ã¨è³ªå•ã™ã‚‹ã¨ã'},
                        {id: 'passive_modal', name: '3. ã€Œã€œã•ã‚Œã‚‹ã¹ãã ã€ã€Œã€œã•ã‚Œã‚‹ã“ã¨ãŒå¯èƒ½ã ã€ãªã©ã‚’ä¼ãˆã‚‹ã¨ã'},
                        {id: 'past_participle_rules', name: '4. éå»åˆ†è©å½¢ã®ä½œã‚Šæ–¹'},
                        {id: 'passive_transformation', name: '5. å—ã‘èº«ã®æ–‡ã®æ›¸ãæ›ãˆä¾‹'}
                    ]
                },
                {
                    id: 'lesson8',
                    name: 'Lesson8 - é–“æ¥ç–‘å•æ–‡/æ„Ÿå˜†æ–‡',
                    grammar: [
                        {id: 'indirect_questions_know', name: '1. ã€Œã„ã¤ãƒ»ã©ã“ã§ã€ãªã©ã®æƒ…å ±ã‚’ã€ŒçŸ¥ã£ã¦ã„ã‚‹ãƒ»çŸ¥ã‚‰ãªã„ã€ãªã©ã¨è¡¨ç¾ã™ã‚‹ã¨ã'},
                        {id: 'indirect_questions_tell', name: '2. ã€Œã„ã¤ãƒ»ã©ã“ã§ã€ãªã©ã®æƒ…å ±ã‚’ã€Œã ã‚Œã«è¨€ã£ãŸã‹ãƒ»èã„ãŸã‹ã€ãªã©ã¨è¡¨ç¾ã™ã‚‹ã¨ã'},
                        {id: 'exclamatory', name: '3. é©šãã‚„æ„Ÿå‹•ã‚’è¡¨ç¾ã™ã‚‹ã¨ã'}
                    ]
                },
                {
                    id: 'lesson9',
                    name: 'Lesson9 - å‹•è©ã®æ§˜ã€…ãªä½¿ã„æ–¹',
                    grammar: [
                        {id: 'make_call', name: '1. ã€Œã©ã‚“ãªæ°—æŒã¡ã«ãªã£ãŸã‹ã€ã€Œå‘¼ã³åã¯ä½•ã‹ã€ãªã©ã‚’ä¼ãˆã‚‹ã¨ã'},
                        {id: 'want_ask_to', name: '2. äººã«ã—ã¦ã»ã—ã„ã“ã¨ã‚’ä¼ãˆãŸã‚Šé ¼ã‚“ã ã‚Šã™ã‚‹ã¨ã'},
                        {id: 'let_help', name: '3. è¨±å¯ã‚’å¾—ã‚‹ã¨ãã€ã ã‚ŒãŒæ‰‹ä¼ã£ã¦ãã‚Œã‚‹ã®ã‹ã‚’è¿°ã¹ã‚‹ã¨ã'}
                    ]
                }
            ],
            grade3: [
                {
                    id: 'review_lesson',
                    name: 'Review Lesson - 2å¹´ç”Ÿã®å¾©ç¿’',
                    grammar: [
                        {id: 'how_to_what_to_review', name: '1. ã€Œã€œã®ä»•æ–¹ã€ã‚„ã€Œã™ã¹ãã“ã¨ã€ãªã©ã‚’è¿°ã¹ã‚‹ã¨ã'},
                        {id: 'make_call_review', name: '2. ã€Œå‘¼ã³åã¯ä½•ã‹ã€ã€Œã©ã‚“ãªæ°—æŒã¡ã«ãªã£ãŸã‹ã€ãªã©ã‚’è¿°ã¹ã‚‹ã¨ã'},
                        {id: 'it_is_to_review', name: '3. ã€Œã€œã™ã‚‹ã“ã¨ã¯é›£ã—ã„ãƒ»ã‚„ã•ã—ã„ã€ãªã©ã‚’è¿°ã¹ã‚‹ã¨ã'}
                    ]
                },
                {
                    id: 'lesson1',
                    name: 'Lesson1 - ç¾åœ¨å®Œäº†å½¢(1)',
                    grammar: [
                        {id: 'present_perfect_completion', name: '1. ã€Œã€œã—çµ‚ãˆãŸã€ã“ã¨ã‚’ä¼ãˆã‚‹ã¨ãï¼ˆç¾åœ¨å®Œäº†å½¢ã®å®Œäº†ç”¨æ³•ï¼‰'},
                        {id: 'present_perfect_experience', name: '2. ã€Œã€œã—ãŸçµŒé¨“ãŒã‚ã‚‹ã€ã“ã¨ã‚’ä¼ãˆã‚‹ã¨ãï¼ˆç¾åœ¨å®Œäº†å½¢ã®çµŒé¨“ç”¨æ³•ï¼‰'},
                        {id: 'present_perfect_experience_questions', name: '3. ã€Œã€œã—ãŸçµŒé¨“ãŒã‚ã‚‹ã‹ã€ã‚’è³ªå•ã™ã‚‹ã¨ãï¼ˆç¾åœ¨å®Œäº†å½¢ã®çµŒé¨“ç”¨æ³•ï¼‰'}
                    ]
                },
                {
                    id: 'lesson2',
                    name: 'Lesson2 - ç¾åœ¨å®Œäº†å½¢(2)',
                    grammar: [
                        {id: 'present_perfect_continuation', name: '1. ã€Œãšã£ã¨ã€œã—ã¦ã„ã‚‹ã€ã“ã¨ã‚’ä¼ãˆã‚‹ã¨ãï¼ˆç¾åœ¨å®Œäº†å½¢ã®ç¶™ç¶šç”¨æ³•ï¼‰'},
                        {id: 'present_perfect_continuation_questions', name: '2. ã€Œã©ã®ãã‚‰ã„ã€œã—ã¦ã„ã¾ã™ã‹ã€ã¨è³ªå•ã™ã‚‹ã¨ãï¼ˆç¾åœ¨å®Œäº†å½¢ã®ç¶™ç¶šç”¨æ³•ï¼‰'},
                        {id: 'present_perfect_continuous', name: '3. ã€Œãšã£ã¨ã€œã—ã¦ã„ã‚‹ã€ã“ã¨ã‚’ä¼ãˆã‚‹ã¨ãï¼ˆç¾åœ¨å®Œäº†é€²è¡Œå½¢ï¼‰'}
                    ]
                },
                {
                    id: 'lesson3',
                    name: 'Lesson3 - å¾Œç½®ä¿®é£¾',
                    grammar: [
                        {id: 'participle_present', name: '1. ã€Œã©ã‚“ãªäººã‹ãƒ»ã©ã‚“ãªã‚‚ã®ã‹ã€ã‚’èª¬æ˜ã™ã‚‹ã¨ãï¼ˆãã®1ï¼šç¾åœ¨åˆ†è©ã«ã‚ˆã‚‹å¾Œç½®ä¿®é£¾ï¼‰'},
                        {id: 'participle_past', name: '2. ã€Œã©ã‚“ãªäººã‹ãƒ»ã©ã‚“ãªã‚‚ã®ã‹ã€ã‚’èª¬æ˜ã™ã‚‹ã¨ãï¼ˆãã®2ï¼šéå»åˆ†è©ã«ã‚ˆã‚‹å¾Œç½®ä¿®é£¾ï¼‰'},
                        {id: 'relative_pronoun_omission', name: '3. ã€Œã©ã‚“ãªäººã‹ãƒ»ã©ã‚“ãªã‚‚ã®ã‹ã€ã‚’èª¬æ˜ã™ã‚‹ã¨ãï¼ˆãã®3ï¼šç›®çš„æ ¼ã®é–¢ä¿‚ä»£åè©ã®çœç•¥ï¼‰'}
                    ]
                },
                {
                    id: 'lesson4',
                    name: 'Lesson4 - é–¢ä¿‚ä»£åè©',
                    grammar: [
                        {id: 'relative_pronoun_who', name: '1. ã€Œã©ã‚“ãªäººã‹ã€ã‚’èª¬æ˜ã™ã‚‹ã¨ãï¼ˆä¸»æ ¼ã®é–¢ä¿‚ä»£åè©ï¼‰'},
                        {id: 'relative_pronoun_which', name: '2. ã€Œã©ã‚“ãªã‚‚ã®ã‹ã€ã‚’èª¬æ˜ã™ã‚‹ã¨ãï¼ˆä¸»æ ¼ã®é–¢ä¿‚ä»£åè©ï¼‰'},
                        {id: 'relative_pronoun_object', name: '3. ã€Œã©ã‚“ãªäººã‹ãƒ»ã©ã‚“ãªã‚‚ã®ã‹ã€ã‚’èª¬æ˜ã™ã‚‹ã¨ãï¼ˆç›®çš„æ ¼ã®é–¢ä¿‚ä»£åè©ï¼‰'}
                    ]
                },
                {
                    id: 'lesson5',
                    name: 'Lesson5 - ä»®å®šæ³•',
                    grammar: [
                        {id: 'subjunctive_1', name: '1. å®Ÿç¾ã™ã‚‹å¯èƒ½æ€§ãŒãªã„ã€ã¾ãŸã¯å¯èƒ½æ€§ãŒä½ã„ã“ã¨ã‚’ã€Œã€œãªã‚‰ãªã‚ã€ã¨è¡¨ç¾ã™ã‚‹å ´åˆï¼ˆãã®1ï¼‰'},
                        {id: 'subjunctive_2', name: '2. å®Ÿç¾ã™ã‚‹å¯èƒ½æ€§ãŒãªã„ã€ã¾ãŸã¯å¯èƒ½æ€§ãŒä½ã„ã“ã¨ã‚’ã€Œã€œãªã‚‰ãªã‚ã€ã¨è¡¨ç¾ã™ã‚‹å ´åˆï¼ˆãã®2ï¼‰'},
                        {id: 'subjunctive_3', name: '3. å®Ÿç¾ã™ã‚‹å¯èƒ½æ€§ãŒãªã„ã€ã¾ãŸã¯å¯èƒ½æ€§ãŒä½ã„ã“ã¨ã‚’ã€Œã€œãªã‚‰ãªã‚ã€ã¨è¡¨ç¾ã™ã‚‹å ´åˆï¼ˆãã®3ï¼‰'}
                    ]
                },
                {
                    id: 'lesson6',
                    name: 'Lesson6 - å¾Œç½®ä¿®é£¾ã¨é–¢ä¿‚ä»£åè©ã®ã¾ã¨ã‚',
                    grammar: [
                        {id: 'postposition_ing', name: '1. ã€ˆåè© ï¼‹ å‹•è©ã®-ingå½¢ ï¼‹ èªå¥ã€‰ï¼ˆç¾åœ¨åˆ†è©ã«ã‚ˆã‚‹å¾Œç½®ä¿®é£¾ï¼‰'},
                        {id: 'postposition_past_participle', name: '2. ã€ˆåè© ï¼‹ å‹•è©ã®éå»åˆ†è©å½¢ ï¼‹ èªå¥ã€‰ï¼ˆéå»åˆ†è©ã«ã‚ˆã‚‹å¾Œç½®ä¿®é£¾ï¼‰'},
                        {id: 'postposition_omission', name: '3. ã€ˆåè© ï¼‹ ä¸»èª ï¼‹ å‹•è© ã€œã€‰ï¼ˆç›®çš„æ ¼ã®é–¢ä¿‚ä»£åè©ã®çœç•¥ï¼‰'},
                        {id: 'relative_summary', name: '4. ã€ˆåè© ï¼‹ é–¢ä¿‚ä»£åè©ï¼ˆwho, which, thatï¼‰ ï¼‹ èªå¥ã€‰ï¼ˆä¸»æ ¼ã®é–¢ä¿‚ä»£åè©ã¨ç›®çš„æ ¼ã®é–¢ä¿‚ä»£åè©ï¼‰'},
                        {id: 'sentence_transformation', name: '5. æ–‡ã®æ›¸ãæ›ãˆ'}
                    ]
                }
            ]
        };

        /* ----------------- ã‚²ãƒ¼ãƒ å¤‰æ•° ----------------- */
        let selectedGrammarItems = [];
        let selectedLessons = []; // è¤‡æ•°ãƒ¬ãƒƒã‚¹ãƒ³é¸æŠæ©Ÿèƒ½
        let currentQuestionIndex = 0;
        let studyCount = 0; // å­¦ç¿’å›æ•°ï¼ˆå•é¡Œã‚’è¦‹ãŸå›æ•°ï¼‰
        let sessionClickCount = 0; // ã‚»ãƒƒã‚·ãƒ§ãƒ³å†…ã‚¯ãƒªãƒƒã‚¯æ•°
        let usedQuestions = [];
        let particleOffset = 0;
        let currentGrade = '';
        let currentLesson = '';
        
        // å‡ºé¡Œå½¢å¼é–¢é€£ã®å¤‰æ•°
        let questionMode = 'random'; // 'random' ã¾ãŸã¯ 'sequential'
        let sequentialIndex = 0;
        let questionDirection = 'jp_to_en'; // 'jp_to_en', 'en_to_jp', 'mixed'
        
        // ã‚¿ã‚¤ãƒãƒ¼é–¢é€£ã®å¤‰æ•°
        let timerLimit = 3; // ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆ3ç§’
        let timerInterval = null;
        let currentTimerValue = 0;
        let isTimerRunning = false;
        let isQuizAnswered = false;

        /* ----------------- ã‚¯ãƒªãƒƒã‚¯æ•°ç®¡ç†æ©Ÿèƒ½ï¼ˆé€£æ‰“é˜²æ­¢æ’¤å»ƒãƒ»è©³ç´°çµ±è¨ˆï¼‰ ----------------- */
        let clickStats = {
            total: 0,
            daily: {} // æ—¥ä»˜åˆ¥ã‚¯ãƒªãƒƒã‚¯æ•°
        };

        function getTodayDateString() {
            const today = new Date();
            return today.getFullYear() + '-' + 
                   String(today.getMonth() + 1).padStart(2, '0') + '-' + 
                   String(today.getDate()).padStart(2, '0');
        }

        function getYesterdayDateString() {
            const yesterday = new Date();
            yesterday.setDate(yesterday.getDate() - 1);
            return yesterday.getFullYear() + '-' + 
                   String(yesterday.getMonth() + 1).padStart(2, '0') + '-' + 
                   String(yesterday.getDate()).padStart(2, '0');
        }

        function getWeekDates() {
            const dates = [];
            for (let i = 0; i < 7; i++) {
                const date = new Date();
                date.setDate(date.getDate() - i);
                const dateStr = date.getFullYear() + '-' + 
                               String(date.getMonth() + 1).padStart(2, '0') + '-' + 
                               String(date.getDate()).padStart(2, '0');
                dates.push(dateStr);
            }
            return dates;
        }

        function incrementClickCount() {
            // é€£æ‰“é˜²æ­¢ã‚’æ’¤å»ƒ - è‡ªç”±ã«ã‚¯ãƒªãƒƒã‚¯ã§ãã‚‹ã‚ˆã†ã«å¤‰æ›´
            const today = getTodayDateString();
            
            // çµ±è¨ˆæ›´æ–°
            clickStats.total++;
            sessionClickCount++;
            
            if (!clickStats.daily[today]) {
                clickStats.daily[today] = 0;
            }
            clickStats.daily[today]++;
            
            updateClickDisplays();
            saveClickStats();
            
            // 10ã‚¯ãƒªãƒƒã‚¯ã”ã¨ã«å¬‰ã—ã„é€šçŸ¥
            if (clickStats.total % 10 === 0) {
                showNotification(`ğŸ‰ ${clickStats.total}å›ã‚¯ãƒªãƒƒã‚¯é”æˆï¼å­¦ç¿’ãŒç©ã¿é‡ãªã£ã¦ã¾ã™ã­ï¼`);
                createParticle('âœ¨', '#a584c7', window.innerWidth / 2, window.innerHeight / 2);
            }
            
            // 100ã‚¯ãƒªãƒƒã‚¯ã”ã¨ã«ç‰¹åˆ¥ãªåŠ¹æœ
            if (clickStats.total % 100 === 0) {
                soundSystem.playSuccess();
                showNotification(`ğŸ† ${clickStats.total}å›ã‚¯ãƒªãƒƒã‚¯è¨˜å¿µï¼ç´ æ™´ã‚‰ã—ã„ç¶™ç¶šåŠ›ã§ã™ï¼`);
                createParticle('ğŸ†', '#f4a261', window.innerWidth / 2, window.innerHeight / 2);
                createParticle('ğŸŠ', '#7fb069', window.innerWidth / 2 - 50, window.innerHeight / 2 - 30);
                createParticle('âœ¨', '#6bb6ff', window.innerWidth / 2 + 50, window.innerHeight / 2 - 30);
            }
            
            return true; // å¸¸ã«trueã‚’è¿”ã™ï¼ˆåˆ¶é™ãªã—ï¼‰
        }

        function updateClickDisplays() {
            const today = getTodayDateString();
            const yesterday = getYesterdayDateString();
            const weekDates = getWeekDates();
            
            // ä»Šæ—¥ã®ã‚¯ãƒªãƒƒã‚¯æ•°
            const todayClicks = clickStats.daily[today] || 0;
            
            // æ˜¨æ—¥ã®ã‚¯ãƒªãƒƒã‚¯æ•°
            const yesterdayClicks = clickStats.daily[yesterday] || 0;
            
            // éå»1é€±é–“ã®ã‚¯ãƒªãƒƒã‚¯æ•°
            const weekClicks = weekDates.reduce((sum, date) => {
                return sum + (clickStats.daily[date] || 0);
            }, 0);
            
            // è¡¨ç¤ºæ›´æ–°
            const todayDisplay = document.getElementById('todayClickDisplay');
            const yesterdayDisplay = document.getElementById('yesterdayClickDisplay');
            const weekDisplay = document.getElementById('weekClickDisplay');
            const totalDisplay = document.getElementById('totalClickDisplay');
            const sessionDisplay = document.getElementById('clickCount');
            
            if (todayDisplay) todayDisplay.textContent = todayClicks;
            if (yesterdayDisplay) yesterdayDisplay.textContent = yesterdayClicks;
            if (weekDisplay) weekDisplay.textContent = weekClicks;
            if (totalDisplay) totalDisplay.textContent = clickStats.total;
            if (sessionDisplay) sessionDisplay.textContent = sessionClickCount;
        }

        function saveClickStats() {
            try {
                localStorage.setItem('oneWorldQuizClickStats', JSON.stringify(clickStats));
            } catch (e) {
                console.log('ã‚¯ãƒªãƒƒã‚¯çµ±è¨ˆã®ä¿å­˜ã«å¤±æ•—ã—ã¾ã—ãŸ');
            }
        }

        function loadClickStats() {
            try {
                const saved = localStorage.getItem('oneWorldQuizClickStats');
                if (saved) {
                    clickStats = JSON.parse(saved);
                    updateClickDisplays();
                }
            } catch (e) {
                console.log('ã‚¯ãƒªãƒƒã‚¯çµ±è¨ˆã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸ');
                clickStats = { total: 0, daily: {} };
            }
        }

        /* ----------------- ã‚¨ãƒ•ã‚§ã‚¯ãƒˆé–¢æ•° ----------------- */
        function createParticle(text, color, x, y) {
            const particle = document.createElement('div');
            particle.className = 'particle';
            particle.textContent = text;
            particle.style.color = color;
            particle.style.left = (x + particleOffset) + 'px';
            particle.style.top = (y + particleOffset) + 'px';
            particle.style.fontSize = '20px';
            document.body.appendChild(particle);

            particleOffset += 40;
            if (particleOffset > 160) particleOffset = 0;

            setTimeout(() => {
                if (particle.parentNode) {
                    particle.parentNode.removeChild(particle);
                }
            }, 2500);
        }

        function showNotification(text) {
            const notification = document.getElementById('notification');
            const notificationText = document.getElementById('notificationText');
            notificationText.textContent = text;
            notification.classList.add('show');
            setTimeout(() => {
                notification.classList.remove('show');
            }, 3500);
        }

        /* ----------------- ã‚¿ã‚¤ãƒãƒ¼é–¢æ•° ----------------- */
        function setTimerLimit(seconds) {
            timerLimit = seconds;
            
            document.getElementById('timer3Btn').classList.remove('active');
            document.getElementById('timer5Btn').classList.remove('active');
            document.getElementById('timer10Btn').classList.remove('active');
            
            if (seconds === 3) {
                document.getElementById('timer3Btn').classList.add('active');
                document.getElementById('timerDescription').textContent = '3ç§’ã§åˆ¶é™æ™‚é–“åˆ‡ã‚Œï¼ãƒ‰ã‚­ãƒ‰ã‚­ãƒãƒ£ãƒ¬ãƒ³ã‚¸';
                showNotification('âš¡ 3ç§’ãƒãƒ£ãƒ¬ãƒ³ã‚¸ï¼è¶…é«˜é€Ÿãƒ¢ãƒ¼ãƒ‰ã§ã™');
            } else if (seconds === 5) {
                document.getElementById('timer5Btn').classList.add('active');
                document.getElementById('timerDescription').textContent = '5ç§’ã§è€ƒãˆã‚‹ï¼é©åº¦ã«ãƒ‰ã‚­ãƒ‰ã‚­';
                showNotification('ğŸ”¥ 5ç§’ãƒãƒ£ãƒ¬ãƒ³ã‚¸ï¼ã„ã„æ„Ÿã˜ã®ç·Šå¼µæ„Ÿ');
            } else {
                document.getElementById('timer10Btn').classList.add('active');
                document.getElementById('timerDescription').textContent = '10ç§’ã§ã˜ã£ãã‚Šè€ƒãˆã‚ˆã†';
                showNotification('ğŸŒŸ 10ç§’ãƒãƒ£ãƒ¬ãƒ³ã‚¸ï¼ã˜ã£ãã‚Šè€ƒãˆã‚‰ã‚Œã¾ã™');
            }
        }

        function startTimer() {
            if (isTimerRunning) return;
            
            isTimerRunning = true;
            isQuizAnswered = false;
            currentTimerValue = timerLimit;
            
            const timerDisplay = document.getElementById('timerDisplay');
            const timerValueEl = document.getElementById('timerValue');
            
            // åˆæœŸè¡¨ç¤º
            timerValueEl.textContent = currentTimerValue;
            updateTimerStyle();
            
            timerInterval = setInterval(() => {
                currentTimerValue--;
                timerValueEl.textContent = currentTimerValue;
                updateTimerStyle();
                
                // æœ€å¾Œã®3ç§’é–“ã¯ãƒãƒƒã‚¯éŸ³
                if (currentTimerValue <= 3 && currentTimerValue > 0) {
                    soundSystem.playTick();
                }
                
                if (currentTimerValue <= 0) {
                    stopTimer();
                    timeUp();
                }
            }, 1000);
        }

        function stopTimer() {
            if (timerInterval) {
                clearInterval(timerInterval);
                timerInterval = null;
            }
            isTimerRunning = false;
        }

        function updateTimerStyle() {
            const timerDisplay = document.getElementById('timerDisplay');
            const percentage = currentTimerValue / timerLimit;
            
            timerDisplay.classList.remove('timer-normal', 'timer-warning', 'timer-danger');
            
            if (percentage > 0.6) {
                timerDisplay.classList.add('timer-normal');
            } else if (percentage > 0.3) {
                timerDisplay.classList.add('timer-warning');
            } else {
                timerDisplay.classList.add('timer-danger');
            }
        }

        function timeUp() {
            if (isQuizAnswered) return;
            
            soundSystem.playTimeUp();
            showNotification('â° æ™‚é–“åˆ‡ã‚Œï¼è§£ç­”ã‚’è¡¨ç¤ºã—ã¾ã™');
            showAnswerForced();
        }

        function showAnswerForced() {
            if (isQuizAnswered) return;
            
            isQuizAnswered = true;
            studyCount++; // å­¦ç¿’å›æ•°ã‚’ã‚«ã‚¦ãƒ³ãƒˆ
            updateStats();
            
            showAnswerContent();
            
            // ãƒœã‚¿ãƒ³ã‚’æœ‰åŠ¹åŒ–
            document.getElementById('quizNext').disabled = false;
            document.getElementById('showAnswerBtn').disabled = true;
            document.getElementById('showAnswerBtn').textContent = 'â° æ™‚é–“åˆ‡ã‚Œ';
            
            createParticle('â° æ™‚é–“åˆ‡ã‚Œ', '#f9b6a3', window.innerWidth / 2, window.innerHeight / 2);
        }

        /* ----------------- ç”»é¢é·ç§»é–¢æ•° ----------------- */
        function hideAllModals() {
            document.querySelectorAll('.modal').forEach(modal => {
                modal.classList.remove('show');
            });
        }

        function goBackToMain() {
            hideAllModals();
            document.getElementById('mainGradeModal').classList.add('show');
            soundSystem.playClick();
        }

        function goBackToGrade(grade) {
            hideAllModals();
            document.getElementById(`${grade}Modal`).classList.add('show');
            soundSystem.playClick();
        }

        /* ----------------- ãƒ¬ãƒƒã‚¹ãƒ³é¸æŠæ©Ÿèƒ½ï¼ˆå˜ä¸€ãƒ»è¤‡æ•°ä¸¡æ–¹å¯¾å¿œï¼‰ ----------------- */
        function handleLessonClick(grade, lesson, buttonElement, event) {
            incrementClickCount();
            soundSystem.playClick();
            
            // å³ã‚¯ãƒªãƒƒã‚¯ã¾ãŸã¯Ctrl+ã‚¯ãƒªãƒƒã‚¯ã®å ´åˆã¯è¤‡æ•°é¸æŠãƒ¢ãƒ¼ãƒ‰
            if (event.button === 2 || event.ctrlKey) {
                event.preventDefault();
                toggleLessonSelection(grade, lesson, buttonElement);
            } else {
                // å·¦ã‚¯ãƒªãƒƒã‚¯ã®å ´åˆã¯å˜ä¸€é¸æŠãƒ¢ãƒ¼ãƒ‰ï¼ˆæ–‡æ³•é …ç›®é¸æŠç”»é¢ã¸ï¼‰
                openGrammarSelection(grade, lesson);
            }
        }

        function toggleLessonSelection(grade, lesson, buttonElement) {
            const gradeNumber = grade.replace('grade', '');
            const lessonKey = `${grade}_${lesson.id}`;
            
            if (selectedLessons.includes(lessonKey)) {
                selectedLessons = selectedLessons.filter(key => key !== lessonKey);
                buttonElement.classList.remove('active');
            } else {
                selectedLessons.push(lessonKey);
                buttonElement.classList.add('active');
            }
            
            updateSelectedLessonsDisplay(grade);
        }

        function updateSelectedLessonsDisplay(grade) {
            const gradeNumber = grade.replace('grade', '');
            const displayEl = document.getElementById(`selectedLessonsDisplay${gradeNumber}`);
            const countEl = document.getElementById(`selectedLessonsCount${gradeNumber}`);
            const listEl = document.getElementById(`selectedLessonsList${gradeNumber}`);
            const startBtn = document.getElementById(`startMultipleLessons${gradeNumber}`);
            
            const gradeLessons = selectedLessons.filter(key => key.startsWith(grade));
            
            if (gradeLessons.length > 0) {
                displayEl.classList.remove('hidden');
                startBtn.classList.remove('hidden');
                startBtn.disabled = false;
                
                countEl.textContent = `${gradeLessons.length}å€‹ã®ãƒ¬ãƒƒã‚¹ãƒ³ã‚’é¸æŠä¸­`;
                
                const lessonNames = gradeLessons.map(key => {
                    const lessonId = key.split('_')[2];
                    const lesson = lessons[grade].find(l => l.id === lessonId);
                    return lesson ? lesson.name : lessonId;
                });
                
                listEl.textContent = lessonNames.join('ã€');
            } else {
                displayEl.classList.add('hidden');
                startBtn.classList.add('hidden');
                startBtn.disabled = true;
            }
        }

        function startMultipleLessonsQuiz(grade) {
            incrementClickCount();
            soundSystem.playSuccess();
            
            hideAllModals();
            
            const gradeNames = {
                'grade1': 'ğŸŒ± ä¸­å­¦1å¹´ç”Ÿ',
                'grade2': 'ğŸŒ¿ ä¸­å­¦2å¹´ç”Ÿ',
                'grade3': 'ğŸŒ³ ä¸­å­¦3å¹´ç”Ÿ'
            };
            
            const gradeLessons = selectedLessons.filter(key => key.startsWith(grade));
            
            // é¸æŠã•ã‚ŒãŸå…¨ãƒ¬ãƒƒã‚¹ãƒ³ã®æ–‡æ³•é …ç›®ã‚’è‡ªå‹•çš„ã«è¿½åŠ 
            selectedGrammarItems = [];
            gradeLessons.forEach(lessonKey => {
                const lessonId = lessonKey.split('_')[2];
                const lesson = lessons[grade].find(l => l.id === lessonId);
                if (lesson) {
                    lesson.grammar.forEach(grammarItem => {
                        selectedGrammarItems.push(grammarItem.id);
                    });
                }
            });
            
            currentGrade = grade;
            currentLesson = 'multiple'; // è¤‡æ•°ãƒ¬ãƒƒã‚¹ãƒ³ã®è­˜åˆ¥
            
            document.getElementById('currentCategory').textContent = 
                `${gradeNames[grade]} - ${gradeLessons.length}å€‹ã®ãƒ¬ãƒƒã‚¹ãƒ³ã‚’æ¨ªæ–­å­¦ç¿’`;
            document.getElementById('gameScreen').classList.remove('hidden');
            
            // ãƒ•ãƒ­ãƒ¼ãƒ†ã‚£ãƒ³ã‚°ãƒœã‚¿ãƒ³ã‚’è¡¨ç¤º
            const floatingBtn = document.getElementById('changeSubject');
            floatingBtn.classList.remove('hidden');
            floatingBtn.style.display = 'flex';

            // çµ±è¨ˆã‚’ãƒªã‚»ãƒƒãƒˆ
            studyCount = 0;
            sessionClickCount = 0;
            usedQuestions = [];
            sequentialIndex = 0;
            updateStats();
            showNotification(`ğŸ¯ ${gradeLessons.length}å€‹ã®ãƒ¬ãƒƒã‚¹ãƒ³ã§å­¦ç¿’ã‚¹ã‚¿ãƒ¼ãƒˆï¼`);
        }

        /* ----------------- ãƒ¬ãƒƒã‚¹ãƒ³ãƒ»æ–‡æ³•é …ç›®ã®åˆæœŸåŒ– ----------------- */
        function initLessonsAndGrammar() {
            // å„å­¦å¹´ã®ãƒ¬ãƒƒã‚¹ãƒ³ã‚’åˆæœŸåŒ–
            ['grade1', 'grade2', 'grade3'].forEach(grade => {
                const container = document.getElementById(`${grade}Lessons`);
                lessons[grade].forEach(lesson => {
                    const btn = document.createElement('button');
                    btn.className = 'lesson-btn';
                    btn.innerHTML = lesson.name;
                    btn.dataset.lessonId = lesson.id;
                    
                    // å·¦ã‚¯ãƒªãƒƒã‚¯ã¨å³ã‚¯ãƒªãƒƒã‚¯ã®ä¸¡æ–¹ã«å¯¾å¿œ
                    btn.onclick = (e) => handleLessonClick(grade, lesson, btn, e);
                    btn.oncontextmenu = (e) => {
                        e.preventDefault();
                        handleLessonClick(grade, lesson, btn, e);
                    };
                    
                    container.appendChild(btn);
                });
            });
        }

        function openGrammarSelection(grade, lesson) {
            currentGrade = grade;
            currentLesson = lesson.id;
            selectedGrammarItems = [];
            
            hideAllModals();
            
            const modal = document.getElementById('grammarModal');
            const title = document.getElementById('grammarModalTitle');
            const container = document.getElementById('grammarCategories');
            const backButton = document.getElementById('grammarBackButton');
            const startButton = document.getElementById('startGrammarQuiz');
            
            // ã‚¿ã‚¤ãƒˆãƒ«è¨­å®š
            const gradeNames = {
                'grade1': 'ğŸŒ± ä¸­å­¦1å¹´ç”Ÿ',
                'grade2': 'ğŸŒ¿ ä¸­å­¦2å¹´ç”Ÿ',
                'grade3': 'ğŸŒ³ ä¸­å­¦3å¹´ç”Ÿ'
            };
            title.textContent = `${gradeNames[grade]} - ${lesson.name}`;
            
            // æ–‡æ³•é …ç›®ãƒœã‚¿ãƒ³ç”Ÿæˆ
            container.innerHTML = '';
            lesson.grammar.forEach(grammarItem => {
                const btn = document.createElement('button');
                btn.className = 'grammar-btn';
                btn.innerHTML = grammarItem.name;
                btn.dataset.grammarId = grammarItem.id;
                btn.onclick = () => toggleGrammarSelection(grammarItem.id, btn);
                container.appendChild(btn);
            });
            
            // æˆ»ã‚‹ãƒœã‚¿ãƒ³ã®è¨­å®š
            backButton.onclick = () => goBackToGrade(grade);
            
            // é–‹å§‹ãƒœã‚¿ãƒ³ã®åˆæœŸçŠ¶æ…‹
            startButton.disabled = true;
            
            modal.classList.add('show');
        }

        function toggleGrammarSelection(grammarId, buttonElement) {
            incrementClickCount();
            soundSystem.playClick();
            if (selectedGrammarItems.includes(grammarId)) {
                selectedGrammarItems = selectedGrammarItems.filter(id => id !== grammarId);
                buttonElement.classList.remove('active');
            } else {
                selectedGrammarItems.push(grammarId);
                buttonElement.classList.add('active');
            }

            // é–‹å§‹ãƒœã‚¿ãƒ³ã®çŠ¶æ…‹ã‚’æ›´æ–°
            const startButton = document.getElementById('startGrammarQuiz');
            startButton.disabled = selectedGrammarItems.length === 0;
        }

        function startSelectedQuiz() {
            hideAllModals();
            
            const gradeNames = {
                'grade1': 'ğŸŒ± ä¸­å­¦1å¹´ç”Ÿ',
                'grade2': 'ğŸŒ¿ ä¸­å­¦2å¹´ç”Ÿ',
                'grade3': 'ğŸŒ³ ä¸­å­¦3å¹´ç”Ÿ'
            };
            
            const lessonName = lessons[currentGrade].find(l => l.id === currentLesson).name;
            document.getElementById('currentCategory').textContent = `${gradeNames[currentGrade]} - ${lessonName} (${selectedGrammarItems.length}é …ç›®é¸æŠ)`;
            document.getElementById('gameScreen').classList.remove('hidden');
            
            // ãƒ•ãƒ­ãƒ¼ãƒ†ã‚£ãƒ³ã‚°ãƒœã‚¿ãƒ³ã‚’è¡¨ç¤º
            const floatingBtn = document.getElementById('changeSubject');
            floatingBtn.classList.remove('hidden');
            floatingBtn.style.display = 'flex';

            // çµ±è¨ˆã‚’ãƒªã‚»ãƒƒãƒˆ
            studyCount = 0;
            sessionClickCount = 0;
            usedQuestions = [];
            sequentialIndex = 0;
            updateStats();
            showNotification(`ğŸ¯ ${selectedGrammarItems.length}é …ç›®ã‚’é¸æŠã—ã¾ã—ãŸï¼å­¦ç¿’ã‚¹ã‚¿ãƒ¼ãƒˆï¼`);
        }

        function updateStats() {
            document.getElementById('studyCount').textContent = studyCount;
            document.getElementById('clickCount').textContent = sessionClickCount;
        }

        function setQuestionMode(mode) {
            questionMode = mode;
            
            document.getElementById('randomModeBtn').classList.remove('active');
            document.getElementById('sequentialModeBtn').classList.remove('active');
            
            if (mode === 'random') {
                document.getElementById('randomModeBtn').classList.add('active');
                document.getElementById('modeDescription').textContent = 'å•é¡Œã‚’ãƒ©ãƒ³ãƒ€ãƒ ã«ã‚·ãƒ£ãƒƒãƒ•ãƒ«ã—ã¦å‡ºé¡Œã—ã¾ã™';
                usedQuestions = [];
                showNotification('ğŸ² ãƒ©ãƒ³ãƒ€ãƒ ãƒ¢ãƒ¼ãƒ‰ã«åˆ‡ã‚Šæ›¿ã‚ã‚Šã¾ã—ãŸï¼');
            } else {
                document.getElementById('sequentialModeBtn').classList.add('active');
                document.getElementById('modeDescription').textContent = 'å•é¡Œã‚’é †ç•ªé€šã‚Šã«å­¦ç¿’ã§ãã¾ã™';
                sequentialIndex = 0;
                showNotification('ğŸ“– é †ç•ªå­¦ç¿’ãƒ¢ãƒ¼ãƒ‰ã«åˆ‡ã‚Šæ›¿ã‚ã‚Šã¾ã—ãŸï¼');
            }
        }

        function setQuestionDirection(direction) {
            questionDirection = direction;
            
            document.getElementById('jpToEnBtn').classList.remove('active');
            document.getElementById('enToJpBtn').classList.remove('active');
            document.getElementById('mixedBtn').classList.remove('active');
            
            if (direction === 'jp_to_en') {
                document.getElementById('jpToEnBtn').classList.add('active');
                document.getElementById('directionDescription').textContent = 'æ—¥æœ¬èªã‚’è‹±èªã«å¤‰æ›ã™ã‚‹å•é¡Œ';
                showNotification('ğŸ‡¯ğŸ‡µâ†’ğŸ‡ºğŸ‡¸ æ—¥æœ¬èªâ†’è‹±èªãƒ¢ãƒ¼ãƒ‰ã«è¨­å®šã—ã¾ã—ãŸï¼');
            } else if (direction === 'en_to_jp') {
                document.getElementById('enToJpBtn').classList.add('active');
                document.getElementById('directionDescription').textContent = 'è‹±èªã‚’æ—¥æœ¬èªã«å¤‰æ›ã™ã‚‹å•é¡Œ';
                showNotification('ğŸ‡ºğŸ‡¸â†’ğŸ‡¯ğŸ‡µ è‹±èªâ†’æ—¥æœ¬èªãƒ¢ãƒ¼ãƒ‰ã«è¨­å®šã—ã¾ã—ãŸï¼');
            } else {
                document.getElementById('mixedBtn').classList.add('active');
                document.getElementById('directionDescription').textContent = 'æ—¥æœ¬èªâ†’è‹±èªã€è‹±èªâ†’æ—¥æœ¬èªã‚’ãƒ©ãƒ³ãƒ€ãƒ ã«å‡ºé¡Œ';
                showNotification('ğŸ”€ ãƒŸãƒƒã‚¯ã‚¹ãƒ¢ãƒ¼ãƒ‰ã§æŒ‘æˆ¦ã—ã¾ã—ã‚‡ã†ï¼');
            }
        }

        /* ----------------- ã‚¯ã‚¤ã‚ºæ©Ÿèƒ½ ----------------- */
        function openQuiz() {
            if (selectedGrammarItems.length === 0) {
                showNotification('ğŸ“š æ–‡æ³•é …ç›®ã‚’é¸æŠã—ã¦ãã ã•ã„');
                return;
            }

            // ãƒ‡ãƒ¢ç”¨ã®å•é¡Œãƒ‡ãƒ¼ã‚¿ï¼ˆproblems.jsãŒèª­ã¿è¾¼ã¾ã‚Œã¦ã„ãªã„å ´åˆï¼‰
            const demoData = [
                { 
                    q: "ç§ã¯éŸ³æ¥½ãŒå¥½ãã§ã™ã€‚", 
                    ans: "I like music.", 
                    exp: "è‹±èªã§ã¯ï¼ˆä¸»èª + å‹•è© + ç›®çš„èªï¼‰ã®èªé †ã«ãªã‚Šã¾ã™ã€‚\n\nãƒ»ã€Œç§ã¯ã€â†’ I\nãƒ»ã€Œå¥½ãã§ã™ã€â†’ like\nãƒ»ã€ŒéŸ³æ¥½ã‚’ã€â†’ music\n\nã“ã®åŸºæœ¬çš„ãªèªé †ã¯è‹±èªå­¦ç¿’ã®åŸºç¤ã¨ãªã‚Šã¾ã™ã€‚æ—¥æœ¬èªã§ã¯ã€Œç§ã¯éŸ³æ¥½ãŒå¥½ãã§ã™ã€ã¨è¨€ã„ã¾ã™ãŒã€è‹±èªã§ã¯ã€ŒI like musicã€ã¨ç›®çš„èªãŒå‹•è©ã®å¾Œã«æ¥ã‚‹ã“ã¨ã«æ³¨æ„ã—ã¾ã—ã‚‡ã†ã€‚"
                },
                { 
                    q: "å½¼ã¯å…ˆç”Ÿã§ã™ã€‚", 
                    ans: "He is a teacher.", 
                    exp: "beå‹•è©ã‚’ä½¿ã£ãŸåŸºæœ¬çš„ãªæ–‡ã§ã™ã€‚\n\nãƒ»ã€Œå½¼ã¯ã€â†’ He\nãƒ»ã€Œã§ã™ã€â†’ isï¼ˆbeå‹•è©ã®ä¸‰äººç§°å˜æ•°å½¢ï¼‰\nãƒ»ã€Œå…ˆç”Ÿã€â†’ a teacher\n\nè·æ¥­ã‚’è¡¨ã™ã¨ãã¯ã€é€šå¸¸ã€Œaã€ã‚„ã€Œanã€ã‚’ã¤ã‘ã¾ã™ã€‚He is teacher ã§ã¯ãªã He is a teacher ãŒæ­£ã—ã„è¡¨ç¾ã§ã™ã€‚"
                },
                { 
                    q: "ã“ã‚Œã¯ç§ã®æœ¬ã§ã™ã€‚", 
                    ans: "This is my book.", 
                    exp: "æŒ‡ç¤ºä»£åè©ã¨æ‰€æœ‰æ ¼ã‚’ä½¿ã£ãŸæ–‡ã§ã™ã€‚\n\nãƒ»ã€Œã“ã‚Œã¯ã€â†’ This is\nãƒ»ã€Œç§ã®ã€â†’ myï¼ˆæ‰€æœ‰æ ¼ï¼‰\nãƒ»ã€Œæœ¬ã€â†’ book\n\næ‰€æœ‰æ ¼ã®ä½¿ã„æ–¹ï¼š\n- I â†’ my\n- you â†’ your\n- he â†’ his\n- she â†’ her\n\nã“ã®ã‚ˆã†ãªåŸºæœ¬çš„ãªæ‰€æœ‰æ ¼ã‚’ã—ã£ã‹ã‚Šè¦šãˆã¾ã—ã‚‡ã†ã€‚"
                }
            ];

            // å•é¡Œãƒ‡ãƒ¼ã‚¿ã®å–å¾—
            let allProblems = [];
            
            if (typeof problemDatabase !== 'undefined') {
                // problems.jsãŒèª­ã¿è¾¼ã¾ã‚Œã¦ã„ã‚‹å ´åˆ
                selectedGrammarItems.forEach(grammarId => {
                    let fullId;
                    if (currentLesson === 'multiple') {
                        // è¤‡æ•°ãƒ¬ãƒƒã‚¹ãƒ³ã®å ´åˆã¯ã€ã™ã¹ã¦ã®ãƒ¬ãƒƒã‚¹ãƒ³ã‹ã‚‰æ¤œç´¢
                        selectedLessons.forEach(lessonKey => {
                            const parts = lessonKey.split('_');
                            const grade = parts[0] + '_' + parts[1];
                            const lessonId = parts[2];
                            const searchId = `${grade}_${lessonId}_${grammarId}`;
                            if (problemDatabase[searchId]) {
                                allProblems = allProblems.concat(problemDatabase[searchId]);
                            }
                        });
                    } else {
                        fullId = `${currentGrade}_${currentLesson}_${grammarId}`;
                        if (problemDatabase[fullId]) {
                            allProblems = allProblems.concat(problemDatabase[fullId]);
                        }
                    }
                });
            }
            
            // ãƒ‡ãƒ¼ã‚¿ãŒãªã„å ´åˆã¯ãƒ‡ãƒ¢ãƒ‡ãƒ¼ã‚¿ã‚’ä½¿ç”¨
            if (allProblems.length === 0) {
                allProblems = demoData;
                showNotification('ğŸ”§ ãƒ‡ãƒ¢å•é¡Œã‚’è¡¨ç¤ºä¸­ã§ã™ï¼ˆproblems.jsã‚’èª­ã¿è¾¼ã‚“ã§ãã ã•ã„ï¼‰');
            }

            if (usedQuestions.length >= allProblems.length) {
                usedQuestions = [];
                showNotification('ğŸŠ å…¨å•ã‚¯ãƒªã‚¢ï¼å•é¡Œã‚’ãƒªã‚»ãƒƒãƒˆã—ã¾ã—ãŸ');
            }

            // å‡ºé¡Œå½¢å¼ã«å¿œã˜ãŸå•é¡Œé¸æŠ
            let quiz;
            let remainingCount;
            
            if (questionMode === 'random') {
                const availableQuestions = allProblems.filter((_, index) => !usedQuestions.includes(index));
                if (availableQuestions.length === 0) return;
                
                const randomIndex = Math.floor(Math.random() * availableQuestions.length);
                quiz = availableQuestions[randomIndex];
                const originalIndex = allProblems.indexOf(quiz);
                usedQuestions.push(originalIndex);
                remainingCount = allProblems.length - usedQuestions.length;
            } else {
                if (sequentialIndex >= allProblems.length) {
                    sequentialIndex = 0;
                    showNotification('ğŸ”„ å…¨å•é¡Œã‚’ä¸€å‘¨ã—ã¾ã—ãŸï¼æœ€åˆã‹ã‚‰å†é–‹ã—ã¾ã™');
                }
                quiz = allProblems[sequentialIndex];
                sequentialIndex++;
                remainingCount = allProblems.length - sequentialIndex;
                if (remainingCount < 0) remainingCount = 0;
            }

            // å‡ºé¡Œæ–¹å‘ã«å¿œã˜ã¦å•é¡Œã‚’èª¿æ•´
            let actualQuiz = quiz;
            if (questionDirection === 'en_to_jp' && quiz.reverse) {
                actualQuiz = quiz.reverse;
            } else if (questionDirection === 'mixed') {
                if (Math.random() < 0.5 && quiz.reverse) {
                    actualQuiz = quiz.reverse;
                }
            }

            displayQuiz(actualQuiz, remainingCount);
        }

        function displayQuiz(quiz, remainingCount) {
            const modal = document.getElementById('quizModal');
            const questionEl = document.getElementById('quizQuestion');
            const remainingEl = document.getElementById('remainingCount');
            const timerValueEl = document.getElementById('timerValue');
            const showAnswerBtn = document.getElementById('showAnswerBtn');
            const answerDisplayEl = document.getElementById('answerDisplay');
            const answerContentEl = document.getElementById('answerContent');
            const nextBtn = document.getElementById('quizNext');
            const backBtn = document.getElementById('quizBack');

            // å•é¡Œè¡¨ç¤ºï¼ˆéŸ³å£°ãƒœã‚¿ãƒ³ä»˜ãï¼‰
            questionEl.innerHTML = '';
            if (typeof quiz.q === 'string') {
                const questionWrapper = addSpeakButton(quiz.q, document.createElement('span'));
                if (questionWrapper.nodeType === Node.ELEMENT_NODE) {
                    questionEl.appendChild(questionWrapper);
                } else {
                questionEl.textContent = quiz.q || '';
            }
            
            remainingEl.textContent = `æ®‹ã‚Š${remainingCount}å•`;

            // ã‚¿ã‚¤ãƒãƒ¼åˆæœŸåŒ–
            timerValueEl.textContent = timerLimit;
            document.getElementById('timerDisplay').classList.remove('timer-warning', 'timer-danger');
            document.getElementById('timerDisplay').classList.add('timer-normal');

            // ãƒœã‚¿ãƒ³ã®åˆæœŸçŠ¶æ…‹
            showAnswerBtn.disabled = false;
            showAnswerBtn.textContent = 'ğŸ’¡ è§£ç­”ã‚’è¦‹ã‚‹';
            nextBtn.disabled = true;
            
            // è§£ç­”è¡¨ç¤ºã‚¨ãƒªã‚¢ã®åˆæœŸåŒ–
            answerDisplayEl.classList.remove('show');
            answerContentEl.innerHTML = '<div class="text-gray-500" style="text-align: center;">é ­ã§è€ƒãˆã¦ã‹ã‚‰è§£ç­”ãƒœã‚¿ãƒ³ã‚’æŠ¼ã—ã¦ã­ï¼</div>';

            // ç¾åœ¨ã®ã‚¯ã‚¤ã‚ºãƒ‡ãƒ¼ã‚¿ã‚’ä¿å­˜
            modal.currentQuiz = quiz;

            // ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼è¨­å®š
            showAnswerBtn.onclick = () => showAnswer();
            nextBtn.onclick = () => {
                incrementClickCount();
                soundSystem.playClick();
                stopTimer();
                openQuiz(); // æ–°ã—ã„å•é¡Œã‚’è¡¨ç¤º
            };
            backBtn.onclick = () => {
                incrementClickCount();
                soundSystem.playClick();
                stopTimer();
                modal.classList.remove('show');
                showNotification('ğŸ  ãŠç–²ã‚Œã•ã¾ã§ã—ãŸï¼ã¾ãŸæŒ‘æˆ¦ã—ã¦ãã ã•ã„ã­');
            };

            // ãƒ¢ãƒ¼ãƒ€ãƒ«è¡¨ç¤º
            modal.classList.add('show');
            
            // å°‘ã—é…ã‚Œã¦ã‚¿ã‚¤ãƒãƒ¼ã‚’é–‹å§‹ï¼ˆãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒå•é¡Œã‚’èª­ã‚€æ™‚é–“ã‚’ä½œã‚‹ï¼‰
            setTimeout(() => {
                startTimer();
            }, 500);
        }

        function showAnswer() {
            if (isQuizAnswered) return;
            incrementClickCount();
            
            soundSystem.playClick();
            soundSystem.playStudyComplete(); // å­¦ç¿’å®Œäº†éŸ³
            stopTimer();
            isQuizAnswered = true;
            
            // å­¦ç¿’å›æ•°ã‚’ã‚«ã‚¦ãƒ³ãƒˆ
            studyCount++;
            updateStats();
            
            showAnswerContent();
            
            // ãƒœã‚¿ãƒ³ã‚’æ›´æ–°
            document.getElementById('showAnswerBtn').disabled = true;
            document.getElementById('showAnswerBtn').textContent = 'ğŸ“– è§£ç­”æ¸ˆã¿';
            document.getElementById('quizNext').disabled = false;
            
            createParticle('ğŸ“š å­¦ç¿’å®Œäº†ï¼', '#7fb069', window.innerWidth / 2, window.innerHeight / 2);
        }

        function showAnswerContent() {
            const modal = document.getElementById('quizModal');
            const quiz = modal.currentQuiz;
            const answerDisplayEl = document.getElementById('answerDisplay');
            const answerContentEl = document.getElementById('answerContent');
            
            answerDisplayEl.classList.add('show');
            
            // è§£èª¬ã‚’æ”¹è¡Œã‚’è€ƒæ…®ã—ã¦è¡¨ç¤º
            const formattedExplanation = (quiz.exp || 'ãŒã‚“ã°ã‚Šã¾ã—ãŸï¼').replace(/\n/g, '<br>');
            
            // è§£ç­”ã«éŸ³å£°ãƒœã‚¿ãƒ³ã‚’è¿½åŠ 
            const answerWithButton = addSpeakButton(quiz.ans || '', document.createElement('div'));
            let answerHTML = '';
            
            if (answerWithButton.nodeType === Node.ELEMENT_NODE) {
                answerHTML = answerWithButton.outerHTML;
            } else {
                answerHTML = quiz.ans || '';
            }
            
            answerContentEl.innerHTML = `
                <div class="answer-text">${answerHTML}</div>
                <div class="explanation-text">${formattedExplanation}</div>
            `;
        }

        /* ----------------- ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼ ----------------- */
        function initEventListeners() {
            // å­¦å¹´é¸æŠ
            document.querySelectorAll('[data-grade]').forEach(btn => {
                btn.addEventListener('click', (e) => {
                    incrementClickCount();
                    soundSystem.playClick();
                    const grade = e.currentTarget.dataset.grade;
                    hideAllModals();
                    document.getElementById(grade + 'Modal').classList.add('show');
                });
            });

            // è¤‡æ•°ãƒ¬ãƒƒã‚¹ãƒ³é–‹å§‹ãƒœã‚¿ãƒ³
            document.getElementById('startMultipleLessons1').addEventListener('click', () => {
                startMultipleLessonsQuiz('grade1');
            });
            document.getElementById('startMultipleLessons2').addEventListener('click', () => {
                startMultipleLessonsQuiz('grade2');
            });
            document.getElementById('startMultipleLessons3').addEventListener('click', () => {
                startMultipleLessonsQuiz('grade3');
            });

            // æ–‡æ³•ã‚¯ã‚¤ã‚ºé–‹å§‹ãƒœã‚¿ãƒ³
            document.getElementById('startGrammarQuiz').addEventListener('click', () => {
                incrementClickCount();
                soundSystem.playSuccess();
                startSelectedQuiz();
            });

            // ãƒ¡ã‚¤ãƒ³ã‚¯ã‚¤ã‚ºã‚¹ã‚¿ãƒ¼ãƒˆãƒœã‚¿ãƒ³
            document.getElementById('startQuizButton').addEventListener('click', () => {
                incrementClickCount();
                soundSystem.playSuccess();
                openQuiz();
            });

            // ã‚¿ã‚¤ãƒãƒ¼è¨­å®šãƒœã‚¿ãƒ³
            document.getElementById('timer3Btn').addEventListener('click', () => {
                incrementClickCount();
                soundSystem.playClick();
                setTimerLimit(3);
            });
            
            document.getElementById('timer5Btn').addEventListener('click', () => {
                incrementClickCount();
                soundSystem.playClick();
                setTimerLimit(5);
            });
            
            document.getElementById('timer10Btn').addEventListener('click', () => {
                incrementClickCount();
                soundSystem.playClick();
                setTimerLimit(10);
            });

            // å‡ºé¡Œå½¢å¼åˆ‡ã‚Šæ›¿ãˆãƒœã‚¿ãƒ³
            document.getElementById('randomModeBtn').addEventListener('click', () => {
                incrementClickCount();
                soundSystem.playClick();
                setQuestionMode('random');
            });
            
            document.getElementById('sequentialModeBtn').addEventListener('click', () => {
                incrementClickCount();
                soundSystem.playClick();
                setQuestionMode('sequential');
            });

            // å‡ºé¡Œæ–¹å‘åˆ‡ã‚Šæ›¿ãˆãƒœã‚¿ãƒ³
            document.getElementById('jpToEnBtn').addEventListener('click', () => {
                incrementClickCount();
                soundSystem.playClick();
                setQuestionDirection('jp_to_en');
            });
            
            document.getElementById('enToJpBtn').addEventListener('click', () => {
                incrementClickCount();
                soundSystem.playClick();
                setQuestionDirection('en_to_jp');
            });
            
            document.getElementById('mixedBtn').addEventListener('click', () => {
                incrementClickCount();
                soundSystem.playClick();
                setQuestionDirection('mixed');
            });

            // æ•™ç§‘å¤‰æ›´ãƒœã‚¿ãƒ³
            document.getElementById('changeSubject').addEventListener('click', (e) => {
                e.preventDefault();
                e.stopPropagation();
                incrementClickCount();
                soundSystem.playClick();
                stopTimer();
                selectedGrammarItems = [];
                selectedLessons = [];
                sequentialIndex = 0;
                usedQuestions = [];
                document.getElementById('gameScreen').classList.add('hidden');
                document.getElementById('changeSubject').classList.add('hidden');
                goBackToMain();
            });

            // éŸ³å£°è¨­å®šãƒœã‚¿ãƒ³
            document.getElementById('voiceSettingsBtn').addEventListener('click', (e) => {
                e.preventDefault();
                e.stopPropagation();
                incrementClickCount();
                soundSystem.playClick();
                openVoiceSettings();
            });

            // éŸ³å£°ON/OFFåˆ‡ã‚Šæ›¿ãˆ
            document.getElementById('voiceEnabled').addEventListener('change', toggleVoiceEnabled);

            // éŸ³å£°ã‚ªãƒ—ã‚·ãƒ§ãƒ³é¸æŠ
            document.querySelectorAll('.voice-option').forEach(option => {
                option.addEventListener('click', () => {
                    const voiceName = option.dataset.voice;
                    previewVoice(voiceName);
                });
            });
        }

        function addClickCounterToAllButtons() {
            // åŸºæœ¬çš„ãªã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼ã§ã‚¯ãƒªãƒƒã‚¯æ¤œçŸ¥
            document.addEventListener('touchstart', (e) => {
                if (e.touches.length > 1) {
                    e.preventDefault();
                }
            }, { passive: false });
            
            document.addEventListener('gesturestart', (e) => {
                e.preventDefault();
            });
        }

        // ãƒšãƒ¼ã‚¸èª­ã¿è¾¼ã¿æ™‚ã®åˆæœŸåŒ–
        document.addEventListener('DOMContentLoaded', () => {
            loadClickStats(); // ä¿å­˜ã•ã‚ŒãŸã‚¯ãƒªãƒƒã‚¯çµ±è¨ˆã‚’èª­ã¿è¾¼ã¿
            initLessonsAndGrammar();
            initEventListeners();
            addClickCounterToAllButtons();
            
            document.getElementById('changeSubject').classList.add('hidden');
            
            document.body.style.webkitTouchCallout = 'none';
            document.body.style.webkitUserSelect = 'none';
            document.body.style.userSelect = 'none';

            // éŸ³å£°ã‚³ãƒ³ãƒ†ã‚­ã‚¹ãƒˆã®åˆæœŸåŒ–
            document.addEventListener('click', () => {
                if (soundSystem.audioContext && soundSystem.audioContext.state === 'suspended') {
                    soundSystem.audioContext.resume();
                }
            }, { once: true });
            
            // åˆå›è¡¨ç¤ºæ™‚ã®ç‰¹åˆ¥ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸
            if (clickStats.total === 0) {
                setTimeout(() => {
                    showNotification('ğŸŒŸ ã‚ˆã†ã“ãï¼å­¦ç¿’ã‚’é€²ã‚ã¦ã‚¯ãƒªãƒƒã‚¯æ•°ã‚’ç©ã¿é‡ã­ã¾ã—ã‚‡ã†ï¼');
                }, 1000);
            } else {
                setTimeout(() => {
                    showNotification('ğŸ¤ éŸ³å£°æ©Ÿèƒ½ãŒè¿½åŠ ã•ã‚Œã¾ã—ãŸï¼å³ä¸‹ã®ãƒã‚¤ã‚¯ãƒœã‚¿ãƒ³ã§è¨­å®šã§ãã¾ã™ã€‚');
                }, 1500);
            }
        });
    </script>
</body>
</html>