<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>üß™ Chemi Quiz - ËªΩÂø´„Å™ÂåñÂ≠¶Âºè„Ç≤„Éº„É† üß™</title>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=M+PLUS+Rounded+1c:wght@400;700&display=swap');
        
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            -webkit-user-select: none;
            -moz-user-select: none;
            -ms-user-select: none;
            user-select: none;
            -webkit-touch-callout: none;
            -webkit-tap-highlight-color: transparent;
        }
        
        :root {
            --primary-purple: #6b46c1;
            --light-purple: #a78bfa;
            --cream: #fef7ff;
            --white: #ffffff;
            --soft-pink: #fce7f3;
            --gold: #fbbf24;
            --green: #10b981;
            --blue: #3b82f6;
            --shadow: rgba(107,70,193,0.25);
            --neon-pink: #ff1493;
            --neon-blue: #00bfff;
            --neon-green: #00ff00;
        }
        
        body {
            font-family: 'M PLUS Rounded 1c', sans-serif;
            background: linear-gradient(135deg, #fef7ff 0%, #fce7f3 50%, #e0e7ff 100%);
            color: var(--primary-purple);
            font-weight: 700;
            min-height: 100vh;
            touch-action: manipulation;
            overflow: hidden;
            cursor: pointer;
            position: relative;
        }

        .kawaii-container {
            height: 100vh;
            display: flex;
            flex-direction: column;
            position: relative;
            overflow: hidden;
        }

        .header {
            text-align: center;
            padding: 15px;
            background: rgba(255,255,255,0.8);
            backdrop-filter: blur(10px);
            border-radius: 0 0 25px 25px;
            box-shadow: 0 5px 20px var(--shadow);
            z-index: 1000;
        }

        .game-title {
            font-size: clamp(1.5rem, 4vw, 2.2rem);
            background: linear-gradient(45deg, var(--primary-purple), var(--light-purple), var(--gold));
            background-size: 200% 200%;
            -webkit-background-clip: text;
            background-clip: text;
            -webkit-text-fill-color: transparent;
            animation: rainbow-shift 3s ease-in-out infinite;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        @keyframes rainbow-shift {
            0%, 100% { background-position: 0% 50%; }
            50% { background-position: 100% 50%; }
        }

        .game-title:hover {
            transform: scale(1.1);
            filter: drop-shadow(0 0 15px var(--neon-pink));
        }

        .chemistry-icon {
            display: inline-block;
            font-size: 1.5em;
            margin: 0 8px;
            cursor: pointer;
            transition: all 0.3s ease;
            animation: float-icon 2s ease-in-out infinite;
        }

        @keyframes float-icon {
            0%, 100% { transform: translateY(0px) rotate(0deg); }
            50% { transform: translateY(-5px) rotate(5deg); }
        }

        .chemistry-icon:hover {
            transform: scale(1.5) rotate(360deg);
            filter: drop-shadow(0 0 20px var(--neon-blue));
        }

        .score-area {
            display: flex;
            justify-content: space-around;
            margin: 10px 0;
            padding: 10px;
            background: rgba(255,255,255,0.6);
            border-radius: 20px;
            backdrop-filter: blur(10px);
        }

        .score-item {
            text-align: center;
            cursor: pointer;
            transition: all 0.3s ease;
            padding: 5px 10px;
            border-radius: 15px;
        }

        .score-item:hover {
            background: rgba(255,255,255,0.8);
            transform: scale(1.1);
        }

        .score-number {
            font-size: 1.5em;
            font-weight: 700;
            color: var(--primary-purple);
        }

        .score-label {
            font-size: 0.8em;
            color: var(--light-purple);
        }

        .game-area {
            flex: 1;
            position: relative;
            overflow: hidden;
            margin: 10px;
            border-radius: 25px;
            background: rgba(255,255,255,0.3);
            backdrop-filter: blur(15px);
            border: 3px solid rgba(255,255,255,0.5);
        }

        .question-display {
            position: absolute;
            top: 20px;
            left: 50%;
            transform: translateX(-50%);
            background: rgba(255,255,255,0.9);
            padding: 15px 25px;
            border-radius: 25px;
            box-shadow: 0 8px 25px var(--shadow);
            font-size: 1.2em;
            font-weight: 700;
            color: var(--primary-purple);
            z-index: 500;
            text-align: center;
            max-width: 90%;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .question-display:hover {
            background: rgba(255,255,255,1);
            transform: translateX(-50%) scale(1.05);
        }

        .answer-area {
            position: absolute;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%);
            background: rgba(255,255,255,0.95);
            padding: 15px 25px;
            border-radius: 25px;
            box-shadow: 0 8px 25px var(--shadow);
            min-height: 80px;
            min-width: 60%;
            max-width: 90%;
            z-index: 500;
            display: flex;
            align-items: center;
            justify-content: center;
            flex-wrap: wrap;
            gap: 8px;
            border: 3px dashed var(--light-purple);
            transition: all 0.3s ease;
        }

        .answer-area.drop-hover {
            border-color: var(--green);
            background: rgba(16, 185, 129, 0.1);
            transform: translateX(-50%) scale(1.05);
        }

        .answer-piece {
            background: linear-gradient(45deg, var(--blue), var(--light-purple));
            color: white;
            padding: 8px 15px;
            border-radius: 20px;
            font-weight: 700;
            box-shadow: 0 4px 12px rgba(0,0,0,0.2);
            cursor: pointer;
            transition: all 0.3s ease;
            animation: piece-appear 0.5s ease-out;
        }

        @keyframes piece-appear {
            0% { transform: scale(0) rotate(180deg); opacity: 0; }
            100% { transform: scale(1) rotate(0deg); opacity: 1; }
        }

        .answer-piece:hover {
            transform: scale(1.1);
            filter: brightness(1.2);
        }

        .atom-card {
            position: absolute;
            width: 70px;
            height: 70px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            font-size: 1.1em;
            cursor: grab;
            transition: all 0.3s ease;
            box-shadow: 0 8px 20px rgba(0,0,0,0.3);
            border: 4px solid rgba(255,255,255,0.3);
            backdrop-filter: blur(10px);
            color: white;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.5);
            user-select: none;
            z-index: 100;
        }

        .atom-card:hover {
            transform: scale(1.2);
            z-index: 200;
            box-shadow: 0 12px 30px rgba(0,0,0,0.4);
        }

        .atom-card:active {
            cursor: grabbing;
            transform: scale(1.3);
            z-index: 300;
        }

        .atom-card.dragging {
            z-index: 400;
            transform: scale(1.4);
            filter: brightness(1.3);
        }

        /* ÂÖÉÁ¥†Âà•„Ç´„É©„Éº„É™„É≥„Ç∞ */
        .atom-hydrogen { background: linear-gradient(135deg, #ff6b6b, #ff8e8e); }
        .atom-oxygen { background: linear-gradient(135deg, #4ecdc4, #44a08d); }
        .atom-carbon { background: linear-gradient(135deg, #45484d, #6c757d); }
        .atom-nitrogen { background: linear-gradient(135deg, #3498db, #2980b9); }
        .atom-chlorine { background: linear-gradient(135deg, #2ecc71, #27ae60); }
        .atom-sulfur { background: linear-gradient(135deg, #f39c12, #e67e22); }
        .atom-metal { background: linear-gradient(135deg, #95a5a6, #7f8c8d); }
        .atom-number { background: linear-gradient(135deg, #9b59b6, #8e44ad); }
        .atom-special { background: linear-gradient(135deg, #e74c3c, #c0392b); }
        .atom-ion { background: linear-gradient(135deg, #00d2ff, #3a7bd5); }

        .controls {
            position: absolute;
            top: 50%;
            right: 20px;
            transform: translateY(-50%);
            display: flex;
            flex-direction: column;
            gap: 15px;
            z-index: 600;
        }

        .control-btn {
            width: 60px;
            height: 60px;
            border-radius: 50%;
            border: none;
            color: white;
            font-size: 1.5em;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 6px 20px rgba(0,0,0,0.3);
            backdrop-filter: blur(10px);
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .btn-check { background: linear-gradient(135deg, var(--green), #059669); }
        .btn-clear { background: linear-gradient(135deg, #ef4444, #dc2626); }
        .btn-hint { background: linear-gradient(135deg, var(--gold), #f59e0b); }
        .btn-next { background: linear-gradient(135deg, var(--blue), #2563eb); }

        .control-btn:hover {
            transform: scale(1.2);
            box-shadow: 0 8px 25px rgba(0,0,0,0.4);
        }

        .control-btn:active {
            transform: scale(0.9);
        }

        .feedback {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: rgba(255,255,255,0.95);
            padding: 25px 35px;
            border-radius: 25px;
            font-size: 1.3em;
            font-weight: 700;
            text-align: center;
            box-shadow: 0 15px 35px rgba(0,0,0,0.3);
            z-index: 1000;
            backdrop-filter: blur(15px);
            opacity: 0;
            pointer-events: none;
            transition: all 0.5s ease;
        }

        .feedback.show {
            opacity: 1;
            pointer-events: auto;
            animation: feedback-bounce 0.6s ease-out;
        }

        @keyframes feedback-bounce {
            0% { transform: translate(-50%, -50%) scale(0.3); }
            50% { transform: translate(-50%, -50%) scale(1.1); }
            100% { transform: translate(-50%, -50%) scale(1); }
        }

        .feedback.correct {
            color: var(--green);
            border: 3px solid var(--green);
        }

        .feedback.incorrect {
            color: #ef4444;
            border: 3px solid #ef4444;
        }

        .kawaii-particle {
            position: absolute;
            pointer-events: none;
            font-size: 1.5em;
            z-index: 2000;
            animation: particle-float 2s ease-out forwards;
        }

        @keyframes particle-float {
            0% { 
                opacity: 1; 
                transform: scale(0) rotate(0deg); 
            }
            50% { 
                opacity: 1; 
                transform: scale(1.2) rotate(180deg); 
            }
            100% { 
                opacity: 0; 
                transform: scale(0.5) rotate(360deg) translateY(-150px); 
            }
        }

        .mode-selector {
            position: absolute;
            top: 20px;
            left: 20px;
            z-index: 600;
        }

        .mode-btn {
            background: rgba(255,255,255,0.8);
            border: 2px solid var(--light-purple);
            border-radius: 15px;
            padding: 10px 15px;
            margin-bottom: 10px;
            cursor: pointer;
            transition: all 0.3s ease;
            color: var(--primary-purple);
            font-weight: 700;
            backdrop-filter: blur(10px);
            display: block;
            width: 150px;
            text-align: center;
        }

        .mode-btn:hover {
            background: rgba(255,255,255,0.95);
            transform: scale(1.05);
        }

        .mode-btn.active {
            background: var(--light-purple);
            color: white;
            border-color: var(--primary-purple);
        }

        .celebration {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 3000;
        }

        .celebration.show {
            display: flex;
            animation: celebration-in 0.5s ease-out;
        }

        @keyframes celebration-in {
            0% { opacity: 0; }
            100% { opacity: 1; }
        }

        .celebration-content {
            background: white;
            padding: 40px;
            border-radius: 30px;
            text-align: center;
            box-shadow: 0 20px 50px rgba(0,0,0,0.3);
            animation: celebration-bounce 0.8s ease-out;
        }

        @keyframes celebration-bounce {
            0% { transform: scale(0.3); }
            50% { transform: scale(1.1); }
            100% { transform: scale(1); }
        }

        @media (max-width: 768px) {
            .atom-card {
                width: 60px;
                height: 60px;
                font-size: 1em;
            }

            .controls {
                right: 10px;
                gap: 10px;
            }

            .control-btn {
                width: 50px;
                height: 50px;
                font-size: 1.2em;
            }

            .mode-selector {
                left: 10px;
            }

            .mode-btn {
                width: 120px;
                padding: 8px 12px;
                font-size: 0.9em;
            }
        }

        /* ËªΩÈáèÁâ©ÁêÜÂäπÊûú */
        .sliding {
            transition: all 0.8s cubic-bezier(0.25, 0.46, 0.45, 0.94);
        }

        .bouncing {
            animation: bounce-effect 0.6s ease-out;
        }

        @keyframes bounce-effect {
            0%, 20%, 53%, 80%, 100% {
                transform: translate3d(0,0,0) scale(1);
            }
            40%, 43% {
                transform: translate3d(0,-30px,0) scale(1.1);
            }
            70% {
                transform: translate3d(0,-15px,0) scale(1.05);
            }
            90% {
                transform: translate3d(0,-4px,0) scale(1.02);
            }
        }

        .wall-bounce {
            animation: wall-bounce 0.3s ease-out;
        }

        @keyframes wall-bounce {
            0% { transform: scale(1); }
            50% { transform: scale(1.2); }
            100% { transform: scale(1); }
        }

        /* Kawaii effects */
        .sparkle-trail {
            position: absolute;
            width: 4px;
            height: 4px;
            background: var(--gold);
            border-radius: 50%;
            pointer-events: none;
            animation: sparkle-trail 1s ease-out forwards;
        }

        @keyframes sparkle-trail {
            0% { opacity: 1; transform: scale(1); }
            100% { opacity: 0; transform: scale(0); }
        }

        .hearts-rain {
            position: absolute;
            font-size: 1.2em;
            pointer-events: none;
            animation: hearts-fall 3s linear forwards;
        }

        @keyframes hearts-fall {
            0% { transform: translateY(-100px) rotate(0deg); opacity: 1; }
            100% { transform: translateY(150vh) rotate(360deg); opacity: 0; }
        }
    </style>
</head>
<body>
    <div class="kawaii-container">
        <!-- „Éò„ÉÉ„ÉÄ„Éº -->
        <div class="header">
            <h1 class="game-title" id="gameTitle">
                <span class="chemistry-icon" id="leftIcon">üß™</span>
                Chemi Quiz
                <span class="chemistry-icon" id="rightIcon">‚öóÔ∏è</span>
            </h1>
            <div class="score-area">
                <div class="score-item" id="correctScore">
                    <div class="score-number" id="correctCount">0</div>
                    <div class="score-label">Ê≠£Ëß£</div>
                </div>
                <div class="score-item" id="totalScore">
                    <div class="score-number" id="totalCount">0</div>
                    <div class="score-label">ÂïèÈ°åÊï∞</div>
                </div>
                <div class="score-item" id="comboScore">
                    <div class="score-number" id="comboCount">0</div>
                    <div class="score-label">„Ç≥„É≥„Éú</div>
                </div>
            </div>
        </div>

        <!-- „Ç≤„Éº„É†„Ç®„É™„Ç¢ -->
        <div class="game-area" id="gameArea">
            <!-- ÂïèÈ°åË°®Á§∫ -->
            <div class="question-display" id="questionDisplay">
                „Ç≤„Éº„É†„É¢„Éº„Éâ„ÇíÈÅ∏„Çì„Åß„Å≠ üíï
            </div>

            <!-- ÂõûÁ≠î„Ç®„É™„Ç¢ -->
            <div class="answer-area" id="answerArea">
                <div style="color: var(--light-purple);">„Åì„Åì„Å´ÂéüÂ≠ê„Ç´„Éº„Éâ„Çí„Éâ„É©„ÉÉ„Ç∞„Åó„Å¶„Å≠ ‚ú®</div>
            </div>

            <!-- „É¢„Éº„ÉâÈÅ∏Êäû -->
            <div class="mode-selector">
                <button class="mode-btn" data-mode="elements">üî¨ ÂÖÉÁ¥†Ë®òÂè∑</button>
                <button class="mode-btn" data-mode="compounds">‚öóÔ∏è ÂåñÂ≠¶Âºè</button>
                <button class="mode-btn" data-mode="reactions">üî• ÂåñÂ≠¶ÂèçÂøúÂºè</button>
                <button class="mode-btn" data-mode="ions">‚ö° „Ç§„Ç™„É≥</button>
            </div>

            <!-- „Ç≥„É≥„Éà„É≠„Éº„É´„Éú„Çø„É≥ -->
            <div class="controls">
                <button class="control-btn btn-check" id="checkBtn" title="Á≠î„Åà„Çí„ÉÅ„Çß„ÉÉ„ÇØ">‚úì</button>
                <button class="control-btn btn-clear" id="clearBtn" title="„ÇØ„É™„Ç¢">üóëÔ∏è</button>
                <button class="control-btn btn-hint" id="hintBtn" title="„Éí„É≥„Éà">üí°</button>
                <button class="control-btn btn-next" id="nextBtn" title="Ê¨°„ÅÆÂïèÈ°å">‚û°Ô∏è</button>
            </div>
        </div>

        <!-- „Éï„Ç£„Éº„Éâ„Éê„ÉÉ„ÇØ -->
        <div class="feedback" id="feedback"></div>

        <!-- ÊàêÂäüÊôÇ„ÅÆ„ÅäÁ•ù„ÅÑ -->
        <div class="celebration" id="celebration">
            <div class="celebration-content">
                <h2 style="color: var(--primary-purple);">üéâ Á¥†Êô¥„Çâ„Åó„ÅÑÔºÅ üéâ</h2>
                <p style="color: var(--light-purple); margin: 15px 0;">ÂåñÂ≠¶„Éû„Çπ„Çø„Éº„Å´‰∏ÄÊ≠©Ëøë„Å•„ÅÑ„Åü„Å≠ÔºÅ</p>
                <button class="mode-btn" onclick="nextProblem()" style="margin: 10px auto; display: block;">Ê¨°„ÅÆÂïèÈ°å„Å∏ ‚ú®</button>
            </div>
        </div>
    </div>

    <script>
        // „Ç≤„Éº„É†„Éá„Éº„Çø
        const gameData = {
            elements: [
                { question: "Ê∞¥Á¥†„ÅÆÂÖÉÁ¥†Ë®òÂè∑„ÅØÔºü", answer: ["H"], pool: ["H", "He", "Li", "Be", "B", "C", "N", "O"] },
                { question: "ÈÖ∏Á¥†„ÅÆÂÖÉÁ¥†Ë®òÂè∑„ÅØÔºü", answer: ["O"], pool: ["O", "H", "C", "N", "F", "Ne", "Na", "Mg"] },
                { question: "ÁÇ≠Á¥†„ÅÆÂÖÉÁ¥†Ë®òÂè∑„ÅØÔºü", answer: ["C"], pool: ["C", "H", "O", "N", "S", "P", "Cl", "Ar"] },
                { question: "Á™íÁ¥†„ÅÆÂÖÉÁ¥†Ë®òÂè∑„ÅØÔºü", answer: ["N"], pool: ["N", "O", "F", "Ne", "Na", "Mg", "Al", "Si"] },
                { question: "Â°©Á¥†„ÅÆÂÖÉÁ¥†Ë®òÂè∑„ÅØÔºü", answer: ["Cl"], pool: ["Cl", "F", "Br", "I", "S", "P", "N", "O"] },
                { question: "Á°´ÈªÑ„ÅÆÂÖÉÁ¥†Ë®òÂè∑„ÅØÔºü", answer: ["S"], pool: ["S", "P", "Cl", "Ar", "K", "Ca", "Sc", "Ti"] },
                { question: "ÈâÑ„ÅÆÂÖÉÁ¥†Ë®òÂè∑„ÅØÔºü", answer: ["Fe"], pool: ["Fe", "Co", "Ni", "Cu", "Zn", "Ga", "Ge", "As"] },
                { question: "ÈäÖ„ÅÆÂÖÉÁ¥†Ë®òÂè∑„ÅØÔºü", answer: ["Cu"], pool: ["Cu", "Zn", "Ag", "Au", "Ni", "Fe", "Co", "Pt"] },
                { question: "„Éä„Éà„É™„Ç¶„É†„ÅÆÂÖÉÁ¥†Ë®òÂè∑„ÅØÔºü", answer: ["Na"], pool: ["Na", "K", "Li", "Mg", "Ca", "Sr", "Ba", "Ra"] },
                { question: "„Éû„Ç∞„Éç„Ç∑„Ç¶„É†„ÅÆÂÖÉÁ¥†Ë®òÂè∑„ÅØÔºü", answer: ["Mg"], pool: ["Mg", "Ca", "Sr", "Ba", "Be", "Ra", "Zn", "Cd"] },
                { question: "„Éê„É™„Ç¶„É†„ÅÆÂÖÉÁ¥†Ë®òÂè∑„ÅØÔºü", answer: ["Ba"], pool: ["Ba", "Ca", "Sr", "Ra", "Mg", "Be", "Zn", "Cd"] },
                { question: "ÈäÄ„ÅÆÂÖÉÁ¥†Ë®òÂè∑„ÅØÔºü", answer: ["Ag"], pool: ["Ag", "Au", "Cu", "Pt", "Pd", "Rh", "Ir", "Os"] }
            ],

            compounds: [
                { question: "Ê∞¥Á¥†ÂàÜÂ≠ê„ÅÆÂåñÂ≠¶Âºè„ÅØÔºü", answer: ["H", "‚ÇÇ"], pool: ["H", "‚ÇÇ", "‚ÇÉ", "O", "N", "C", "‚ÇÑ", "‚ÇÖ"] },
                { question: "Ê∞¥ÂàÜÂ≠ê„ÅÆÂåñÂ≠¶Âºè„ÅØÔºü", answer: ["H", "‚ÇÇ", "O"], pool: ["H", "‚ÇÇ", "O", "‚ÇÉ", "N", "C", "S", "‚ÇÑ"] },
                { question: "Â°©Âåñ„Éä„Éà„É™„Ç¶„É†„ÅÆÂåñÂ≠¶Âºè„ÅØÔºü", answer: ["Na", "Cl"], pool: ["Na", "Cl", "K", "Br", "I", "F", "Ca", "Mg"] },
                { question: "ÁÇ≠ÈÖ∏„Éä„Éà„É™„Ç¶„É†„ÅÆÂåñÂ≠¶Âºè„ÅØÔºü", answer: ["Na", "‚ÇÇ", "C", "O", "‚ÇÉ"], pool: ["Na", "‚ÇÇ", "C", "O", "‚ÇÉ", "H", "S", "‚ÇÑ"] },
                { question: "‰∫åÈÖ∏ÂåñÁÇ≠Á¥†„ÅÆÂåñÂ≠¶Âºè„ÅØÔºü", answer: ["C", "O", "‚ÇÇ"], pool: ["C", "O", "‚ÇÇ", "H", "N", "S", "‚ÇÉ", "‚ÇÑ"] },
                { question: "ÈÖ∏ÂåñÈäÄ„ÅÆÂåñÂ≠¶Âºè„ÅØÔºü", answer: ["Ag", "‚ÇÇ", "O"], pool: ["Ag", "‚ÇÇ", "O", "Au", "Cu", "‚ÇÉ", "H", "N"] },
                { question: "Á°´ÂåñÈâÑ„ÅÆÂåñÂ≠¶Âºè„ÅØÔºü", answer: ["Fe", "S"], pool: ["Fe", "S", "Cu", "O", "Zn", "Ni", "Co", "Mn"] },
                { question: "Á°´ÂåñÈäÖ„ÅÆÂåñÂ≠¶Âºè„ÅØÔºü", answer: ["Cu", "S"], pool: ["Cu", "S", "Fe", "O", "Ag", "Au", "Zn", "Ni"] },
                { question: "ÈÖ∏ÂåñÈäÖ„ÅÆÂåñÂ≠¶Âºè„ÅØÔºü", answer: ["Cu", "O"], pool: ["Cu", "O", "S", "Fe", "Ag", "H", "N", "C"] },
                { question: "Á°´ÈÖ∏„ÅÆÂåñÂ≠¶Âºè„ÅØÔºü", answer: ["H", "‚ÇÇ", "S", "O", "‚ÇÑ"], pool: ["H", "‚ÇÇ", "S", "O", "‚ÇÑ", "N", "C", "‚ÇÉ"] },
                { question: "Á°ùÈÖ∏„ÅÆÂåñÂ≠¶Âºè„ÅØÔºü", answer: ["H", "N", "O", "‚ÇÉ"], pool: ["H", "N", "O", "‚ÇÉ", "S", "C", "‚ÇÇ", "‚ÇÑ"] },
                { question: "Ê∞¥ÈÖ∏Âåñ„Éä„Éà„É™„Ç¶„É†„ÅÆÂåñÂ≠¶Âºè„ÅØÔºü", answer: ["Na", "O", "H"], pool: ["Na", "O", "H", "K", "Ca", "Mg", "C", "N"] },
                { question: "Â°©ÂåñÈäÖ„ÅÆÂåñÂ≠¶Âºè„ÅØÔºü", answer: ["Cu", "Cl", "‚ÇÇ"], pool: ["Cu", "Cl", "‚ÇÇ", "Fe", "Br", "I", "‚ÇÉ", "‚ÇÑ"] },
                { question: "Ê∞¥ÈÖ∏Âåñ„Éê„É™„Ç¶„É†„ÅÆÂåñÂ≠¶Âºè„ÅØÔºü", answer: ["Ba", "(", "O", "H", ")", "‚ÇÇ"], pool: ["Ba", "(", "O", "H", ")", "‚ÇÇ", "Ca", "Sr"] }
            ],

            reactions: [
                { question: "Ê∞¥„ÅÆÈõªÊ∞óÂàÜËß£„ÅÆÂºè„ÅØÔºü", answer: ["2", "H", "‚ÇÇ", "O", "‚Üí", "2", "H", "‚ÇÇ", "+", "O", "‚ÇÇ"], pool: ["2", "H", "O", "‚Üí", "+", "‚ÇÇ", "3", "4"] },
                { question: "ÈÖ∏ÂåñÈäÄ„ÅÆÁÜ±ÂàÜËß£„ÅÆÂºè„ÅØÔºü", answer: ["2", "Ag", "‚ÇÇ", "O", "‚Üí", "4", "Ag", "+", "O", "‚ÇÇ"], pool: ["2", "4", "Ag", "O", "‚Üí", "+", "‚ÇÇ", "3"] },
                { question: "ÈâÑ„Å®Á°´ÈªÑ„ÅÆÂåñÂêà„ÅÆÂºè„ÅØÔºü", answer: ["Fe", "+", "S", "‚Üí", "Fe", "S"], pool: ["Fe", "S", "‚Üí", "+", "Cu", "O", "H", "N"] },
                { question: "ÈäÖ„Å®Á°´ÈªÑ„ÅÆÂåñÂêà„ÅÆÂºè„ÅØÔºü", answer: ["Cu", "+", "S", "‚Üí", "Cu", "S"], pool: ["Cu", "S", "‚Üí", "+", "Fe", "O", "Ag", "H"] },
                { question: "ÈäÖ„ÅÆÈÖ∏Âåñ„ÅÆÂºè„ÅØÔºü", answer: ["2", "Cu", "+", "O", "‚ÇÇ", "‚Üí", "2", "Cu", "O"], pool: ["2", "Cu", "O", "‚Üí", "+", "‚ÇÇ", "3", "4"] },
                { question: "ÁÇ≠Á¥†„ÅÆÁáÉÁÑº„ÅÆÂºè„ÅØÔºü", answer: ["C", "+", "O", "‚ÇÇ", "‚Üí", "C", "O", "‚ÇÇ"], pool: ["C", "O", "‚ÇÇ", "‚Üí", "+", "H", "N", "S"] },
                { question: "„Éû„Ç∞„Éç„Ç∑„Ç¶„É†„ÅÆÁáÉÁÑº„ÅÆÂºè„ÅØÔºü", answer: ["2", "Mg", "+", "O", "‚ÇÇ", "‚Üí", "2", "Mg", "O"], pool: ["2", "Mg", "O", "‚Üí", "+", "‚ÇÇ", "Ca", "3"] }
            ],

            ions: [
                { question: "ÈäÖ„Ç§„Ç™„É≥„ÅÆÂåñÂ≠¶Âºè„ÅØÔºü", answer: ["Cu", "¬≤‚Å∫"], pool: ["Cu", "¬≤‚Å∫", "‚Å∫", "¬≤‚Åª", "Fe", "Ag", "Au", "Zn"] },
                { question: "Á°´ÈÖ∏„Ç§„Ç™„É≥„ÅÆÂåñÂ≠¶Âºè„ÅØÔºü", answer: ["S", "O", "‚ÇÑ", "¬≤‚Åª"], pool: ["S", "O", "‚ÇÑ", "¬≤‚Åª", "‚Åª", "¬≥‚Åª", "P", "N"] },
                { question: "Ê∞¥Á¥†„Ç§„Ç™„É≥„ÅÆÂåñÂ≠¶Âºè„ÅØÔºü", answer: ["H", "‚Å∫"], pool: ["H", "‚Å∫", "¬≤‚Å∫", "‚Åª", "O", "N", "C", "Li"] },
                { question: "Ê∞¥ÈÖ∏ÂåñÁâ©„Ç§„Ç™„É≥„ÅÆÂåñÂ≠¶Âºè„ÅØÔºü", answer: ["O", "H", "‚Åª"], pool: ["O", "H", "‚Åª", "‚Å∫", "¬≤‚Åª", "N", "C", "S"] },
                { question: "ÈäÄ„Ç§„Ç™„É≥„ÅÆÂåñÂ≠¶Âºè„ÅØÔºü", answer: ["Ag", "‚Å∫"], pool: ["Ag", "‚Å∫", "¬≤‚Å∫", "Au", "Cu", "‚Åª", "Pt", "Pd"] },
                { question: "„Ç´„É´„Ç∑„Ç¶„É†„Ç§„Ç™„É≥„ÅÆÂåñÂ≠¶Âºè„ÅØÔºü", answer: ["Ca", "¬≤‚Å∫"], pool: ["Ca", "¬≤‚Å∫", "‚Å∫", "Mg", "Ba", "Sr", "¬≥‚Å∫", "‚Åª"] },
                { question: "„Éû„Ç∞„Éç„Ç∑„Ç¶„É†„Ç§„Ç™„É≥„ÅÆÂåñÂ≠¶Âºè„ÅØÔºü", answer: ["Mg", "¬≤‚Å∫"], pool: ["Mg", "¬≤‚Å∫", "‚Å∫", "Ca", "Be", "Ba", "¬≥‚Å∫", "‚Åª"] },
                { question: "„Éê„É™„Ç¶„É†„Ç§„Ç™„É≥„ÅÆÂåñÂ≠¶Âºè„ÅØÔºü", answer: ["Ba", "¬≤‚Å∫"], pool: ["Ba", "¬≤‚Å∫", "‚Å∫", "Ca", "Sr", "Ra", "¬≥‚Å∫", "‚Åª"] },
                { question: "Á°ùÈÖ∏„Ç§„Ç™„É≥„ÅÆÂåñÂ≠¶Âºè„ÅØÔºü", answer: ["N", "O", "‚ÇÉ", "‚Åª"], pool: ["N", "O", "‚ÇÉ", "‚Åª", "¬≤‚Åª", "P", "‚ÇÑ", "S"] },
                { question: "„Ç´„É™„Ç¶„É†„Ç§„Ç™„É≥„ÅÆÂåñÂ≠¶Âºè„ÅØÔºü", answer: ["K", "‚Å∫"], pool: ["K", "‚Å∫", "¬≤‚Å∫", "Na", "Li", "Rb", "Cs", "‚Åª"] },
                { question: "„Éä„Éà„É™„Ç¶„É†„Ç§„Ç™„É≥„ÅÆÂåñÂ≠¶Âºè„ÅØÔºü", answer: ["Na", "‚Å∫"], pool: ["Na", "‚Å∫", "¬≤‚Å∫", "K", "Li", "Mg", "Ca", "‚Åª"] },
                { question: "Â°©ÂåñÁâ©„Ç§„Ç™„É≥„ÅÆÂåñÂ≠¶Âºè„ÅØÔºü", answer: ["Cl", "‚Åª"], pool: ["Cl", "‚Åª", "Br", "I", "F", "‚Å∫", "¬≤‚Åª", "¬≥‚Åª"] },
                { question: "„Ç¢„É≥„É¢„Éã„Ç¶„É†„Ç§„Ç™„É≥„ÅÆÂåñÂ≠¶Âºè„ÅØÔºü", answer: ["N", "H", "‚ÇÑ", "‚Å∫"], pool: ["N", "H", "‚ÇÑ", "‚Å∫", "‚ÇÉ", "P", "¬≤‚Å∫", "‚Åª"] },
                { question: "ÁÇ≠ÈÖ∏„Ç§„Ç™„É≥„ÅÆÂåñÂ≠¶Âºè„ÅØÔºü", answer: ["C", "O", "‚ÇÉ", "¬≤‚Åª"], pool: ["C", "O", "‚ÇÉ", "¬≤‚Åª", "‚Åª", "S", "‚ÇÑ", "N"] },
                { question: "‰∫úÈâõ„Ç§„Ç™„É≥„ÅÆÂåñÂ≠¶Âºè„ÅØÔºü", answer: ["Zn", "¬≤‚Å∫"], pool: ["Zn", "¬≤‚Å∫", "‚Å∫", "Cu", "Fe", "Ni", "Co", "‚Åª"] },
                { question: "ÈâÑ„Ç§„Ç™„É≥(II)„ÅÆÂåñÂ≠¶Âºè„ÅØÔºü", answer: ["Fe", "¬≤‚Å∫"], pool: ["Fe", "¬≤‚Å∫", "¬≥‚Å∫", "‚Å∫", "Cu", "Ni", "Co", "‚Åª"] }
            ]
        };

        // „Ç≤„Éº„É†Áä∂ÊÖã
        let currentMode = '';
        let currentProblem = null;
        let currentProblemIndex = 0;
        let correctCount = 0;
        let totalCount = 0;
        let comboCount = 0;
        let currentAnswer = [];
        let atomCards = [];

        // Èü≥Èüø„Ç∑„Çπ„ÉÜ„É†
        class KawaiiSoundSystem {
            constructor() {
                this.audioContext = null;
                this.initAudio();
            }

            initAudio() {
                try {
                    this.audioContext = new (window.AudioContext || window.webkitAudioContext)();
                } catch (e) {
                    console.log('Èü≥Â£∞„Ç∑„Çπ„ÉÜ„É†„ÇíÂàùÊúüÂåñ„Åß„Åç„Åæ„Åõ„Çì„Åß„Åó„Åü');
                }
            }

            playTone(frequency, duration, type = 'sine', volume = 0.3) {
                if (!this.audioContext) return;

                try {
                    if (this.audioContext.state === 'suspended') {
                        this.audioContext.resume();
                    }

                    const oscillator = this.audioContext.createOscillator();
                    const gainNode = this.audioContext.createGain();
                    const filterNode = this.audioContext.createBiquadFilter();

                    oscillator.connect(filterNode);
                    filterNode.connect(gainNode);
                    gainNode.connect(this.audioContext.destination);

                    oscillator.frequency.setValueAtTime(frequency, this.audioContext.currentTime);
                    oscillator.type = type;

                    filterNode.frequency.setValueAtTime(frequency * 2, this.audioContext.currentTime);
                    filterNode.Q.setValueAtTime(1, this.audioContext.currentTime);

                    gainNode.gain.setValueAtTime(0, this.audioContext.currentTime);
                    gainNode.gain.linearRampToValueAtTime(volume, this.audioContext.currentTime + 0.01);
                    gainNode.gain.exponentialRampToValueAtTime(0.001, this.audioContext.currentTime + duration);

                    oscillator.start(this.audioContext.currentTime);
                    oscillator.stop(this.audioContext.currentTime + duration);
                } catch (e) {
                    // „Ç®„É©„Éº„ÅØÁÑ°Ë¶ñ
                }
            }

            playClick() {
                this.playTone(800, 0.15, 'sine', 0.2);
            }

            playCorrect() {
                const notes = [523, 659, 784, 1047];
                notes.forEach((freq, i) => {
                    setTimeout(() => this.playTone(freq, 0.2, 'sine', 0.25), i * 100);
                });
            }

            playIncorrect() {
                this.playTone(300, 0.5, 'sawtooth', 0.2);
            }

            playMagical() {
                const notes = [1047, 1175, 1319, 1568, 1760];
                notes.forEach((freq, i) => {
                    setTimeout(() => this.playTone(freq, 0.3, 'sine', 0.2), i * 80);
                });
            }

            playBounce() {
                this.playTone(600 + Math.random() * 400, 0.2, 'sine', 0.15);
            }

            vibrate(pattern) {
                if ('vibrate' in navigator) {
                    navigator.vibrate(pattern);
                }
            }
        }

        const soundSystem = new KawaiiSoundSystem();

        // „Éë„Éº„ÉÜ„Ç£„ÇØ„É´„Ç∑„Çπ„ÉÜ„É†
        class KawaiiParticleSystem {
            constructor() {
                this.particles = [];
            }

            createParticle(x, y, emoji, color = null) {
                const particle = document.createElement('div');
                particle.className = 'kawaii-particle';
                particle.textContent = emoji;
                if (color) particle.style.color = color;
                particle.style.left = x + 'px';
                particle.style.top = y + 'px';
                document.body.appendChild(particle);

                setTimeout(() => {
                    if (particle.parentNode) {
                        particle.parentNode.removeChild(particle);
                    }
                }, 2000);
            }

            createExplosion(x, y, emojis, count = 8) {
                for (let i = 0; i < count; i++) {
                    setTimeout(() => {
                        const emoji = emojis[Math.floor(Math.random() * emojis.length)];
                        const offsetX = (Math.random() - 0.5) * 100;
                        const offsetY = (Math.random() - 0.5) * 100;
                        this.createParticle(x + offsetX, y + offsetY, emoji);
                    }, i * 50);
                }
            }

            createSparkleTrail(x, y) {
                const sparkle = document.createElement('div');
                sparkle.className = 'sparkle-trail';
                sparkle.style.left = x + 'px';
                sparkle.style.top = y + 'px';
                document.body.appendChild(sparkle);

                setTimeout(() => {
                    if (sparkle.parentNode) {
                        sparkle.parentNode.removeChild(sparkle);
                    }
                }, 1000);
            }

            createHeartsRain() {
                const hearts = ['üíï', 'üíñ', 'üíó', 'üíù', 'üíû', 'üíì'];
                for (let i = 0; i < 20; i++) {
                    setTimeout(() => {
                        const heart = document.createElement('div');
                        heart.className = 'hearts-rain';
                        heart.textContent = hearts[Math.floor(Math.random() * hearts.length)];
                        heart.style.left = Math.random() * window.innerWidth + 'px';
                        heart.style.top = '-50px';
                        document.body.appendChild(heart);

                        setTimeout(() => {
                            if (heart.parentNode) {
                                heart.parentNode.removeChild(heart);
                            }
                        }, 3000);
                    }, i * 200);
                }
            }
        }

        const particleSystem = new KawaiiParticleSystem();

        // ËªΩÈáèÁâ©ÁêÜ„ÇØ„É©„Çπ
        class AtomCard {
            constructor(element, x, y, type) {
                this.element = element;
                this.x = x;
                this.y = y;
                this.type = type;
                this.radius = 35;
                this.isDragging = false;
            }

            setPosition(x, y) {
                const gameArea = document.getElementById('gameArea');
                const rect = gameArea.getBoundingClientRect();
                const maxX = rect.width - this.radius * 2;
                const maxY = rect.height - this.radius * 2;

                // Â¢ÉÁïå„ÉÅ„Çß„ÉÉ„ÇØ„Å®Ë∑≥„Å≠Ëøî„Çä
                if (x <= 0 || x >= maxX || y <= 100 || y >= maxY - 100) {
                    this.bounce();
                }

                this.x = Math.max(0, Math.min(x, maxX));
                this.y = Math.max(100, Math.min(y, maxY - 100));
                
                this.element.style.left = this.x + 'px';
                this.element.style.top = this.y + 'px';
            }

            startDrag() {
                this.isDragging = true;
                this.element.classList.add('dragging');
            }

            endDrag() {
                this.isDragging = false;
                this.element.classList.remove('dragging');
                
                // „Çπ„É©„Ç§„ÉâÂäπÊûú
                this.element.classList.add('sliding');
                setTimeout(() => {
                    this.element.classList.remove('sliding');
                }, 800);
            }

            bounce() {
                soundSystem.playBounce();
                soundSystem.vibrate([30]);
                this.element.classList.add('wall-bounce');
                setTimeout(() => {
                    this.element.classList.remove('wall-bounce');
                }, 300);

                // „Éê„Ç¶„É≥„ÇπÊôÇ„ÅÆ„Éë„Éº„ÉÜ„Ç£„ÇØ„É´
                const rect = this.element.getBoundingClientRect();
                particleSystem.createParticle(
                    rect.left + rect.width / 2,
                    rect.top + rect.height / 2,
                    '‚ú®'
                );
            }
        }

        // „Ç≤„Éº„É†ÂàùÊúüÂåñ
        function initGame() {
            // „Ç§„Éô„É≥„Éà„É™„Çπ„Éä„Éº„ÅÆË®≠ÂÆö
            setupEventListeners();

            // ÂàùÊúü„É°„ÉÉ„Çª„Éº„Ç∏
            setTimeout(() => {
                showFeedback('Chemi Quiz „Å∏„Çà„ÅÜ„Åì„ÅùÔºÅüíï', 'correct');
            }, 500);
        }

        // „Ç§„Éô„É≥„Éà„É™„Çπ„Éä„ÉºË®≠ÂÆö
        function setupEventListeners() {
            // „É¢„Éº„ÉâÈÅ∏Êäû
            document.querySelectorAll('.mode-btn').forEach(btn => {
                btn.addEventListener('click', (e) => {
                    selectMode(e.target.dataset.mode);
                });
            });

            // „Ç≥„É≥„Éà„É≠„Éº„É´„Éú„Çø„É≥
            document.getElementById('checkBtn').addEventListener('click', checkAnswer);
            document.getElementById('clearBtn').addEventListener('click', clearAnswer);
            document.getElementById('hintBtn').addEventListener('click', showHint);
            document.getElementById('nextBtn').addEventListener('click', nextProblem);

            // „Çø„Ç§„Éà„É´„ÅÆ„Ç§„É≥„Çø„É©„ÇØ„Ç∑„Éß„É≥
            document.getElementById('gameTitle').addEventListener('click', () => {
                soundSystem.playMagical();
                soundSystem.vibrate([100, 50, 100, 50, 150]);
                particleSystem.createHeartsRain();
                
                const rect = document.getElementById('gameTitle').getBoundingClientRect();
                particleSystem.createExplosion(
                    rect.left + rect.width / 2,
                    rect.top + rect.height / 2,
                    ['üß™', '‚öóÔ∏è', 'üî¨', 'üíï', '‚ú®', 'üåü'],
                    12
                );
            });

            // ÂåñÂ≠¶„Ç¢„Ç§„Ç≥„É≥„ÅÆ„Ç§„É≥„Çø„É©„ÇØ„Ç∑„Éß„É≥
            document.getElementById('leftIcon').addEventListener('click', () => {
                soundSystem.playClick();
                soundSystem.vibrate([50]);
                const rect = document.getElementById('leftIcon').getBoundingClientRect();
                particleSystem.createExplosion(
                    rect.left + rect.width / 2,
                    rect.top + rect.height / 2,
                    ['üß™', 'üíï', '‚ú®'],
                    5
                );
            });

            document.getElementById('rightIcon').addEventListener('click', () => {
                soundSystem.playClick();
                soundSystem.vibrate([50]);
                const rect = document.getElementById('rightIcon').getBoundingClientRect();
                particleSystem.createExplosion(
                    rect.left + rect.width / 2,
                    rect.top + rect.height / 2,
                    ['‚öóÔ∏è', 'üíñ', 'üåü'],
                    5
                );
            });

            // „Çπ„Ç≥„Ç¢„Ç®„É™„Ç¢„ÅÆ„Ç§„É≥„Çø„É©„ÇØ„Ç∑„Éß„É≥
            document.querySelectorAll('.score-item').forEach(item => {
                item.addEventListener('click', () => {
                    soundSystem.playClick();
                    soundSystem.vibrate([30]);
                    const rect = item.getBoundingClientRect();
                    particleSystem.createParticle(
                        rect.left + rect.width / 2,
                        rect.top + rect.height / 2,
                        'üí´'
                    );
                });
            });

            // ÂõûÁ≠î„Ç®„É™„Ç¢„ÅÆ„Éâ„É≠„ÉÉ„ÉóÂØæÂøú
            const answerArea = document.getElementById('answerArea');
            answerArea.addEventListener('dragover', (e) => {
                e.preventDefault();
                answerArea.classList.add('drop-hover');
            });

            answerArea.addEventListener('dragleave', () => {
                answerArea.classList.remove('drop-hover');
            });

            answerArea.addEventListener('drop', (e) => {
                e.preventDefault();
                answerArea.classList.remove('drop-hover');
                
                const atomText = e.dataTransfer.getData('text/plain');
                if (atomText) {
                    addToAnswer(atomText);
                    
                    // „Éâ„É≠„ÉÉ„ÉóÊôÇ„ÅÆ„Ç®„Éï„Çß„ÇØ„Éà
                    soundSystem.playClick();
                    soundSystem.vibrate([50]);
                    const rect = answerArea.getBoundingClientRect();
                    particleSystem.createParticle(
                        rect.left + rect.width / 2,
                        rect.top + rect.height / 2,
                        '‚ú®'
                    );
                }
            });

            // Èü≥Â£∞„Ç∑„Çπ„ÉÜ„É†„ÅÆÂàùÊúüÂåñ
            document.addEventListener('click', () => {
                if (soundSystem.audioContext && soundSystem.audioContext.state === 'suspended') {
                    soundSystem.audioContext.resume();
                }
            }, { once: true });
        }

        // „É¢„Éº„ÉâÈÅ∏Êäû
        function selectMode(mode) {
            currentMode = mode;
            currentProblemIndex = 0;
            
            // UIÊõ¥Êñ∞
            document.querySelectorAll('.mode-btn').forEach(btn => {
                btn.classList.remove('active');
            });
            document.querySelector(`[data-mode="${mode}"]`).classList.add('active');

            soundSystem.playMagical();
            soundSystem.vibrate([100, 50, 100]);

            // Êñ∞„Åó„ÅÑÂïèÈ°å„ÇíÈñãÂßã
            loadProblem();

            // „É¢„Éº„ÉâÈÅ∏ÊäûÊôÇ„ÅÆ„Ç®„Éï„Çß„ÇØ„Éà
            const btn = document.querySelector(`[data-mode="${mode}"]`);
            const rect = btn.getBoundingClientRect();
            particleSystem.createExplosion(
                rect.left + rect.width / 2,
                rect.top + rect.height / 2,
                ['üéâ', '‚ú®', 'üíï', 'üåü'],
                8
            );
        }

        // ÂïèÈ°åË™≠„ÅøËæº„Åø
        function loadProblem() {
            if (!currentMode || !gameData[currentMode]) return;

            const problems = gameData[currentMode];
            if (currentProblemIndex >= problems.length) {
                currentProblemIndex = 0;
            }

            currentProblem = problems[currentProblemIndex];
            clearAnswer();
            createAtomCards();
            
            document.getElementById('questionDisplay').textContent = currentProblem.question;
            
            showFeedback('Êñ∞„Åó„ÅÑÂïèÈ°å„Å†„ÇàÔºÅÈ†ëÂºµ„Å£„Å¶ üí™', 'correct');
        }

        // ÂéüÂ≠ê„Ç´„Éº„Éâ‰ΩúÊàê
        function createAtomCards() {
            // Êó¢Â≠ò„ÅÆ„Ç´„Éº„Éâ„ÇíÂâäÈô§
            atomCards.forEach(card => {
                if (card.element.parentNode) {
                    card.element.parentNode.removeChild(card.element);
                }
            });
            atomCards = [];

            if (!currentProblem) return;

            const gameArea = document.getElementById('gameArea');
            const rect = gameArea.getBoundingClientRect();

            // „Ç´„Éº„Éâ„ÅÆÁ®ÆÈ°û„ÇíÊ∑∑Âêà
            const allAtoms = [...currentProblem.answer, ...currentProblem.pool];
            const uniqueAtoms = [...new Set(allAtoms)];

            uniqueAtoms.forEach((atom, index) => {
                const card = document.createElement('div');
                card.className = `atom-card ${getAtomClass(atom)}`;
                card.textContent = atom;
                card.draggable = true;

                // ÂàùÊúü‰ΩçÁΩÆ„Çí„É©„É≥„ÉÄ„É†„Å´Ë®≠ÂÆö
                const x = Math.random() * (rect.width - 140) + 70;
                const y = Math.random() * (rect.height - 300) + 150;

                card.style.left = x + 'px';
                card.style.top = y + 'px';

                // „Éâ„É©„ÉÉ„Ç∞„Ç§„Éô„É≥„Éà
                card.addEventListener('dragstart', (e) => {
                    e.dataTransfer.setData('text/plain', atom);
                    const cardObj = atomCards.find(c => c.element === card);
                    if (cardObj) cardObj.startDrag();
                });

                card.addEventListener('dragend', () => {
                    const cardObj = atomCards.find(c => c.element === card);
                    if (cardObj) cardObj.endDrag();
                });

                // „Çø„ÉÉ„ÉÅÂØæÂøú
                let isDraggingTouch = false;
                let startX, startY;

                card.addEventListener('touchstart', (e) => {
                    e.preventDefault();
                    isDraggingTouch = true;
                    const touch = e.touches[0];
                    startX = touch.clientX - card.offsetLeft;
                    startY = touch.clientY - card.offsetTop;
                    
                    const cardObj = atomCards.find(c => c.element === card);
                    if (cardObj) cardObj.startDrag();
                });

                card.addEventListener('touchmove', (e) => {
                    if (!isDraggingTouch) return;
                    e.preventDefault();

                    const touch = e.touches[0];
                    const gameRect = gameArea.getBoundingClientRect();
                    const newX = touch.clientX - gameRect.left - startX;
                    const newY = touch.clientY - gameRect.top - startY;

                    const cardObj = atomCards.find(c => c.element === card);
                    if (cardObj) {
                        cardObj.setPosition(newX, newY);
                    }
                });

                card.addEventListener('touchend', (e) => {
                    if (!isDraggingTouch) return;
                    isDraggingTouch = false;

                    const cardObj = atomCards.find(c => c.element === card);
                    if (cardObj) cardObj.endDrag();

                    // ÂõûÁ≠î„Ç®„É™„Ç¢„Å´Ëøë„ÅÑÂ†¥Âêà„ÅØËá™ÂãïËøΩÂä†
                    const answerArea = document.getElementById('answerArea');
                    const answerRect = answerArea.getBoundingClientRect();
                    const cardRect = card.getBoundingClientRect();

                    const distance = Math.sqrt(
                        Math.pow(cardRect.left - answerRect.left, 2) +
                        Math.pow(cardRect.top - answerRect.top, 2)
                    );

                    if (distance < 150) {
                        addToAnswer(atom);
                        soundSystem.playClick();
                        soundSystem.vibrate([50]);
                        particleSystem.createParticle(
                            answerRect.left + answerRect.width / 2,
                            answerRect.top + answerRect.height / 2,
                            '‚ú®'
                        );
                    }
                });

                // „ÇØ„É™„ÉÉ„ÇØÊôÇ„ÅÆÂèçÂøú
                card.addEventListener('click', () => {
                    soundSystem.playClick();
                    soundSystem.vibrate([30]);
                    const rect = card.getBoundingClientRect();
                    particleSystem.createParticle(
                        rect.left + rect.width / 2,
                        rect.top + rect.height / 2,
                        'üí´'
                    );
                });

                gameArea.appendChild(card);

                // ËªΩÈáèÁâ©ÁêÜ„Ç™„Éñ„Ç∏„Çß„ÇØ„Éà‰ΩúÊàê
                const atomCard = new AtomCard(card, x, y, getAtomClass(atom));
                atomCards.push(atomCard);

                // Âá∫Áèæ„Ç¢„Éã„É°„Éº„Ç∑„Éß„É≥
                setTimeout(() => {
                    card.style.animation = 'none';
                }, 500);
            });
        }

        // ÂéüÂ≠ê„ÇØ„É©„ÇπÂèñÂæó
        function getAtomClass(atom) {
            if (['H'].includes(atom)) return 'atom-hydrogen';
            if (['O'].includes(atom)) return 'atom-oxygen';
            if (['C'].includes(atom)) return 'atom-carbon';
            if (['N'].includes(atom)) return 'atom-nitrogen';
            if (['Cl', 'Br', 'I', 'F'].includes(atom)) return 'atom-chlorine';
            if (['S', 'P'].includes(atom)) return 'atom-sulfur';
            if (['Fe', 'Cu', 'Na', 'Mg', 'Ba', 'Ag', 'K', 'Ca', 'Zn', 'Al', 'Ti', 'Mn', 'Ni'].includes(atom)) return 'atom-metal';
            if (['1', '2', '3', '4', '5', '6', '7', '8', '9', '0', '‚ÇÅ', '‚ÇÇ', '‚ÇÉ', '‚ÇÑ', '‚ÇÖ', '‚ÇÜ', '‚Çá', '‚Çà', '‚Çâ', '‚ÇÄ'].includes(atom)) return 'atom-number';
            if (['‚Å∫', '‚Åª', '¬≤‚Å∫', '¬≤‚Åª', '¬≥‚Å∫', '¬≥‚Åª'].includes(atom)) return 'atom-ion';
            if (['‚Üí', '+', '(', ')'].includes(atom)) return 'atom-special';
            return 'atom-carbon';
        }

        // ÂõûÁ≠î„Å´ËøΩÂä†
        function addToAnswer(atom) {
            currentAnswer.push(atom);
            updateAnswerDisplay();
        }

        // ÂõûÁ≠îË°®Á§∫Êõ¥Êñ∞
        function updateAnswerDisplay() {
            const answerArea = document.getElementById('answerArea');
            
            if (currentAnswer.length === 0) {
                answerArea.innerHTML = '<div style="color: var(--light-purple);">„Åì„Åì„Å´ÂéüÂ≠ê„Ç´„Éº„Éâ„Çí„Éâ„É©„ÉÉ„Ç∞„Åó„Å¶„Å≠ ‚ú®</div>';
            } else {
                answerArea.innerHTML = currentAnswer.map((atom, index) => 
                    `<span class="answer-piece" onclick="removeFromAnswer(${index})">${atom}</span>`
                ).join('');
            }
        }

        // ÂõûÁ≠î„Åã„ÇâÂâäÈô§
        function removeFromAnswer(index) {
            currentAnswer.splice(index, 1);
            updateAnswerDisplay();
            soundSystem.playClick();
            soundSystem.vibrate([30]);
        }

        // ÂõûÁ≠î„Çí„ÇØ„É™„Ç¢
        function clearAnswer() {
            currentAnswer = [];
            updateAnswerDisplay();
            soundSystem.playClick();
            soundSystem.vibrate([50]);
            
            const answerArea = document.getElementById('answerArea');
            const rect = answerArea.getBoundingClientRect();
            particleSystem.createParticle(
                rect.left + rect.width / 2,
                rect.top + rect.height / 2,
                'üóëÔ∏è'
            );
        }

        // Á≠î„Åà„Çí„ÉÅ„Çß„ÉÉ„ÇØ
        function checkAnswer() {
            if (!currentProblem || currentAnswer.length === 0) {
                showFeedback('Á≠î„Åà„ÇíÂÖ•Âäõ„Åó„Å¶„Å≠ ü§î', 'incorrect');
                return;
            }

            totalCount++;
            const isCorrect = arraysEqual(currentAnswer, currentProblem.answer);

            if (isCorrect) {
                correctCount++;
                comboCount++;
                soundSystem.playCorrect();
                soundSystem.vibrate([100, 50, 100, 50, 150]);
                
                showFeedback(`Ê≠£Ëß£ÔºÅ üéâ „Ç≥„É≥„Éú: ${comboCount}`, 'correct');
                
                // Ê≠£Ëß£ÊôÇ„ÅÆ„Ç®„Éï„Çß„ÇØ„Éà
                particleSystem.createHeartsRain();
                setTimeout(() => {
                    const rect = document.getElementById('answerArea').getBoundingClientRect();
                    particleSystem.createExplosion(
                        rect.left + rect.width / 2,
                        rect.top + rect.height / 2,
                        ['üéâ', 'üéä', '‚ú®', 'üåü', 'üíï', 'üíñ'],
                        15
                    );
                }, 300);

                // ÊàêÂäüÁîªÈù¢„ÇíË°®Á§∫
                setTimeout(() => {
                    document.getElementById('celebration').classList.add('show');
                }, 1000);

            } else {
                comboCount = 0;
                soundSystem.playIncorrect();
                soundSystem.vibrate([80, 40, 80]);
                
                const correctStr = currentProblem.answer.join('');
                showFeedback(`ÊÆãÂøµ...Ê≠£Ëß£„ÅØ„Äå${correctStr}„Äç„Å†„Çà üòÖ`, 'incorrect');
            }

            updateScoreDisplay();
        }

        // ÈÖçÂàóÊØîËºÉ
        function arraysEqual(a, b) {
            return a.length === b.length && a.every((val, i) => val === b[i]);
        }

        // „Éí„É≥„ÉàË°®Á§∫
        function showHint() {
            if (!currentProblem) return;

            soundSystem.playClick();
            soundSystem.vibrate([100, 50, 100]);

            const hint = currentProblem.answer[0];
            showFeedback(`„Éí„É≥„Éà: ÊúÄÂàù„ÅØ„Äå${hint}„Äç„Å†„Çà üí°`, 'correct');

            // „Éí„É≥„ÉàÊôÇ„ÅÆ„Ç®„Éï„Çß„ÇØ„Éà
            const questionDisplay = document.getElementById('questionDisplay');
            const rect = questionDisplay.getBoundingClientRect();
            particleSystem.createExplosion(
                rect.left + rect.width / 2,
                rect.top + rect.height / 2,
                ['üí°', '‚ú®', 'üåü'],
                5
            );
        }

        // Ê¨°„ÅÆÂïèÈ°å
        function nextProblem() {
            currentProblemIndex++;
            document.getElementById('celebration').classList.remove('show');
            loadProblem();
            
            soundSystem.playMagical();
            soundSystem.vibrate([100, 50, 100]);
        }

        // „Çπ„Ç≥„Ç¢Ë°®Á§∫Êõ¥Êñ∞
        function updateScoreDisplay() {
            document.getElementById('correctCount').textContent = correctCount;
            document.getElementById('totalCount').textContent = totalCount;
            document.getElementById('comboCount').textContent = comboCount;

            // „Çπ„Ç≥„Ç¢Êõ¥Êñ∞ÊôÇ„ÅÆ„Ç®„Éï„Çß„ÇØ„Éà
            const scoreArea = document.querySelector('.score-area');
            scoreArea.style.animation = 'none';
            setTimeout(() => {
                scoreArea.style.animation = 'bounce-effect 0.6s ease-out';
            }, 10);
        }

        // „Éï„Ç£„Éº„Éâ„Éê„ÉÉ„ÇØË°®Á§∫
        function showFeedback(message, type) {
            const feedback = document.getElementById('feedback');
            feedback.textContent = message;
            feedback.className = `feedback ${type} show`;
            
            setTimeout(() => {
                feedback.classList.remove('show');
            }, 3000);
        }

        // ÂàùÊúüÂåñÂÆüË°å
        document.addEventListener('DOMContentLoaded', () => {
            initGame();
            
            // „Ç¶„Çß„É´„Ç´„É†„Ç®„Éï„Çß„ÇØ„Éà
            setTimeout(() => {
                particleSystem.createHeartsRain();
            }, 1000);
        });
    </script>
</body>
</html>